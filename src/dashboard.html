<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Branch360 Unified Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="activity-client.html"></script>
  <script src="options-data.html"></script>
  <style>
    :root {
      --brand-primary: #2563eb;
      --brand-accent: #60a5fa;
      --brand-dark: #0f172a;
    }
    .submenu-button {
      color: rgba(255, 255, 255, 0.85);
      background: rgba(15, 23, 42, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 0.85rem;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .submenu-button:hover {
      background: rgba(255, 255, 255, 0.18);
      color: #fff;
    }
    .hidden {
      display: none !important;
    }
    body {
      background: #1e293b;
      min-height: 100vh;
    }
    
    /* Handoff Pipeline Styles */
    #handoffPipeline > div {
      max-height: 600px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
    }
    #handoffPipeline > div::-webkit-scrollbar {
      width: 6px;
    }
    #handoffPipeline > div::-webkit-scrollbar-track {
      background: transparent;
    }
    #handoffPipeline > div::-webkit-scrollbar-thumb {
      background-color: rgba(156, 163, 175, 0.5);
      border-radius: 3px;
    }
    #handoffPipeline > div::-webkit-scrollbar-thumb:hover {
      background-color: rgba(156, 163, 175, 0.7);
    }
    .nav-button {
      color: rgba(255, 255, 255, 0.85);
      background-color: rgba(15, 23, 42, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }
    .nav-button:hover {
      background-color: rgba(255, 255, 255, 0.18);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.3);
    }
    .nav-button.active {
      background-color: var(--brand-primary);
      color: #ffffff;
      font-weight: 700;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.25);
      border-color: transparent;
    }
    iframe.persona-frame {
      border: none;
      width: 100%;
      height: calc(100vh - 80px);
      min-height: 800px;
      background: #334155;
      border-radius: 0.75rem;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }

    /* Improve iframe behavior on smaller screens */
    @media (max-width: 768px) {
      iframe.persona-frame {
        height: calc(100vh - 120px);
        min-height: 520px;
        border-radius: 0.5rem;
      }
    }
    aside {
      background: linear-gradient(180deg, var(--brand-dark) 0%, #1f2a3f 100%);
      color: #f8fafc;
    }
    aside h1, aside div {
      color: #fff;
    }
    
    /* Ensure select elements in sidebar are visible */
    aside select {
      color: #ffffff !important;
      background-color: rgba(255, 255, 255, 0.1) !important;
    }
    
    aside select option {
      color: #111827 !important;
      background-color: #ffffff !important;
    }
    
    /* Ensure demoUserSelect is visible */
    #demoUserSelect {
      color: #ffffff !important;
      background-color: rgba(255, 255, 255, 0.1) !important;
    }
    
    #demoUserSelect option {
      color: #111827 !important;
      background-color: #ffffff !important;
    }
    main {
      background: #1e293b;
      border-radius: 2rem 0 0 2rem;
      box-shadow: -30px 0 80px rgba(15, 23, 42, 0.2);
    }
    header, section {
      background: transparent;
    }
    
    /* Ensure header content is visible */
    header, header * {
      color: #f1f5f9 !important;
    }
    
    header .text-gray-500 { color: #94a3b8 !important; }
    header .text-gray-900 { color: #f1f5f9 !important; }
    header label { color: #cbd5e1 !important; }
    header input, header select {
      color: #f1f5f9 !important;
      background-color: #334155 !important;
      border-color: #475569 !important;
    }
    header button.bg-blue-600,
    header button[class*="bg-"] {
      color: #ffffff !important;
    }
    .surface-card {
      background: #334155;
      border: 1px solid #475569;
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.3);
    }
    input, select, textarea {
      background: #334155;
      color: #f1f5f9;
      border: 1px solid #475569;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }
    #refreshBtn, #branchExportBtn, #pilotRunBtn, #googleEarthBtn, #prospectSearchInput {
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    #refreshBtn:hover, #branchExportBtn:hover, #pilotRunBtn:hover, #prospectSearchInput:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(30, 64, 175, 0.2);
    }
    
    /* Ensure all text is visible - OVERRIDE ANY CONFLICTING STYLES */
    main, main *, section, section * {
      color: #f1f5f9 !important;
    }
    
    main h1, main h2, main h3, main h4, main h5, main h6,
    section h1, section h2, section h3, section h4, section h5, section h6 {
      color: #f1f5f9 !important;
      font-weight: 700 !important;
    }
    
    main p, main span, main div:not(button):not(.nav-button):not(.submenu-button),
    section p, section span, section div:not(button):not(.nav-button):not(.submenu-button) {
      color: #f1f5f9 !important;
    }
    
    main label, section label {
      color: #cbd5e1 !important;
    }
    
    /* Ensure buttons are visible and styled - EXCEPT sidebar nav buttons */
    main button:not(.nav-button):not(.submenu-button),
    section button:not(.nav-button):not(.submenu-button) {
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    
    /* Colored buttons - white text on colored background */
    main button.bg-blue-600, main button.bg-green-600, main button.bg-red-600,
    main button.bg-purple-600, main button.bg-emerald-600, main button.bg-indigo-600,
    main .bg-blue-600, main .bg-green-600, main .bg-red-600,
    main .bg-purple-600, main .bg-emerald-600, main .bg-indigo-600 {
      color: #ffffff !important;
    }
    
    /* Gray/outline buttons - light text on dark background */
    main button.border, main button:not([class*="bg-blue"]):not([class*="bg-green"]):not([class*="bg-red"]):not([class*="bg-purple"]):not([class*="bg-emerald"]):not([class*="bg-indigo"]):not(.bg-blue-600):not(.bg-green-600):not(.bg-red-600):not(.bg-purple-600):not(.bg-emerald-600):not(.bg-indigo-600) {
      color: #f1f5f9 !important;
      background-color: #334155 !important;
      border-color: #475569 !important;
    }
    
    /* Ensure buttons with text-white class work */
    main button.text-white, section button.text-white {
      color: #ffffff !important;
    }
    
    /* Ensure form elements are visible */
    main input, main select, main textarea,
    section input, section select, section textarea {
      color: #f1f5f9 !important;
      background-color: #334155 !important;
      border-color: #475569 !important;
    }
    
    /* Ensure links are visible */
    main a:not(.nav-button), section a:not(.nav-button) {
      color: #2563eb !important;
    }
    
    /* Ensure text-gray utilities work */
    main .text-gray-900, section .text-gray-900 { color: #f1f5f9 !important; }
    main .text-gray-800, section .text-gray-800 { color: #e2e8f0 !important; }
    main .text-gray-700, section .text-gray-700 { color: #cbd5e1 !important; }
    main .text-gray-600, section .text-gray-600 { color: #94a3b8 !important; }
    main .text-gray-500, section .text-gray-500 { color: #94a3b8 !important; }
    main .text-gray-400, section .text-gray-400 { color: #64748b !important; }
    
    /* Ensure tables are visible */
    main table, section table {
      color: #f1f5f9 !important;
    }
    main table th, section table th {
      color: #94a3b8 !important;
      font-weight: 600 !important;
    }
    main table td, section table td {
      color: #f1f5f9 !important;
    }
    
    /* Ensure surface cards have visible content */
    main .surface-card, main .bg-white,
    section .surface-card, section .bg-white {
      background-color: #334155 !important;
      color: #f1f5f9 !important;
      border-color: #475569 !important;
    }
    
    main .surface-card *, main .bg-white *,
    section .surface-card *, section .bg-white * {
      color: inherit !important;
    }
    
    /* Toggle switch styling */
    label.relative.inline-flex {
      position: relative;
      display: inline-flex;
      align-items: center;
    }
    
    /* Dark mode styles */
    :root.dark-mode,
    body.dark-mode {
      background: #0f172a;
      color: #f1f5f9;
    }
    
    .dark-mode main,
    .dark-mode .bg-white,
    .dark-mode .surface-card {
      background: #1e293b !important;
      color: #f1f5f9 !important;
      border-color: #334155 !important;
    }
    
    .dark-mode .text-gray-800,
    .dark-mode .text-gray-900 {
      color: #f1f5f9 !important;
    }
    
    .dark-mode .text-gray-600,
    .dark-mode .text-gray-700 {
      color: #cbd5e1 !important;
    }
    
    .dark-mode .text-gray-500 {
      color: #94a3b8 !important;
    }
    
    .dark-mode input,
    .dark-mode select,
    .dark-mode textarea {
      background: #334155 !important;
      color: #f1f5f9 !important;
      border-color: #475569 !important;
    }
    
    /* Compact view styles */
    body.compact-view .space-y-4 > * + * {
      margin-top: var(--compact-spacing, 0.5rem) !important;
    }
    
    body.compact-view .p-4,
    body.compact-view .p-6 {
      padding: var(--compact-padding, 0.75rem) !important;
    }
    
    body.compact-view .mb-4,
    body.compact-view .mb-6 {
      margin-bottom: calc(var(--compact-spacing, 0.5rem) * 1.5) !important;
    }
    
    /* Toggle switch container */
    label .w-11 {
      width: 2.75rem;
      height: 1.5rem;
      background-color: #e5e7eb;
      border-radius: 9999px;
      position: relative;
      transition: background-color 0.2s;
      display: block;
    }
    
    /* Toggle switch circle */
    label .w-11::after {
      content: '';
      position: absolute;
      top: 0.125rem;
      left: 0.125rem;
      width: 1.25rem;
      height: 1.25rem;
      background-color: white;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    /* Checked state */
    input:checked + .w-11,
    .peer:checked ~ .w-11,
    .peer-checked ~ .w-11 {
      background-color: #2563eb;
    }
    
    input:checked + .w-11::after,
    .peer:checked ~ .w-11::after,
    .peer-checked ~ .w-11::after {
      transform: translateX(1.25rem);
    }
    
    /* Handle Tailwind peer classes */
    .peer:checked + div,
    .peer-checked + div {
      background-color: #2563eb;
    }
    
    .peer:checked + div::after,
    .peer-checked + div::after {
      transform: translateX(1.25rem);
    }
    
    /* Ensure white backgrounds are visible */
    .bg-white {
      background-color: #334155;
    }
    
    /* Colored backgrounds for pipeline stages */
    .bg-blue-50 { background: rgba(37, 99, 235, 0.2) !important; }
    .bg-yellow-50 { background: rgba(234, 179, 8, 0.2) !important; }
    .bg-green-50 { background: rgba(34, 197, 94, 0.2) !important; }
    .bg-red-50 { background: rgba(239, 68, 68, 0.2) !important; }
    .bg-purple-50 { background: rgba(168, 85, 247, 0.2) !important; }
    
    /* Hover states */
    .hover\:bg-gray-50:hover { background: #475569 !important; }
    .hover\:bg-blue-100:hover { background: rgba(37, 99, 235, 0.3) !important; }
    .hover\:bg-yellow-100:hover { background: rgba(234, 179, 8, 0.3) !important; }
    .hover\:bg-green-100:hover { background: rgba(34, 197, 94, 0.3) !important; }
    
    /* Ensure text colors are visible */
    .text-gray-900 { color: #f1f5f9; }
    .text-gray-800 { color: #e2e8f0; }
    .text-gray-700 { color: #cbd5e1; }
    .text-gray-600 { color: #94a3b8; }
    .text-gray-500 { color: #94a3b8; }
    .text-white { color: #ffffff; }
    
    /* Ensure button colors */
    .bg-blue-600 { background-color: #2563eb; }
    .bg-green-600 { background-color: #16a34a; }
    .bg-red-600 { background-color: #dc2626; }
    .bg-gray-600 { background-color: #4b5563; }
    .bg-purple-600 { background-color: #9333ea; }
    .bg-emerald-600 { background-color: #059669; }
    
    /* Fix canvas chart heights to prevent unbounded growth */
    #trendChart, #pilotChart, #timeChart {
      max-height: 300px !important;
      height: 300px !important;
      width: 100% !important;
    }

    /* Simple spinner used for long-running tasks */
    .b360-spinner {
      width: 22px;
      height: 22px;
      border: 3px solid rgba(148, 163, 184, 0.35);
      border-top-color: rgba(37, 99, 235, 1);
      border-radius: 9999px;
      animation: b360-spin 0.8s linear infinite;
      flex: 0 0 auto;
    }

    @keyframes b360-spin {
      to { transform: rotate(360deg); }
    }
    
    /* Ensure chart containers have proper height constraints */
    canvas[id="trendChart"],
    canvas[id="pilotChart"],
    canvas[id="timeChart"] {
      max-height: 300px !important;
      height: 300px !important;
    }
    </style>
</head>
<body>
  <div class="flex min-h-screen">
    <aside class="w-64 border-r border-slate-800 p-4 space-y-2">
      <div class="flex items-center gap-3 pb-6 border-b border-white/10 mb-4">
        <img id="brandLogo" src="https://ik.imagekit.io/9cyexhymf/Presto-X%20Logo-ARentokilCompany.png?updatedAt=1762540113819" alt="Brand logo" class="w-12 h-12 object-contain bg-white rounded-lg p-1 shadow" />
        <div>
          <div class="text-xl font-bold text-white">Branch360</div>
          <p class="text-xs text-white/70">Unified Pilot Dashboard</p>
        </div>
      </div>
      <div class="space-y-2 mb-4">
        <p class="text-[11px] uppercase tracking-wide text-white/60">Demo Persona</p>
        <select id="demoUserSelect" class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-sm text-white">
        </select>
        <p id="demoUserSummary" class="text-xs text-white/70">Select a user to simulate their view.</p>
      </div>
      <button class="nav-button w-full text-left px-3 py-2 rounded-lg font-semibold flex items-center justify-between" data-view="ae" id="navAE" data-roles="ae,branch,admin">
        <span>Sales / AE</span>
        <svg class="w-4 h-4 text-white/80" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div id="aeSubmenu" class="hidden ml-3 pl-3 border-l border-white/15 space-y-1">
        <button class="submenu-button w-full text-left px-3 py-2 rounded-lg flex items-center gap-2" id="submenuStartPacket" data-roles="ae,branch,admin">
          <span class="text-lg">üìÑ</span>
          <span>Import Salesforce Quote</span>
        </button>
        <button class="submenu-button w-full text-left px-3 py-2 rounded-lg flex items-center gap-2" id="submenuRouteProspects" data-roles="ae,branch,admin">
          <span class="text-lg">üó∫Ô∏è</span>
          <span>Route & Prospects</span>
        </button>
      </div>
      <button class="nav-button w-full text-left px-3 py-2 rounded-lg" data-view="tech" data-roles="tech,ops,branch,admin">Technician</button>
      <button class="nav-button w-full text-left px-3 py-2 rounded-lg" data-view="ops" data-roles="ops,branch,admin">Operations</button>
      <button class="nav-button w-full text-left px-3 py-2 rounded-lg" data-view="branch" data-roles="branch,admin">Branch Manager</button>
      <button class="nav-button w-full text-left px-3 py-2 rounded-lg" data-view="admin" data-roles="admin" style="background: rgba(124, 58, 237, 0.3); border-color: rgba(124, 58, 237, 0.5);">
        üîê Admin Dashboard
      </button>
      <button class="nav-button w-full text-left px-3 py-2 rounded-lg" data-view="market" data-roles="market,branch,admin">Market Director</button>
      <button class="nav-button w-full text-left px-3 py-2 rounded-lg" data-view="time" data-roles="ops,branch,market,admin">Time Saved</button>
      <button type="button" class="nav-button w-full text-left px-3 py-2 rounded-lg" data-view="pilot" data-roles="branch,market,admin">90-Day Pilot Report</button>
      <button class="nav-button w-full text-left px-3 py-2 rounded-lg" data-view="handoff" data-roles="ops,branch,admin">Sales ‚Üí Ops Handoff</button>
      <button class="nav-button w-full text-left px-3 py-2 rounded-lg" data-view="settings" data-roles="branch,admin">Settings</button>
    </aside>
    <main class="flex-1 p-6 space-y-4 overflow-x-hidden">
      <header class="flex flex-col lg:flex-row lg:items-center lg:justify-between surface-card p-4 rounded-xl shadow-sm gap-4">
        <div class="flex flex-wrap items-center gap-3">
          <div class="min-w-[140px]">
            <label class="text-sm text-gray-500 block mb-1">Branch</label>
            <select id="branchSelect" class="border rounded-lg px-3 py-2 w-full">
              <option value="BRN-001">Houston</option>
            </select>
          </div>
          <div class="min-w-[140px]">
            <label class="text-sm text-gray-500 block mb-1">Start Date</label>
            <input type="date" id="startDate" class="border rounded-lg px-3 py-2 w-full" />
          </div>
          <div class="min-w-[140px]">
            <label class="text-sm text-gray-500 block mb-1">End Date</label>
            <input type="date" id="endDate" class="border rounded-lg px-3 py-2 w-full" />
          </div>
          <div class="min-w-[140px]">
            <label class="text-sm text-gray-500 block mb-1">AE Filter</label>
            <select id="aeFilter" class="border rounded-lg px-3 py-2 w-full">
              <option value="">All AEs</option>
            </select>
          </div>
          <div class="min-w-[140px]">
            <label class="text-sm text-gray-500 block mb-1">Service Type</label>
            <select id="serviceFilter" class="border rounded-lg px-3 py-2 w-full">
              <option value="">All</option>
              <option value="GPC">GPC</option>
              <option value="Rodent">Rodent</option>
              <option value="Fly">Fly</option>
              <option value="Mosquito">Mosquito</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <div>
            <p class="text-xs text-gray-500 uppercase tracking-wide">Active User</p>
            <p id="personaLabel" class="text-sm font-semibold text-gray-900">Demo Persona</p>
          </div>
          <span id="environmentTag" class="px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-700">Demo</span>
          <button id="refreshBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Refresh</button>
        </div>
      </header>

      <section id="view-ae" class="view hidden">
        <iframe class="persona-frame" src="ae-dashboard.html" title="AE Dashboard"></iframe>
      </section>
      <section id="view-tech" class="view hidden">
        <iframe class="persona-frame" src="tech-dashboard.html" title="Tech Dashboard"></iframe>
      </section>
      <section id="view-ops" class="view hidden">
        <iframe class="persona-frame" src="ops-manager-dashboard.html" title="Ops Dashboard"></iframe>
      </section>

      <section id="view-branch" class="view hidden space-y-4">
        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-3 mb-4">
          <button id="btn-generate-report" aria-label="Generate daily report" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">üìä Generate Daily Report</button>
          <button id="btn-weekly-trends" aria-label="View weekly trends" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">üìà View Weekly Trends</button>
          <button id="btn-export-data" aria-label="Export data" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">üíæ Export Data</button>
          <button id="btn-detailed-pipeline" aria-label="View detailed pipeline" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">üíº Detailed Pipeline</button>
          <button id="btn-export-pipeline" aria-label="Export pipeline data" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">üì§ Pipeline Export</button>
          <button id="btn-team-message" aria-label="Send team message" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">üí¨ Team Message</button>
        </div>
        
        <!-- Today's Summary -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="surface-card rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-bold text-gray-800">üìà Sales Today</h2>
              <button id="btn-sales-details" class="text-sm text-blue-600 hover:underline cursor-pointer">View Details ‚Üí</button>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="TAP" title="Click for details">
                <p class="text-sm text-gray-600">TAP</p>
                <p class="text-3xl font-bold text-blue-600" id="branchTodayTAP">0</p>
              </div>
              <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="Appointments" title="Click for details">
                <p class="text-sm text-gray-600">Appointments</p>
                <p class="text-3xl font-bold text-green-600" id="branchTodayAppts">0</p>
              </div>
              <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="Quotes" title="Click for details">
                <p class="text-sm text-gray-600">Quotes</p>
                <p class="text-3xl font-bold text-purple-600" id="branchTodayQuotes">0</p>
              </div>
              <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="Revenue" title="Click for details">
                <p class="text-sm text-gray-600">Revenue</p>
                <p class="text-3xl font-bold text-emerald-600">$<span id="branchTodayRevenue">0</span></p>
              </div>
            </div>
          </div>
          
          <div class="surface-card rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-bold text-gray-800">üîß Operations Today</h2>
              <button id="btn-ops-details" class="text-sm text-blue-600 hover:underline cursor-pointer">View Details ‚Üí</button>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="MissedStops" title="Click for details">
                <p class="text-sm text-gray-600">Missed Stops</p>
                <p class="text-3xl font-bold text-red-600" id="branchTodayMissedStops">0</p>
              </div>
              <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="Backlog" title="Click for details">
                <p class="text-sm text-gray-600">Backlog %</p>
                <p class="text-3xl font-bold text-yellow-600"><span id="branchTodayBacklog">0</span>%</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Alerts -->
        <div id="branchAlertsSection" class="mb-6"></div>
        
        <!-- Team Performance -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="surface-card rounded-lg shadow p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">üèÜ Sales Team Leaderboard</h3>
            <div id="branchSalesLeaderboard">Loading...</div>
          </div>
          
          <div class="surface-card rounded-lg shadow p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">üë∑ Operations Team</h3>
            <div id="branchOpsTeam">Loading...</div>
          </div>
        </div>
        
        <!-- Pipeline Overview -->
        <div class="surface-card rounded-lg shadow p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800">üíº Branch Pipeline</h3>
            <button id="btn-pipeline-all" class="text-sm text-blue-600 hover:underline cursor-pointer">View All ‚Üí</button>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div class="text-center p-4 bg-blue-50 rounded cursor-pointer hover:bg-blue-100 transition pipeline-stage" data-stage="Proposal">
              <p class="text-sm text-gray-600 mb-1">Proposal</p>
              <p class="text-2xl font-bold text-blue-600">$<span id="branchPipelineProposal">0</span></p>
            </div>
            <div class="text-center p-4 bg-yellow-50 rounded cursor-pointer hover:bg-yellow-100 transition pipeline-stage" data-stage="Negotiation">
              <p class="text-sm text-gray-600 mb-1">Negotiation</p>
              <p class="text-2xl font-bold text-yellow-600">$<span id="branchPipelineNegotiation">0</span></p>
            </div>
            <div class="text-center p-4 bg-green-50 rounded cursor-pointer hover:bg-green-100 transition pipeline-stage" data-stage="Sold">
              <p class="text-sm text-gray-600 mb-1">Sold</p>
              <p class="text-2xl font-bold text-green-600">$<span id="branchPipelineSold">0</span></p>
            </div>
          </div>
        </div>
        
        <!-- Additional KPIs -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 flex-1" id="branchCards"></div>
          <button id="branchExportBtn" class="md:w-auto w-full bg-indigo-600 text-white px-4 py-2 rounded-lg">Export Branch Report</button>
        </div>
      </section>

      <section id="view-market" class="view hidden space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="marketCards"></div>
        <div class="surface-card rounded-xl p-4 shadow">
          <h2 class="text-lg font-bold mb-2">New Starts Trend</h2>
          <div style="height: 300px; position: relative;">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
        <div class="surface-card rounded-xl p-4 shadow">
          <h2 class="text-lg font-bold mb-2">AE Summary</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full" id="marketAeTable"></table>
          </div>
        </div>
      </section>

      <section id="view-time" class="view hidden space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="timeCards"></div>
        <div class="surface-card rounded-xl p-4 shadow">
          <h2 class="text-lg font-bold mb-2">Weekly Hours Saved</h2>
          <div style="height: 300px; position: relative;">
            <canvas id="timeChart"></canvas>
          </div>
        </div>
        <div class="surface-card rounded-xl p-4 shadow">
          <h2 class="text-lg font-bold mb-2">Team Breakdown</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full" id="timeTable"></table>
          </div>
        </div>
      </section>

      <section id="view-route" class="view hidden space-y-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="surface-card rounded-xl p-4 shadow space-y-4">
            <div id="territoryList"></div>
            <div>
              <h4 class="text-sm font-semibold text-gray-700 mb-2">Heatmap</h4>
              <div id="territoryHeatmap" class="space-y-2"></div>
            </div>
          </div>
          <div class="lg:col-span-2 space-y-4">
            <div class="surface-card rounded-xl p-4 shadow">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                <div>
                  <h2 class="text-lg font-bold">Prospects</h2>
                  <p class="text-sm text-gray-500" id="prospectSummary">Select a territory to view prospects.</p>
                </div>
                <div class="flex gap-2">
                  <button id="routeImportToAEBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold whitespace-nowrap">
                    ‚ûï Import to Sales AE
                  </button>
                  <input type="search" id="prospectSearchInput" placeholder="Search prospects" class="border rounded-lg px-3 py-2 text-sm" />
                </div>
              </div>
              <div class="overflow-x-auto" id="prospectTable"></div>
              <p id="prospectEmpty" class="text-center text-gray-500 text-sm mt-3">Select a territory to see prospects.</p>
            </div>
            <div class="surface-card rounded-xl p-4 shadow hidden" id="pricingHelperSection">
              <h2 class="text-lg font-bold mb-4">Pricing Helper</h2>
              <form id="pricingForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="text-sm text-gray-500">Square Feet</label>
                  <input type="number" id="pricingSqft" value="10000" class="w-full border rounded-lg px-3 py-2" />
                </div>
                <div>
                  <label class="text-sm text-gray-500">Linear Feet</label>
                  <input type="number" id="pricingLinear" value="200" class="w-full border rounded-lg px-3 py-2" />
                </div>
                <div>
                  <label class="text-sm text-gray-500">Acres</label>
                  <input type="number" id="pricingAcres" value="1" step="0.1" class="w-full border rounded-lg px-3 py-2" />
                </div>
                <div>
                  <label class="text-sm text-gray-500">Excluder Units</label>
                  <input type="number" id="pricingExcluder" value="0" class="w-full border rounded-lg px-3 py-2" />
                </div>
              </form>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div class="border rounded-lg p-3">
                  <p class="text-xs text-gray-500">Base Monthly</p>
                  <p id="pricingMonthly" class="text-2xl font-bold">$0</p>
                </div>
                <div class="border rounded-lg p-3">
                  <p class="text-xs text-gray-500">Estimated Initial</p>
                  <p id="pricingInitial" class="text-2xl font-bold">$0</p>
                </div>
                <div class="border rounded-lg p-3">
                  <p class="text-xs text-gray-500">Suggested Annual</p>
                  <p id="pricingAnnual" class="text-2xl font-bold">$0</p>
                </div>
              </div>
              <div id="pricingBreakdown" class="mt-4 text-sm text-gray-600 space-y-1"></div>
              <button id="googleEarthBtn" class="mt-4 text-sm text-blue-600 underline">Estimate via Google Earth (Coming Soon)</button>
              <p class="text-xs text-gray-500 mt-2">* Placeholder formulas for pilot. Future versions will auto-import sqft/lf/acres.</p>
            </div>
          </div>
        </div>
      </section>

      <section id="view-pilot" class="view hidden space-y-4">
        <div class="surface-card rounded-xl p-4 shadow">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="text-sm text-gray-500 block">Pilot Start</label>
              <input type="date" id="pilotStart" class="border rounded-lg px-3 py-2 w-full" />
            </div>
            <div>
              <label class="text-sm text-gray-500 block">Pilot End</label>
              <input type="date" id="pilotEnd" class="border rounded-lg px-3 py-2 w-full" />
            </div>
            <div>
              <label class="text-sm text-gray-500 block">Role Filter</label>
              <select id="pilotRole" class="border rounded-lg px-3 py-2 w-full">
                <option value="">All Roles</option>
                <option value="Account Executive">Account Executive</option>
                <option value="Technician">Technician</option>
                <option value="Operations Manager">Operations Manager</option>
                <option value="Branch Manager">Branch Manager</option>
              </select>
            </div>
            <div class="flex items-end">
              <button id="pilotRunBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg">Run Report</button>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="pilotCards"></div>
        <div class="surface-card rounded-xl p-4 shadow">
          <h2 class="text-lg font-bold mb-2">Executive Summary</h2>
          <p class="text-sm text-gray-700" id="pilotSummary">Report will generate once data is available.</p>
        </div>
        <div class="surface-card rounded-xl p-4 shadow" id="pilotRoleBreakdownSection">
          <h2 class="text-lg font-bold mb-2">Breakdown by Role</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full" id="pilotRoleBreakdown"></table>
          </div>
        </div>
        <div class="surface-card rounded-xl p-4 shadow" id="pilotActionBreakdownSection">
          <h2 class="text-lg font-bold mb-2">Breakdown by Action Type</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full" id="pilotActionBreakdown"></table>
          </div>
        </div>
        <div class="surface-card rounded-xl p-4 shadow">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-3 gap-3">
            <h2 class="text-lg font-bold" id="pilotTableTitle">Per-User Breakdown</h2>
            <div class="flex gap-2">
              <button id="pilotSortHours" class="px-3 py-2 rounded-lg border text-sm">Sort by Hours</button>
              <button id="pilotSortDollars" class="px-3 py-2 rounded-lg border text-sm">Sort by $</button>
              <button id="pilotSortActivities" class="px-3 py-2 rounded-lg border text-sm">Sort by Activities</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full" id="pilotTable"></table>
          </div>
          <p id="pilotEmpty" class="hidden text-center text-gray-500 text-sm mt-3">No activity logged for this range yet.</p>
        </div>
        <div class="surface-card rounded-xl p-4 shadow">
          <h2 class="text-lg font-bold mb-2">Weekly Trend</h2>
          <div style="height: 300px; position: relative;">
            <canvas id="pilotChart"></canvas>
          </div>
        </div>
      </section>

      <section id="view-handoff" class="view hidden space-y-4">
        <!-- Header with Stats -->
        <div class="surface-card rounded-xl p-6 shadow">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
            <div>
              <h2 class="text-2xl font-bold mb-1">Sales ‚Üí Ops Handoff</h2>
              <p class="text-sm text-gray-500">Track sold opportunities through the handoff pipeline</p>
            </div>
            <div class="flex gap-2">
              <button onclick="loadHandoffQueue()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                üîÑ Refresh
              </button>
            </div>
          </div>
          
          <!-- Quick Stats -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-3">
              <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Not Started</div>
              <div class="text-2xl font-bold text-red-600" id="handoffStatNotCreated">0</div>
            </div>
            <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-3">
              <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">In Draft</div>
              <div class="text-2xl font-bold text-yellow-600" id="handoffStatDraft">0</div>
            </div>
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3">
              <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">In Progress</div>
              <div class="text-2xl font-bold text-blue-600" id="handoffStatProgress">0</div>
            </div>
            <div class="bg-emerald-50 dark:bg-emerald-900/20 rounded-lg p-3">
              <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">Total Pipeline</div>
              <div class="text-2xl font-bold text-emerald-600" id="handoffStatTotal">0</div>
            </div>
          </div>
        </div>

        <!-- Search and Filters -->
        <div class="surface-card rounded-xl p-4 shadow">
          <div class="flex flex-col md:flex-row gap-3">
            <input type="text" id="handoffSearch" placeholder="Search by customer, address, or AE..." 
              class="flex-1 border rounded-lg px-4 py-2 text-sm" onkeyup="filterHandoffCards()">
            <select id="handoffStatusFilter" onchange="filterHandoffCards()" 
              class="border rounded-lg px-4 py-2 text-sm">
              <option value="">All Statuses</option>
              <option value="Not Created">Not Created</option>
              <option value="Draft">Draft</option>
              <option value="Packet Drafted">Packet Drafted</option>
              <option value="Assign Specialist">Assign Specialist</option>
              <option value="Awaiting Install">Awaiting Install</option>
            </select>
          </div>
        </div>

        <!-- Pipeline View -->
        <div class="surface-card rounded-xl p-6 shadow">
          <h3 class="text-lg font-bold mb-4">Handoff Pipeline</h3>
          
          <!-- Pipeline Stages -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="handoffPipeline">
            <!-- Stage 1: Not Created -->
            <div class="bg-red-50 dark:bg-red-900/10 rounded-lg p-4 border-2 border-red-200 dark:border-red-800">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-bold text-red-700 dark:text-red-400 flex items-center gap-2">
                  <span class="text-xl">üö®</span>
                  <span>Not Started</span>
                </h4>
                <span class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded" id="countNotCreated">0</span>
              </div>
              <div class="text-xs text-gray-600 dark:text-gray-400 mb-3">Start packets need to be created</div>
              <div class="space-y-2" id="handoffNotCreated"></div>
            </div>

            <!-- Stage 2: Draft / In Progress -->
            <div class="bg-yellow-50 dark:bg-yellow-900/10 rounded-lg p-4 border-2 border-yellow-200 dark:border-yellow-800">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-bold text-yellow-700 dark:text-yellow-400 flex items-center gap-2">
                  <span class="text-xl">üìù</span>
                  <span>In Progress</span>
                </h4>
                <span class="bg-yellow-600 text-white text-xs font-bold px-2 py-1 rounded" id="countInProgress">0</span>
              </div>
              <div class="text-xs text-gray-600 dark:text-gray-400 mb-3">Packets being prepared</div>
              <div class="space-y-2" id="handoffInProgress"></div>
            </div>

            <!-- Stage 3: Ready / Awaiting -->
            <div class="bg-emerald-50 dark:bg-emerald-900/10 rounded-lg p-4 border-2 border-emerald-200 dark:border-emerald-800">
              <div class="flex items-center justify-between mb-3">
                <h4 class="font-bold text-emerald-700 dark:text-emerald-400 flex items-center gap-2">
                  <span class="text-xl">‚úÖ</span>
                  <span>Ready / Awaiting</span>
                </h4>
                <span class="bg-emerald-600 text-white text-xs font-bold px-2 py-1 rounded" id="countReady">0</span>
              </div>
              <div class="text-xs text-gray-600 dark:text-gray-400 mb-3">Ready for next steps</div>
              <div class="space-y-2" id="handoffReady"></div>
            </div>
          </div>

          <!-- Empty State -->
          <div id="handoffEmpty" class="text-center py-8 hidden">
            <div class="text-4xl mb-2">üì¶</div>
            <p class="text-gray-500">No handoffs in the pipeline</p>
            <p class="text-sm text-gray-400 mt-1">Sold opportunities will appear here automatically</p>
          </div>
        </div>
      </section>

      <section id="view-admin" class="view hidden" style="height: calc(100vh - 200px);">
        <iframe id="adminDashboardFrame" src="admin-dashboard.html" style="width: 100%; height: 100%; border: none; border-radius: 1rem;"></iframe>
      </section>

      <section id="view-settings" class="view hidden space-y-4">
        <div class="surface-card rounded-xl p-4 shadow">
          <h2 class="text-lg font-bold mb-3">Brand Settings</h2>
          <p class="text-sm text-gray-500 mb-4">Select which brand preset should theme Branch360. Future iterations will persist this per branch.</p>
          <div id="brandPresetGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-4">
            <div class="flex flex-wrap gap-3">
              <button id="brandSaveBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">Save</button>
              <button id="brandSaveCloseBtn" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-semibold">Save & Close</button>
              <button id="brandCloseBtn" class="border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold">Close</button>
            </div>
            <p id="brandStatus" class="text-sm text-gray-500">Previewing default brand.</p>
          </div>
        </div>

        <div class="surface-card rounded-xl p-4 shadow">
          <h2 class="text-lg font-bold mb-4">Display Preferences</h2>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm font-medium text-gray-700">Compact View</label>
                <p class="text-xs text-gray-500">Reduce spacing and padding for a denser layout</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="settingCompactView" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm font-medium text-gray-700">Dark Mode</label>
                <p class="text-xs text-gray-500">Enable dark theme for the dashboard</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="settingDarkMode" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm font-medium text-gray-700">Show Dollar Values</label>
                <p class="text-xs text-gray-500">Display currency formatting in tables and cards</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="settingShowDollarValues" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <label for="settingRefreshInterval" class="text-sm font-medium text-gray-700 block mb-1">Data Refresh Interval</label>
                <p class="text-xs text-gray-500">How often to automatically refresh dashboard data</p>
              </div>
              <select id="settingRefreshInterval" class="ml-4 border rounded-lg px-3 py-2 text-sm min-w-[120px]">
                <option value="30">30 seconds</option>
                <option value="60" selected>1 minute</option>
                <option value="120">2 minutes</option>
                <option value="300">5 minutes</option>
                <option value="manual">Manual</option>
              </select>
            </div>
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <label for="settingItemsPerPage" class="text-sm font-medium text-gray-700 block mb-1">Items Per Page</label>
                <p class="text-xs text-gray-500">Number of rows to display in tables</p>
              </div>
              <select id="settingItemsPerPage" class="ml-4 border rounded-lg px-3 py-2 text-sm min-w-[120px]">
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>
        </div>

        <div class="surface-card rounded-xl p-4 shadow">
          <h2 class="text-lg font-bold mb-4">Notification Settings</h2>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm font-medium text-gray-700">Email Notifications</label>
                <p class="text-xs text-gray-500">Receive email alerts for important updates</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="settingEmailNotifications" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm font-medium text-gray-700">Browser Notifications</label>
                <p class="text-xs text-gray-500">Enable browser push notifications for real-time updates</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="settingBrowserNotifications" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm font-medium text-gray-700">Success Toast Messages</label>
                <p class="text-xs text-gray-500">Display temporary success notifications when actions complete</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="settingSuccessToasts" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
          </div>
        </div>

        <div class="surface-card rounded-xl p-4 shadow">
          <h2 class="text-lg font-bold mb-4">Export & Data Settings</h2>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <label for="settingExportFormat" class="text-sm font-medium text-gray-700 block mb-1">Default Export Format</label>
                <p class="text-xs text-gray-500">Preferred file format for data exports</p>
              </div>
              <select id="settingExportFormat" class="ml-4 border rounded-lg px-3 py-2 text-sm min-w-[120px]">
                <option value="csv" selected>CSV</option>
                <option value="excel">Excel</option>
                <option value="pdf">PDF</option>
                <option value="json">JSON</option>
              </select>
            </div>
            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm font-medium text-gray-700">Include Charts in Exports</label>
                <p class="text-xs text-gray-500">Export charts and visualizations with data</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="settingIncludeCharts" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <div>
                <label class="text-sm font-medium text-gray-700">Auto-save Form Drafts</label>
                <p class="text-xs text-gray-500">Automatically save form progress locally</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="settingAutoSaveDrafts" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer"></div>
              </label>
            </div>
          </div>
        </div>

        <div class="surface-card rounded-xl p-4 shadow">
          <h2 class="text-lg font-bold mb-4">Advanced Settings</h2>
          <div class="space-y-3">
            <button id="settingClearCache" class="w-full md:w-auto bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition">Clear Local Cache</button>
            <button id="settingResetDefaults" class="w-full md:w-auto bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition">Reset to Defaults</button>
            <button id="settingBackupSettings" class="w-full md:w-auto bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Backup Settings</button>
          </div>
        </div>

        <div class="surface-card rounded-xl p-4 shadow">
          <h2 class="text-lg font-bold mb-3">Environment</h2>
          <div class="flex items-center justify-between">
            <p class="text-sm text-gray-500">Current mode mirrors the Demo/Live toggle in the header.</p>
            <div class="text-sm text-gray-600">
              <span class="font-semibold">Version:</span> 1.0.0-pilot | <span class="font-semibold">Environment:</span> <span id="settingsEnvironmentTag">Demo</span>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <script>
    const ENVIRONMENT = new URLSearchParams(window.location.search).get('env') || 'Demo';
    window.Branch360Environment = ENVIRONMENT;
    document.getElementById('environmentTag').textContent = ENVIRONMENT + ' MODE';
    const defaultPricingConfig = { baseMonthly: 150, perSqft: 0.02, perLinear: 0.5, perAcre: 25, excluderMonthly: 35, excluderInitial: 50 };
    window.pricingConfig = Object.assign({}, defaultPricingConfig);
    window.brandPresetsCache = [];
    window.currentBrand = window.localStorage ? (window.localStorage.getItem('branch360Brand') || 'PRESTOX') : 'PRESTOX';
    window.pendingBrandSelection = window.currentBrand;
    window.hasAppliedInitialBrand = false;
    const SESSION_KEY = 'branch360DemoUserId';
    const ROLE_VIEWS = {
      ae: ['view-ae'],
      tech: ['view-tech'],
      ops: ['view-ops','view-tech','view-time','view-route','view-handoff'],
      branch: ['view-branch','view-ae','view-tech','view-ops','view-market','view-time','view-route','view-pilot','view-handoff','view-settings'],
      market: ['view-market','view-branch','view-time','view-route','view-pilot'],
      admin: ['view-branch','view-ae','view-tech','view-ops','view-market','view-time','view-route','view-pilot','view-handoff','view-settings','view-admin']
    };
    const DEMO_USERS = [
      { id: 'admin-me', name: 'Branch360 Admin', email: 'admin@branch360.demo', role: 'admin', roleLabel: 'Admin', branchId: 'BRN-001', branchName: 'Houston Branch', marketId: 'HOUSTON', defaultView: 'branch' },
      { id: 'ae-blair', name: 'Blair Sloat', email: 'blair.sloat@rentokil-terminix.com', role: 'ae', roleLabel: 'Account Executive', branchId: 'BRN-001', branchName: 'Houston Branch', marketId: 'HOUSTON', defaultView: 'ae' },
      { id: 'ae-demo2', name: 'Demo AE 2', email: 'demo.ae2@example.com', role: 'ae', roleLabel: 'Account Executive', branchId: 'BRN-001', branchName: 'Houston Branch', marketId: 'HOUSTON', defaultView: 'ae' },
      { id: 'tech-demo', name: 'Demo Tech', email: 'demo.tech@example.com', role: 'tech', roleLabel: 'Technician', branchId: 'BRN-001', branchName: 'Houston Branch', marketId: 'HOUSTON', defaultView: 'tech' },
      { id: 'ops-bruce', name: 'Bruce Hockless', email: 'bruce.hockless@prestox.com', role: 'ops', roleLabel: 'Operations Manager', branchId: 'BRN-001', branchName: 'Houston Branch', marketId: 'HOUSTON', defaultView: 'ops' },
      { id: 'branch-brad', name: 'Brad Hudson', email: 'brad.hudson@example.com', role: 'branch', roleLabel: 'Branch Manager', branchId: 'BRN-001', branchName: 'Houston Branch', marketId: 'HOUSTON', defaultView: 'branch' },
      { id: 'market-adam', name: 'Adam Grier', email: 'adam.grier@rentokil.com', role: 'market', roleLabel: 'Market Director', branchId: 'BRN-001', branchName: 'Houston Branch', marketId: 'HOUSTON', defaultView: 'market' }
    ];
    const DEMO_ACCOUNTS = ['Houston Tower', 'East River Storage', 'Bayou Coffee', 'Montrose Medical'];
    const DEMO_DASHBOARD_DATA = {
      branch: {
        branchCards: {
          starts: 18,
          revenueMonthly: 38500,
          revenueInitial: 92500,
          quotes: 34,
          conversion: 53.1,
          hoursSaved: 142,
          dollarsSaved: 7850
        },
        aeTable: [
          { name: 'Blair Sloat', aeId: 'AE-HTX-001', leads: 24, quotes: 13, starts: 7, conversion: 53.8, avgLeadToStart: 11.2, revenueMonthly: 15200, revenueInitial: 32000, hoursSaved: 38, dollarsSaved: 2100 },
          { name: 'Demo AE 2', aeId: 'AE-HTX-002', leads: 21, quotes: 11, starts: 6, conversion: 54.5, avgLeadToStart: 12.6, revenueMonthly: 13850, revenueInitial: 30500, hoursSaved: 32, dollarsSaved: 1750 },
          { name: 'Cody L.', aeId: 'AE-HTX-003', leads: 18, quotes: 10, starts: 5, conversion: 50, avgLeadToStart: 13.4, revenueMonthly: 9450, revenueInitial: 30000, hoursSaved: 25, dollarsSaved: 1400 }
        ],
        opsTable: [
          { manager: 'Bruce Hockless', starts: 10, estimatedHours: 38, overload: false },
          { manager: 'Ops Demo', starts: 8, estimatedHours: 44, overload: true }
        ]
      },
      market: {
        branchCards: {
          starts: 18,
          revenueMonthly: 38500,
          revenueInitial: 92500,
          conversion: 53.1,
          hoursSaved: 142,
          dollarsSaved: 7850
        },
        trend: [
          { week: 'Aug 5', starts: 3 },
          { week: 'Aug 12', starts: 4 },
          { week: 'Aug 19', starts: 5 },
          { week: 'Aug 26', starts: 3 },
          { week: 'Sep 2', starts: 3 }
        ],
        aeTable: [
          { name: 'Blair Sloat', starts: 7, conversion: 53.8, avgLeadToStart: 11.2, hoursSaved: 38, dollarsSaved: 2100 },
          { name: 'Demo AE 2', starts: 6, conversion: 54.5, avgLeadToStart: 12.6, hoursSaved: 32, dollarsSaved: 1750 },
          { name: 'Cody L.', starts: 5, conversion: 50, avgLeadToStart: 13.4, hoursSaved: 25, dollarsSaved: 1400 }
        ]
      },
      time: {
        totals: {
          hoursSaved: 142,
          hoursSavedAE: 78,
          hoursSavedOps: 52,
          hoursSavedBranch: 12,
          dollarsSaved: 7850
        },
        weekly: [
          { week: 'Week 1', hoursSaved: 18 },
          { week: 'Week 2', hoursSaved: 24 },
          { week: 'Week 3', hoursSaved: 29 },
          { week: 'Week 4', hoursSaved: 32 },
          { week: 'Week 5', hoursSaved: 39 }
        ],
        rows: [
          { userId: 'AE-HTX-001', name: 'Blair Sloat', role: 'AE', activities: 34, hoursSpent: 18, hoursSaved: 38, avgDurationMinutes: 4.2, dollarsSaved: 2100 },
          { userId: 'AE-HTX-002', name: 'Demo AE 2', role: 'AE', activities: 28, hoursSpent: 16, hoursSaved: 32, avgDurationMinutes: 4.1, dollarsSaved: 1750 },
          { userId: 'OPS-HTX-001', name: 'Bruce Hockless', role: 'Ops Manager', activities: 22, hoursSpent: 14, hoursSaved: 28, avgDurationMinutes: 6.5, dollarsSaved: 2200 },
          { userId: 'TECH-HTX-001', name: 'Demo Tech', role: 'Technician', activities: 18, hoursSpent: 12, hoursSaved: 22, avgDurationMinutes: 8.1, dollarsSaved: 1800 }
        ]
      },
      territories: {
        territories: [
          { id: 'TERR-DT', name: 'Downtown Houston', aeName: 'Blair Sloat', aeEmail: 'blair.sloat@rentokil-terminix.com', zipCount: 6, totalProspects: 12, zipCodes: ['77002','77003','77004'] },
          { id: 'TERR-MID', name: 'Midtown', aeName: 'Demo AE 2', aeEmail: 'demo.ae2@example.com', zipCount: 5, totalProspects: 9, zipCodes: ['77005','77006'] },
          { id: 'TERR-GALL', name: 'Galleria / Uptown', aeName: 'Cody L.', aeEmail: 'cody@example.com', zipCount: 7, totalProspects: 8, zipCodes: ['77024','77056','77057'] }
        ],
        prospects: [
          { territoryId: 'TERR-DT', customer: 'Bayou Coffee Roasters', address: '1818 Commerce St', status: 'Qualified', serviceType: 'GPC (Comm)', leadType: 'Inbound', zipCode: '77002', aeName: 'Blair Sloat' },
          { territoryId: 'TERR-DT', customer: 'East River Storage', address: '1500 Navigation Blvd', status: 'Contacted', serviceType: 'Rodent Control', leadType: 'Creative', zipCode: '77003', aeName: 'Blair Sloat' },
          { territoryId: 'TERR-MID', customer: 'Montrose Medical Group', address: '450 Westheimer Rd', status: 'New', serviceType: 'Fly / ILT', leadType: 'Inbound', zipCode: '77006', aeName: 'Demo AE 2' },
          { territoryId: 'TERR-GALL', customer: 'Galleria Offices', address: '5085 Westheimer Rd', status: 'Qualified', serviceType: 'GPC (Comm)', leadType: 'TAP', zipCode: '77056', aeName: 'Cody L.' }
        ]
      },
      handoff: [
        { trackerEntryID: 'ENTRY-001', customer: 'Texas Thrift Midtown', address: '1234 Westheimer Rd', aeName: 'Blair Sloat', soldDate: new Date().toISOString(), packetStatus: 'Not Created' },
        { trackerEntryID: 'ENTRY-002', customer: 'Montrose Medical', address: '450 Westheimer Rd', aeName: 'Demo AE 2', soldDate: new Date(Date.now() - 86400000 * 2).toISOString(), packetStatus: 'Not Created' },
        { trackerEntryID: 'ENTRY-003', customer: 'Downtown Storage Co', address: '1818 Commerce St', aeName: 'Blair Sloat', soldDate: new Date(Date.now() - 86400000 * 5).toISOString(), packetStatus: 'Draft' },
        { trackerEntryID: 'ENTRY-004', customer: 'Bayou Coffee Roasters', address: '2200 San Jacinto', aeName: 'Cody L.', soldDate: new Date(Date.now() - 86400000 * 4).toISOString(), packetStatus: 'Packet Drafted' },
        { trackerEntryID: 'ENTRY-005', customer: 'Galleria Offices', address: '5085 Westheimer Rd', aeName: 'Demo AE 2', soldDate: new Date(Date.now() - 86400000 * 8).toISOString(), packetStatus: 'Assign Specialist' },
        { trackerEntryID: 'ENTRY-006', customer: 'Heights Medical Center', address: '890 Heights Blvd', aeName: 'Blair Sloat', soldDate: new Date(Date.now() - 86400000 * 10).toISOString(), packetStatus: 'Awaiting Install' }
      ]
    };
    let currentRole = null;
    let currentDemoUser = null;
    let demoLoopHandle = null;
    const QUOTE_TRACKER_STORAGE_KEY = 'branch360QuoteTracker';
    const PILOT_TEAM_TARGETS = {
      aes: 4,
      opsManagers: 5,
      technicians: 25,
      branchManagers: 1
    };
    const REGION_BRANCH_COUNTS = [
      { region: 'Region 16', branches: 18 },
      { region: 'Region 17', branches: 12 },
      { region: 'Region 18', branches: 13 },
      { region: 'Region 19', branches: 14 },
      { region: 'Region 22', branches: 16 },
      { region: 'Region 23', branches: 12 },
      { region: 'Region 24', branches: 13 },
      { region: 'Region 50', branches: 13 },
      { region: 'Region 52', branches: 9 },
      { region: 'Region 54', branches: 13 },
      { region: 'Region 75', branches: 8 }
    ];

    const navButtons = document.querySelectorAll('.nav-button');
    const submenuButtons = document.querySelectorAll('.submenu-button');
    const demoUserSelect = document.getElementById('demoUserSelect');
    const personaLabel = document.getElementById('personaLabel');
    const demoUserSummary = document.getElementById('demoUserSummary');
    navButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (btn.classList.contains('hidden')) return;
        if (btn.dataset.view) {
          showView(btn.dataset.view);
        }
      });
    });
    const aeSubmenu = document.getElementById('aeSubmenu');
    const submenuStartPacket = document.getElementById('submenuStartPacket');
    if (submenuStartPacket) {
      submenuStartPacket.addEventListener('click', function() {
        if (!currentRole || currentRole === 'ae' || currentRole === 'branch' || currentRole === 'admin') {
          openSalesforceImport();
        }
      });
    }
    const submenuRouteProspects = document.getElementById('submenuRouteProspects');
    if (submenuRouteProspects) {
      submenuRouteProspects.addEventListener('click', function() {
        showView('route');
      });
    }

    function roleCanView(view) {
      if (!currentRole) return true;
      // Admin view is a separate page, not a regular view - always allow if user is admin
      if (view === 'admin' && currentRole === 'admin') return true;
      const allowed = ROLE_VIEWS[currentRole] || [];
      return allowed.includes('view-' + view);
    }
    
    function getDefaultViewForRole(role) {
      const allowed = ROLE_VIEWS[role] || ROLE_VIEWS.branch;
      if (currentDemoUser && currentDemoUser.defaultView) {
        const preferredId = 'view-' + currentDemoUser.defaultView;
        if (allowed.includes(preferredId)) {
          return currentDemoUser.defaultView;
        }
      }
      return allowed.length ? allowed[0].replace('view-', '') : 'branch';
    }

    function showView(view) {
      // Admin dashboard should be shown inline, not navigate away
      if (view === 'admin') {
        // Show admin view inline using iframe
        activeView = view;
        document.querySelectorAll('.view').forEach(section => section.classList.add('hidden'));
        const adminView = document.getElementById('view-admin');
        if (adminView) {
          adminView.classList.remove('hidden');
        } else {
          console.error('Admin view section not found');
        }
        navButtons.forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.nav-button[data-view="${view}"]`)?.classList.add('active');
        return;
      }
      
      // Ensure we're on the main dashboard page, not admin-dashboard
      const currentPath = window.location.pathname;
      if (currentPath.includes('admin-dashboard.html')) {
        // Redirect back to main dashboard
        const dashboardPath = currentPath.replace(/admin-dashboard\.html$/, 'dashboard.html');
        window.location.href = dashboardPath + '?view=' + view;
        return;
      }
      
      if (currentRole && !roleCanView(view)) {
        const fallback = getDefaultViewForRole(currentRole);
        if (fallback && fallback !== view) {
          showView(fallback);
        }
        return;
      }
      
      activeView = view;
      document.querySelectorAll('.view').forEach(section => section.classList.add('hidden'));
      const targetView = document.getElementById('view-' + view);
      if (!targetView) {
        console.error('View not found: view-' + view);
        return;
      }
      targetView.classList.remove('hidden');
      navButtons.forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.nav-button[data-view="${view}"]`)?.classList.add('active');
      if (aeSubmenu) {
        if (view === 'ae') {
          aeSubmenu.classList.remove('hidden');
        } else {
          aeSubmenu.classList.add('hidden');
        }
      }
      if (view === 'pilot') {
        loadPilotReport();
      }
      if (view === 'route') {
        loadRouteView();
      }
      if (view === 'handoff') {
        loadHandoffQueue();
      }
      if (view === 'settings') {
        loadSettingsView();
      }
    }

    function openStartPacketGenerator() {
      showView('ae');
      const frame = document.querySelector('#view-ae iframe');
      if (!frame) return;
      function sendMessage() {
        if (frame.contentWindow) {
          frame.contentWindow.postMessage({ type: 'OPEN_START_PACKET' }, '*');
        }
      }
      if (frame.contentDocument && frame.contentDocument.readyState === 'complete') {
        sendMessage();
      } else {
        frame.addEventListener('load', function handleLoad() {
          sendMessage();
        }, { once: true });
      }
    }

    function openSalesforceImport() {
      showView('ae');
      const frame = document.querySelector('#view-ae iframe');
      if (!frame) return;
      function sendMessage() {
        if (frame.contentWindow) {
          frame.contentWindow.postMessage({ type: 'OPEN_SALESFORCE_IMPORT' }, '*');
        }
      }
      if (frame.contentDocument && frame.contentDocument.readyState === 'complete') {
        sendMessage();
      } else {
        frame.addEventListener('load', function handleLoad() {
          sendMessage();
        }, { once: true });
      }
    }

    function applyRolePermissions(role) {
      currentRole = role;
      console.log('Applying role permissions for role:', role);
      const allowedViews = ROLE_VIEWS[role] || ROLE_VIEWS.branch;
      const allowedViewIds = new Set(allowedViews);
      navButtons.forEach(btn => {
        const roleList = (btn.dataset.roles || 'branch').split(',').map(r => r.trim());
        // Allow admin role access to all buttons, or if role is in the list
        const allowed = role === 'admin' || roleList.includes(role) || roleList.includes('admin');
        btn.classList.toggle('hidden', !allowed);
        // Debug logging for admin button
        if (btn.dataset.view === 'admin') {
          console.log('Admin button visibility:', { role, roleList, allowed, button: btn });
        }
      });
      submenuButtons.forEach(btn => {
        const roleList = (btn.dataset.roles || 'branch').split(',').map(r => r.trim());
        // Allow admin role access to all buttons, or if role is in the list
        const allowed = role === 'admin' || roleList.includes(role) || roleList.includes('admin');
        btn.classList.toggle('hidden', !allowed);
      });
      document.querySelectorAll('.view').forEach(section => {
        if (!allowedViewIds.has(section.id)) {
          section.classList.add('hidden');
        }
      });
      
      // Check URL parameter for view first
      const urlParams = new URLSearchParams(window.location.search);
      const urlView = urlParams.get('view');
      if (urlView && allowedViewIds.has('view-' + urlView)) {
        activeView = urlView;
        showView(urlView);
      } else {
        // Check if current view is allowed
        const currentViewAllowed = allowedViewIds.has('view-' + activeView);
        if (!currentViewAllowed) {
          const fallback = getDefaultViewForRole(role);
          showView(fallback);
        } else {
          // Make sure current view is shown
          showView(activeView);
        }
      }
      startDemoLoop();
    }

    function populateDemoUserSelect() {
      if (!demoUserSelect) return;
      demoUserSelect.innerHTML = DEMO_USERS.map(function(user) {
        return `<option value="${user.id}">${user.name} ‚Ä¢ ${user.roleLabel}</option>`;
      }).join('');
    }

    function refreshPersonaFrames() {
      const frames = document.querySelectorAll('.persona-frame');
      frames.forEach(function(frame) {
        if (!frame.dataset.base) {
          frame.dataset.base = frame.getAttribute('src') || '';
        }
        const base = frame.dataset.base || '';
        if (!base) return;
        const url = new URL(base, window.location.href);
        if (currentDemoUser) {
          url.searchParams.set('demoUser', currentDemoUser.id);
          url.searchParams.set('branchId', currentDemoUser.branchId || '');
        }
        url.searchParams.set('ts', Date.now());
        frame.src = url.pathname + url.search;
      });
    }

    function applyDemoUser(userId) {
      const user = DEMO_USERS.find(u => u.id === userId) || DEMO_USERS[0];
      if (!user) return;
      currentDemoUser = user;
      currentRole = user.role;
      if (window.localStorage) {
        localStorage.setItem(SESSION_KEY, user.id);
        localStorage.setItem('branch360CurrentUser', JSON.stringify(user));
      }
      window.Branch360CurrentUser = user;
      if (demoUserSelect) {
        demoUserSelect.value = user.id;
      }
      if (personaLabel) {
        personaLabel.textContent = `${user.name} ‚Ä¢ ${user.roleLabel}`;
      }
      if (demoUserSummary) {
        demoUserSummary.textContent = user.email;
      }
      const branchSelect = document.getElementById('branchSelect');
      if (branchSelect && user.branchId) {
        branchSelect.value = user.branchId;
      }
      refreshPersonaFrames();
      applyRolePermissions(user.role);
    }

    function initializeDemoUser() {
      // First, try to get the real logged-in user
      const runner = window && window.google && window.google.script && window.google.script.run;
      if (runner && runner.getCurrentUser) {
        runner
          .withSuccessHandler(function(user) {
            if (user && (user.role || user.Role)) {
              // Map backend role to frontend role format
              const roleMap = {
                'Administrator': 'admin',
                'Account Executive': 'ae',
                'Technician': 'tech',
                'Operations Manager': 'ops',
                'Branch Manager': 'branch',
                'Regional Director': 'region',
                'Market Director': 'market',
                'Executive': 'executive'
              };
              // Check both user.role and user.Role (case variations)
              const backendRole = user.role || user.Role || '';
              const frontendRole = roleMap[backendRole] || backendRole.toLowerCase();
              
              console.log('User role mapping:', { backendRole, frontendRole, user });
              
              // Apply real user's role
              applyRolePermissions(frontendRole);
              
              // Still populate demo select for switching personas
              populateDemoUserSelect();
              if (demoUserSelect) {
                demoUserSelect.addEventListener('change', function(e) {
                  applyDemoUser(e.target.value);
                });
              }
            } else {
              console.warn('No user role found:', user);
              // No real user, use demo mode
              initializeDemoMode();
            }
          })
          .withFailureHandler(function(error) {
            console.log('No real user found, using demo mode:', error);
            // Fall back to demo mode if getCurrentUser fails
            initializeDemoMode();
          })
          .getCurrentUser();
      } else {
        // No Apps Script runner, use demo mode
        initializeDemoMode();
      }
    }
    
    function initializeDemoMode() {
      populateDemoUserSelect();
      let storedId = null;
      if (window.localStorage) {
        storedId = localStorage.getItem(SESSION_KEY);
      }
      // Default to admin user when running locally (no Apps Script)
      const adminUser = DEMO_USERS.find(u => u.role === 'admin') || DEMO_USERS.find(u => u.id === 'admin-me');
      const defaultUser = DEMO_USERS.find(u => u.id === storedId) || adminUser || DEMO_USERS[0];
      applyDemoUser(defaultUser.id);
      if (demoUserSelect) {
        demoUserSelect.addEventListener('change', function(e) {
          applyDemoUser(e.target.value);
        });
      }
    }

    function getFilters() {
      const branchId = document.getElementById('branchSelect').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const aeId = document.getElementById('aeFilter').value;
      const serviceType = document.getElementById('serviceFilter').value;
      return { branchId, startDate, endDate, aeId, serviceType };
    }

    function callServer(method, handler, fallbackData) {
      const runner = window && window.google && window.google.script && window.google.script.run;
      if (runner && typeof runner[method] === 'function') {
        runner
          .withSuccessHandler(handler)
          .withFailureHandler(err => {
            console.error('Dashboard error', err);
          })[method](getFilters());
      } else if (fallbackData) {
        handler(fallbackData);
      }
    }

    function callServerCustom(method, payload, handler, fallbackData) {
      const runner = window && window.google && window.google.script && window.google.script.run;
      if (runner && typeof runner[method] === 'function') {
        runner
          .withSuccessHandler(handler)
          .withFailureHandler(err => {
            console.error('Dashboard error for', method, err);
            // Use fallback data if available, otherwise call handler with error object
            if (fallbackData) {
              handler(fallbackData);
            } else {
              handler({ success: false, message: err && err.message ? err.message : 'Unknown error', error: err });
            }
          })[method](payload);
      } else if (fallbackData) {
        handler(fallbackData);
      } else {
        // No runner and no fallback - call handler with empty data
        handler({ success: false, territories: [], stats: { totalAEs: 0, totalZipCodes: 0, averageCoverage: 0, totalTerritories: 0 } });
      }
    }

    function loadBranchKPIs() {
      callServer('getBranchManagerKPIs', renderBranchKPIs, mockBranchKpis());
      // Also load branch manager dashboard data for today's summary, teams, pipeline, alerts
      callServerCustom('getBranchManagerDashboard', null, renderBranchDashboardData, {
        user: { name: 'Demo Branch Manager', branchID: 'BRN-001' },
        todaySummary: { sales: { tap: 0, appointments: 0, quotes: 0, revenue: 0 }, operations: { missedStops: 0, backlog: 0 } },
        salesTeam: [],
        opsTeam: [],
        pipeline: { proposal: 0, negotiation: 0, sold: 0 },
        alerts: [],
        weekTrends: { thisWeek: 0, lastWeek: 0, change: 0 }
      });
    }

    function renderBranchDashboardData(data) {
      // Populate today's summary
      if (data.todaySummary) {
        const sales = data.todaySummary.sales || {};
        const ops = data.todaySummary.operations || {};
        const tapEl = document.getElementById('branchTodayTAP');
        const apptsEl = document.getElementById('branchTodayAppts');
        const quotesEl = document.getElementById('branchTodayQuotes');
        const revenueEl = document.getElementById('branchTodayRevenue');
        const missedStopsEl = document.getElementById('branchTodayMissedStops');
        const backlogEl = document.getElementById('branchTodayBacklog');
        
        if (tapEl) tapEl.textContent = sales.tap || 0;
        if (apptsEl) apptsEl.textContent = sales.appointments || 0;
        if (quotesEl) quotesEl.textContent = sales.quotes || 0;
        if (revenueEl) revenueEl.textContent = (sales.revenue || 0).toLocaleString();
        if (missedStopsEl) missedStopsEl.textContent = ops.missedStops || 0;
        if (backlogEl) backlogEl.textContent = ops.backlog || 0;
      }

      // Populate pipeline
      if (data.pipeline) {
        const proposalEl = document.getElementById('branchPipelineProposal');
        const negotiationEl = document.getElementById('branchPipelineNegotiation');
        const soldEl = document.getElementById('branchPipelineSold');
        
        if (proposalEl) proposalEl.textContent = (data.pipeline.proposal || 0).toLocaleString();
        if (negotiationEl) negotiationEl.textContent = (data.pipeline.negotiation || 0).toLocaleString();
        if (soldEl) soldEl.textContent = (data.pipeline.sold || 0).toLocaleString();
      }

      // Render teams and alerts
      renderBranchSalesLeaderboard(data.salesTeam || []);
      renderBranchOpsTeam(data.opsTeam || []);
      renderBranchAlerts(data.alerts || []);
    }

    function renderBranchKPIs(data) {
      const cards = document.getElementById('branchCards');
      const cardItems = [
        { label: 'New Starts', value: data.branchCards.starts },
        { label: 'Monthly Revenue', value: formatCurrency(data.branchCards.revenueMonthly) },
        { label: 'Initial Revenue', value: formatCurrency(data.branchCards.revenueInitial) },
        { label: 'Quote ‚Üí Start %', value: data.branchCards.conversion.toFixed(1) + '%' },
        { label: 'Hours Saved', value: formatHours(data.branchCards.hoursSaved) },
        { label: 'Time Saved $', value: formatCurrency(data.branchCards.dollarsSaved) }
      ];
      cards.innerHTML = cardItems.map(card => cardTemplate(card.label, card.value)).join('');

      const aeTable = document.getElementById('branchAeTable');
      if (aeTable) {
        aeTable.innerHTML = tableTemplate([
          'AE', 'Leads', 'Quotes', 'New Starts', 'Conversion %', 'Avg Days Lead ‚Üí Start', 'Monthly Revenue', 'Initial Revenue', 'Hours Saved', '$ Value'
        ], data.aeTable.map(row => [
          row.name,
          row.leads,
          row.quotes,
          row.starts,
          row.conversion.toFixed(1) + '%',
          row.avgLeadToStart.toFixed(1),
          formatCurrency(row.revenueMonthly),
          formatCurrency(row.revenueInitial),
          formatHours(row.hoursSaved),
          formatCurrency(row.dollarsSaved)
        ]));
      }

      const opsTable = document.getElementById('branchOpsTable');
      if (opsTable) {
        opsTable.innerHTML = tableTemplate(['Ops Manager', 'New Starts', 'Est. Hours', 'Overload'], data.opsTable.map(row => [
          row.manager,
          row.starts,
          row.estimatedHours.toFixed(1),
          row.overload ? '‚ö†Ô∏è' : 'OK'
        ]));
      }

      const aeFilter = document.getElementById('aeFilter');
      if (aeFilter) {
        const existing = new Set(Array.from(aeFilter.options).map(o => o.value));
        data.aeTable.forEach(row => {
          if (!existing.has(row.aeId)) {
            const opt = document.createElement('option');
            opt.value = row.aeId;
            opt.textContent = row.name;
            aeFilter.appendChild(opt);
          }
        });
      }

      latestBranchKPIs = data;
      loadOpsTimeline();
    }

    function loadMarketKPIs() {
      callServer('getMarketDirectorKPIs', renderMarketKPIs, mockMarketKpis());
    }

    let trendChart;
    function renderMarketKPIs(data) {
      const cards = document.getElementById('marketCards');
      const cardItems = [
        { label: 'Starts', value: data.branchCards.starts },
        { label: 'Monthly Revenue', value: formatCurrency(data.branchCards.revenueMonthly) },
        { label: 'Initial Revenue', value: formatCurrency(data.branchCards.revenueInitial) },
        { label: 'Conversion %', value: data.branchCards.conversion.toFixed(1) + '%' },
        { label: 'Hours Saved', value: formatHours(data.branchCards.hoursSaved) },
        { label: 'Time Saved $', value: formatCurrency(data.branchCards.dollarsSaved) }
      ];
      cards.innerHTML = cardItems.map(card => cardTemplate(card.label, card.value)).join('');

      const ctx = document.getElementById('trendChart').getContext('2d');
      if (trendChart) trendChart.destroy();
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.trend.map(point => point.week),
          datasets: [{ label: 'New Starts', data: data.trend.map(point => point.starts), borderColor: '#2563EB', tension: 0.2 }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });

      const aeTable = document.getElementById('marketAeTable');
      aeTable.innerHTML = tableTemplate(['AE', 'Starts', 'Conversion %', 'Avg Days Lead ‚Üí Start', 'Hours Saved', '$ Value'], data.aeTable.map(row => [
        row.name,
        row.starts,
        row.conversion.toFixed(1) + '%',
        row.avgLeadToStart.toFixed(1),
        formatHours(row.hoursSaved),
        formatCurrency(row.dollarsSaved)
      ]));
    }

    let timeChart;
    function loadTimeSaved() {
      callServer('getActivityAnalytics', renderTimeSaved, mockTimeAnalytics());
    }

    function renderTimeSaved(data) {
      const cards = document.getElementById('timeCards');
      const cardItems = [
        { label: 'Total Hours Saved', value: data.totals.hoursSaved.toFixed(1) },
        { label: 'AE Hours Saved', value: data.totals.hoursSavedAE.toFixed(1) },
        { label: 'Ops Hours Saved', value: data.totals.hoursSavedOps.toFixed(1) },
        { label: 'Dollars Saved', value: formatCurrency(data.totals.dollarsSaved) }
      ];
      cards.innerHTML = cardItems.map(card => cardTemplate(card.label, card.value)).join('');

      const ctx = document.getElementById('timeChart').getContext('2d');
      if (timeChart) timeChart.destroy();
      timeChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.weekly.map(point => point.week),
          datasets: [{ label: 'Hours Saved', data: data.weekly.map(point => point.hoursSaved), backgroundColor: '#10B981' }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });

      const table = document.getElementById('timeTable');
      table.innerHTML = tableTemplate(['User', 'Role', 'Activities', 'Hours Spent', 'Hours Saved', 'Avg Minutes', 'Dollars Saved'], data.rows.map(row => [
        row.name,
        row.role,
        row.activities,
        row.hoursSpent.toFixed(1),
        row.hoursSaved.toFixed(1),
        row.avgDurationMinutes.toFixed(1),
        formatCurrency(row.dollarsSaved)
      ]));
      latestTimeAnalytics = data;
    }

    function loadOpsTimeline() {
      callServer('getOpsTimeline', renderOpsTimeline, []);
    }

    function renderOpsTimeline(events) {
      const container = document.getElementById('opsTimeline');
      if (!container) return;
      if (!events || events.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">No lifecycle events yet.</p>';
        return;
      }
      container.innerHTML = events.slice(-15).map(event => `
        <div class="flex items-center gap-3 border-b pb-2">
          <div class="w-28 text-xs text-gray-500">${event.date ? new Date(event.date).toLocaleDateString() : '--'}</div>
          <div class="flex-1">
            <p class="text-sm font-semibold">${event.label}</p>
            <p class="text-xs text-gray-500">${event.account || ''} ‚Ä¢ ${event.status || ''}</p>
          </div>
        </div>`).join('');
    }

    function loadRouteView(force) {
      if (territoryLoaded && !force) return;
      const payload = { branchId: document.getElementById('branchSelect').value };
      callServerCustom('getTerritoryProspects', payload, renderRouteProspects, mockTerritoryProspects());
    }

    function renderRouteProspects(data) {
      territoryDataCache = data.territories || [];
      prospectDataCache = data.prospects || [];
      if (!selectedTerritory && territoryDataCache.length > 0) {
        selectedTerritory = territoryDataCache[0];
      } else if (selectedTerritory) {
        const match = territoryDataCache.find(t => t.id === selectedTerritory.id);
        selectedTerritory = match || territoryDataCache[0];
      }
      renderTerritoryList();
      renderProspects();
      territoryLoaded = true;
    }

    function renderTerritoryList() {
      const container = document.getElementById('territoryList');
      if (!territoryDataCache.length) {
        container.innerHTML = '<p class="text-gray-500">No territories configured.</p>';
        document.getElementById('prospectSummary').textContent = 'No territories available.';
        document.getElementById('territoryHeatmap').innerHTML = '';
        return;
      }
      container.innerHTML = `
        <h4 class="text-sm font-semibold text-gray-700 mb-2">Territories</h4>
        ${territoryDataCache.map(territory => `
        <div class="border rounded-lg p-3 mb-3 cursor-pointer transition-all ${selectedTerritory && selectedTerritory.id === territory.id ? 'border-blue-500 bg-blue-50 shadow-md' : 'hover:bg-gray-50 hover:border-gray-300'}" onclick="selectTerritory('${territory.id}')" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();selectTerritory('${territory.id}')}">
          <p class="font-semibold">${territory.name}</p>
          <p class="text-xs text-gray-500">AE: ${territory.aeName}</p>
          <p class="text-xs text-gray-500">ZIPs: ${territory.zipCount} | Prospects: ${territory.totalProspects}</p>
        </div>
      `).join('')}`;
      renderTerritoryHeatmap();
    }

    function renderTerritoryHeatmap() {
      const container = document.getElementById('territoryHeatmap');
      if (!container) return;
      if (!territoryDataCache.length) {
        container.innerHTML = '';
        return;
      }
      const maxProspects = Math.max(...territoryDataCache.map(t => t.totalProspects || 0), 1);
      container.innerHTML = territoryDataCache.map(function(territory) {
        const ratio = (territory.totalProspects || 0) / maxProspects;
        const intensity = Math.min(100, Math.floor(ratio * 100));
        return `<div class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded" onclick="selectTerritory('${territory.id}')" title="Click to view ${territory.name}">
          <div class="w-24 text-xs text-gray-600">${territory.name}</div>
          <div class="flex-1 h-2 bg-gray-200 rounded-full mx-3">
            <div class="h-2 rounded-full" style="width:${intensity}%;background:${intensity > 66 ? '#16a34a' : intensity > 33 ? '#f59e0b' : '#ef4444'}"></div>
          </div>
          <div class="text-xs text-gray-500">${territory.totalProspects || 0}</div>
        </div>`;
      }).join('');
    }

    window.selectTerritory = function(id) {
      selectedTerritory = territoryDataCache.find(t => t.id === id) || selectedTerritory;
      renderTerritoryList();
      renderProspects();
    };

    function renderProspects() {
      const table = document.getElementById('prospectTable');
      const empty = document.getElementById('prospectEmpty');
      const summary = document.getElementById('prospectSummary');
      if (!selectedTerritory) {
        table.innerHTML = '';
        empty.classList.remove('hidden');
        summary.textContent = 'Select a territory to view prospects.';
        return;
      }
      const zips = selectedTerritory.zipCodes || [];
      const rawProspects = Array.isArray(prospectDataCache) ? prospectDataCache : [];
      const searchTermRaw = typeof prospectSearchTerm === 'string' || typeof prospectSearchTerm === 'number'
        ? String(prospectSearchTerm)
        : '';
      const searchTerm = searchTermRaw.toLowerCase();
      prospectsFiltered = rawProspects.filter(function(prospect) {
        if (zips.length && zips.indexOf(prospect.zipCode) === -1) return false;
        if (searchTerm) {
          const term = searchTerm;
          return (
            (prospect.customer || '').toLowerCase().includes(term) ||
            (prospect.address || '').toLowerCase().includes(term) ||
            (prospect.serviceType || '').toLowerCase().includes(term)
          );
        }
        return true;
      });
      summary.textContent = `${prospectsFiltered.length} prospects in ${selectedTerritory.name}`;
      if (!prospectsFiltered.length) {
        table.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');
      const headers = ['Customer', 'Address', 'Status', 'Service', 'Zip'];
      const rows = prospectsFiltered.map(function(prospect) {
        return [
          `<div>
            <p class="font-semibold text-gray-800">${prospect.customer || ''}</p>
            <p class="text-xs text-gray-500">${prospect.aeName || ''}</p>
          </div>`,
          `<span class="text-sm text-gray-600">${prospect.address || ''}</span>`,
          `<span class="text-sm">${prospect.status || ''}</span>`,
          `<span class="text-sm">${prospect.serviceType || ''}</span>`,
          `<span class="text-sm">${prospect.zipCode || ''}</span>`
        ];
      });
      table.innerHTML = `<table class="min-w-full">${tableTemplate(headers, rows)}</table>`;
      // Add click handlers to prospect rows
      const prospectRows = table.querySelectorAll('tbody tr');
      prospectsFiltered.forEach(function(prospect, index) {
        if (prospectRows[index]) {
          prospectRows[index].classList.add('cursor-pointer', 'hover:bg-blue-50');
          prospectRows[index].style.transition = 'background-color 0.2s';
          prospectRows[index].addEventListener('click', function() {
            viewProspectDetails(prospect);
          });
        }
      });
    }
    
    function viewProspectDetails(prospect) {
      const details = [
        `Customer: ${prospect.customer || 'N/A'}`,
        `Address: ${prospect.address || 'N/A'}`,
        `Status: ${prospect.status || 'N/A'}`,
        `Service: ${prospect.serviceType || 'N/A'}`,
        `Zip: ${prospect.zipCode || 'N/A'}`,
        `AE: ${prospect.aeName || 'N/A'}`,
        `Lead Type: ${prospect.leadType || 'N/A'}`
      ].join('\n');
      alert('Prospect Details:\n\n' + details);
    }

    const prospectInput = document.getElementById('prospectSearchInput');
    if (prospectInput) {
      prospectInput.addEventListener('input', function(e) {
        prospectSearchTerm = e.target.value ? e.target.value.trim() : '';
        renderProspects();
      });
    }

    ['pricingSqft','pricingLinear','pricingAcres'].forEach(id => {
      document.getElementById(id).addEventListener('input', updatePricingHelper);
    });
    document.getElementById('pricingExcluder').addEventListener('input', updatePricingHelper);
    document.getElementById('googleEarthBtn').addEventListener('click', function() {
      alert('Google Earth integration will estimate sqft/linear feet automatically in a future iteration.');
    });

    function updatePricingHelper() {
      const sqft = Number(document.getElementById('pricingSqft').value) || 0;
      const linear = Number(document.getElementById('pricingLinear').value) || 0;
      const acres = Number(document.getElementById('pricingAcres').value) || 0;
      const excluder = Number(document.getElementById('pricingExcluder').value) || 0;
      const config = window.pricingConfig || defaultPricingConfig;
      const base = config.baseMonthly || 0;
      const sqftCharge = sqft * (config.perSqft || 0);
      const linearCharge = linear * (config.perLinear || 0);
      const acresCharge = acres * (config.perAcre || 0);
      const excluderMonthly = excluder * (config.excluderMonthly || 0);
      const excluderInitial = excluder * (config.excluderInitial || 0);
      const monthly = base + sqftCharge + linearCharge + acresCharge + excluderMonthly;
      const initial = monthly * 2 + excluderInitial;
      document.getElementById('pricingMonthly').textContent = formatCurrency(monthly);
      document.getElementById('pricingInitial').textContent = formatCurrency(initial);
      document.getElementById('pricingAnnual').textContent = formatCurrency(monthly * 12);
      const breakdown = document.getElementById('pricingBreakdown');
      if (breakdown) {
        const items = [
          { label: 'Base Coverage', value: base },
          { label: 'Sq Ft Factor', value: sqftCharge },
          { label: 'Linear Footage', value: linearCharge },
          { label: 'Acreage uplift', value: acresCharge },
          { label: 'Excluder Monthly', value: excluderMonthly },
          { label: 'Excluder Initial', value: excluderInitial }
        ];
        breakdown.innerHTML = items.map(item => `<div class="flex justify-between"><span>${item.label}</span><span class="font-semibold">${formatCurrency(item.value)}</span></div>`).join('');
      }
    }

    function mockTerritoryProspects() {
      return cloneDemoData(DEMO_DASHBOARD_DATA.territories);
    }

    function loadHandoffQueue() {
      callServer('getSalesOpsHandoffQueue', renderHandoffQueue, mockHandoffQueue());
    }

    function renderHandoffQueue(rows) {
      // Store the raw data for filtering
      window.handoffQueueData = rows || [];
      
      const empty = document.getElementById('handoffEmpty');
      if (!rows || rows.length === 0) {
        empty.classList.remove('hidden');
        document.getElementById('handoffPipeline').classList.add('hidden');
        updateHandoffStats([], [], []);
        return;
      }
      
      empty.classList.add('hidden');
      document.getElementById('handoffPipeline').classList.remove('hidden');
      
      // Categorize items by stage
      const notCreated = [];
      const inProgress = [];
      const ready = [];
      
      rows.forEach(function(row) {
        const status = row.packetStatus || 'Not Created';
        if (status === 'Not Created' || status === 'Pending') {
          notCreated.push(row);
        } else if (status === 'Draft' || status === 'Packet Drafted') {
          inProgress.push(row);
        } else {
          ready.push(row);
        }
      });
      
      // Render each column
      renderHandoffColumn('handoffNotCreated', notCreated, 'notCreated');
      renderHandoffColumn('handoffInProgress', inProgress, 'inProgress');
      renderHandoffColumn('handoffReady', ready, 'ready');
      
      // Update stats and counts
      updateHandoffStats(notCreated, inProgress, ready);
    }
    
    function renderHandoffColumn(containerId, items, stage) {
      const container = document.getElementById(containerId);
      if (!items || items.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400 text-xs py-4">No items</div>';
        return;
      }
      
      container.innerHTML = items.map(function(row) {
        const recordID = (row.trackerEntryID || row.recordID || row.id || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const customer = (row.customer || 'N/A').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const address = (row.address || 'N/A').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const aeName = row.aeName || 'N/A';
        const soldDate = row.soldDate ? new Date(row.soldDate) : null;
        const daysAgo = soldDate ? Math.floor((Date.now() - soldDate.getTime()) / (1000 * 60 * 60 * 24)) : 0;
        const urgency = daysAgo > 7 ? 'high' : daysAgo > 3 ? 'medium' : 'low';
        const urgencyColor = urgency === 'high' ? 'red' : urgency === 'medium' ? 'yellow' : 'gray';
        const urgencyIcon = urgency === 'high' ? 'üî•' : urgency === 'medium' ? '‚ö†Ô∏è' : 'üïê';
        
        let actionButton = '';
        if (stage === 'notCreated') {
          actionButton = `
            <button onclick="createStartPacketFromHandoff('${recordID}', '${customer}', '${address}')" 
              class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold px-3 py-2 rounded-lg mt-2">
              ‚ûï Create Packet
            </button>`;
        } else if (stage === 'inProgress') {
          actionButton = `
            <button onclick="viewHandoffDetails('${recordID}')" 
              class="w-full bg-gray-600 hover:bg-gray-700 text-white text-xs font-semibold px-3 py-2 rounded-lg mt-2">
              üëÅÔ∏è View Details
            </button>`;
        } else {
          actionButton = `
            <button onclick="viewHandoffDetails('${recordID}')" 
              class="w-full bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-semibold px-3 py-2 rounded-lg mt-2">
              ‚úì View Status
            </button>`;
        }
        
        return `
          <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-3 shadow-sm hover:shadow-md transition-shadow" 
            data-customer="${customer.toLowerCase()}" 
            data-address="${address.toLowerCase()}" 
            data-ae="${aeName.toLowerCase()}"
            data-status="${row.packetStatus || 'Not Created'}">
            <div class="flex items-start justify-between mb-2">
              <div class="font-semibold text-sm text-gray-800 dark:text-gray-200 flex-1">${row.customer || 'N/A'}</div>
              <span class="text-${urgencyColor}-600 text-lg ml-2" title="${daysAgo} days since sold">${urgencyIcon}</span>
            </div>
            <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
              <div class="flex items-start">
                <span class="mr-1">üìç</span>
                <span class="flex-1">${row.address || 'N/A'}</span>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <span class="mr-1">üë§</span>
                  <span>${aeName}</span>
                </div>
                <span class="text-gray-400">${daysAgo}d ago</span>
              </div>
            </div>
            ${actionButton}
          </div>`;
      }).join('');
    }
    
    function updateHandoffStats(notCreated, inProgress, ready) {
      const total = notCreated.length + inProgress.length + ready.length;
      document.getElementById('handoffStatNotCreated').textContent = notCreated.length;
      document.getElementById('handoffStatDraft').textContent = inProgress.length;
      document.getElementById('handoffStatProgress').textContent = inProgress.length;
      document.getElementById('handoffStatTotal').textContent = total;
      document.getElementById('countNotCreated').textContent = notCreated.length;
      document.getElementById('countInProgress').textContent = inProgress.length;
      document.getElementById('countReady').textContent = ready.length;
    }
    
    function filterHandoffCards() {
      const searchTerm = (document.getElementById('handoffSearch').value || '').toLowerCase();
      const statusFilter = document.getElementById('handoffStatusFilter').value;
      
      const allCards = document.querySelectorAll('#handoffPipeline [data-customer]');
      let visibleCount = 0;
      
      allCards.forEach(function(card) {
        const customer = card.getAttribute('data-customer') || '';
        const address = card.getAttribute('data-address') || '';
        const ae = card.getAttribute('data-ae') || '';
        const status = card.getAttribute('data-status') || '';
        
        const matchesSearch = !searchTerm || 
          customer.includes(searchTerm) || 
          address.includes(searchTerm) || 
          ae.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;
        
        if (matchesSearch && matchesStatus) {
          card.classList.remove('hidden');
          visibleCount++;
        } else {
          card.classList.add('hidden');
        }
      });
      
      // Show/hide empty state based on visible cards
      const isEmpty = visibleCount === 0;
      document.getElementById('handoffEmpty').classList.toggle('hidden', !isEmpty);
      document.getElementById('handoffPipeline').classList.toggle('hidden', isEmpty);
    }
    
    function viewHandoffDetails(recordID) {
      // Find the record in the stored data
      const record = window.handoffQueueData.find(function(item) {
        return (item.trackerEntryID || item.recordID || item.id) === recordID;
      });
      
      if (!record) {
        alert('Record not found: ' + recordID);
        return;
      }
      
      const soldDate = record.soldDate ? new Date(record.soldDate).toLocaleDateString() : 'Unknown';
      const message = `Handoff Details
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Customer: ${record.customer || 'N/A'}
Address: ${record.address || 'N/A'}
AE: ${record.aeName || 'N/A'}
Sold Date: ${soldDate}
Packet Status: ${record.packetStatus || 'Not Created'}

Record ID: ${recordID}`;
      
      alert(message);
    }
    
    function createStartPacketFromHandoff(recordID, customer, address) {
      if (!confirm('Create start packet for ' + customer + '?\n\nAddress: ' + address)) {
        return;
      }
      
      // Switch to AE view to open the unified sale form
      showView('ae');
      
      // Wait for iframe to load, then send message to open unified sale form with pre-filled data
      setTimeout(function() {
        const frame = document.querySelector('#view-ae iframe');
        if (frame && frame.contentWindow) {
          try {
            frame.contentWindow.postMessage({
              type: 'CREATE_START_PACKET_FROM_HANDOFF',
              data: {
                recordID: recordID,
                accountName: customer,
                serviceAddress: address
              }
            }, '*');
          } catch (e) {
            console.error('Failed to send message to AE dashboard:', e);
          }
        }
        alert('Opening start packet form. Please fill in the remaining details and submit.');
      }, 500);
    }

    function mockHandoffQueue() {
      return cloneDemoData(DEMO_DASHBOARD_DATA.handoff);
    }

    function loadSettingsView() {
      callServer('getBrandPresets', renderBrandPresets, mockBrandPresets());
      loadUISettings();
      updateSettingsEnvironmentTag();
    }

    const SETTINGS_STORAGE_KEY = 'branch360UISettings';
    const DEFAULT_SETTINGS = {
      compactView: false,
      darkMode: false,
      showDollarValues: true,
      refreshInterval: 60,
      itemsPerPage: 25,
      emailNotifications: true,
      browserNotifications: false,
      successToasts: true,
      exportFormat: 'csv',
      includeCharts: true,
      autoSaveDrafts: true
    };

    function loadUISettings() {
      if (!window.localStorage) {
        applyDefaultSettings();
        return;
      }
      try {
        const stored = JSON.parse(window.localStorage.getItem(SETTINGS_STORAGE_KEY) || '{}');
        const settings = Object.assign({}, DEFAULT_SETTINGS, stored);
        applySettings(settings);
      } catch (err) {
        console.warn('Failed to load UI settings', err);
        applyDefaultSettings();
      }
    }

    function saveUISettings() {
      if (!window.localStorage) return;
      try {
        const settings = {
          compactView: document.getElementById('settingCompactView').checked,
          darkMode: document.getElementById('settingDarkMode').checked,
          showDollarValues: document.getElementById('settingShowDollarValues').checked,
          refreshInterval: document.getElementById('settingRefreshInterval').value,
          itemsPerPage: document.getElementById('settingItemsPerPage').value,
          emailNotifications: document.getElementById('settingEmailNotifications').checked,
          browserNotifications: document.getElementById('settingBrowserNotifications').checked,
          successToasts: document.getElementById('settingSuccessToasts').checked,
          exportFormat: document.getElementById('settingExportFormat').value,
          includeCharts: document.getElementById('settingIncludeCharts').checked,
          autoSaveDrafts: document.getElementById('settingAutoSaveDrafts').checked
        };
        window.localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
        showSettingsToast('Settings saved successfully');
      } catch (err) {
        console.error('Failed to save UI settings', err);
        showSettingsToast('Failed to save settings', 'error');
      }
    }

    function applySettings(settings) {
      if (document.getElementById('settingCompactView')) {
        document.getElementById('settingCompactView').checked = settings.compactView || false;
        applyCompactView(settings.compactView || false);
      }
      if (document.getElementById('settingDarkMode')) {
        document.getElementById('settingDarkMode').checked = settings.darkMode || false;
        applyDarkMode(settings.darkMode || false);
      }
      if (document.getElementById('settingShowDollarValues')) {
        document.getElementById('settingShowDollarValues').checked = settings.showDollarValues !== false;
      }
      if (document.getElementById('settingRefreshInterval')) {
        document.getElementById('settingRefreshInterval').value = settings.refreshInterval || 60;
      }
      if (document.getElementById('settingItemsPerPage')) {
        document.getElementById('settingItemsPerPage').value = settings.itemsPerPage || 25;
      }
      if (document.getElementById('settingEmailNotifications')) {
        document.getElementById('settingEmailNotifications').checked = settings.emailNotifications !== false;
      }
      if (document.getElementById('settingBrowserNotifications')) {
        document.getElementById('settingBrowserNotifications').checked = settings.browserNotifications || false;
      }
      if (document.getElementById('settingSuccessToasts')) {
        document.getElementById('settingSuccessToasts').checked = settings.successToasts !== false;
      }
      if (document.getElementById('settingExportFormat')) {
        document.getElementById('settingExportFormat').value = settings.exportFormat || 'csv';
      }
      if (document.getElementById('settingIncludeCharts')) {
        document.getElementById('settingIncludeCharts').checked = settings.includeCharts !== false;
      }
      if (document.getElementById('settingAutoSaveDrafts')) {
        document.getElementById('settingAutoSaveDrafts').checked = settings.autoSaveDrafts !== false;
      }
    }
    
    function applyCompactView(enabled) {
      if (enabled) {
        document.body.classList.add('compact-view');
        document.body.style.setProperty('--compact-spacing', '0.5rem');
        document.body.style.setProperty('--compact-padding', '0.75rem');
      } else {
        document.body.classList.remove('compact-view');
        document.body.style.removeProperty('--compact-spacing');
        document.body.style.removeProperty('--compact-padding');
      }
    }
    
    function applyDarkMode(enabled) {
      if (enabled) {
        document.documentElement.classList.add('dark-mode');
        document.body.classList.add('dark-mode');
        if (window.localStorage) {
          window.localStorage.setItem('branch360Theme', 'dark');
        }
      } else {
        document.documentElement.classList.remove('dark-mode');
        document.body.classList.remove('dark-mode');
        if (window.localStorage) {
          window.localStorage.setItem('branch360Theme', 'light');
        }
      }
      
      // Propagate theme to all iframes
      try {
        const iframes = document.querySelectorAll('iframe.persona-frame');
        iframes.forEach(function(iframe) {
          if (iframe.contentWindow && iframe.contentWindow.document) {
            const iframeBody = iframe.contentWindow.document.body;
            if (enabled) {
              iframeBody.classList.add('dark-mode', 'bg-gray-900');
              iframeBody.classList.remove('bg-gray-50', 'bg-gray-100');
            } else {
              iframeBody.classList.remove('dark-mode', 'bg-gray-900');
              iframeBody.classList.add('bg-gray-50');
            }
          }
        });
      } catch(e) {
        console.log('Could not propagate theme to iframes:', e);
      }
    }

    function applyDefaultSettings() {
      applySettings(DEFAULT_SETTINGS);
    }

    function resetSettingsToDefaults() {
      if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
        if (window.localStorage) {
          window.localStorage.removeItem(SETTINGS_STORAGE_KEY);
        }
        applyDefaultSettings();
        showSettingsToast('Settings reset to defaults');
      }
    }

    function clearLocalCache() {
      if (confirm('Are you sure you want to clear all local cache? This will remove saved data and you may need to log in again.')) {
        if (window.localStorage) {
          const brand = window.localStorage.getItem('branch360Brand');
          const demoUser = window.localStorage.getItem(SESSION_KEY);
          window.localStorage.clear();
          if (brand) window.localStorage.setItem('branch360Brand', brand);
          if (demoUser) window.localStorage.setItem(SESSION_KEY, demoUser);
        }
        showSettingsToast('Local cache cleared');
        setTimeout(() => {
          location.reload();
        }, 1000);
      }
    }

    function backupSettings() {
      if (!window.localStorage) {
        showSettingsToast('Local storage not available', 'error');
        return;
      }
      try {
        const settings = window.localStorage.getItem(SETTINGS_STORAGE_KEY);
        const brand = window.localStorage.getItem('branch360Brand');
        const backup = {
          settings: settings ? JSON.parse(settings) : null,
          brand: brand,
          timestamp: new Date().toISOString(),
          version: '1.0.0-pilot'
        };
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `branch360-settings-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showSettingsToast('Settings backed up successfully');
      } catch (err) {
        console.error('Failed to backup settings', err);
        showSettingsToast('Failed to backup settings', 'error');
      }
    }

    function showSettingsToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${
        type === 'error' ? 'bg-red-600 text-white' : 'bg-green-600 text-white'
      }`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.transition = 'opacity 0.3s';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function updateSettingsEnvironmentTag() {
      const tag = document.getElementById('settingsEnvironmentTag');
      if (tag) {
        tag.textContent = ENVIRONMENT;
      }
    }

    function renderBrandPresets(presets) {
      const grid = document.getElementById('brandPresetGrid');
      if (!grid) return;
      window.brandPresetsCache = presets || [];
      if (!presets || presets.length === 0) {
        grid.innerHTML = '<p class="text-gray-500">No brand presets configured.</p>';
        updateBrandStatus('No brand presets available.');
        return;
      }
      if (!window.pendingBrandSelection) {
        window.pendingBrandSelection = window.currentBrand || presets[0].key;
      }
      grid.innerHTML = presets.map(function(preset) {
        const selected = (window.pendingBrandSelection || '') === preset.key;
        return `<div class="border rounded-xl p-4 flex gap-4 items-center ${selected ? 'border-blue-500 shadow-lg' : 'border-gray-200'}">
          <img src="${preset.logo}" alt="${preset.name} logo" class="w-16 h-16 object-contain surface-card rounded-lg p-2" />
          <div class="flex-1">
            <p class="font-bold text-gray-800">${preset.name}</p>
            <p class="text-xs text-gray-500">Primary: ${preset.colors.primary} ‚Ä¢ Accent: ${preset.colors.accent}</p>
            <p class="text-xs text-gray-500">Legacy Color: ${preset.legacyColor || preset.colors.primary}</p>
            <button class="mt-2 text-sm px-3 py-1 rounded-lg border ${selected ? 'bg-blue-50 border-blue-400 text-blue-700' : 'text-gray-600'}" onclick="previewBrandTheme('${preset.key}')">
              ${selected ? 'Selected' : 'Preview Theme'}
            </button>
          </div>
        </div>`;
      }).join('');
      if (!window.hasAppliedInitialBrand) {
        window.hasAppliedInitialBrand = true;
        previewBrandTheme(window.pendingBrandSelection, { skipRender: true, skipStatus: false });
      }
      applyBrandStylesFromKey(window.pendingBrandSelection, presets);
    }

    function applyBrandStyles(preset) {
      if (!preset) return;
      document.documentElement.style.setProperty('--brand-primary', preset.colors.primary);
      document.documentElement.style.setProperty('--brand-accent', preset.colors.accent);
      document.documentElement.style.setProperty('--brand-dark', preset.colors.dark);
      window.pricingConfig = Object.assign({}, defaultPricingConfig, preset.pricing || {});
      updatePricingHelper();
    }

    function updateBrandStatus(message) {
      const el = document.getElementById('brandStatus');
      if (el) el.textContent = message;
    }

    window.previewBrandTheme = function(key, options) {
      if (!window.brandPresetsCache || window.brandPresetsCache.length === 0) return;
      const preset = findPresetByKey(key, window.brandPresetsCache);
      if (!preset) return;
      window.pendingBrandSelection = key;
      applyBrandStyles(preset);
      if (!options || !options.skipRender) {
        renderBrandPresets(window.brandPresetsCache);
      }
      if (!options || !options.skipStatus) {
        updateBrandStatus('Previewing ' + preset.name + ' theme.');
      }
    };

    function commitBrandSelection(closeAfter) {
      if (!window.brandPresetsCache || window.brandPresetsCache.length === 0) return;
      const key = window.pendingBrandSelection || window.currentBrand || window.brandPresetsCache[0].key;
      const preset = window.brandPresetsCache.find(p => p.key === key);
      window.currentBrand = key;
      if (window.localStorage) {
        window.localStorage.setItem('branch360Brand', key);
      }
      applyBrandStyles(preset);
      updateBrandStatus('Saved ' + (preset ? preset.name : key) + ' theme for this demo.');
      if (closeAfter && roleCanView('branch')) {
        showView('branch');
      }
    }

    document.getElementById('brandSaveBtn').addEventListener('click', function() {
      commitBrandSelection(false);
    });
    document.getElementById('brandSaveCloseBtn').addEventListener('click', function() {
      commitBrandSelection(true);
    });
    document.getElementById('brandCloseBtn').addEventListener('click', function() {
      window.pendingBrandSelection = window.currentBrand;
      previewBrandTheme(window.currentBrand, { skipRender: false, skipStatus: false });
      if (roleCanView('branch')) {
        showView('branch');
      }
    });

    function findPresetByKey(key, presets) {
      const list = presets || window.brandPresetsCache || [];
      if (!list || list.length === 0) return null;
      const match = list.find(function(preset) { return preset.key === key; });
      return match || list[0];
    }

    function applyBrandStylesFromKey(key, presets) {
      const preset = findPresetByKey(key, presets);
      if (preset) {
        applyBrandStyles(preset);
      }
    }

    function applyBrandStyles(preset) {
      if (!preset) return;
      document.documentElement.style.setProperty('--brand-primary', preset.colors.primary || '#2563eb');
      document.documentElement.style.setProperty('--brand-accent', preset.colors.accent || preset.colors.primary || '#60a5fa');
      document.documentElement.style.setProperty('--brand-dark', preset.colors.dark || '#0f172a');
      const logoImg = document.getElementById('brandLogo');
      if (logoImg && preset.logo) {
        logoImg.src = preset.logo;
        logoImg.alt = preset.name + ' logo';
      }
    }

    function mockBrandPresets() {
      return [
        { key: 'PRESTOX', name: 'Presto-X', logo: 'https://ik.imagekit.io/9cyexhymf/Presto-X%20Logo-ARentokilCompany.png?updatedAt=1762540113819', colors: { primary: '#E4002B', accent: '#FF6B6B', dark: '#B00024', background: '#FDF2F2' }, legacyColor: '#E4002B', pricing: { baseMonthly: 160, perSqft: 0.022, perLinear: 0.45, perAcre: 22, excluderMonthly: 38, excluderInitial: 55 } },
        { key: 'BUGOUT', name: 'BugOut', logo: 'https://ik.imagekit.io/9cyexhymf/BugOut%20Logo.png?updatedAt=1762651397528', colors: { primary: '#16A34A', accent: '#22C55E', dark: '#14532D', background: '#F0FDF4' }, legacyColor: '#16A34A', pricing: { baseMonthly: 145, perSqft: 0.018, perLinear: 0.4, perAcre: 20, excluderMonthly: 32, excluderInitial: 48 } },
        { key: 'TERMINIX', name: 'Terminix', logo: 'https://ik.imagekit.io/9cyexhymf/terminix_color_lg.png?updatedAt=1762622940808', colors: { primary: '#15803D', accent: '#22C55E', dark: '#166534', background: '#ECFDF5' }, legacyColor: '#15803D', pricing: { baseMonthly: 150, perSqft: 0.019, perLinear: 0.42, perAcre: 22, excluderMonthly: 34, excluderInitial: 50 } },
        { key: 'RENTOKIL', name: 'Rentokil', logo: 'https://ik.imagekit.io/9cyexhymf/Rentokil%20Logo.png?updatedAt=1762651397519', colors: { primary: '#E4002B', accent: '#FF6B6B', dark: '#B00024', background: '#FDF2F2' }, legacyColor: '#E4002B', pricing: { baseMonthly: 165, perSqft: 0.023, perLinear: 0.48, perAcre: 24, excluderMonthly: 40, excluderInitial: 60 } }
      ];
    }

    function loadPilotReport() {
      const start = document.getElementById('pilotStart').value;
      const end = document.getElementById('pilotEnd').value;
      const role = document.getElementById('pilotRole').value;
      const payload = {
        startDate: start,
        endDate: end,
        role: role || '',
        branchId: document.getElementById('branchSelect').value
      };
      callServerCustom('getActivityAnalytics', payload, renderPilotReport, mockTimeAnalytics());
    }

    function renderPilotReport(data) {
      pilotDataCache = data;
      const totalHours = data.totals.hoursSaved || 0;
      const totalHoursSpent = data.totals.hoursSpent || 0;
      const totalActivities = (data.rows || []).reduce((sum, row) => sum + (row.activities || 0), 0);
      const totalUsers = (data.rows || []).length;
      const avgHoursPerUser = totalUsers > 0 ? totalHours / totalUsers : 0;
      const avgActivitiesPerUser = totalUsers > 0 ? totalActivities / totalUsers : 0;
      const efficiency = totalHoursSpent > 0 ? ((totalHours / (totalHours + totalHoursSpent)) * 100) : 0;
      const fte = totalHours / 40;
      
      const cards = document.getElementById('pilotCards');
      const roleFilter = document.getElementById('pilotRole').value;
      
      const cardItems = [
        { label: 'Total Hours Saved', value: totalHours.toFixed(1), sub: `${totalHoursSpent.toFixed(1)} hrs spent` },
        { label: 'Total Activities', value: totalActivities.toLocaleString(), sub: `${avgActivitiesPerUser.toFixed(1)} avg per user` },
        { label: 'Total $ Value', value: formatCurrency(data.totals.dollarsSaved || 0), sub: `${efficiency.toFixed(1)}% efficiency` },
        { label: 'Active Users', value: totalUsers.toString(), sub: `${avgHoursPerUser.toFixed(1)} hrs avg` },
        { label: 'AE Hours', value: (data.totals.hoursSavedAE || 0).toFixed(1), sub: roleFilter === 'Account Executive' ? 'Filtered' : 'All AEs' },
        { label: 'Ops/Tech Hours', value: (data.totals.hoursSavedOps || 0).toFixed(1), sub: roleFilter === 'Technician' || roleFilter === 'Operations Manager' ? 'Filtered' : 'All Ops' },
        { label: 'Branch Hours', value: (data.totals.hoursSavedBranch || 0).toFixed(1), sub: roleFilter === 'Branch Manager' ? 'Filtered' : 'All Branch' },
        { label: 'Approx. FTE', value: fte.toFixed(1), sub: 'Based on 40hr/week' }
      ];
      cards.innerHTML = cardItems.map(card => cardTemplate(card.label, card.value, card.sub)).join('');

      document.getElementById('pilotEmpty').classList.toggle('hidden', (data.rows && data.rows.length > 0));

      // Update table title based on filter
      const tableTitle = document.getElementById('pilotTableTitle');
      if (tableTitle) {
        if (roleFilter) {
          tableTitle.textContent = `Per-User Breakdown (${roleFilter})`;
        } else {
          tableTitle.textContent = 'Per-User Breakdown';
        }
      }

      renderPilotSummary(data);
      renderPilotRoleBreakdown(data);
      renderPilotActionBreakdown(data);
      renderPilotTable();
      renderPilotTrend(data);
    }

    function renderPilotTable() {
      const table = document.getElementById('pilotTable');
      if (!pilotDataCache || !pilotDataCache.rows || pilotDataCache.rows.length === 0) {
        table.innerHTML = '<tbody><tr><td class="px-3 py-2 text-sm text-gray-500" colspan="7">No activity logged yet.</td></tr></tbody>';
        return;
      }
      const rows = [...pilotDataCache.rows];
      rows.sort((a, b) => {
        if (pilotSort === 'dollars') {
          return (b.dollarsSaved || 0) - (a.dollarsSaved || 0);
        } else if (pilotSort === 'activities') {
          return (b.activities || 0) - (a.activities || 0);
        }
        return (b.hoursSaved || 0) - (a.hoursSaved || 0);
      });
      table.innerHTML = tableTemplate(['User', 'Role', 'Activities', 'Hours Saved', 'Hours Spent', 'Avg Duration', '$ Value'], rows.map(row => [
        row.name,
        row.role,
        row.activities || 0,
        (row.hoursSaved || 0).toFixed(1),
        (row.hoursSpent || 0).toFixed(1),
        row.avgDurationMinutes ? row.avgDurationMinutes.toFixed(1) + ' min' : '--',
        formatCurrency(row.dollarsSaved || 0)
      ]));
    }

    function renderPilotRoleBreakdown(data) {
      const table = document.getElementById('pilotRoleBreakdown');
      const section = document.getElementById('pilotRoleBreakdownSection');
      if (!table || !section) return;
      
      const roleFilter = document.getElementById('pilotRole').value;
      let breakdown = data.breakdownByRole || [];
      
      // If a role filter is selected, only show that role's breakdown
      if (roleFilter) {
        breakdown = breakdown.filter(r => r.role === roleFilter);
      }
      
      if (!breakdown || breakdown.length === 0) {
        section.classList.add('hidden');
        return;
      }
      
      section.classList.remove('hidden');
      
      // Sort by hours saved descending
      breakdown.sort((a, b) => (b.hoursSaved || 0) - (a.hoursSaved || 0));
      
      const totalHours = breakdown.reduce((sum, r) => sum + (r.hoursSaved || 0), 0);
      const totalActivities = breakdown.reduce((sum, r) => sum + (r.activities || 0), 0);
      
      table.innerHTML = tableTemplate(
        ['Role', 'Hours Saved', 'Activities', '% of Total Hours', '% of Total Activities'],
        breakdown.map(row => {
          const hoursPct = totalHours > 0 ? ((row.hoursSaved / totalHours) * 100).toFixed(1) : '0.0';
          const activitiesPct = totalActivities > 0 ? ((row.activities / totalActivities) * 100).toFixed(1) : '0.0';
          return [
            row.role,
            (row.hoursSaved || 0).toFixed(1),
            (row.activities || 0).toLocaleString(),
            hoursPct + '%',
            activitiesPct + '%'
          ];
        })
      );
    }

    function renderPilotActionBreakdown(data) {
      const table = document.getElementById('pilotActionBreakdown');
      const section = document.getElementById('pilotActionBreakdownSection');
      if (!table || !section) return;
      
      const breakdown = data.breakdownByAction || [];
      
      if (!breakdown || breakdown.length === 0) {
        section.classList.add('hidden');
        return;
      }
      
      section.classList.remove('hidden');
      
      // Sort by hours saved descending
      breakdown.sort((a, b) => (b.hoursSaved || 0) - (a.hoursSaved || 0));
      
      // Show top 10 actions
      const topActions = breakdown.slice(0, 10);
      const totalHours = breakdown.reduce((sum, a) => sum + (a.hoursSaved || 0), 0);
      const totalActivities = breakdown.reduce((sum, a) => sum + (a.activities || 0), 0);
      
      table.innerHTML = tableTemplate(
        ['Action Type', 'Hours Saved', 'Activities', '% of Total Hours', '% of Total Activities'],
        topActions.map(row => {
          const hoursPct = totalHours > 0 ? ((row.hoursSaved / totalHours) * 100).toFixed(1) : '0.0';
          const activitiesPct = totalActivities > 0 ? ((row.activities / totalActivities) * 100).toFixed(1) : '0.0';
          return [
            row.actionType,
            (row.hoursSaved || 0).toFixed(1),
            (row.activities || 0).toLocaleString(),
            hoursPct + '%',
            activitiesPct + '%'
          ];
        })
      );
    }

    function renderPilotTrend(data) {
      const ctx = document.getElementById('pilotChart').getContext('2d');
      if (pilotChart) pilotChart.destroy();
      const labels = (data.weekly || []).map(point => point.week);
      const dataset = (data.weekly || []).map(point => point.hoursSaved);
      pilotChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{ label: 'Hours Saved per Week', data: dataset, borderColor: '#0ea5e9', backgroundColor: 'rgba(14,165,233,0.2)', tension: 0.2 }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    function renderPilotSummary(data) {
      const totalHours = data.totals.hoursSaved || 0;
      const totalHoursSpent = data.totals.hoursSpent || 0;
      const aeHours = data.totals.hoursSavedAE || 0;
      const opsHours = data.totals.hoursSavedOps || 0;
      const branchHours = data.totals.hoursSavedBranch || 0;
      const totalDollars = data.totals.dollarsSaved || 0;
      const totalActivities = (data.rows || []).reduce((sum, row) => sum + (row.activities || 0), 0);
      const totalUsers = (data.rows || []).length;
      const fte = totalHours / 40;
      const efficiency = totalHoursSpent > 0 ? ((totalHours / (totalHours + totalHoursSpent)) * 100) : 0;
      const aePct = totalHours > 0 ? (aeHours / totalHours) * 100 : 0;
      const opsPct = totalHours > 0 ? (opsHours / totalHours) * 100 : 0;
      const branchPct = totalHours > 0 ? (branchHours / totalHours) * 100 : 0;
      const start = document.getElementById('pilotStart').value;
      const end = document.getElementById('pilotEnd').value;
      const roleFilter = document.getElementById('pilotRole').value;
      
      let summary = '';
      if (totalHours > 0) {
        const filterText = roleFilter ? ` (filtered by ${roleFilter})` : '';
        summary = `From ${start} to ${end}${filterText}, Branch360 saved ${totalHours.toFixed(1)} hours (~${fte.toFixed(1)} FTEs) worth ${formatCurrency(totalDollars)}. `;
        if (!roleFilter) {
          summary += `AEs accounted for ${aePct.toFixed(1)}% of hours saved, Ops/Techs ${opsPct.toFixed(1)}%, Branch/Others ${branchPct.toFixed(1)}%. `;
        }
        summary += `Total of ${totalActivities.toLocaleString()} activities tracked across ${totalUsers} active user${totalUsers !== 1 ? 's' : ''} with ${efficiency.toFixed(1)}% time efficiency.`;
      } else {
        summary = 'No activity logged for this period. Encourage the team to track their work in Branch360 to capture ROI.';
      }
      document.getElementById('pilotSummary').textContent = summary;
    }

  let quoteTrackerEntries = [];

  function loadQuoteTrackerEntries() {
    if (!window.localStorage) return [];
    try {
      const stored = JSON.parse(window.localStorage.getItem(QUOTE_TRACKER_STORAGE_KEY));
      if (!Array.isArray(stored)) return [];
      return stored;
    } catch (err) {
      console.warn('Quote tracker load failed', err);
      return [];
    }
  }

  function saveQuoteTrackerEntries() {
    if (!window.localStorage) return;
    try {
      window.localStorage.setItem(QUOTE_TRACKER_STORAGE_KEY, JSON.stringify(quoteTrackerEntries));
    } catch (err) {
      console.warn('Quote tracker save failed', err);
    }
  }

  function uniqueStrings(arr) {
    if (!Array.isArray(arr)) return [];
    const seen = {};
    return arr.filter(function(str) {
      if (seen[str]) return false;
      seen[str] = true;
      return true;
    });
  }

  function deriveLobsFromServices(services) {
    if (!Array.isArray(services)) return [];
    const matches = [];
    const lobMap = [
      { label: 'Crawling Insect', test: /(general pest|gpc|crawling)/i },
      { label: 'Rodent', test: /rodent/i },
      { label: 'Fly', test: /fly|ilt/i },
      { label: 'Bird', test: /bird/i },
      { label: 'Drain', test: /drain/i },
      { label: 'Mosquito', test: /mosquito/i }
    ];
    services.forEach(function(service) {
      if (!service) return;
      const name = (service.category || service.serviceName || service.programType || '').trim();
      if (name) {
        matches.push(name);
      }
      lobMap.forEach(function(entry) {
        if (entry.test.test(name)) {
          matches.push(entry.label);
        }
      });
    });
    return uniqueStrings(matches);
  }

  function trackSalesforceProposal(draft) {
    if (!draft || !draft.accountName) return null;
    const trackerId = draft.quoteTrackerId || draft.trackerId || 'SF-' + Date.now();
    const address = [draft.serviceAddressLine1 || draft.serviceAddress || '', draft.serviceCity || '', draft.serviceState || '', draft.serviceZip || '']
      .filter(Boolean)
      .join(', ');
    const lobList = deriveLobsFromServices(draft.services || []);
    const entry = {
      id: trackerId,
      accountName: draft.accountName,
      serviceAddress: address,
      uploadedAt: new Date().toISOString(),
      status: 'Proposal',
      initial: draft.combinedInitialTotal || draft.servicesInitialTotal || 0,
      monthly: draft.combinedMonthlyTotal || draft.servicesMonthlyTotal || 0,
      branchId: draft.branchId || 'HOUSTON',
      lobs: lobList
    };
    quoteTrackerEntries = [entry].concat(quoteTrackerEntries.filter(function(item) { return item.id !== trackerId; })).slice(0, 25);
    saveQuoteTrackerEntries();
    renderQuoteTracker();
    refreshTodayMetricsFromQuotes();
    return trackerId;
  }

  function markQuoteTrackerSold(trackerId, saleRecordID) {
    if (!trackerId && !saleRecordID) return;
    const entry = quoteTrackerEntries.find(function(item) {
      if (trackerId && item.id === trackerId) return true;
      if (saleRecordID && item.saleRecordID === saleRecordID) return true;
      return false;
    });
    if (entry && entry.status !== 'Sold') {
      entry.status = 'Sold';
      entry.saleRecordID = saleRecordID || entry.saleRecordID;
      entry.soldAt = new Date().toISOString();
      saveQuoteTrackerEntries();
      renderQuoteTracker();
      refreshTodayMetricsFromQuotes();
    }
  }

  function renderQuoteTracker() {
    // Stub function - quote tracker rendering not needed for dashboard demo
  }

  function refreshTodayMetricsFromQuotes() {
    // Stub function - metrics refresh not needed for dashboard demo
  }

  // Initialize quote tracker entries on load
  quoteTrackerEntries = loadQuoteTrackerEntries();

  function getQuoteTrackerCount() {
    if (!window.localStorage) return 0;
    try {
      const stored = JSON.parse(window.localStorage.getItem(QUOTE_TRACKER_STORAGE_KEY));
      return Array.isArray(stored) ? stored.length : 0;
    } catch (err) {
      return 0;
    }
  }

  function startDemoLoop() {
    if (demoLoopHandle) return;
    demoLoopHandle = setInterval(runDemoActivity, 16000);
  }

  function runDemoActivity() {
    simulateQuoteActivity();
    simulateTimeSavingsBoost();
  }

  function simulateQuoteActivity() {
    const account = DEMO_ACCOUNTS[Math.floor(Math.random() * DEMO_ACCOUNTS.length)];
    const valueInitial = 3000 + Math.floor(Math.random() * 1200);
    const valueMonthly = 800 + Math.floor(Math.random() * 500);
    const draft = {
      accountName: account,
      serviceAddressLine1: account + ' Campus',
      serviceCity: 'Houston',
      serviceState: 'TX',
      serviceZip: '7700' + Math.floor(Math.random() * 9),
      branchId: 'BRN-001',
      services: [{
        serviceName: 'GPC Interior/Exterior',
        descriptionText: 'Auto-generated scope',
        servicesPerYear: 12,
        frequencyLabel: 'Monthly'
      }],
      combinedInitialTotal: valueInitial,
      combinedMonthlyTotal: valueMonthly
    };
    const trackerId = trackSalesforceProposal(draft);
    setTimeout(function() {
      markQuoteTrackerSold(trackerId, trackerId);
    }, 6000);
  }

  function simulateTimeSavingsBoost() {
    if (!latestTimeAnalytics || !latestTimeAnalytics.totals) return;
    const deltaHours = 0.4 + Math.random() * 0.4;
    const deltaDollars = deltaHours * 55;
    latestTimeAnalytics.totals.hoursSaved += deltaHours;
    latestTimeAnalytics.totals.dollarsSaved += deltaDollars;
    if (latestTimeAnalytics.totals.hoursSavedAE !== undefined) {
      latestTimeAnalytics.totals.hoursSavedAE += deltaHours / 2;
    }
    if (latestTimeAnalytics.totals.hoursSavedOps !== undefined) {
      latestTimeAnalytics.totals.hoursSavedOps += deltaHours / 2;
    }
    renderTimeSaved(latestTimeAnalytics);
  }

    function cardTemplate(label, value, sub) {
      return `<div class="surface-card rounded-xl p-4 shadow"><p class="text-sm text-gray-500">${label}</p><p class="text-2xl font-bold">${value}</p>${sub ? `<span class="block text-xs text-gray-500 mt-1">${sub}</span>` : ''}</div>`;
    }

    function tableTemplate(headers, rows) {
      const safeRows = Array.isArray(rows) ? rows : [];
      const thead = `<thead><tr>${headers.map(h => `<th class="text-left text-xs uppercase tracking-wide text-gray-500 px-3 py-2">${h}</th>`).join('')}</tr></thead>`;
      const tbody = `<tbody>${safeRows.map(row => {
        const cols = Array.isArray(row) ? row : [row];
        return `<tr class="border-t">${cols.map(cell => `<td class="px-3 py-2 text-sm">${cell}</td>`).join('')}</tr>`;
      }).join('')}</tbody>`;
      return `${thead}${tbody}`;
    }

    function formatCurrency(value) {
      return '$' + (Number(value) || 0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function formatHours(value) {
      const hours = Number(value) || 0;
      if (hours >= 1) {
        return hours.toFixed(1) + ' hrs';
      }
      return Math.round(hours * 60) + ' mins';
    }

    function cloneDemoData(source) {
      if (!source) return {};
      return JSON.parse(JSON.stringify(source));
    }

    function mockBranchKpis() {
      return cloneDemoData(DEMO_DASHBOARD_DATA.branch);
    }

    function mockMarketKpis() {
      return cloneDemoData(DEMO_DASHBOARD_DATA.market);
    }

    function mockTimeAnalytics() {
      return cloneDemoData(DEMO_DASHBOARD_DATA.time);
    }

    function exportBranchReport() {
      const filters = getFilters();
      const task = createTaskModal('Exporting Data', 'Preparing export‚Ä¶');
      document.body.appendChild(task.overlay);

      const btn = document.getElementById('btn-export-data');
      if (btn) { btn.disabled = true; btn.classList.add('opacity-70'); }

      let activityToken = window.ActivityClient ? ActivityClient.start('BM_EXPORT_REPORT', filters.branchId, { role: 'Branch Manager' }) : null;
      callServerCustom('exportBranchReport', filters, function(result) {
        if (activityToken && window.ActivityClient) {
          ActivityClient.finish(activityToken, { success: result && result.success });
          activityToken = null;
        }

        const fileName = (result && result.fileName) ? result.fileName : `branch360-export-${new Date().toISOString().slice(0,10)}.txt`;
        const content = (result && result.content) ? String(result.content) : '';

        if (content) {
          const ok = safeDownloadTextFile(fileName, content, 'text/plain;charset=utf-8');
          if (ok) {
            task.done('Export ready. Download started.');
          } else {
            task.done('Export ready, but download was blocked.');
            task.addHtml('<p class="text-sm text-gray-600">Your browser may be blocking downloads in this environment. Try again in production or use a different browser.</p>');
          }
        } else {
          task.done('Export completed.');
          task.addHtml('<p class="text-sm text-gray-600">No file content was returned by the backend.</p>');
        }

        setTimeout(() => {
          if (btn) { btn.disabled = false; btn.classList.remove('opacity-70'); }
        }, 800);
      }, { success: true, content: 'Export not available in this environment.' });
    }

    // Branch Manager Action Functions
    function generateDailyReport() {
      const confirmModal = createModal('Generate Daily Report', `
        <p class="text-sm text-gray-600 mb-4">This will generate today‚Äôs branch cadence report. It may take a moment.</p>
        <div class="flex justify-end gap-3">
          <button type="button" data-action="cancel" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300">Cancel</button>
          <button type="button" data-action="run" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700">Generate</button>
        </div>
      `);
      document.body.appendChild(confirmModal);

      const cancelBtn = confirmModal.querySelector('[data-action="cancel"]');
      const runBtn = confirmModal.querySelector('[data-action="run"]');
      if (cancelBtn) cancelBtn.addEventListener('click', () => confirmModal.remove());
      if (runBtn) runBtn.addEventListener('click', () => {
        confirmModal.remove();
        startDailyReportGeneration();
      });
    }

    function startDailyReportGeneration() {
      const task = createTaskModal('Generating Daily Report', 'Starting report generation‚Ä¶');
      document.body.appendChild(task.overlay);

      const btn = document.getElementById('btn-generate-report');
      if (btn) { btn.disabled = true; btn.classList.add('opacity-70'); }

      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              task.done('Daily report generated.');
              const summaryID = result.summaryID ? String(result.summaryID) : '';
              if (summaryID) {
                task.addHtml(`
                  <div class="text-sm text-gray-600">
                    <div><span class="font-semibold">Summary ID:</span> <code class="bg-gray-100 px-1 rounded">${escapeHtml(summaryID)}</code></div>
                    <p class="text-xs text-gray-500 mt-1">If you don‚Äôt see it immediately, refresh in 30‚Äì60 seconds.</p>
                  </div>
                `);
              }
              loadBranchKPIs();
            } else {
              task.done('Report generation failed.');
              task.addHtml(`<p class="text-sm text-red-600">${escapeHtml((result && result.message) ? result.message : 'Unknown error')}</p>`);
            }
          })
          .withFailureHandler(function(error) {
            task.done('Report generation failed.');
            task.addHtml(`<p class="text-sm text-red-600">${escapeHtml(error && error.message ? error.message : 'Unknown error')}</p>`);
          })
          .generateBranchDailyReport();
      } else {
        task.done('Not available in local/demo mode.');
        task.addHtml('<p class="text-sm text-gray-600">Connect the Apps Script backend to generate reports.</p>');
      }

      setTimeout(() => {
        if (btn) { btn.disabled = false; btn.classList.remove('opacity-70'); }
      }, 800);
    }

    function viewWeeklyTrends() {
      const task = createTaskModal('Weekly Trends', 'Loading weekly trends‚Ä¶');
      document.body.appendChild(task.overlay);

      callServer('getWeekTrends', function(data) {
        if (data && data.thisWeek !== undefined) {
          task.done('Weekly trends loaded.');
          const change = parseFloat(data.change) || 0;
          const changeSymbol = change >= 0 ? '‚Üë' : '‚Üì';
          task.addHtml(`
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
              <div class="bg-gray-50 rounded p-3"><div class="text-xs text-gray-500">This Week</div><div class="font-bold">$${(data.thisWeek || 0).toLocaleString()}</div></div>
              <div class="bg-gray-50 rounded p-3"><div class="text-xs text-gray-500">Last Week</div><div class="font-bold">$${(data.lastWeek || 0).toLocaleString()}</div></div>
              <div class="bg-gray-50 rounded p-3"><div class="text-xs text-gray-500">Change</div><div class="font-bold">${changeSymbol} ${Math.abs(change)}%</div></div>
            </div>
            <p class="text-xs text-gray-500 mt-2">${change >= 0 ? 'Sales are trending up.' : 'Sales are trending down. Review strategy.'}</p>
          `);
        } else {
          task.done('Weekly trends unavailable.');
          task.addHtml('<p class="text-sm text-gray-600">No weekly trend data is configured yet for this environment.</p>');
        }
      }, { thisWeek: 0, lastWeek: 0, change: 0 });
    }

    function exportBranchData() {
      const confirmModal = createModal('Export Data', `
        <p class="text-sm text-gray-600 mb-4">Export branch data as a CSV download.</p>
        <div class="flex justify-end gap-3">
          <button type="button" data-action="cancel" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300">Cancel</button>
          <button type="button" data-action="run" class="px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700">Export CSV</button>
        </div>
      `);
      document.body.appendChild(confirmModal);
      const cancelBtn = confirmModal.querySelector('[data-action="cancel"]');
      const runBtn = confirmModal.querySelector('[data-action="run"]');
      if (cancelBtn) cancelBtn.addEventListener('click', () => confirmModal.remove());
      if (runBtn) runBtn.addEventListener('click', () => {
        confirmModal.remove();
        exportBranchReport();
      });
    }

    function viewDetailedPipeline() {
      const task = createTaskModal('Detailed Pipeline', 'Loading pipeline entries‚Ä¶');
      document.body.appendChild(task.overlay);

      callServer('getDetailedBranchPipeline', function(data) {
        if (data && Array.isArray(data.entries)) {
          task.overlay.remove();
          showDetailedPipelineModal(data);
        } else {
          task.done('Pipeline data unavailable.');
          task.addHtml('<p class="text-sm text-gray-600">No detailed pipeline data is configured yet for this environment.</p>');
        }
      }, { entries: [] });
    }

    function showDetailedPipelineModal(data) {
      const entries = Array.isArray(data && data.entries) ? data.entries : [];

      const exportCsv = () => {
        if (!entries.length) {
          alert('No pipeline entries to export.');
          return;
        }

        const header = ['Customer','Stage','Value','AE','Date'];
        const csv = [
          header.join(','),
          ...entries.map(e => ([
            String(e.customerName || '').replace(/"/g, '""'),
            String(e.stage || '').replace(/"/g, '""'),
            String(e.value || 0),
            String(e.aeName || '').replace(/"/g, '""'),
            String(e.date || '').replace(/"/g, '""')
          ].map(v => `"${v}"`).join(',')))
        ].join('\n');

        const fileName = `branch360-pipeline-${new Date().toISOString().slice(0,10)}.csv`;
        const ok = safeDownloadTextFile(fileName, csv, 'text/csv;charset=utf-8');
        if (!ok) {
          alert('Download failed. Your browser may be blocking downloads in this environment.');
        }
      };

      const modal = createModal('Detailed Pipeline', `
        <div class="flex items-center justify-between gap-3 mb-3">
          <p class="text-sm text-gray-600">Showing ${entries.length} entries.</p>
          <button type="button" data-action="export" class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700">Export Pipeline CSV</button>
        </div>
        <div class="space-y-2">
          ${entries.length ? entries.slice(0, 100).map(entry => `
            <div class="border-l-4 border-blue-500 bg-gray-50 p-3 rounded">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="font-semibold text-gray-800">${escapeHtml(entry.customerName || 'Unknown')}</p>
                  <p class="text-sm text-gray-600">Stage: ${escapeHtml(entry.stage || 'N/A')} ‚Ä¢ Value: $${Number(entry.value || 0).toLocaleString()}</p>
                  <p class="text-xs text-gray-500">AE: ${escapeHtml(entry.aeName || 'Unknown')} ‚Ä¢ Date: ${escapeHtml(entry.date || '')}</p>
                </div>
              </div>
            </div>
          `).join('') : '<p class="text-gray-500 text-sm">No pipeline entries found for this branch.</p>'}
          ${entries.length > 100 ? `<p class="text-xs text-gray-500 mt-2">Showing first 100 entries. Export CSV to see all.</p>` : ''}
        </div>
      `);

      document.body.appendChild(modal);
      const exportBtn = modal.querySelector('[data-action="export"]');
      if (exportBtn) exportBtn.addEventListener('click', exportCsv);
    }

    function exportPipelineCsv() {
      const task = createTaskModal('Pipeline Export', 'Preparing pipeline export‚Ä¶');
      document.body.appendChild(task.overlay);

      callServer('getDetailedBranchPipeline', function(data) {
        const entries = (data && Array.isArray(data.entries)) ? data.entries : [];
        if (!entries.length) {
          task.done('No pipeline entries found.');
          task.addHtml('<p class="text-sm text-gray-600">There is nothing to export yet.</p>');
          return;
        }

        const header = ['Customer','Stage','Value','AE','Date'];
        const csv = [
          header.join(','),
          ...entries.map(e => ([
            String(e.customerName || '').replace(/"/g, '""'),
            String(e.stage || '').replace(/"/g, '""'),
            String(e.value || 0),
            String(e.aeName || '').replace(/"/g, '""'),
            String(e.date || '').replace(/"/g, '""')
          ].map(v => `"${v}"`).join(',')))
        ].join('\n');

        const fileName = `branch360-pipeline-${new Date().toISOString().slice(0,10)}.csv`;
        const ok = safeDownloadTextFile(fileName, csv, 'text/csv;charset=utf-8');
        if (ok) {
          task.done('Pipeline export ready. Download started.');
        } else {
          task.done('Pipeline export ready, but download was blocked.');
          task.addHtml('<p class="text-sm text-gray-600">Your browser may be blocking downloads in this environment. Try again in production.</p>');
        }
      }, { entries: [] });
    }

    function sendTeamMessage() {
      const message = prompt('Enter message to send to your team:');
      if (message && message.trim()) {
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                alert('Message sent to team successfully!');
              } else {
                alert('Failed to send message: ' + (result.message || 'Unknown error'));
              }
            })
            .withFailureHandler(function(error) {
              alert('Error sending message: ' + error.message);
            })
            .sendBranchTeamMessage(message);
        } else {
          alert('Team message: ' + message + ' (local mode - connect to backend API)');
        }
      }
    }

    // Additional Branch Manager Functions
    function viewSalesDetails() {
      callServer('getBranchSalesDetails', function(data) {
        const modal = createModal('Sales Details', `
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div><strong>Total TAP:</strong> ${data.totalTAP || 0}</div>
              <div><strong>Appointments:</strong> ${data.appointments || 0}</div>
              <div><strong>Quotes:</strong> ${data.quotes || 0}</div>
              <div><strong>Revenue:</strong> $${(data.revenue || 0).toLocaleString()}</div>
            </div>
            ${data.breakdown ? `
              <div class="mt-4">
                <h4 class="font-semibold mb-2">By AE:</h4>
                ${data.breakdown.map(ae => `
                  <p class="text-sm">${ae.name}: $${ae.revenue.toLocaleString()}</p>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `);
        document.body.appendChild(modal);
      }, { totalTAP: 0, appointments: 0, quotes: 0, revenue: 0, breakdown: [] });
    }

    function viewOpsDetails() {
      callServer('getBranchOpsDetails', function(data) {
        const modal = createModal('Operations Details', `
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div><strong>Missed Stops:</strong> ${data.missedStops || 0}</div>
              <div><strong>Backlog %:</strong> ${data.backlog || 0}%</div>
            </div>
          </div>
        `);
        document.body.appendChild(modal);
      }, { missedStops: 0, backlog: 0 });
    }

    function viewMetricDetail(metricType) {
      callServerCustom('getMetricDetails', { metricType: metricType }, function(data) {
        const modal = createModal(`${metricType} Details`, `
          <div class="space-y-4">
            <p><strong>Current Value:</strong> ${data.current || 0}</p>
            <p><strong>Target:</strong> ${data.target || 'N/A'}</p>
            <p><strong>Status:</strong> ${data.status || 'N/A'}</p>
            ${data.trend ? `<p><strong>Trend:</strong> ${data.trend}</p>` : ''}
          </div>
        `);
        document.body.appendChild(modal);
      }, { current: 0, target: 'N/A', status: 'Local Mode', trend: 'N/A' });
    }

    function viewPipelineStage(stage) {
      callServerCustom('getPipelineStageDetails', { stage: stage }, function(data) {
        const modal = createModal(`${stage} Stage Pipeline`, `
          <div class="space-y-4">
            ${data.entries && data.entries.length > 0 ? data.entries.map(entry => `
              <div class="border-l-4 border-blue-500 bg-gray-50 p-3 rounded">
                <p class="font-semibold">${entry.customerName}</p>
                <p class="text-sm text-gray-600">Value: $${entry.value.toLocaleString()}</p>
                <p class="text-xs text-gray-500">AE: ${entry.aeName}</p>
              </div>
            `).join('') : `<p class="text-gray-500">No entries in ${stage} stage</p>`}
          </div>
        `);
        document.body.appendChild(modal);
      }, { entries: [] });
    }

    function viewAEPerformance(userID) {
      callServerCustom('getAEPerformanceDetails', { userID: userID }, function(data) {
        const modal = createModal(`AE Performance: ${data.name}`, `
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div><strong>Month Sales:</strong> $${(data.monthSales || 0).toLocaleString()}</div>
              <div><strong>Month TAP:</strong> ${data.monthTAP || 0}</div>
              <div><strong>Month Quotes:</strong> ${data.monthQuotes || 0}</div>
              <div><strong>Win Rate:</strong> ${data.winRate || 0}%</div>
            </div>
          </div>
        `);
        document.body.appendChild(modal);
      }, { name: 'Demo AE', monthSales: 0, monthTAP: 0, monthQuotes: 0, winRate: 0 });
    }

    function viewTechPerformance(userID) {
      callServerCustom('getTechPerformanceDetails', { userID: userID }, function(data) {
        const modal = createModal(`Technician Performance: ${data.name}`, `
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div><strong>Leads Submitted:</strong> ${data.leadsSubmitted || 0}</div>
              <div><strong>Installs Completed:</strong> ${data.installsCompleted || 0}</div>
            </div>
          </div>
        `);
        document.body.appendChild(modal);
      }, { name: 'Demo Tech', leadsSubmitted: 0, installsCompleted: 0 });
    }

    function viewAlertDetails(alertType, alertID) {
      callServerCustom('getAlertDetails', { alertType: alertType, alertID: alertID }, function(data) {
        const modal = createModal('Alert Details', `
          <div class="space-y-4">
            <p><strong>Type:</strong> ${data.type || 'N/A'}</p>
            <p><strong>Message:</strong> ${data.message || 'N/A'}</p>
            <p><strong>Severity:</strong> ${data.severity || 'N/A'}</p>
            ${data.details ? `<p><strong>Details:</strong> ${data.details}</p>` : ''}
          </div>
        `);
        document.body.appendChild(modal);
      }, { type: alertType, message: 'Demo alert', severity: 'medium', details: 'Local mode' });
    }

    function resolveAlert(alertType, alertID) {
      const notes = prompt('Resolution notes:');
      if (notes === null || !notes.trim()) {
        if (notes !== null) alert('Please provide resolution notes.');
        return;
      }
      
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('Alert resolved successfully!');
              loadBranchKPIs();
            } else {
              alert('Failed to resolve alert: ' + (result.message || 'Unknown error'));
            }
          })
          .withFailureHandler(function(error) {
            alert('Error resolving alert: ' + error.message);
          })
          .resolveBranchAlert(alertType, alertID, notes);
      } else {
        alert('Alert resolved (local mode - connect to backend API)');
        loadBranchKPIs();
      }
    }

    function renderBranchSalesLeaderboard(team) {
      const container = document.getElementById('branchSalesLeaderboard');
      if (!container) return;
      if (!team || team.length === 0) {
        container.innerHTML = `
          <div class="text-sm text-gray-500">
            <p class="font-semibold text-gray-600">No sales team members found for this branch.</p>
            <p class="text-xs text-gray-500 mt-1">If this is unexpected, confirm users are assigned to this branch in <span class="font-semibold">Admin ‚Üí Users</span>.</p>
          </div>
        `;
        return;
      }
      container.innerHTML = team.map((ae, index) => `
        <div class="flex justify-between items-center p-3 ${index === 0 ? 'bg-yellow-900 bg-opacity-20' : 'bg-slate-700'} rounded mb-2 cursor-pointer hover:shadow-md transition" data-ae-id="${ae.email || ae.userID || ''}" data-action="view-ae">
          <div>
            <span class="font-semibold">${index + 1}. ${ae.name}</span>
            <p class="text-xs text-gray-600">TAP: ${ae.monthTAP} | Quotes: ${ae.monthQuotes}</p>
          </div>
          <div class="text-right">
            <p class="font-bold text-green-600">$${ae.monthSales.toLocaleString()}</p>
            <p class="text-xs text-gray-500">MTD</p>
          </div>
        </div>
      `).join('');
      
      container.querySelectorAll('[data-action="view-ae"]').forEach(function(el) {
        el.addEventListener('click', function() {
          const aeId = this.getAttribute('data-ae-id');
          if (aeId) viewAEPerformance(aeId);
        });
      });
    }

    function renderBranchOpsTeam(team) {
      const container = document.getElementById('branchOpsTeam');
      if (!container) return;
      if (!team || team.length === 0) {
        container.innerHTML = `
          <div class="text-sm text-gray-500">
            <p class="font-semibold text-gray-600">No operations team members found for this branch.</p>
            <p class="text-xs text-gray-500 mt-1">Add technicians/ops managers to the branch or verify branch IDs in the Users sheet.</p>
          </div>
        `;
        return;
      }
      container.innerHTML = team.map(tech => `
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded mb-2 cursor-pointer hover:shadow-md transition" data-tech-id="${tech.email || tech.userID || ''}" data-action="view-tech">
          <p class="font-semibold">${tech.name}</p>
          <div class="text-right text-sm">
            <p>Leads: ${tech.leadsSubmitted}</p>
            <p>Installs: ${tech.installsCompleted}</p>
          </div>
        </div>
      `).join('');
      
      container.querySelectorAll('[data-action="view-tech"]').forEach(function(el) {
        el.addEventListener('click', function() {
          const techId = this.getAttribute('data-tech-id');
          if (techId) viewTechPerformance(techId);
        });
      });
    }

    function renderBranchAlerts(alerts) {
      const container = document.getElementById('branchAlertsSection');
      if (!container) return;
      if (!alerts || alerts.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = `
        <div class="surface-card rounded-lg shadow p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">‚ö†Ô∏è Alerts (${alerts.length})</h3>
          ${alerts.map((alert, index) => `
            <div class="border-l-4 ${alert.severity === 'high' ? 'border-red-500 bg-red-50' : 'border-yellow-500 bg-yellow-50'} p-3 rounded mb-2 cursor-pointer hover:shadow-md transition" data-alert-index="${index}" data-action="view-alert">
              <div class="flex justify-between items-start">
                <p class="font-semibold text-gray-800">${alert.message}</p>
                <button data-resolve-index="${index}" data-action="resolve-alert" 
                  class="ml-2 text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">
                  Resolve
                </button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      window.currentBranchAlerts = alerts;
      
      container.querySelectorAll('[data-action="view-alert"]').forEach(function(el) {
        el.addEventListener('click', function(e) {
          if (e.target.closest('[data-action="resolve-alert"]')) return;
          const index = parseInt(this.getAttribute('data-alert-index'));
          const alert = window.currentBranchAlerts[index];
          if (alert) {
            const alertID = alert.data ? (alert.data.EntryID || alert.data.issueID || alert.data.packetID || '') : '';
            viewAlertDetails(alert.type, alertID);
          }
        });
      });
      
      container.querySelectorAll('[data-action="resolve-alert"]').forEach(function(el) {
        el.addEventListener('click', function(e) {
          e.stopPropagation();
          const index = parseInt(this.getAttribute('data-resolve-index'));
          const alert = window.currentBranchAlerts[index];
          if (alert) {
            const alertID = alert.data ? (alert.data.EntryID || alert.data.issueID || alert.data.packetID || '') : '';
            resolveAlert(alert.type, alertID);
          }
        });
      });
    }

    function escapeHtml(value) {
      return String(value == null ? '' : value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function safeDownloadTextFile(filename, content, mimeType) {
      try {
        const blob = new Blob([content], { type: mimeType || 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename || 'download.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        return true;
      } catch (e) {
        console.warn('Download failed', e);
        return false;
      }
    }

    function createModal(title, content, options = {}) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      overlay.setAttribute('role', 'dialog');
      overlay.setAttribute('aria-modal', 'true');
      overlay.setAttribute('tabindex', '-1');

      const modal = document.createElement('div');
      modal.className = 'bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto';
      modal.onclick = function(e) { e.stopPropagation(); };

      const titleId = 'b360-modal-title-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
      overlay.setAttribute('aria-labelledby', titleId);

      modal.innerHTML = `
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800" id="${titleId}">${escapeHtml(title)}</h3>
          <button type="button" data-modal-close class="text-gray-500 hover:text-gray-700 text-2xl" aria-label="Close modal">&times;</button>
        </div>
        ${content}
      `;

      overlay.appendChild(modal);

      const close = () => {
        overlay.remove();
        document.removeEventListener('keydown', escHandler);
        if (options.onClose) options.onClose();
      };

      overlay.onclick = function(e) {
        if (e.target === overlay && options.closeOnBackdrop !== false) close();
      };

      const closeBtn = overlay.querySelector('[data-modal-close]');
      if (closeBtn) closeBtn.addEventListener('click', close);

      const escHandler = (e) => {
        if (e.key === 'Escape') close();
      };
      document.addEventListener('keydown', escHandler);

      // Focus management
      setTimeout(() => {
        (closeBtn || overlay).focus();
      }, 0);

      return overlay;
    }

    function createTaskModal(title, initialStatus) {
      const modalId = 'b360-task-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
      const overlay = createModal(title, `
        <div class="flex items-start gap-3">
          <div class="b360-spinner" aria-hidden="true"></div>
          <div class="flex-1">
            <p id="${modalId}-status" class="text-sm text-gray-600">${escapeHtml(initialStatus || 'Working...')}</p>
            <div id="${modalId}-details" class="mt-3 space-y-2"></div>
          </div>
        </div>
      `, { closeOnBackdrop: false });

      const statusEl = overlay.querySelector('#' + modalId + '-status');
      const detailsEl = overlay.querySelector('#' + modalId + '-details');
      const spinnerEl = overlay.querySelector('.b360-spinner');

      const api = {
        overlay,
        setStatus: (text) => { if (statusEl) statusEl.textContent = text || ''; },
        addHtml: (html) => { if (detailsEl) detailsEl.insertAdjacentHTML('beforeend', html); },
        done: (finalText) => {
          if (spinnerEl) spinnerEl.style.display = 'none';
          if (finalText) api.setStatus(finalText);
        }
      };

      return api;
    }

    // Set up branch manager button event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const btnGenerate = document.getElementById('btn-generate-report');
      if (btnGenerate) btnGenerate.addEventListener('click', generateDailyReport);
      
      const btnTrends = document.getElementById('btn-weekly-trends');
      if (btnTrends) btnTrends.addEventListener('click', viewWeeklyTrends);
      
      const btnExport = document.getElementById('btn-export-data');
      if (btnExport) btnExport.addEventListener('click', exportBranchData);
      
      const btnPipeline = document.getElementById('btn-detailed-pipeline');
      if (btnPipeline) btnPipeline.addEventListener('click', viewDetailedPipeline);

      const btnPipelineExport = document.getElementById('btn-export-pipeline');
      if (btnPipelineExport) btnPipelineExport.addEventListener('click', exportPipelineCsv);
      
      const btnMessage = document.getElementById('btn-team-message');
      if (btnMessage) btnMessage.addEventListener('click', sendTeamMessage);

      const btnSalesDetails = document.getElementById('btn-sales-details');
      if (btnSalesDetails) btnSalesDetails.addEventListener('click', viewSalesDetails);

      const btnOpsDetails = document.getElementById('btn-ops-details');
      if (btnOpsDetails) btnOpsDetails.addEventListener('click', viewOpsDetails);

      const btnPipelineAll = document.getElementById('btn-pipeline-all');
      if (btnPipelineAll) btnPipelineAll.addEventListener('click', viewDetailedPipeline);

      // Make metric cards clickable (delegated event listener)
      document.addEventListener('click', function(e) {
        const metricEl = e.target.closest('.metric-clickable');
        if (metricEl) {
          const metric = metricEl.getAttribute('data-metric');
          if (metric) viewMetricDetail(metric);
          return;
        }
        
        // Pipeline stage handlers
        const stageEl = e.target.closest('.pipeline-stage');
        if (stageEl) {
          const stage = stageEl.getAttribute('data-stage');
          if (stage) viewPipelineStage(stage);
          return;
        }
      });
    });

    applyBrandStylesFromKey(window.currentBrand, mockBrandPresets());

    ['branchSelect','startDate','endDate','aeFilter','serviceFilter'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => {
        loadBranchKPIs();
        loadMarketKPIs();
        loadTimeSaved();
        loadPilotReport();
        territoryLoaded = false;
        loadRouteView(true);
      });
    });

    let pilotChart;
    let pilotSort = 'hours';
    let pilotDataCache = null;
    let territoryDataCache = [];
    let prospectDataCache = [];
    let selectedTerritory = null;
    let prospectsFiltered = [];
    let territoryLoaded = false;
    let prospectSearchTerm = '';
    let activeView = 'branch';
    let latestBranchKPIs = null;
    let latestTimeAnalytics = null;

    document.getElementById('refreshBtn').addEventListener('click', () => {
      loadBranchKPIs();
      loadMarketKPIs();
      loadTimeSaved();
      loadPilotReport();
      territoryLoaded = false;
      loadRouteView(true);
      loadHandoffQueue();
      loadSettingsView();
    });
    document.getElementById('branchExportBtn').addEventListener('click', exportBranchReport);

    document.getElementById('pilotRunBtn').addEventListener('click', loadPilotReport);
    document.getElementById('pilotSortHours').addEventListener('click', () => {
      pilotSort = 'hours';
      renderPilotTable();
    });
    document.getElementById('pilotSortDollars').addEventListener('click', () => {
      pilotSort = 'dollars';
      renderPilotTable();
    });
    const pilotSortActivitiesBtn = document.getElementById('pilotSortActivities');
    if (pilotSortActivitiesBtn) {
      pilotSortActivitiesBtn.addEventListener('click', () => {
        pilotSort = 'activities';
        renderPilotTable();
      });
    }
    ['pilotStart','pilotEnd','pilotRole'].forEach(id => {
      document.getElementById(id).addEventListener('change', loadPilotReport);
    });
    
    // Pilot report action buttons
    const pilotExportBtn = document.getElementById('pilotExportBtn');
    if (pilotExportBtn) {
      pilotExportBtn.addEventListener('click', function() {
        if (!pilotDataCache || !pilotDataCache.rows) {
          alert('Please run the report first before exporting.');
          return;
        }
        const csv = convertPilotDataToCSV(pilotDataCache);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = '90-day-pilot-report-' + new Date().toISOString().slice(0, 10) + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }
    
    const pilotPrintBtn = document.getElementById('pilotPrintBtn');
    if (pilotPrintBtn) {
      pilotPrintBtn.addEventListener('click', function() {
        window.print();
      });
    }
    
    const pilotEmailBtn = document.getElementById('pilotEmailBtn');
    if (pilotEmailBtn) {
      pilotEmailBtn.addEventListener('click', function() {
        if (!pilotDataCache || !pilotDataCache.rows) {
          alert('Please run the report first before emailing.');
          return;
        }
        const emailSubject = encodeURIComponent('90-Day Pilot Report - ' + new Date().toLocaleDateString());
        const emailBody = encodeURIComponent('Please find the attached 90-day pilot report.');
        const csv = convertPilotDataToCSV(pilotDataCache);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const emailLink = 'mailto:?subject=' + emailSubject + '&body=' + emailBody;
        // Note: Attachments via mailto: are limited. In production, use a server-side email API.
        alert('Email functionality: In production, this will send the report via email API. For now, please use the export button and attach manually.');
        URL.revokeObjectURL(url);
      });
    }
    
    const pilotResetBtn = document.getElementById('pilotResetBtn');
    if (pilotResetBtn) {
      pilotResetBtn.addEventListener('click', function() {
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), 1);
        document.getElementById('pilotStart').value = start.toISOString().slice(0, 10);
        document.getElementById('pilotEnd').value = now.toISOString().slice(0, 10);
        document.getElementById('pilotRole').value = '';
        loadPilotReport();
      });
    }
    
    function convertPilotDataToCSV(data) {
      const headers = ['User', 'Role', 'Activities', 'Hours Saved', 'Hours Spent', 'Avg Duration (min)', '$ Value'];
      const rows = (data.rows || []).map(row => [
        row.name || '',
        row.role || '',
        row.activities || 0,
        (row.hoursSaved || 0).toFixed(1),
        (row.hoursSpent || 0).toFixed(1),
        row.avgDurationMinutes ? row.avgDurationMinutes.toFixed(1) : '0',
        (row.dollarsSaved || 0).toFixed(2)
      ]);
      const csvRows = [headers.join(','), ...rows.map(row => row.map(cell => '"' + String(cell).replace(/"/g, '""') + '"').join(','))];
      return csvRows.join('\n');
    }
    
    // Handoff queue refresh button
    const handoffRefreshBtn = document.getElementById('handoffRefreshBtn');
    if (handoffRefreshBtn) {
      handoffRefreshBtn.addEventListener('click', loadHandoffQueue);
    }
    
    // Route & Prospects import to Sales AE button
    const routeImportToAEBtn = document.getElementById('routeImportToAEBtn');
    if (routeImportToAEBtn) {
      routeImportToAEBtn.addEventListener('click', function() {
        if (!selectedTerritory || !prospectsFiltered || prospectsFiltered.length === 0) {
          alert('Please select a territory and ensure prospects are visible before importing to Sales AE.');
          return;
        }
        
        // Switch to AE view
        const aeViewButton = document.querySelector('[data-view="ae"]');
        if (aeViewButton) {
          aeViewButton.click();
        }
        
        // Show notification
        setTimeout(function() {
          alert('Prospects from ' + selectedTerritory.name + ' are now available in the Sales AE dashboard. You can use "Load from Calendar" or filter by zip code to view them.');
        }, 500);
      });
    }

    // Settings event listeners
    const settingsInputs = [
      'settingCompactView', 'settingDarkMode', 'settingShowDollarValues',
      'settingEmailNotifications', 'settingBrowserNotifications', 'settingSuccessToasts',
      'settingIncludeCharts', 'settingAutoSaveDrafts'
    ];
    settingsInputs.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('change', function() {
          if (id === 'settingCompactView') {
            applyCompactView(this.checked);
          } else if (id === 'settingDarkMode') {
            applyDarkMode(this.checked);
          }
          saveUISettings();
        });
      }
    });
    ['settingRefreshInterval', 'settingItemsPerPage', 'settingExportFormat'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('change', saveUISettings);
      }
    });
    const clearCacheBtn = document.getElementById('settingClearCache');
    if (clearCacheBtn) {
      clearCacheBtn.addEventListener('click', clearLocalCache);
    }
    const resetDefaultsBtn = document.getElementById('settingResetDefaults');
    if (resetDefaultsBtn) {
      resetDefaultsBtn.addEventListener('click', resetSettingsToDefaults);
    }
    const backupSettingsBtn = document.getElementById('settingBackupSettings');
    if (backupSettingsBtn) {
      backupSettingsBtn.addEventListener('click', backupSettings);
    }

    // Default dates: current month & pilot range (90 days)
    function populateServiceFilterOptions() {
      if (!window.Branch360Options) return;
      const filter = document.getElementById('serviceFilter');
      if (!filter) return;
      const existingValues = new Set(Array.from(filter.options).map(opt => opt.value));
      window.Branch360Options.serviceTypes.forEach(function(type) {
        if (!existingValues.has(type)) {
          const opt = document.createElement('option');
          opt.value = type;
          opt.textContent = type;
          filter.appendChild(opt);
        }
      });
    }

    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    document.getElementById('startDate').value = start.toISOString().slice(0, 10);
    document.getElementById('endDate').value = now.toISOString().slice(0, 10);

    const pilotEnd = document.getElementById('pilotEnd');
    const pilotStart = document.getElementById('pilotStart');
    pilotEnd.value = now.toISOString().slice(0, 10);
    const ninetyDaysAgo = new Date(now.getTime() - 89 * 86400000);
    pilotStart.value = ninetyDaysAgo.toISOString().slice(0, 10);

    populateServiceFilterOptions();
    initializeDemoUser();
    loadBranchKPIs();
    loadMarketKPIs();
    loadTimeSaved();
    loadPilotReport();
    loadRouteView();
    updatePricingHelper();
    loadHandoffQueue();
    loadSettingsView();

    // Handle navigation messages from iframes
    window.addEventListener('message', function(event) {
      // Handle navigation to tech dashboard
      if (event.data && event.data.type === 'NAVIGATE_TO_TECH_DASHBOARD') {
        showView('tech');
      }
      // Handle navigation to tech lead form
      if (event.data && event.data.type === 'NAVIGATE_TO_TECH_LEAD_FORM') {
        showView('tech');
        // The tech dashboard iframe will handle opening the lead form
      }
    });
  </script>

</body>
</html>
