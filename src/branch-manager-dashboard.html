<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563EB">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Branch360">
  <link rel="manifest" href="manifest.json">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* Force dark theme globally */
    * { box-sizing: border-box; }
    html { background: #1e293b !important; }
    
    /* Dark theme styles (default) */
    body { background: #1e293b !important; color: #f1f5f9; }
    .bg-white { background: #334155 !important; }
    .bg-gray-50, .bg-gray-100 { background: #334155 !important; }
    .bg-blue-50 { background: rgba(37, 99, 235, 0.2) !important; }
    .bg-yellow-50 { background: rgba(234, 179, 8, 0.2) !important; }
    .bg-green-50 { background: rgba(34, 197, 94, 0.2) !important; }
    .bg-red-50 { background: rgba(239, 68, 68, 0.2) !important; }
    .bg-indigo-50 { background: rgba(67, 56, 202, 0.2) !important; }
    .text-gray-800, .text-gray-900 { color: #f1f5f9 !important; }
    .text-gray-600, .text-gray-700 { color: #cbd5e1 !important; }
    .text-gray-500 { color: #94a3b8 !important; }
    .text-gray-400 { color: #64748b !important; }
    .border, .border-gray-200 { border-color: #475569 !important; }
    input, select, textarea {
      background: #334155 !important; color: #f1f5f9 !important; border-color: #475569 !important;
    }
    .shadow, .shadow-sm, .shadow-lg {
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 1px 2px 0 rgba(0, 0, 0, 0.3);
    }
    
    /* Dark mode styles for legacy compatibility */
    body.dark-mode { background: #1e293b; color: #f1f5f9; }
    body.dark-mode nav { background: #334155; border-color: #475569; }
    body.dark-mode .bg-white { background: #334155 !important; }
    body.dark-mode .text-gray-800, body.dark-mode .text-gray-900 { color: #f1f5f9 !important; }
    body.dark-mode .text-gray-600, body.dark-mode .text-gray-700 { color: #cbd5e1 !important; }
    body.dark-mode .text-gray-500 { color: #94a3b8 !important; }
    body.dark-mode .text-gray-400 { color: #64748b !important; }
    body.dark-mode .border, body.dark-mode .border-gray-200 { border-color: #475569 !important; }
    body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
      background: #334155 !important; color: #f1f5f9 !important; border-color: #475569 !important;
    }
    body.dark-mode .shadow, body.dark-mode .shadow-sm, body.dark-mode .shadow-lg {
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 1px 2px 0 rgba(0, 0, 0, 0.3);
    }
    
    :root {
      --brand-primary: #2563eb;
      --brand-accent: #60a5fa;
      --brand-dark: #0f172a;
    }
    
    /* Navigation sidebar styles matching unified dashboard */
    .nav-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 256px;
      background: linear-gradient(180deg, var(--brand-dark) 0%, #1f2a3f 100%);
      border-right: 1px solid #334155;
      overflow-y: auto;
      z-index: 1000;
      padding: 1rem;
    }
    .nav-button {
      color: rgba(255, 255, 255, 0.85);
      background-color: rgba(15, 23, 42, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
      width: 100%;
      text-align: left;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-weight: 600;
      margin: 0.25rem 0;
    }
    .nav-button:hover {
      background-color: rgba(255, 255, 255, 0.18);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.3);
    }
    .nav-button.active {
      background-color: var(--brand-primary);
      color: #ffffff;
      font-weight: 700;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.25);
      border-color: transparent;
    }
    .main-with-sidebar {
      margin-left: 256px;
    }
  </style>
</head>
<body style="background: #1e293b;">

<!-- Apply theme from parent or localStorage -->
<script>
  (function() {
    try {
      const savedTheme = window.localStorage ? window.localStorage.getItem('branch360Theme') : null;
      if (savedTheme === 'dark' || document.documentElement.classList.contains('dark-mode')) {
        document.body.classList.add('dark-mode', 'bg-gray-900');
        document.body.classList.remove('bg-gray-50');
      }
    } catch(e) {
      console.log('Theme init:', e);
    }
    
    // Hide sidebar when loaded in iframe (unified dashboard already has sidebar)
    if (window.self !== window.top) {
      const style = document.createElement('style');
      style.textContent = `
        .nav-sidebar { display: none !important; }
        .main-with-sidebar { margin-left: 0 !important; }
      `;
      document.head.appendChild(style);
    }
  })();
</script>

<!-- Navigation Sidebar -->
<aside class="nav-sidebar space-y-2">
  <div class="flex items-center gap-3 pb-6 border-b border-white/10 mb-4">
    <img src="https://ik.imagekit.io/9cyexhymf/Presto-X%20Logo-ARentokilCompany.png?updatedAt=1762540113819" alt="Branch360" class="w-12 h-12 object-contain bg-white rounded-lg p-1 shadow" />
    <div>
      <div class="text-xl font-bold text-white">Branch360</div>
      <p class="text-xs text-white/70">Unified Pilot Dashboard</p>
    </div>
  </div>
  <button class="nav-button" onclick="window.location.href='?view=ae'">Sales / AE</button>
  <button class="nav-button" onclick="window.location.href='?view=ae'" style="padding-left: 1.5rem; font-size: 0.9rem; background: rgba(15, 23, 42, 0.25);">üìã Leads</button>
  <button class="nav-button" onclick="window.location.href='?view=tech'">Technician</button>
  <button class="nav-button" onclick="window.location.href='?view=ops'">Operations</button>
  <button class="nav-button active" onclick="window.location.href='?view=branch'">Branch Manager</button>
  <button class="nav-button" onclick="window.location.href='?view=admin'" style="background: rgba(124, 58, 237, 0.3); border-color: rgba(124, 58, 237, 0.5);">üîê Admin Dashboard</button>
  <button class="nav-button" onclick="window.location.href='?view=market'">Market Director</button>
  <button class="nav-button" onclick="window.location.href='?view=time'">Time Saved</button>
  <button class="nav-button" onclick="window.location.href='?view=pilot'">90-Day Pilot Report</button>
  <button class="nav-button" onclick="window.location.href='?view=handoff'">Sales ‚Üí Ops Handoff</button>
  <button class="nav-button" onclick="window.location.href='?view=settings'">Settings</button>
</aside>

<!-- Main Content with Sidebar -->
<div class="main-with-sidebar">
  <nav class="bg-indigo-900 text-white p-4">
    <h1 class="text-xl font-bold">Branch Manager Dashboard</h1>
    <p class="text-sm opacity-75" id="managerName">Loading...</p>
  </nav>

  <div class="w-full px-6 py-6">
  
  <!-- Action Buttons -->
  <div class="mb-6 flex flex-wrap gap-3">
    <button id="btn-generate-report" aria-label="Generate daily report"
      class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">
      üìä Generate Daily Report
    </button>
    <button id="btn-weekly-trends" aria-label="View weekly trends"
      class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">
      üìà View Weekly Trends
    </button>
    <button id="btn-export-data" aria-label="Export data"
      class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">
      üíæ Export Data
    </button>
    <button id="btn-detailed-pipeline" aria-label="View detailed pipeline"
      class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">
      üíº Detailed Pipeline
    </button>
    <button id="btn-export-pipeline" aria-label="Export pipeline data"
      class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">
      üì§ Pipeline Export
    </button>
    <button id="btn-team-message" 
      class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">
      üí¨ Team Message
    </button>
  </div>

  <!-- Today's Summary -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold text-gray-800">üìà Sales Today</h2>
        <button id="btn-sales-details" class="text-sm text-blue-600 hover:underline cursor-pointer">View Details ‚Üí</button>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="TAP" title="Click for details">
          <p class="text-sm text-gray-600">TAP</p>
          <p class="text-3xl font-bold text-blue-600" id="todayTAP">0</p>
        </div>
        <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="Appointments" title="Click for details">
          <p class="text-sm text-gray-600">Appointments</p>
          <p class="text-3xl font-bold text-green-600" id="todayAppts">0</p>
        </div>
        <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="Quotes" title="Click for details">
          <p class="text-sm text-gray-600">Quotes</p>
          <p class="text-3xl font-bold text-purple-600" id="todayQuotes">0</p>
        </div>
        <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="Revenue" title="Click for details">
          <p class="text-sm text-gray-600">Revenue</p>
          <p class="text-3xl font-bold text-emerald-600">$<span id="todayRevenue">0</span></p>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold text-gray-800">üîß Operations Today</h2>
        <button id="btn-ops-details" class="text-sm text-blue-600 hover:underline cursor-pointer">View Details ‚Üí</button>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="MissedStops" title="Click for details">
          <p class="text-sm text-gray-600">Missed Stops</p>
          <p class="text-3xl font-bold text-red-600" id="todayMissedStops">0</p>
        </div>
        <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="Backlog" title="Click for details">
          <p class="text-sm text-gray-600">Backlog %</p>
          <p class="text-3xl font-bold text-yellow-600"><span id="todayBacklog">0</span>%</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Alerts -->
  <div id="alertsSection" class="mb-6"></div>
  
  <!-- Team Performance -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">üèÜ Sales Team Leaderboard</h3>
      <div id="salesLeaderboard">Loading...</div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">üë∑ Operations Team</h3>
      <div id="opsTeam">Loading...</div>
    </div>
  </div>
  
  <!-- Pipeline Overview -->
  <div class="bg-white rounded-lg shadow p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-gray-800">üíº Branch Pipeline</h3>
      <button id="btn-pipeline-all" class="text-sm text-blue-600 hover:underline cursor-pointer">View All ‚Üí</button>
    </div>
    <div class="grid grid-cols-3 gap-4">
      <div class="text-center p-4 bg-blue-50 rounded cursor-pointer hover:bg-blue-100 transition pipeline-stage" data-stage="Proposal">
        <p class="text-sm text-gray-600 mb-1">Proposal</p>
        <p class="text-2xl font-bold text-blue-600">$<span id="pipelineProposal">0</span></p>
      </div>
      <div class="text-center p-4 bg-yellow-50 rounded cursor-pointer hover:bg-yellow-100 transition pipeline-stage" data-stage="Negotiation">
        <p class="text-sm text-gray-600 mb-1">Negotiation</p>
        <p class="text-2xl font-bold text-yellow-600">$<span id="pipelineNegotiation">0</span></p>
      </div>
      <div class="text-center p-4 bg-green-50 rounded cursor-pointer hover:bg-green-100 transition pipeline-stage" data-stage="Sold">
        <p class="text-sm text-gray-600 mb-1">Sold</p>
        <p class="text-2xl font-bold text-green-600">$<span id="pipelineSold">0</span></p>
      </div>
    </div>
  </div>
  
</div>

<script>
  var dashboardData = {};
  var currentBranchID = '';

  function loadDashboard() {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          dashboardData = data;
          currentBranchID = data.user.branchID;
          
          document.getElementById('managerName').textContent = data.user.name;
          
          // Today's summary
          document.getElementById('todayTAP').textContent = data.todaySummary.sales.tap;
          document.getElementById('todayAppts').textContent = data.todaySummary.sales.appointments;
          document.getElementById('todayQuotes').textContent = data.todaySummary.sales.quotes;
          document.getElementById('todayRevenue').textContent = data.todaySummary.sales.revenue.toLocaleString();
          document.getElementById('todayMissedStops').textContent = data.todaySummary.operations.missedStops;
          document.getElementById('todayBacklog').textContent = data.todaySummary.operations.backlog;
          
          // Pipeline
          document.getElementById('pipelineProposal').textContent = data.pipeline.proposal.toLocaleString();
          document.getElementById('pipelineNegotiation').textContent = data.pipeline.negotiation.toLocaleString();
          document.getElementById('pipelineSold').textContent = data.pipeline.sold.toLocaleString();
          
          // Teams
          renderSalesLeaderboard(data.salesTeam);
          renderOpsTeam(data.opsTeam);
          renderAlerts(data.alerts);
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load dashboard:', error);
          alert('Failed to load dashboard: ' + error.message);
        })
        .getBranchManagerDashboard();
    } else {
      // Local mode - use demo data
      dashboardData = {
        user: { name: 'Demo Branch Manager', branchID: 'BRN-001' },
        todaySummary: { sales: { tap: 0, appointments: 0, quotes: 0, revenue: 0 }, operations: { missedStops: 0, backlog: 0 } },
        pipeline: { proposal: 0, negotiation: 0, sold: 0 },
        salesTeam: [],
        opsTeam: [],
        alerts: [],
        weekTrends: { thisWeek: 0, lastWeek: 0, change: 0 }
      };
      document.getElementById('managerName').textContent = 'Demo Branch Manager';
      renderSalesLeaderboard([]);
      renderOpsTeam([]);
      renderAlerts([]);
    }
  }
  
  function renderSalesLeaderboard(team) {
    const container = document.getElementById('salesLeaderboard');
    if (team.length === 0) {
      container.innerHTML = `
        <div class="text-sm text-gray-500">
          <p class="font-semibold text-gray-600">No sales team members found for this branch.</p>
          <p class="text-xs text-gray-500 mt-1">Assign AEs to the branch in <span class="font-semibold">Admin ‚Üí Users</span> (or verify branch IDs in the Users sheet).</p>
        </div>
      `;
      return;
    }
    container.innerHTML = team.map((ae, index) => `
      <div class="flex justify-between items-center p-3 ${index === 0 ? 'bg-yellow-50' : 'bg-gray-50'} rounded mb-2 cursor-pointer hover:shadow-md transition" data-ae-id="${ae.email || ae.userID || ''}" data-action="view-ae">
        <div>
          <span class="font-semibold">${index + 1}. ${ae.name}</span>
          <p class="text-xs text-gray-600">TAP: ${ae.monthTAP} | Quotes: ${ae.monthQuotes}</p>
        </div>
        <div class="text-right">
          <p class="font-bold text-green-600">$${ae.monthSales.toLocaleString()}</p>
          <p class="text-xs text-gray-500">MTD</p>
        </div>
      </div>
    `).join('');
    
    // Add event listeners
    container.querySelectorAll('[data-action="view-ae"]').forEach(function(el) {
      el.addEventListener('click', function() {
        const aeId = this.getAttribute('data-ae-id');
        if (aeId) viewAEPerformance(aeId);
      });
    });
  }
  
  function renderOpsTeam(team) {
    const container = document.getElementById('opsTeam');
    if (team.length === 0) {
      container.innerHTML = `
        <div class="text-sm text-gray-500">
          <p class="font-semibold text-gray-600">No operations team members found for this branch.</p>
          <p class="text-xs text-gray-500 mt-1">Add technicians/ops managers to the branch or verify branch IDs in the Users sheet.</p>
        </div>
      `;
      return;
    }
    container.innerHTML = team.map(tech => `
      <div class="flex justify-between items-center p-3 bg-gray-50 rounded mb-2 cursor-pointer hover:shadow-md transition" data-tech-id="${tech.email || tech.userID || ''}" data-action="view-tech">
        <p class="font-semibold">${tech.name}</p>
        <div class="text-right text-sm">
          <p>Leads: ${tech.leadsSubmitted}</p>
          <p>Installs: ${tech.installsCompleted}</p>
        </div>
      </div>
    `).join('');
    
    // Add event listeners
    container.querySelectorAll('[data-action="view-tech"]').forEach(function(el) {
      el.addEventListener('click', function() {
        const techId = this.getAttribute('data-tech-id');
        if (techId) viewTechPerformance(techId);
      });
    });
  }
  
  function renderAlerts(alerts) {
    const container = document.getElementById('alertsSection');
    if (alerts.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    container.innerHTML = `
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">‚ö†Ô∏è Alerts (${alerts.length})</h3>
        ${alerts.map((alert, index) => `
          <div class="border-l-4 ${alert.severity === 'high' ? 'border-red-500 bg-red-50' : 'border-yellow-500 bg-yellow-50'} p-3 rounded mb-2 cursor-pointer hover:shadow-md transition" data-alert-index="${index}" data-action="view-alert">
            <div class="flex justify-between items-start">
              <p class="font-semibold text-gray-800">${alert.message}</p>
              <button data-resolve-index="${index}" data-action="resolve-alert" 
                class="ml-2 text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">
                Resolve
              </button>
            </div>
          </div>
        `).join('')}
      </div>
    `;
    
    // Store alerts for event handlers
    window.currentAlerts = alerts;
    
    // Add event listeners
    container.querySelectorAll('[data-action="view-alert"]').forEach(function(el) {
      el.addEventListener('click', function(e) {
        if (e.target.closest('[data-action="resolve-alert"]')) return; // Don't trigger on resolve button
        const index = parseInt(this.getAttribute('data-alert-index'));
        const alert = window.currentAlerts[index];
        if (alert) {
          const alertID = alert.data ? (alert.data.EntryID || alert.data.issueID || alert.data.packetID || '') : '';
          viewAlertDetails(alert.type, alertID);
        }
      });
    });
    
    container.querySelectorAll('[data-action="resolve-alert"]').forEach(function(el) {
      el.addEventListener('click', function(e) {
        e.stopPropagation();
        const index = parseInt(this.getAttribute('data-resolve-index'));
        const alert = window.currentAlerts[index];
        if (alert) {
          const alertID = alert.data ? (alert.data.EntryID || alert.data.issueID || alert.data.packetID || '') : '';
          resolveAlert(alert.type, alertID);
        }
      });
    });
  }
  
  var dashboardData = {};
  var currentBranchID = '';

  // Action Functions
  function generateDailyReport() {
    const confirmModal = createModal('Generate Daily Report', `
      <p class="text-sm text-gray-600 mb-4">Generate today‚Äôs branch cadence report. It may take a moment.</p>
      <div class="flex justify-end gap-3">
        <button type="button" data-action="cancel" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300">Cancel</button>
        <button type="button" data-action="run" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700">Generate</button>
      </div>
    `);
    document.body.appendChild(confirmModal);
    const cancelBtn = confirmModal.querySelector('[data-action="cancel"]');
    const runBtn = confirmModal.querySelector('[data-action="run"]');
    if (cancelBtn) cancelBtn.addEventListener('click', () => confirmModal.remove());
    if (runBtn) runBtn.addEventListener('click', () => {
      confirmModal.remove();
      const task = createTaskModal('Generating Daily Report', 'Starting report generation‚Ä¶');
      document.body.appendChild(task.overlay);

      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              task.done('Daily report generated.');
              if (result.summaryID) {
                task.addHtml(`<p class="text-sm text-gray-600"><span class="font-semibold">Summary ID:</span> <code class="bg-gray-100 px-1 rounded">${escapeHtml(result.summaryID)}</code></p>`);
              }
              loadDashboard();
            } else {
              task.done('Report generation failed.');
              task.addHtml(`<p class="text-sm text-red-600">${escapeHtml((result && result.message) ? result.message : 'Unknown error')}</p>`);
            }
          })
          .withFailureHandler(function(error) {
            task.done('Report generation failed.');
            task.addHtml(`<p class="text-sm text-red-600">${escapeHtml(error && error.message ? error.message : 'Unknown error')}</p>`);
          })
          .generateBranchDailyReport();
      } else {
        task.done('Not available in local/demo mode.');
        task.addHtml('<p class="text-sm text-gray-600">Connect the Apps Script backend to generate reports.</p>');
      }
    });
  }

  function viewWeeklyTrends() {
    const trends = dashboardData && dashboardData.weekTrends ? dashboardData.weekTrends : null;
    if (!trends) {
      const m = createModal('Weekly Trends', `<p class="text-sm text-gray-600">Weekly trends data is not available yet for this environment.</p>`);
      document.body.appendChild(m);
      return;
    }

    const change = parseFloat(trends.change) || 0;
    const changeSymbol = change >= 0 ? '‚Üë' : '‚Üì';
    const m = createModal('Weekly Trends', `
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
        <div class="bg-gray-50 rounded p-3"><div class="text-xs text-gray-500">This Week</div><div class="font-bold">$${(trends.thisWeek || 0).toLocaleString()}</div></div>
        <div class="bg-gray-50 rounded p-3"><div class="text-xs text-gray-500">Last Week</div><div class="font-bold">$${(trends.lastWeek || 0).toLocaleString()}</div></div>
        <div class="bg-gray-50 rounded p-3"><div class="text-xs text-gray-500">Change</div><div class="font-bold">${changeSymbol} ${Math.abs(change)}%</div></div>
      </div>
      <p class="text-xs text-gray-500 mt-2">${change >= 0 ? 'Sales are trending up.' : 'Sales are trending down. Review strategy.'}</p>
    `);
    document.body.appendChild(m);
  }

  function exportBranchData() {
    const confirmModal = createModal('Export Data', `
      <p class="text-sm text-gray-600 mb-4">Export branch data as a CSV download.</p>
      <div class="flex justify-end gap-3">
        <button type="button" data-action="cancel" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300">Cancel</button>
        <button type="button" data-action="run" class="px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700">Export CSV</button>
      </div>
    `);
    document.body.appendChild(confirmModal);
    const cancelBtn = confirmModal.querySelector('[data-action="cancel"]');
    const runBtn = confirmModal.querySelector('[data-action="run"]');
    if (cancelBtn) cancelBtn.addEventListener('click', () => confirmModal.remove());
    if (runBtn) runBtn.addEventListener('click', () => {
      confirmModal.remove();
      const task = createTaskModal('Exporting Data', 'Preparing export‚Ä¶');
      document.body.appendChild(task.overlay);

      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              // Try to open the file in a new tab (Drive preview link)
              if (result.url) {
                try { window.open(result.url, '_blank'); } catch (e) {}
                task.done('Export ready.');
                task.addHtml(`
                  <p class="text-sm text-gray-600">If your download didn‚Äôt start, use the link below:</p>
                  <a class="text-sm text-blue-600 hover:underline break-all" href="${escapeHtml(result.url)}" target="_blank" rel="noopener">Open export file</a>
                `);
              } else {
                task.done('Export completed.');
                task.addHtml('<p class="text-sm text-gray-600">The backend did not return a download link.</p>');
              }
            } else {
              task.done('Export failed.');
              task.addHtml(`<p class="text-sm text-red-600">${escapeHtml((result && result.message) ? result.message : 'Unknown error')}</p>`);
            }
          })
          .withFailureHandler(function(error) {
            task.done('Export failed.');
            task.addHtml(`<p class="text-sm text-red-600">${escapeHtml(error && error.message ? error.message : 'Unknown error')}</p>`);
          })
          .exportBranchManagerData();
      } else {
        task.done('Not available in local/demo mode.');
        task.addHtml('<p class="text-sm text-gray-600">Connect the Apps Script backend to export data.</p>');
      }
    });
  }

  function viewDetailedPipeline() {
    const task = createTaskModal('Detailed Pipeline', 'Loading pipeline entries‚Ä¶');
    document.body.appendChild(task.overlay);

    const onData = function(data) {
      task.overlay.remove();
      showPipelineModal(data || { entries: [] });
    };

    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(onData)
        .withFailureHandler(function(error) {
          task.done('Failed to load pipeline.');
          task.addHtml(`<p class="text-sm text-red-600">${escapeHtml(error && error.message ? error.message : 'Unknown error')}</p>`);
        })
        .getDetailedBranchPipeline();
    } else {
      onData({ entries: [] });
    }
  }

  function exportPipelineCsv() {
    const task = createTaskModal('Pipeline Export', 'Preparing pipeline export‚Ä¶');
    document.body.appendChild(task.overlay);

    const onData = function(data) {
      const entries = (data && Array.isArray(data.entries)) ? data.entries : [];
      if (!entries.length) {
        task.done('No pipeline entries found.');
        task.addHtml('<p class="text-sm text-gray-600">There is nothing to export yet.</p>');
        return;
      }

      const header = ['Customer','Stage','Value','AE','Date'];
      const csv = [
        header.join(','),
        ...entries.map(e => ([
          String(e.customerName || '').replace(/"/g, '""'),
          String(e.stage || '').replace(/"/g, '""'),
          String(e.value || 0),
          String(e.aeName || '').replace(/"/g, '""'),
          String(e.date || '').replace(/"/g, '""')
        ].map(v => `"${v}"`).join(',')))
      ].join('\n');

      const fileName = `branch360-pipeline-${new Date().toISOString().slice(0,10)}.csv`;
      const ok = safeDownloadTextFile(fileName, csv, 'text/csv;charset=utf-8');
      if (ok) {
        task.done('Pipeline export ready. Download started.');
      } else {
        task.done('Pipeline export ready, but download was blocked.');
        task.addHtml('<p class="text-sm text-gray-600">Your browser may be blocking downloads in this environment. Try again in production.</p>');
      }
    };

    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(onData)
        .withFailureHandler(function(error) {
          task.done('Pipeline export failed.');
          task.addHtml(`<p class="text-sm text-red-600">${escapeHtml(error && error.message ? error.message : 'Unknown error')}</p>`);
        })
        .getDetailedBranchPipeline();
    } else {
      onData({ entries: [] });
    }
  }

  function viewPipelineStage(stage) {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showPipelineStageModal(stage, data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading pipeline stage: ' + error.message);
        })
        .getPipelineStageDetails(stage);
    } else {
      showPipelineStageModal(stage, { entries: [] });
    }
  }

  function viewSalesDetails() {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showSalesDetailsModal(data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading sales details: ' + error.message);
        })
        .getBranchSalesDetails();
    } else {
      showSalesDetailsModal({ totalTAP: 0, appointments: 0, quotes: 0, revenue: 0, breakdown: [] });
    }
  }

  function viewOpsDetails() {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showOpsDetailsModal(data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading operations details: ' + error.message);
        })
        .getBranchOpsDetails();
    } else {
      showOpsDetailsModal({ missedStops: 0, backlog: 0 });
    }
  }

  function viewMetricDetail(metricType) {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showMetricDetailModal(metricType, data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading metric details: ' + error.message);
        })
        .getMetricDetails(metricType);
    } else {
      showMetricDetailModal(metricType, { 
        current: 0, 
        target: 'N/A', 
        status: 'Local Mode', 
        trend: 'N/A' 
      });
    }
  }

  function viewAEPerformance(userID) {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showAEPerformanceModal(data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading AE performance: ' + error.message);
        })
        .getAEPerformanceDetails(userID);
    } else {
      showAEPerformanceModal({ name: 'Demo AE', monthSales: 0, monthTAP: 0, monthQuotes: 0, winRate: 0 });
    }
  }

  function viewTechPerformance(userID) {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showTechPerformanceModal(data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading technician performance: ' + error.message);
        })
        .getTechPerformanceDetails(userID);
    } else {
      showTechPerformanceModal({ name: 'Demo Tech', leadsSubmitted: 0, installsCompleted: 0 });
    }
  }

  function viewAlertDetails(alertType, alertID) {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showAlertDetailsModal(data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading alert details: ' + error.message);
        })
        .getAlertDetails(alertType, alertID);
    } else {
      showAlertDetailsModal({ type: alertType, message: 'Demo alert', severity: 'medium', details: 'Local mode' });
    }
  }

  function resolveAlert(alertType, alertID) {
    const notes = prompt('Resolution notes:');
    if (notes === null || !notes.trim()) {
      if (notes !== null) alert('Please provide resolution notes.');
      return;
    }
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            alert('Alert resolved successfully!');
            loadDashboard();
          } else {
            alert('Failed to resolve alert: ' + (result.message || 'Unknown error'));
          }
        })
        .withFailureHandler(function(error) {
          alert('Error resolving alert: ' + error.message);
        })
        .resolveBranchAlert(alertType, alertID, notes);
    } else {
      alert('Alert resolved (local mode - connect to backend API)');
      loadDashboard();
    }
  }

  function sendTeamMessage() {
    const message = prompt('Enter message to send to your team:');
    if (message === null || !message.trim()) {
      if (message !== null) alert('Please enter a message.');
      return;
    }
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            alert('Message sent to team successfully!');
          } else {
            alert('Failed to send message: ' + (result.message || 'Unknown error'));
          }
        })
        .withFailureHandler(function(error) {
          alert('Error sending message: ' + error.message);
        })
        .sendBranchTeamMessage(message);
    } else {
      alert('Team message: ' + message + ' (local mode - connect to backend API)');
    }
  }

  // Modal Functions
  function showPipelineModal(data) {
    const modal = createModal('Detailed Pipeline', `
      <div class="space-y-4">
        ${data.entries && data.entries.length > 0 ? data.entries.map(entry => `
          <div class="border-l-4 border-blue-500 bg-gray-50 p-3 rounded">
            <p class="font-semibold">${entry.customerName}</p>
            <p class="text-sm text-gray-600">Stage: ${entry.stage} | Value: $${entry.value.toLocaleString()}</p>
            <p class="text-xs text-gray-500">AE: ${entry.aeName} | Date: ${entry.date}</p>
          </div>
        `).join('') : '<p class="text-gray-500">No pipeline entries found</p>'}
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showPipelineStageModal(stage, data) {
    const modal = createModal(`${stage} Stage Pipeline`, `
      <div class="space-y-4">
        ${data.entries && data.entries.length > 0 ? data.entries.map(entry => `
          <div class="border-l-4 border-blue-500 bg-gray-50 p-3 rounded">
            <p class="font-semibold">${entry.customerName}</p>
            <p class="text-sm text-gray-600">Value: $${entry.value.toLocaleString()}</p>
            <p class="text-xs text-gray-500">AE: ${entry.aeName}</p>
          </div>
        `).join('') : '<p class="text-gray-500">No entries in ${stage} stage</p>'}
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showSalesDetailsModal(data) {
    const modal = createModal('Sales Details', `
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><strong>Total TAP:</strong> ${data.totalTAP || 0}</div>
          <div><strong>Appointments:</strong> ${data.appointments || 0}</div>
          <div><strong>Quotes:</strong> ${data.quotes || 0}</div>
          <div><strong>Revenue:</strong> $${(data.revenue || 0).toLocaleString()}</div>
        </div>
        ${data.breakdown ? `
          <div class="mt-4">
            <h4 class="font-semibold mb-2">By AE:</h4>
            ${data.breakdown.map(ae => `
              <p class="text-sm">${ae.name}: $${ae.revenue.toLocaleString()}</p>
            `).join('')}
          </div>
        ` : ''}
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showOpsDetailsModal(data) {
    const modal = createModal('Operations Details', `
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><strong>Missed Stops:</strong> ${data.missedStops || 0}</div>
          <div><strong>Backlog %:</strong> ${data.backlog || 0}%</div>
        </div>
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showMetricDetailModal(metricType, data) {
    const modal = createModal(`${metricType} Details`, `
      <div class="space-y-4">
        <p><strong>Current Value:</strong> ${data.current || 0}</p>
        <p><strong>Target:</strong> ${data.target || 'N/A'}</p>
        <p><strong>Status:</strong> ${data.status || 'N/A'}</p>
        ${data.trend ? `<p><strong>Trend:</strong> ${data.trend}</p>` : ''}
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showAEPerformanceModal(data) {
    const modal = createModal(`AE Performance: ${data.name}`, `
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><strong>Month Sales:</strong> $${(data.monthSales || 0).toLocaleString()}</div>
          <div><strong>Month TAP:</strong> ${data.monthTAP || 0}</div>
          <div><strong>Month Quotes:</strong> ${data.monthQuotes || 0}</div>
          <div><strong>Win Rate:</strong> ${data.winRate || 0}%</div>
        </div>
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showTechPerformanceModal(data) {
    const modal = createModal(`Technician Performance: ${data.name}`, `
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><strong>Leads Submitted:</strong> ${data.leadsSubmitted || 0}</div>
          <div><strong>Installs Completed:</strong> ${data.installsCompleted || 0}</div>
        </div>
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showAlertDetailsModal(data) {
    const modal = createModal('Alert Details', `
      <div class="space-y-4">
        <p><strong>Type:</strong> ${data.type || 'N/A'}</p>
        <p><strong>Message:</strong> ${data.message || 'N/A'}</p>
        <p><strong>Severity:</strong> ${data.severity || 'N/A'}</p>
        ${data.details ? `<p><strong>Details:</strong> ${data.details}</p>` : ''}
      </div>
    `);
    document.body.appendChild(modal);
  }

  function escapeHtml(value) {
    return String(value == null ? '' : value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function safeDownloadTextFile(filename, content, mimeType) {
    try {
      const blob = new Blob([content], { type: mimeType || 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename || 'download.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      return true;
    } catch (e) {
      console.warn('Download failed', e);
      return false;
    }
  }

  function createModal(title, content, options = {}) {
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    overlay.setAttribute('role', 'dialog');
    overlay.setAttribute('aria-modal', 'true');
    overlay.setAttribute('tabindex', '-1');

    const modal = document.createElement('div');
    modal.className = 'bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto';
    modal.onclick = function(e) { e.stopPropagation(); };

    const titleId = 'b360-modal-title-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
    overlay.setAttribute('aria-labelledby', titleId);

    modal.innerHTML = `
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800" id="${titleId}">${escapeHtml(title)}</h3>
        <button type="button" data-modal-close class="text-gray-500 hover:text-gray-700 text-2xl" aria-label="Close modal">&times;</button>
      </div>
      ${content}
    `;

    overlay.appendChild(modal);

    const close = () => {
      overlay.remove();
      document.removeEventListener('keydown', escHandler);
      if (options.onClose) options.onClose();
    };

    overlay.onclick = function(e) {
      if (e.target === overlay && options.closeOnBackdrop !== false) close();
    };

    const closeBtn = overlay.querySelector('[data-modal-close]');
    if (closeBtn) closeBtn.addEventListener('click', close);

    const escHandler = (e) => {
      if (e.key === 'Escape') close();
    };
    document.addEventListener('keydown', escHandler);

    setTimeout(() => { (closeBtn || overlay).focus(); }, 0);
    return overlay;
  }

  function createTaskModal(title, initialStatus) {
    const modalId = 'b360-task-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
    const overlay = createModal(title, `
      <div class="flex items-start gap-3">
        <div class="b360-spinner" aria-hidden="true" style="width:22px;height:22px;border:3px solid rgba(148,163,184,0.35);border-top-color:rgba(37,99,235,1);border-radius:9999px;animation:b360-spin 0.8s linear infinite;"></div>
        <div class="flex-1">
          <p id="${modalId}-status" class="text-sm text-gray-600">${escapeHtml(initialStatus || 'Working...')}</p>
          <div id="${modalId}-details" class="mt-3 space-y-2"></div>
        </div>
      </div>
      <style>@keyframes b360-spin{to{transform:rotate(360deg);}}</style>
    `, { closeOnBackdrop: false });

    const statusEl = overlay.querySelector('#' + modalId + '-status');
    const detailsEl = overlay.querySelector('#' + modalId + '-details');
    const spinnerEl = overlay.querySelector('.b360-spinner');

    const api = {
      overlay,
      setStatus: (text) => { if (statusEl) statusEl.textContent = text || ''; },
      addHtml: (html) => { if (detailsEl) detailsEl.insertAdjacentHTML('beforeend', html); },
      done: (finalText) => {
        if (spinnerEl) spinnerEl.style.display = 'none';
        if (finalText) api.setStatus(finalText);
      }
    };

    return api;
  }

  // Set up event listeners for clickable elements
  function setupEventListeners() {
    // Action buttons
    const btnGenerate = document.getElementById('btn-generate-report');
    if (btnGenerate) btnGenerate.addEventListener('click', generateDailyReport);
    
    const btnTrends = document.getElementById('btn-weekly-trends');
    if (btnTrends) btnTrends.addEventListener('click', viewWeeklyTrends);
    
    const btnExport = document.getElementById('btn-export-data');
    if (btnExport) btnExport.addEventListener('click', exportBranchData);
    
    const btnPipeline = document.getElementById('btn-detailed-pipeline');
    if (btnPipeline) btnPipeline.addEventListener('click', viewDetailedPipeline);

    const btnPipelineExport = document.getElementById('btn-export-pipeline');
    if (btnPipelineExport) btnPipelineExport.addEventListener('click', exportPipelineCsv);
    
    const btnMessage = document.getElementById('btn-team-message');
    if (btnMessage) btnMessage.addEventListener('click', sendTeamMessage);
    
    const btnSalesDetails = document.getElementById('btn-sales-details');
    if (btnSalesDetails) btnSalesDetails.addEventListener('click', viewSalesDetails);
    
    const btnOpsDetails = document.getElementById('btn-ops-details');
    if (btnOpsDetails) btnOpsDetails.addEventListener('click', viewOpsDetails);
    
    const btnPipelineAll = document.getElementById('btn-pipeline-all');
    if (btnPipelineAll) btnPipelineAll.addEventListener('click', viewDetailedPipeline);
    
    // Metrics click handlers (delegated)
    document.addEventListener('click', function(e) {
      const metricEl = e.target.closest('.metric-clickable');
      if (metricEl) {
        const metric = metricEl.getAttribute('data-metric');
        if (metric) viewMetricDetail(metric);
        return;
      }
      
      // Pipeline stage handlers
      const stageEl = e.target.closest('.pipeline-stage');
      if (stageEl) {
        const stage = stageEl.getAttribute('data-stage');
        if (stage) viewPipelineStage(stage);
        return;
      }
    });
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupEventListeners);
  } else {
    setupEventListeners();
  }

  loadDashboard();
  setInterval(loadDashboard, 300000); // Refresh every 5 minutes
  
  // Register service worker for PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('service-worker.js')
        .then(function(registration) {
          console.log('ServiceWorker registration successful');
        })
        .catch(function(error) {
          console.log('ServiceWorker registration failed:', error);
        });
    });
  }
</script>

</div>
<!-- End main-with-sidebar -->

</body>
</html>

