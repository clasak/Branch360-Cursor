<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563EB">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Branch360">
  <link rel="manifest" href="manifest.json">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="notification-system.html"></script>
</head>
<body class="bg-gray-100">

<nav class="bg-indigo-900 text-white p-4">
  <h1 class="text-xl font-bold">Branch Manager Dashboard</h1>
  <p class="text-sm opacity-75" id="managerName">Loading...</p>
</nav>

<div class="max-w-7xl mx-auto px-4 py-6">
  
  <!-- Action Buttons -->
  <div class="mb-6 flex flex-wrap gap-3">
    <button id="btn-generate-report" 
      class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">
      üìä Generate Daily Report
    </button>
    <button id="btn-weekly-trends" 
      class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">
      üìà View Weekly Trends
    </button>
    <button id="btn-export-data" 
      class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">
      üíæ Export Data
    </button>
    <button id="btn-detailed-pipeline" 
      class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">
      üíº Detailed Pipeline
    </button>
    <button id="btn-team-message" 
      class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer">
      üí¨ Team Message
    </button>
  </div>

  <!-- Today's Summary -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold text-gray-800">üìà Sales Today</h2>
        <button id="btn-sales-details" class="text-sm text-blue-600 hover:underline cursor-pointer">View Details ‚Üí</button>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="TAP" title="Click for details">
          <p class="text-sm text-gray-600">TAP</p>
          <p class="text-3xl font-bold text-blue-600" id="todayTAP">0</p>
        </div>
        <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="Appointments" title="Click for details">
          <p class="text-sm text-gray-600">Appointments</p>
          <p class="text-3xl font-bold text-green-600" id="todayAppts">0</p>
        </div>
        <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="Quotes" title="Click for details">
          <p class="text-sm text-gray-600">Quotes</p>
          <p class="text-3xl font-bold text-purple-600" id="todayQuotes">0</p>
        </div>
        <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="Revenue" title="Click for details">
          <p class="text-sm text-gray-600">Revenue</p>
          <p class="text-3xl font-bold text-emerald-600">$<span id="todayRevenue">0</span></p>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold text-gray-800">üîß Operations Today</h2>
        <button id="btn-ops-details" class="text-sm text-blue-600 hover:underline cursor-pointer">View Details ‚Üí</button>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="MissedStops" title="Click for details">
          <p class="text-sm text-gray-600">Missed Stops</p>
          <p class="text-3xl font-bold text-red-600" id="todayMissedStops">0</p>
        </div>
        <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition metric-clickable" data-metric="Backlog" title="Click for details">
          <p class="text-sm text-gray-600">Backlog %</p>
          <p class="text-3xl font-bold text-yellow-600"><span id="todayBacklog">0</span>%</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Alerts -->
  <div id="alertsSection" class="mb-6"></div>
  
  <!-- Team Performance -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">üèÜ Sales Team Leaderboard</h3>
      <div id="salesLeaderboard">Loading...</div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">üë∑ Operations Team</h3>
      <div id="opsTeam">Loading...</div>
    </div>
  </div>
  
  <!-- Pipeline Overview -->
  <div class="bg-white rounded-lg shadow p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-gray-800">üíº Branch Pipeline</h3>
      <button id="btn-pipeline-all" class="text-sm text-blue-600 hover:underline cursor-pointer">View All ‚Üí</button>
    </div>
    <div class="grid grid-cols-3 gap-4">
      <div class="text-center p-4 bg-blue-50 rounded cursor-pointer hover:bg-blue-100 transition pipeline-stage" data-stage="Proposal">
        <p class="text-sm text-gray-600 mb-1">Proposal</p>
        <p class="text-2xl font-bold text-blue-600">$<span id="pipelineProposal">0</span></p>
      </div>
      <div class="text-center p-4 bg-yellow-50 rounded cursor-pointer hover:bg-yellow-100 transition pipeline-stage" data-stage="Negotiation">
        <p class="text-sm text-gray-600 mb-1">Negotiation</p>
        <p class="text-2xl font-bold text-yellow-600">$<span id="pipelineNegotiation">0</span></p>
      </div>
      <div class="text-center p-4 bg-green-50 rounded cursor-pointer hover:bg-green-100 transition pipeline-stage" data-stage="Sold">
        <p class="text-sm text-gray-600 mb-1">Sold</p>
        <p class="text-2xl font-bold text-green-600">$<span id="pipelineSold">0</span></p>
      </div>
    </div>
  </div>
  
</div>

<script>
  var dashboardData = {};
  var currentBranchID = '';

  function loadDashboard() {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          dashboardData = data;
          currentBranchID = data.user.branchID;
          
          document.getElementById('managerName').textContent = data.user.name;
          
          // Today's summary
          document.getElementById('todayTAP').textContent = data.todaySummary.sales.tap;
          document.getElementById('todayAppts').textContent = data.todaySummary.sales.appointments;
          document.getElementById('todayQuotes').textContent = data.todaySummary.sales.quotes;
          document.getElementById('todayRevenue').textContent = data.todaySummary.sales.revenue.toLocaleString();
          document.getElementById('todayMissedStops').textContent = data.todaySummary.operations.missedStops;
          document.getElementById('todayBacklog').textContent = data.todaySummary.operations.backlog;
          
          // Pipeline
          document.getElementById('pipelineProposal').textContent = data.pipeline.proposal.toLocaleString();
          document.getElementById('pipelineNegotiation').textContent = data.pipeline.negotiation.toLocaleString();
          document.getElementById('pipelineSold').textContent = data.pipeline.sold.toLocaleString();
          
          // Teams
          renderSalesLeaderboard(data.salesTeam);
          renderOpsTeam(data.opsTeam);
          renderAlerts(data.alerts);
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load dashboard:', error);
          alert('Failed to load dashboard: ' + error.message);
        })
        .getBranchManagerDashboard();
    } else {
      // Local mode - use demo data
      dashboardData = {
        user: { name: 'Demo Branch Manager', branchID: 'BRN-001' },
        todaySummary: { sales: { tap: 0, appointments: 0, quotes: 0, revenue: 0 }, operations: { missedStops: 0, backlog: 0 } },
        pipeline: { proposal: 0, negotiation: 0, sold: 0 },
        salesTeam: [],
        opsTeam: [],
        alerts: [],
        weekTrends: { thisWeek: 0, lastWeek: 0, change: 0 }
      };
      document.getElementById('managerName').textContent = 'Demo Branch Manager';
      renderSalesLeaderboard([]);
      renderOpsTeam([]);
      renderAlerts([]);
    }
  }
  
  function renderSalesLeaderboard(team) {
    const container = document.getElementById('salesLeaderboard');
    if (team.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-sm">No sales team members found</p>';
      return;
    }
    container.innerHTML = team.map((ae, index) => `
      <div class="flex justify-between items-center p-3 ${index === 0 ? 'bg-yellow-50' : 'bg-gray-50'} rounded mb-2 cursor-pointer hover:shadow-md transition" data-ae-id="${ae.email || ae.userID || ''}" data-action="view-ae">
        <div>
          <span class="font-semibold">${index + 1}. ${ae.name}</span>
          <p class="text-xs text-gray-600">TAP: ${ae.monthTAP} | Quotes: ${ae.monthQuotes}</p>
        </div>
        <div class="text-right">
          <p class="font-bold text-green-600">$${ae.monthSales.toLocaleString()}</p>
          <p class="text-xs text-gray-500">MTD</p>
        </div>
      </div>
    `).join('');
    
    // Add event listeners
    container.querySelectorAll('[data-action="view-ae"]').forEach(function(el) {
      el.addEventListener('click', function() {
        const aeId = this.getAttribute('data-ae-id');
        if (aeId) viewAEPerformance(aeId);
      });
    });
  }
  
  function renderOpsTeam(team) {
    const container = document.getElementById('opsTeam');
    if (team.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-sm">No operations team members found</p>';
      return;
    }
    container.innerHTML = team.map(tech => `
      <div class="flex justify-between items-center p-3 bg-gray-50 rounded mb-2 cursor-pointer hover:shadow-md transition" data-tech-id="${tech.email || tech.userID || ''}" data-action="view-tech">
        <p class="font-semibold">${tech.name}</p>
        <div class="text-right text-sm">
          <p>Leads: ${tech.leadsSubmitted}</p>
          <p>Installs: ${tech.installsCompleted}</p>
        </div>
      </div>
    `).join('');
    
    // Add event listeners
    container.querySelectorAll('[data-action="view-tech"]').forEach(function(el) {
      el.addEventListener('click', function() {
        const techId = this.getAttribute('data-tech-id');
        if (techId) viewTechPerformance(techId);
      });
    });
  }
  
  function renderAlerts(alerts) {
    const container = document.getElementById('alertsSection');
    if (alerts.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    container.innerHTML = `
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">‚ö†Ô∏è Alerts (${alerts.length})</h3>
        ${alerts.map((alert, index) => `
          <div class="border-l-4 ${alert.severity === 'high' ? 'border-red-500 bg-red-50' : 'border-yellow-500 bg-yellow-50'} p-3 rounded mb-2 cursor-pointer hover:shadow-md transition" data-alert-index="${index}" data-action="view-alert">
            <div class="flex justify-between items-start">
              <p class="font-semibold text-gray-800">${alert.message}</p>
              <button data-resolve-index="${index}" data-action="resolve-alert" 
                class="ml-2 text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">
                Resolve
              </button>
            </div>
          </div>
        `).join('')}
      </div>
    `;
    
    // Store alerts for event handlers
    window.currentAlerts = alerts;
    
    // Add event listeners
    container.querySelectorAll('[data-action="view-alert"]').forEach(function(el) {
      el.addEventListener('click', function(e) {
        if (e.target.closest('[data-action="resolve-alert"]')) return; // Don't trigger on resolve button
        const index = parseInt(this.getAttribute('data-alert-index'));
        const alert = window.currentAlerts[index];
        if (alert) {
          const alertID = alert.data ? (alert.data.EntryID || alert.data.issueID || alert.data.packetID || '') : '';
          viewAlertDetails(alert.type, alertID);
        }
      });
    });
    
    container.querySelectorAll('[data-action="resolve-alert"]').forEach(function(el) {
      el.addEventListener('click', function(e) {
        e.stopPropagation();
        const index = parseInt(this.getAttribute('data-resolve-index'));
        const alert = window.currentAlerts[index];
        if (alert) {
          const alertID = alert.data ? (alert.data.EntryID || alert.data.issueID || alert.data.packetID || '') : '';
          resolveAlert(alert.type, alertID);
        }
      });
    });
  }
  
  var dashboardData = {};
  var currentBranchID = '';

  // Action Functions
  function generateDailyReport() {
    if (!confirm('Generate daily cadence report for today?')) return;
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            alert('Daily report generated successfully! Summary ID: ' + result.summaryID);
            loadDashboard();
          } else {
            alert('Failed to generate report: ' + (result.message || 'Unknown error'));
          }
        })
        .withFailureHandler(function(error) {
          alert('Error generating report: ' + error.message);
        })
        .generateBranchDailyReport();
    } else {
      alert('Daily report generation (local mode - connect to backend API)');
    }
  }

  function viewWeeklyTrends() {
    if (!dashboardData.weekTrends) {
      alert('Weekly trends data not available');
      return;
    }
    
    const trends = dashboardData.weekTrends;
    const change = parseFloat(trends.change) || 0;
    const changeColor = change >= 0 ? 'green' : 'red';
    const changeSymbol = change >= 0 ? '‚Üë' : '‚Üì';
    
    const message = `Weekly Sales Trends
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

This Week: $${trends.thisWeek.toLocaleString()}
Last Week: $${trends.lastWeek.toLocaleString()}
Change: ${changeSymbol} ${Math.abs(change)}%

${change >= 0 ? '‚úì Sales are trending up!' : '‚ö† Sales are trending down. Review strategy.'}`;
    
    alert(message);
  }

  function exportBranchData() {
    if (!confirm('Export branch data to CSV?')) return;
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.url) {
            window.open(result.url, '_blank');
            alert('Data exported successfully!');
          } else {
            alert('Export completed. Check your downloads folder.');
          }
        })
        .withFailureHandler(function(error) {
          alert('Error exporting data: ' + error.message);
        })
        .exportBranchManagerData();
    } else {
      alert('Export data (local mode - connect to backend API)');
    }
  }

  function viewDetailedPipeline() {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showPipelineModal(data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading pipeline: ' + error.message);
        })
        .getDetailedBranchPipeline();
    } else {
      showPipelineModal({ entries: [] });
    }
  }

  function viewPipelineStage(stage) {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showPipelineStageModal(stage, data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading pipeline stage: ' + error.message);
        })
        .getPipelineStageDetails(stage);
    } else {
      showPipelineStageModal(stage, { entries: [] });
    }
  }

  function viewSalesDetails() {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showSalesDetailsModal(data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading sales details: ' + error.message);
        })
        .getBranchSalesDetails();
    } else {
      showSalesDetailsModal({ totalTAP: 0, appointments: 0, quotes: 0, revenue: 0, breakdown: [] });
    }
  }

  function viewOpsDetails() {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showOpsDetailsModal(data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading operations details: ' + error.message);
        })
        .getBranchOpsDetails();
    } else {
      showOpsDetailsModal({ missedStops: 0, backlog: 0 });
    }
  }

  function viewMetricDetail(metricType) {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showMetricDetailModal(metricType, data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading metric details: ' + error.message);
        })
        .getMetricDetails(metricType);
    } else {
      showMetricDetailModal(metricType, { 
        current: 0, 
        target: 'N/A', 
        status: 'Local Mode', 
        trend: 'N/A' 
      });
    }
  }

  function viewAEPerformance(userID) {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showAEPerformanceModal(data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading AE performance: ' + error.message);
        })
        .getAEPerformanceDetails(userID);
    } else {
      showAEPerformanceModal({ name: 'Demo AE', monthSales: 0, monthTAP: 0, monthQuotes: 0, winRate: 0 });
    }
  }

  function viewTechPerformance(userID) {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showTechPerformanceModal(data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading technician performance: ' + error.message);
        })
        .getTechPerformanceDetails(userID);
    } else {
      showTechPerformanceModal({ name: 'Demo Tech', leadsSubmitted: 0, installsCompleted: 0 });
    }
  }

  function viewAlertDetails(alertType, alertID) {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          showAlertDetailsModal(data);
        })
        .withFailureHandler(function(error) {
          alert('Error loading alert details: ' + error.message);
        })
        .getAlertDetails(alertType, alertID);
    } else {
      showAlertDetailsModal({ type: alertType, message: 'Demo alert', severity: 'medium', details: 'Local mode' });
    }
  }

  function resolveAlert(alertType, alertID) {
    const notes = prompt('Resolution notes:');
    if (notes === null || !notes.trim()) {
      if (notes !== null) alert('Please provide resolution notes.');
      return;
    }
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            alert('Alert resolved successfully!');
            loadDashboard();
          } else {
            alert('Failed to resolve alert: ' + (result.message || 'Unknown error'));
          }
        })
        .withFailureHandler(function(error) {
          alert('Error resolving alert: ' + error.message);
        })
        .resolveBranchAlert(alertType, alertID, notes);
    } else {
      alert('Alert resolved (local mode - connect to backend API)');
      loadDashboard();
    }
  }

  function sendTeamMessage() {
    const message = prompt('Enter message to send to your team:');
    if (message === null || !message.trim()) {
      if (message !== null) alert('Please enter a message.');
      return;
    }
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            alert('Message sent to team successfully!');
          } else {
            alert('Failed to send message: ' + (result.message || 'Unknown error'));
          }
        })
        .withFailureHandler(function(error) {
          alert('Error sending message: ' + error.message);
        })
        .sendBranchTeamMessage(message);
    } else {
      alert('Team message: ' + message + ' (local mode - connect to backend API)');
    }
  }

  // Modal Functions
  function showPipelineModal(data) {
    const modal = createModal('Detailed Pipeline', `
      <div class="space-y-4">
        ${data.entries && data.entries.length > 0 ? data.entries.map(entry => `
          <div class="border-l-4 border-blue-500 bg-gray-50 p-3 rounded">
            <p class="font-semibold">${entry.customerName}</p>
            <p class="text-sm text-gray-600">Stage: ${entry.stage} | Value: $${entry.value.toLocaleString()}</p>
            <p class="text-xs text-gray-500">AE: ${entry.aeName} | Date: ${entry.date}</p>
          </div>
        `).join('') : '<p class="text-gray-500">No pipeline entries found</p>'}
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showPipelineStageModal(stage, data) {
    const modal = createModal(`${stage} Stage Pipeline`, `
      <div class="space-y-4">
        ${data.entries && data.entries.length > 0 ? data.entries.map(entry => `
          <div class="border-l-4 border-blue-500 bg-gray-50 p-3 rounded">
            <p class="font-semibold">${entry.customerName}</p>
            <p class="text-sm text-gray-600">Value: $${entry.value.toLocaleString()}</p>
            <p class="text-xs text-gray-500">AE: ${entry.aeName}</p>
          </div>
        `).join('') : '<p class="text-gray-500">No entries in ${stage} stage</p>'}
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showSalesDetailsModal(data) {
    const modal = createModal('Sales Details', `
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><strong>Total TAP:</strong> ${data.totalTAP || 0}</div>
          <div><strong>Appointments:</strong> ${data.appointments || 0}</div>
          <div><strong>Quotes:</strong> ${data.quotes || 0}</div>
          <div><strong>Revenue:</strong> $${(data.revenue || 0).toLocaleString()}</div>
        </div>
        ${data.breakdown ? `
          <div class="mt-4">
            <h4 class="font-semibold mb-2">By AE:</h4>
            ${data.breakdown.map(ae => `
              <p class="text-sm">${ae.name}: $${ae.revenue.toLocaleString()}</p>
            `).join('')}
          </div>
        ` : ''}
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showOpsDetailsModal(data) {
    const modal = createModal('Operations Details', `
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><strong>Missed Stops:</strong> ${data.missedStops || 0}</div>
          <div><strong>Backlog %:</strong> ${data.backlog || 0}%</div>
        </div>
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showMetricDetailModal(metricType, data) {
    const modal = createModal(`${metricType} Details`, `
      <div class="space-y-4">
        <p><strong>Current Value:</strong> ${data.current || 0}</p>
        <p><strong>Target:</strong> ${data.target || 'N/A'}</p>
        <p><strong>Status:</strong> ${data.status || 'N/A'}</p>
        ${data.trend ? `<p><strong>Trend:</strong> ${data.trend}</p>` : ''}
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showAEPerformanceModal(data) {
    const modal = createModal(`AE Performance: ${data.name}`, `
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><strong>Month Sales:</strong> $${(data.monthSales || 0).toLocaleString()}</div>
          <div><strong>Month TAP:</strong> ${data.monthTAP || 0}</div>
          <div><strong>Month Quotes:</strong> ${data.monthQuotes || 0}</div>
          <div><strong>Win Rate:</strong> ${data.winRate || 0}%</div>
        </div>
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showTechPerformanceModal(data) {
    const modal = createModal(`Technician Performance: ${data.name}`, `
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><strong>Leads Submitted:</strong> ${data.leadsSubmitted || 0}</div>
          <div><strong>Installs Completed:</strong> ${data.installsCompleted || 0}</div>
        </div>
      </div>
    `);
    document.body.appendChild(modal);
  }

  function showAlertDetailsModal(data) {
    const modal = createModal('Alert Details', `
      <div class="space-y-4">
        <p><strong>Type:</strong> ${data.type || 'N/A'}</p>
        <p><strong>Message:</strong> ${data.message || 'N/A'}</p>
        <p><strong>Severity:</strong> ${data.severity || 'N/A'}</p>
        ${data.details ? `<p><strong>Details:</strong> ${data.details}</p>` : ''}
      </div>
    `);
    document.body.appendChild(modal);
  }

  function createModal(title, content) {
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    overlay.onclick = function(e) {
      if (e.target === overlay) {
        overlay.remove();
      }
    };
    
    const modal = document.createElement('div');
    modal.className = 'bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto';
    modal.onclick = function(e) { e.stopPropagation(); };
    
    modal.innerHTML = `
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">${title}</h3>
        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      ${content}
    `;
    
    overlay.appendChild(modal);
    return overlay;
  }

  // Set up event listeners for clickable elements
  function setupEventListeners() {
    // Action buttons
    const btnGenerate = document.getElementById('btn-generate-report');
    if (btnGenerate) btnGenerate.addEventListener('click', generateDailyReport);
    
    const btnTrends = document.getElementById('btn-weekly-trends');
    if (btnTrends) btnTrends.addEventListener('click', viewWeeklyTrends);
    
    const btnExport = document.getElementById('btn-export-data');
    if (btnExport) btnExport.addEventListener('click', exportBranchData);
    
    const btnPipeline = document.getElementById('btn-detailed-pipeline');
    if (btnPipeline) btnPipeline.addEventListener('click', viewDetailedPipeline);
    
    const btnMessage = document.getElementById('btn-team-message');
    if (btnMessage) btnMessage.addEventListener('click', sendTeamMessage);
    
    const btnSalesDetails = document.getElementById('btn-sales-details');
    if (btnSalesDetails) btnSalesDetails.addEventListener('click', viewSalesDetails);
    
    const btnOpsDetails = document.getElementById('btn-ops-details');
    if (btnOpsDetails) btnOpsDetails.addEventListener('click', viewOpsDetails);
    
    const btnPipelineAll = document.getElementById('btn-pipeline-all');
    if (btnPipelineAll) btnPipelineAll.addEventListener('click', viewDetailedPipeline);
    
    // Metrics click handlers (delegated)
    document.addEventListener('click', function(e) {
      const metricEl = e.target.closest('.metric-clickable');
      if (metricEl) {
        const metric = metricEl.getAttribute('data-metric');
        if (metric) viewMetricDetail(metric);
        return;
      }
      
      // Pipeline stage handlers
      const stageEl = e.target.closest('.pipeline-stage');
      if (stageEl) {
        const stage = stageEl.getAttribute('data-stage');
        if (stage) viewPipelineStage(stage);
        return;
      }
    });
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupEventListeners);
  } else {
    setupEventListeners();
  }

  loadDashboard();
  setInterval(loadDashboard, 300000); // Refresh every 5 minutes
  
  // Register service worker for PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('service-worker.js')
        .then(function(registration) {
          console.log('ServiceWorker registration successful');
        })
        .catch(function(error) {
          console.log('ServiceWorker registration failed:', error);
        });
    });
  }
</script>

</body>
</html>

