<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .loading { display: none; }
    .loading.active { display: block; }
  </style>
</head>
<body class="bg-gray-100 p-4">

<div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
  <h2 class="text-2xl font-bold text-gray-800 mb-6">üìù Submit New Lead</h2>
  
  <form id="leadForm" class="space-y-4">
    <!-- Customer Name -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name *</label>
      <input type="text" id="customerName" required 
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="John Doe"/>
    </div>
    
    <!-- Service Address -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Service Address *</label>
      <input type="text" id="serviceAddress" required 
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="123 Main St, Houston, TX"/>
    </div>
    
    <!-- Zip Code -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Zip Code *</label>
      <input type="text" id="zipCode" required pattern="\d{5}" maxlength="5"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="77001"/>
      <p class="text-xs text-gray-500 mt-1">Must be 5 digits</p>
    </div>
    
    <!-- Assignment Preview -->
    <div id="assignmentPreview" class="hidden p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <p class="text-sm text-blue-800">
        <strong>Will be assigned to:</strong> <span id="assignedAEName" class="font-bold"></span>
      </p>
    </div>
    
    <!-- Phone -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
      <input type="tel" id="phone" required 
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="555-123-4567"/>
    </div>
    
    <!-- Email -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Email (Optional)</label>
      <input type="email" id="email" 
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="john@example.com"/>
    </div>
    
    <!-- Service Type -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Service Type *</label>
      <select id="serviceType" required
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <option value="Pest Control">Pest Control</option>
        <option value="Termite">Termite</option>
        <option value="Wildlife">Wildlife</option>
        <option value="Lawn Care">Lawn Care</option>
        <option value="Mosquito">Mosquito</option>
        <option value="Rodent">Rodent</option>
        <option value="Other">Other</option>
      </select>
    </div>
    
    <!-- Notes -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
      <textarea id="notes" rows="3"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Any additional information..."></textarea>
    </div>
    
    <!-- Submit Button -->
    <button type="submit" 
      class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
      Submit Lead
    </button>
    
    <!-- Loading Indicator -->
    <div class="loading text-center py-4">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <p class="text-gray-600 mt-2">Submitting...</p>
    </div>
  </form>
  
  <!-- Success Message -->
  <div id="successMessage" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
    <p class="text-green-800 font-semibold">‚úÖ Lead submitted successfully!</p>
    <p class="text-green-700 text-sm mt-1" id="assignmentMessage"></p>
  </div>
</div>

<script>
  // Zip code lookup
  document.getElementById('zipCode').addEventListener('blur', function() {
    const zip = this.value.trim();
    if (zip.length === 5) {
      google.script.run
        .withSuccessHandler(function(ae) {
          if (ae) {
            document.getElementById('assignedAEName').textContent = ae.name;
            document.getElementById('assignmentPreview').classList.remove('hidden');
          } else {
            document.getElementById('assignedAEName').textContent = 'Branch Manager (no territory match)';
            document.getElementById('assignmentPreview').classList.remove('hidden');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Lookup failed:', error);
        })
        .getAEForZipCode(zip);
    }
  });
  
  // Form submission
  document.getElementById('leadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const leadData = {
      customer_name: document.getElementById('customerName').value.trim(),
      service_address: document.getElementById('serviceAddress').value.trim(),
      zipCode: document.getElementById('zipCode').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      email: document.getElementById('email').value.trim(),
      service_type: document.getElementById('serviceType').value,
      notes: document.getElementById('notes').value.trim()
    };
    
    // Show loading
    document.querySelector('.loading').classList.add('active');
    document.querySelector('button[type="submit"]').disabled = true;
    
    google.script.run
      .withSuccessHandler(function(result) {
        document.querySelector('.loading').classList.remove('active');
        
        if (result.success) {
          document.getElementById('leadForm').reset();
          document.getElementById('assignmentPreview').classList.add('hidden');
          document.getElementById('assignmentMessage').textContent = 
            'Assigned to: ' + result.assignedTo + ' (Lead ID: ' + result.leadID + ')';
          document.getElementById('successMessage').classList.remove('hidden');
          
          setTimeout(function() {
            document.getElementById('successMessage').classList.add('hidden');
            document.querySelector('button[type="submit"]').disabled = false;
          }, 5000);
        } else {
          alert('Error: ' + result.message);
          document.querySelector('button[type="submit"]').disabled = false;
        }
      })
      .withFailureHandler(function(error) {
        document.querySelector('.loading').classList.remove('active');
        document.querySelector('button[type="submit"]').disabled = false;
        alert('Submission failed: ' + error.message);
      })
      .submitLead(leadData);
  });
</script>

</body>
</html>

