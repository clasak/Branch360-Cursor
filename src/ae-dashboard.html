<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563EB">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Branch360">
  <link rel="manifest" href="manifest.json">
  <script src="activity-client.html"></script>
  <script src="options-data.html"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    if (window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions) {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .metric-card { transition: transform 0.2s; }
    .metric-card:hover { transform: translateY(-2px); }
    .modal-scroll { max-height: 70vh; overflow-y: auto; }
    .interactive-card { cursor: pointer; position: relative; }
    .interactive-card:focus-within, .interactive-card:focus { outline: 2px solid #2563EB; outline-offset: 2px; }
    .highlight-flash { box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.6); transition: box-shadow 0.3s ease; }
    .chip-button { border: 1px solid #d1d5db; border-radius: 9999px; padding: 0.25rem 0.9rem; font-size: 0.75rem; font-weight: 600; cursor: pointer; }
    .chip-button.active { background: #2563eb; color: #fff; border-color: #2563eb; }
    
    /* Dark theme styles (default) */
    body { background: #1e293b; color: #f1f5f9; }
    nav { background: #334155; border-color: #475569; }
    .bg-white { background: #334155 !important; }
    .bg-gray-50 { background: #334155 !important; }
    .bg-indigo-50 { background: rgba(67, 56, 202, 0.2) !important; }
    .bg-blue-50 { background: rgba(37, 99, 235, 0.2) !important; }
    .bg-yellow-50 { background: rgba(234, 179, 8, 0.2) !important; }
    .bg-green-50 { background: rgba(34, 197, 94, 0.2) !important; }
    .bg-red-50 { background: rgba(239, 68, 68, 0.2) !important; }
    .bg-purple-50 { background: rgba(168, 85, 247, 0.2) !important; }
    .border-blue-100 { border-color: rgba(37, 99, 235, 0.3) !important; }
    .text-gray-800, .text-gray-900 { color: #f1f5f9 !important; }
    .text-gray-600, .text-gray-700 { color: #cbd5e1 !important; }
    .text-gray-500 { color: #94a3b8 !important; }
    .text-gray-400 { color: #64748b !important; }
    .text-indigo-700 { color: #c7d2fe !important; }
    .text-indigo-900 { color: #e0e7ff !important; }
    .text-indigo-600 { color: #a5b4fc !important; }
    .border, .border-gray-200 { border-color: #475569 !important; }
    .border-indigo-200 { border-color: #4338ca !important; }
    input, select, textarea {
      background: #334155 !important; color: #f1f5f9 !important; border-color: #475569 !important;
    }
    .shadow, .shadow-sm, .shadow-lg {
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 1px 2px 0 rgba(0, 0, 0, 0.3);
    }
    
    /* Dark mode styles for legacy compatibility */
    body.dark-mode { background: #1e293b; color: #f1f5f9; }
    body.dark-mode nav { background: #334155; border-color: #475569; }
    body.dark-mode .bg-white { background: #334155 !important; }
    body.dark-mode .text-gray-800, body.dark-mode .text-gray-900 { color: #f1f5f9 !important; }
    body.dark-mode .text-gray-600, body.dark-mode .text-gray-700 { color: #cbd5e1 !important; }
    body.dark-mode .text-gray-500 { color: #94a3b8 !important; }
    body.dark-mode .text-gray-400 { color: #64748b !important; }
    body.dark-mode .border, body.dark-mode .border-gray-200 { border-color: #475569 !important; }
    body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
      background: #334155 !important; color: #f1f5f9 !important; border-color: #475569 !important;
    }
    body.dark-mode .shadow, body.dark-mode .shadow-sm, body.dark-mode .shadow-lg {
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 1px 2px 0 rgba(0, 0, 0, 0.3);
    }
    
    :root {
      --brand-primary: #2563eb;
      --brand-accent: #60a5fa;
      --brand-dark: #0f172a;
    }
    
    /* Navigation sidebar styles matching unified dashboard */
    .nav-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 256px;
      background: linear-gradient(180deg, var(--brand-dark) 0%, #1f2a3f 100%);
      border-right: 1px solid #334155;
      overflow-y: auto;
      z-index: 1000;
      padding: 1rem;
    }
    .nav-button {
      color: rgba(255, 255, 255, 0.85);
      background-color: rgba(15, 23, 42, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
      width: 100%;
      text-align: left;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-weight: 600;
      margin: 0.25rem 0;
    }
    .nav-button:hover {
      background-color: rgba(255, 255, 255, 0.18);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.3);
    }
    .nav-button.active {
      background-color: var(--brand-primary);
      color: #ffffff;
      font-weight: 700;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.25);
      border-color: transparent;
    }
    .main-with-sidebar {
      margin-left: 256px;
    }
  </style>
</head>
<body style="background: #1e293b;">

<!-- Apply theme from parent or localStorage -->
<script>
  (function() {
    try {
      const savedTheme = window.localStorage ? window.localStorage.getItem('branch360Theme') : null;
      if (savedTheme === 'dark' || document.documentElement.classList.contains('dark-mode')) {
        document.body.classList.add('dark-mode', 'bg-gray-900');
        document.body.classList.remove('bg-gray-50');
      }
    } catch(e) {
      console.log('Theme init:', e);
    }
    
    // Hide sidebar when loaded in iframe (unified dashboard already has sidebar)
    if (window.self !== window.top) {
      const style = document.createElement('style');
      style.textContent = `
        .nav-sidebar { display: none !important; }
        .main-with-sidebar { margin-left: 0 !important; }
      `;
      document.head.appendChild(style);
    }
  })();
</script>

<!-- Navigation Sidebar -->
<aside class="nav-sidebar space-y-2">
  <div class="flex items-center gap-3 pb-6 border-b border-white/10 mb-4">
    <img src="https://ik.imagekit.io/9cyexhymf/Presto-X%20Logo-ARentokilCompany.png?updatedAt=1762540113819" alt="Branch360" class="w-12 h-12 object-contain bg-white rounded-lg p-1 shadow" />
    <div>
      <div class="text-xl font-bold text-white">Branch360</div>
      <p class="text-xs text-white/70">Unified Pilot Dashboard</p>
    </div>
  </div>
  <button class="nav-button active" onclick="window.location.href='?view=ae'">Sales / AE</button>
  <button class="nav-button" onclick="window.location.href='?view=ae'" style="padding-left: 1.5rem; font-size: 0.9rem; background: rgba(15, 23, 42, 0.25);">üìã Leads</button>
  <button class="nav-button" onclick="window.location.href='?view=tech'">Technician</button>
  <button class="nav-button" onclick="window.location.href='?view=ops'">Operations</button>
  <button class="nav-button" onclick="window.location.href='?view=branch'">Branch Manager</button>
  <button class="nav-button" onclick="window.location.href='?view=admin'" style="background: rgba(124, 58, 237, 0.3); border-color: rgba(124, 58, 237, 0.5);">üîê Admin Dashboard</button>
  <button class="nav-button" onclick="window.location.href='?view=market'">Market Director</button>
  <button class="nav-button" onclick="window.location.href='?view=time'">Time Saved</button>
  <button class="nav-button" onclick="window.location.href='?view=pilot'">90-Day Pilot Report</button>
  <button class="nav-button" onclick="window.location.href='?view=handoff'">Sales ‚Üí Ops Handoff</button>
  <button class="nav-button" onclick="window.location.href='?view=settings'">Settings</button>
</aside>

<!-- Main Content with Sidebar -->
<div class="main-with-sidebar">
  <!-- Navigation Header -->
  <nav class="bg-white shadow-sm border-b">
    <div class="w-full px-4 py-3">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-xl font-bold text-gray-800">Branch360</h1>
          <p class="text-sm text-gray-600">Account Executive Dashboard</p>
        </div>
        <div class="text-right">
          <p class="text-sm font-semibold" id="userName">Loading...</p>
          <p class="text-xs text-gray-500" id="userBranch"></p>
        </div>
      </div>
    </div>
  </nav>

  <div class="w-full px-6 py-6">
  <div class="mb-6">
    <div class="border rounded-lg p-4 flex flex-col md:flex-row md:items-center md:justify-between" style="background: rgba(67, 56, 202, 0.15); border-color: rgba(67, 56, 202, 0.3);">
      <div>
        <p class="text-sm font-semibold" style="color: #a5b4fc;">‚è± My Time Saved</p>
        <p id="myTimeSavedValue" class="text-2xl font-bold" style="color: #e0e7ff;">--</p>
        <p id="myTimeSavedDetails" class="text-xs" style="color: #a5b4fc;">Time saved metrics will appear here as you work your leads.</p>
      </div>
      <div class="mt-3 md:mt-0 text-sm" style="color: #a5b4fc;">
        Tracking your lead contact + conversion activity automatically.
      </div>
    </div>
  </div>
  
  <!-- Today's Metrics -->
  <div class="mb-6">
    <h2 class="text-lg font-bold text-gray-800 mb-3">Today's Performance</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="todayMetrics">
      <div class="metric-card bg-white rounded-lg shadow p-6 cursor-pointer hover:shadow-lg transition-shadow" onclick="viewMetricDetails('proposals')" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();viewMetricDetails('proposals')}">
        <div class="text-sm text-gray-600 mb-1">Proposals Delivered</div>
        <div class="text-3xl font-bold text-blue-600" id="metricProposalsDelivered">0</div>
        <p class="text-xs text-gray-500 mt-2">
          LOBs on proposals: <span id="metricLobsProposed">--</span>
        </p>
      </div>
      <div class="metric-card bg-white rounded-lg shadow p-6 cursor-pointer hover:shadow-lg transition-shadow" onclick="viewMetricDetails('lobs')" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();viewMetricDetails('lobs')}">
        <div class="text-sm text-gray-600 mb-1">PRP LOBs Sold Today</div>
        <div class="text-3xl font-bold text-green-600" id="metricLobsSoldCount">0</div>
        <p class="text-xs text-gray-500 mt-2">
          Lines sold: <span id="metricLobsSold">--</span>
        </p>
      </div>
      <div class="metric-card bg-white rounded-lg shadow p-6">
        <div class="text-sm text-gray-600 mb-1">Total Dollars Sold</div>
        <div class="text-3xl font-bold text-purple-600" id="metricDollarsSold">$0</div>
        <p class="text-xs text-gray-500 mt-2">
          Proposed today: <span id="metricDollarsProposed">$0</span>
        </p>
      </div>
      <div class="metric-card bg-white rounded-lg shadow p-6">
        <div class="text-sm text-gray-600 mb-1">Next Day CONF</div>
        <div class="text-3xl font-bold text-emerald-600" id="metricNextDayConf">0</div>
        <p class="text-xs text-gray-500 mt-2">
          Events completed: <span id="metricEventsCompleted">0</span>
          <span class="block text-[11px] text-gray-400 mt-1" id="metricEventsSummary">No events logged yet.</span>
        </p>
      </div>
    </div>
    
    <!-- Quick Entry Button -->
    <div class="mt-3 flex flex-col md:flex-row gap-3 items-center">
      <button onclick="openDailyActivityForm()" 
        class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">
        üìù Log Today's Activity
      </button>
      <button onclick="openUnifiedSaleForm()"
        class="w-full md:w-auto inline-flex items-center justify-center gap-2 border border-emerald-400 bg-white text-emerald-700 hover:bg-emerald-600 hover:text-white font-semibold py-2 px-6 rounded-lg shadow">
        <span class="text-lg">üöÄ</span>
        <span>Start Packet Generator</span>
      </button>
      <button onclick="openSalesforceImportModal()"
        class="w-full md:w-auto inline-flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg">
        <span class="text-lg">üìÑ</span>
        <span>Import Salesforce Quote</span>
      </button>
    </div>
  </div>
  
  <!-- Territory & Prospecting Section -->
  <div class="mb-6">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
        <div>
          <h2 class="text-xl font-bold text-gray-800">üó∫Ô∏è Branch360 Account Executive Dashboard</h2>
          <p class="text-sm text-gray-600 mt-1">Interactive map and list view for territory management and prospecting</p>
        </div>
        <div class="flex gap-2">
          <button id="viewMapBtn" onclick="switchView('map')" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">
            üó∫Ô∏è Map
          </button>
          <button id="viewListBtn" onclick="switchView('list')" class="px-4 py-2 bg-gray-700 text-white rounded-lg font-semibold hover:bg-gray-600">
            üìã List
          </button>
        </div>
      </div>
      
      <!-- Filters -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Filter by AE</label>
          <select id="aeFilter" class="w-full border rounded-lg px-3 py-2 text-sm">
            <option value="">All AEs</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Vertical</label>
          <select id="verticalFilter" class="w-full border rounded-lg px-3 py-2 text-sm">
            <option value="">All Verticals</option>
            <option value="restaurant">Restaurants</option>
            <option value="property_management">Property Management</option>
            <option value="retail">Retail</option>
            <option value="healthcare">Healthcare</option>
            <option value="hospitality">Hospitality</option>
            <option value="commercial">Commercial</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Zip Code / Area</label>
          <input type="text" id="zipFilter" placeholder="Enter zip code" class="w-full border rounded-lg px-3 py-2 text-sm" maxlength="5">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Calendar Integration</label>
          <button onclick="loadProspectsFromCalendar()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">
            üìÖ Load from Calendar
          </button>
        </div>
      </div>
      
      <!-- Map View -->
      <div id="mapView" class="hidden">
        <div id="prospectMap" style="height: 600px; border-radius: 8px; overflow: hidden;" class="border border-gray-700"></div>
        <div class="mt-4 flex items-center justify-between">
          <div class="text-sm text-gray-600">
            <span id="mapProspectCount">0</span> prospects shown
          </div>
          <div class="flex gap-2">
            <button onclick="zoomMapIn()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm">Zoom In</button>
            <button onclick="zoomMapOut()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm">Zoom Out</button>
            <button onclick="resetMapView()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm">Reset</button>
          </div>
        </div>
      </div>
      
      <!-- List View -->
      <div id="listView">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Customer</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Address</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Zip</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Vertical</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Status</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody id="prospectListBody" class="bg-white divide-y divide-gray-200">
              <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">Loading prospects...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Two Column Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    <!-- Left Column: Pipeline & Leads -->
    <div class="space-y-6">
      
      <!-- New Leads Widget (from Agent 2) -->
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-gray-800">üéØ New Leads</h3>
          <span id="newLeadsCount" class="bg-red-500 text-white text-sm font-bold px-3 py-1 rounded-full">0</span>
        </div>
        <div id="newLeadsList" class="space-y-3">
          <p class="text-gray-500 text-sm">Loading...</p>
        </div>
        <button type="button" onclick="viewAllLeads(event)" class="w-full mt-3 text-blue-600 hover:text-blue-800 text-sm font-semibold">
          View All Leads ‚Üí
        </button>
      </div>
      
      <!-- Pipeline Overview -->
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800">üíº Sales Pipeline</h3>
          <button type="button" class="text-sm font-semibold text-blue-600 hover:text-blue-800" onclick="openPipelineDetailModal('sales')">
            Open
          </button>
        </div>
        <div class="space-y-3">
          <div class="flex justify-between items-center p-3 bg-blue-50 rounded cursor-pointer" role="button" tabindex="0" onclick="handlePipelineStageClick('proposal')" onkeydown="handlePipelineStageKey(event, 'proposal')">
            <div>
              <span class="font-semibold">Proposal</span>
              <span class="text-sm text-gray-600 ml-2">(<span id="proposalCount">0</span>)</span>
            </div>
            <span class="font-bold text-blue-600">$<span id="proposalValue">0</span></span>
          </div>
          
          <div class="flex justify-between items-center p-3 bg-yellow-50 rounded cursor-pointer" role="button" tabindex="0" onclick="handlePipelineStageClick('negotiation')" onkeydown="handlePipelineStageKey(event, 'negotiation')">
            <div>
              <span class="font-semibold">Negotiation</span>
              <span class="text-sm text-gray-600 ml-2">(<span id="negotiationCount">0</span>)</span>
            </div>
            <span class="font-bold text-yellow-600">$<span id="negotiationValue">0</span></span>
          </div>
          
          <div class="flex justify-between items-center p-3 bg-green-50 rounded cursor-pointer" role="button" tabindex="0" onclick="handlePipelineStageClick('sold')" onkeydown="handlePipelineStageKey(event, 'sold')">
            <div>
              <span class="font-semibold">Sold (This Month)</span>
              <span class="text-sm text-gray-600 ml-2">(<span id="soldCount">0</span>)</span>
            </div>
            <span class="font-bold text-green-600">$<span id="soldValue">0</span></span>
          </div>
        </div>
        <button type="button" onclick="viewPipeline(event)" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg">
          Manage Pipeline
        </button>
      </div>

      <!-- Lead Pipeline Detail -->
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <div>
            <h3 class="text-lg font-bold text-gray-800">üìã Lead Pipeline</h3>
            <p class="text-sm text-gray-500">Track every lead and keep them moving</p>
            <div class="mt-2">
              <button type="button" class="text-xs font-semibold text-blue-600 hover:text-blue-800" onclick="openPipelineDetailModal('leads')">
                Open Pipeline Actions ‚Üí
              </button>
            </div>
          </div>
          <div class="flex gap-2 flex-wrap">
            <input type="search" id="leadSearch" placeholder="Search leads" class="border rounded-lg px-3 py-2 text-sm" />
            <select id="leadSort" class="border rounded-lg px-3 py-2 text-sm">
              <option value="newest">Newest</option>
              <option value="oldest">Oldest</option>
              <option value="name">Customer A-Z</option>
              <option value="status">Status</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4" id="leadStatusCards"></div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200" id="leadPipelineTable"></table>
        </div>

        <p id="leadPipelineEmpty" class="text-center text-gray-500 text-sm mt-3 hidden">No leads match your filters.</p>
      </div>
      
    </div>
    
    <!-- Right Column: Activity & Tasks -->
    <div class="space-y-6">
      
      <!-- Month-to-Date Stats -->
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800">üìä Month-to-Date</h3>
          <button type="button" class="text-sm font-semibold text-blue-600 hover:text-blue-800" onclick="openMonthDetailModal()">
            Open
          </button>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-sm text-gray-600">Total TAP</p>
            <p class="text-2xl font-bold text-gray-800" id="monthTAP">0</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Win Rate</p>
            <p class="text-2xl font-bold text-gray-800"><span id="monthWinRate">0</span>%</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Total Sales</p>
            <p class="text-2xl font-bold text-gray-800">$<span id="monthSales">0</span></p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Appointments</p>
            <p class="text-2xl font-bold text-gray-800" id="monthAppointments">0</p>
          </div>
        </div>
      </div>

      <!-- Salesforce Quote Tracker -->
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <div>
            <h3 class="text-lg font-bold text-gray-800">üìë Salesforce Quote Tracker</h3>
            <p class="text-sm text-gray-500">Uploads log as proposals automatically; marking sold creates the start packet + Ops log.</p>
          </div>
          <div class="flex items-center gap-2">
            <span id="quoteTrackerCount" class="text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700 font-semibold">0 tracked</span>
            <button type="button" class="text-sm font-semibold text-blue-600 hover:text-blue-800" onclick="openQuoteTrackerModal()">
              Open
            </button>
          </div>
        </div>
        <div class="overflow-x-auto max-h-96 overflow-y-auto">
          <table class="min-w-full text-sm" id="quoteTrackerTable"></table>
        </div>
        <p id="quoteTrackerEmpty" class="text-center text-gray-500 text-sm mt-3">Import a Salesforce quote to see it here.</p>
      </div>
      
      <!-- Sold Quotes Tracker -->
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <div>
            <h3 class="text-lg font-bold text-gray-800">‚úÖ Sold Quotes</h3>
            <p class="text-sm text-gray-500">Quotes marked as sold - start packets generated.</p>
          </div>
          <span id="soldQuotesCount" class="text-xs px-3 py-1 rounded-full bg-green-100 text-green-700 font-semibold">0 sold</span>
        </div>
        <div class="overflow-x-auto max-h-96 overflow-y-auto">
          <table class="min-w-full text-sm" id="soldQuotesTable"></table>
        </div>
        <p id="soldQuotesEmpty" class="text-center text-gray-500 text-sm mt-3">No sold quotes yet.</p>
      </div>
      
      <!-- Upcoming Tasks -->
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800">üìÖ Follow-Up Needed</h3>
          <button type="button" class="text-sm font-semibold text-blue-600 hover:text-blue-800" onclick="openFollowUpModal()">
            Manage
          </button>
        </div>
        <div id="tasksList" class="space-y-3">
          <p class="text-gray-500 text-sm">No pending tasks</p>
        </div>
      </div>
      
      <!-- Recent Activity -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">üïí Recent Activity</h3>
        <div id="recentActivity" class="space-y-2">
          <p class="text-gray-500 text-sm">Loading...</p>
        </div>
      </div>
      
    </div>
    
  </div>
  
</div>

<!-- Daily Activity Modal -->
<div id="dailyActivityModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target.id==='dailyActivityModal')closeDailyActivityForm()">
  <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
    <h3 class="text-xl font-bold text-gray-800 mb-4">Log Today's Activity</h3>
    <form id="dailyActivityForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Proposals Delivered Today</label>
          <input type="number" id="formProposalsDelivered" value="0" min="0"
            class="w-full px-3 py-2 border rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">LOBs on Proposals Delivered</label>
          <input type="text" id="formLobsOnProposals" placeholder="GPC, Rodent, Fly"
            class="w-full px-3 py-2 border rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">LOBs Sold Today</label>
          <input type="text" id="formLobsSold" placeholder="Rodent, Fly"
            class="w-full px-3 py-2 border rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Dollars Sold Today ($)</label>
          <input type="number" id="formDollarsSold" value="0" min="0"
            class="w-full px-3 py-2 border rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Total Dollars Proposed Today</label>
          <input type="number" id="formDollarsProposed" value="0" min="0"
            class="w-full px-3 py-2 border rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Next Day CONF (Proposals to deliver)</label>
          <input type="number" id="formNextDayConf" value="0" min="0"
            class="w-full px-3 py-2 border rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Events Completed Today</label>
          <input type="number" id="formEventsCount" value="0" min="0"
            class="w-full px-3 py-2 border rounded-lg"/>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Events Summary / Notes</label>
        <textarea id="formEvents" rows="2" class="w-full px-3 py-2 border rounded-lg" placeholder="Site assessments, first-time appointments, proposals delivered, in-person follow-ups, etc."></textarea>
      </div>
      <button type="button" onclick="prefillActivityFromQuotes()" class="w-full bg-gray-100 text-gray-800 font-semibold py-2 rounded-lg border">
        Autofill from Salesforce Imports
      </button>
      
      <div class="flex gap-3 mt-6">
        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg">
          Save Activity
        </button>
        <button type="button" onclick="closeDailyActivityForm()"
          class="px-6 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded-lg">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<div id="unifiedSaleModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[90]" onclick="if(event.target.id==='unifiedSaleModal')closeUnifiedSaleForm()">
  <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4">
    <div class="flex items-center justify-between px-6 py-4 border-b">
      <div>
        <p class="text-xs uppercase tracking-wide text-gray-500">Unified Entry</p>
        <h3 class="text-xl font-semibold text-gray-900">Create New Start Packet</h3>
      </div>
      <button onclick="closeUnifiedSaleForm()" aria-label="Close sale form" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
    </div>
    <form id="unifiedSaleForm" class="px-6 py-4 modal-scroll space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Account Name</label>
          <input id="unifiedAccountName" type="text" class="w-full border rounded-lg px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Service Address</label>
          <input id="unifiedServiceAddress" type="text" class="w-full border rounded-lg px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Sold Date</label>
          <input id="unifiedSoldDate" type="date" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Requested Start Month</label>
          <select id="unifiedStartMonth" class="w-full border rounded-lg px-3 py-2">
            <option value="">Select Month</option>
            <option>January</option>
            <option>February</option>
            <option>March</option>
            <option>April</option>
            <option>May</option>
            <option>June</option>
            <option>July</option>
            <option>August</option>
            <option>September</option>
            <option>October</option>
            <option>November</option>
            <option>December</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Point of Contact</label>
          <input id="unifiedPOCName" type="text" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">POC Phone</label>
          <input id="unifiedPOCPhone" type="tel" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">POC Email</label>
          <input id="unifiedPOCEmail" type="email" class="w-full border rounded-lg px-3 py-2" placeholder="contact@example.com">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Billing Email</label>
          <input id="unifiedBillingEmail" type="email" class="w-full border rounded-lg px-3 py-2" placeholder="billing@example.com">
        </div>
        <div class="flex items-center space-x-2">
          <input id="unifiedBillingAddressDifferent" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
          <label for="unifiedBillingAddressDifferent" class="text-sm text-gray-700">Billing address different from service address</label>
        </div>
        <div id="billingAddressContainer" class="hidden">
          <label class="block text-sm font-semibold text-gray-700 mb-1">Billing Address</label>
          <input id="unifiedBillingAddress" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Enter billing address">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Initial Price (One-Time)</label>
          <input id="unifiedInitialPrice" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Avg Monthly Cost</label>
          <input id="unifiedMaintenancePrice" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Service Name</label>
          <input id="unifiedServiceName" type="text" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Service Type</label>
          <select id="unifiedServiceType" class="w-full border rounded-lg px-3 py-2">
            <option value="">Select Service Type</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Covered Pests</label>
          <input id="unifiedCoveredPests" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Rodents, Flies, Mosquito">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Lead Type</label>
          <select id="unifiedLeadType" class="w-full border rounded-lg px-3 py-2">
            <option value="">Select Lead Type</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Job Type</label>
          <select id="unifiedJobType" class="w-full border rounded-lg px-3 py-2">
            <option value="">Select Job Type</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Frequency (# of visits)</label>
          <input id="unifiedFrequency" type="number" class="w-full border rounded-lg px-3 py-2" value="12">
        </div>
      </div>

      <div class="border rounded-lg p-4">
        <p class="text-sm font-semibold text-gray-700 mb-2">Service Months</p>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="serviceMonthOptions"></div>
      </div>

      <div class="border rounded-lg p-4">
        <p class="text-sm font-semibold text-gray-700 mb-3">Equipment Counts</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">MRT Count</label>
            <input id="unifiedMRTCount" type="number" min="0" class="w-full border rounded-lg px-3 py-2" placeholder="0" onchange="updateInitialServiceDescription()">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">RBS Count</label>
            <input id="unifiedRBSCount" type="number" min="0" class="w-full border rounded-lg px-3 py-2" placeholder="0" onchange="updateInitialServiceDescription()">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">ILT Count</label>
            <input id="unifiedILTCount" type="number" min="0" class="w-full border rounded-lg px-3 py-2" placeholder="0" onchange="updateInitialServiceDescription()">
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Initial Service Description</label>
          <textarea id="unifiedInitialServiceDescription" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Install 22 MRTs, 14 RBSs, For ILTs, Initial GPC"></textarea>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Maintenance Scope Description</label>
          <textarea id="unifiedMaintenanceScopeDescription" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Monthly GPC exterior tour, rodent monitoring, Semi-monthly interior rodent monitoring and ILT Maintenance"></textarea>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Service Areas</label>
          <input id="unifiedServiceAreas" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Enter service areas">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Sales Rep(s)</label>
          <input id="unifiedSalesReps" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Comma separated">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Branch</label>
          <select id="unifiedBranch" class="w-full border rounded-lg px-3 py-2">
            <option value="HOUSTON">Houston</option>
            <option value="AUSTIN">Austin</option>
            <option value="DALLAS">Dallas</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="flex items-center space-x-2">
          <input id="unifiedPestPac" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
          <label for="unifiedPestPac" class="text-sm text-gray-700">PestPac entry confirmed</label>
        </div>
        <div class="flex items-center space-x-2">
          <input id="unifiedTapLead" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
          <label for="unifiedTapLead" class="text-sm text-gray-700">TAP lead / specialist needed</label>
        </div>
        <div class="flex items-center space-x-2">
          <input id="unifiedLogBook" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
          <label for="unifiedLogBook" class="text-sm text-gray-700">Log book required</label>
        </div>
        <div class="flex items-center space-x-2">
          <input id="unifiedPNOL" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
          <label for="unifiedPNOL" class="text-sm text-gray-700">PNOL required</label>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">SRA Completed By</label>
          <input id="unifiedSRABy" type="text" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">SRA Date</label>
          <input id="unifiedSRADate" type="date" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">SRA Time</label>
          <input id="unifiedSRATime" type="time" class="w-full border rounded-lg px-3 py-2">
        </div>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Special Notes / Equipment</label>
        <textarea id="unifiedNotes" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="Equipment counts, special instructions, etc."></textarea>
      </div>

      <div class="border rounded-lg p-4">
        <div class="flex items-center justify-between mb-3">
          <div>
            <p class="text-sm font-semibold text-gray-700">SRA Hazard List</p>
            <p class="text-xs text-gray-500">Document hazards & control measures replacing the old paper packet.</p>
          </div>
          <button type="button" onclick="addHazardRow()" class="text-sm font-semibold text-blue-600 hover:text-blue-800">+ Add hazard</button>
        </div>
        <div id="hazardRows" class="space-y-3"></div>
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Additional Hazards</label>
        <textarea id="unifiedAdditionalHazards" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="None"></textarea>
      </div>
      <div class="bg-gray-50 border rounded-lg p-3 text-xs text-gray-600" id="sraReviewNote">
        Include this SRA in the Sales Agreement. Site Risk Assessment Completed by: <span id="sraCompletedByLabel">--</span>. Date: <span id="sraCompletedAtLabel">--</span>.
      </div>

      <div class="flex flex-col md:flex-row md:justify-end gap-3 pb-4">
        <button type="button" onclick="closeUnifiedSaleForm()" class="w-full md:w-auto border border-gray-300 text-gray-700 px-5 py-2 rounded-lg">Close</button>
        
        <button type="button" onclick="previewStartPacket()" class="w-full md:w-auto bg-indigo-50 text-indigo-700 border border-indigo-200 font-semibold px-5 py-2 rounded-lg hover:bg-indigo-100">
          üëÅÔ∏è Preview Packet
        </button>
        
        <button type="submit" class="w-full md:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-6 py-2 rounded-lg">Mark Sold & Generate Start Packet</button>
      </div>
    </form>
  </div>
</div>

<div id="salesforceImportModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" onclick="if(event.target.id==='salesforceImportModal')closeSalesforceImportModal()">
  <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4">
    <div class="flex items-center justify-between px-6 py-4 border-b">
      <div>
        <p class="text-xs uppercase tracking-wide text-gray-500">Salesforce Quote Import</p>
        <h3 class="text-xl font-semibold text-gray-900">Upload Quote PDF</h3>
      </div>
      <button onclick="closeSalesforceImportModal()" aria-label="Close Salesforce import modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
    </div>
    <div class="px-6 py-4 space-y-4">
      <p class="text-sm text-gray-600">
        Upload the exported Salesforce quote PDF. Branch360 will extract customer, pricing, and scope information, pre-fill the start packet, and populate the SRA checklist automatically.
      </p>
      <input type="file" id="salesforceQuoteFile" accept="application/pdf" class="w-full border rounded-lg px-3 py-2">
      <div id="importStatus" class="text-xs text-gray-500">No file selected.</div>
      <div class="bg-gray-50 border rounded-lg p-3 text-xs text-gray-600">
        <p>Supported sections:</p>
        <ul class="list-disc pl-5 space-y-1">
          <li>Prepared For / Prepared By blocks</li>
          <li>Scope of Service & Routine Management</li>
          <li>Equipment Summary & Investment Summary</li>
          <li>Timeline (requested start dates)</li>
        </ul>
      </div>
      <div class="flex flex-col md:flex-row md:justify-end gap-3 pt-2">
        <button type="button" onclick="closeSalesforceImportModal()" class="w-full md:w-auto border border-gray-300 text-gray-700 px-5 py-2 rounded-lg">Cancel</button>
        <button type="button" onclick="processSalesforceQuote()" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-2 rounded-lg">Extract & Prefill</button>
      </div>
    </div>
  </div>
</div>

<!-- Pipeline Detail Modal -->
<div id="pipelineDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" onclick="if(event.target.id==='pipelineDetailModal')closePipelineDetailModal()">
  <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4">
    <div class="flex items-center justify-between px-6 py-4 border-b">
      <div>
        <p class="text-xs uppercase tracking-wide text-gray-500">Pipeline Drilldown</p>
        <h3 class="text-xl font-semibold text-gray-900">Sales & Lead Pipeline</h3>
      </div>
      <button onclick="closePipelineDetailModal()" aria-label="Close pipeline detail modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
    </div>
    <div class="px-6 py-4 space-y-5">
      <div id="pipelineSummaryList" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
      <div>
        <p class="text-xs uppercase text-gray-500 mb-2">Filter by Lead Status</p>
        <div id="pipelineStageFilters" class="flex flex-wrap gap-2"></div>
      </div>
      <div class="border rounded-lg divide-y max-h-72 overflow-y-auto" id="pipelineModalLeads">
        <p class="text-sm text-gray-500 p-3">Pipeline data loading...</p>
      </div>
      <div class="flex flex-col md:flex-row gap-3 pt-2">
        <button type="button" onclick="focusLeadPipelineTable()" class="w-full md:w-auto border border-blue-200 text-blue-700 font-semibold px-5 py-2 rounded-lg">Jump to Lead Table</button>
        <button type="button" onclick="openUnifiedSaleForm()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-lg">Create Opportunity</button>
      </div>
    </div>
  </div>
</div>

<!-- Month-to-Date Detail Modal -->
<div id="monthDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" onclick="if(event.target.id==='monthDetailModal')closeMonthDetailModal()">
  <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4">
    <div class="flex items-center justify-between px-6 py-4 border-b">
      <div>
        <p class="text-xs uppercase tracking-wide text-gray-500">MTD Metrics</p>
        <h3 class="text-xl font-semibold text-gray-900">Month-to-Date Details</h3>
      </div>
      <button onclick="closeMonthDetailModal()" aria-label="Close month detail modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
    </div>
    <div class="px-6 py-4 space-y-4">
      <div class="grid grid-cols-2 gap-4" id="monthDetailMetrics"></div>
      <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 text-sm text-blue-700">
        Keep these numbers current by logging daily activity or importing Salesforce quotes.
      </div>
      <div class="flex flex-col md:flex-row gap-3 pt-2">
        <button type="button" onclick="openDailyActivityForm()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-lg">Log Today's Activity</button>
        <button type="button" onclick="prefillActivityFromQuotes()" class="w-full md:w-auto border border-blue-200 text-blue-700 font-semibold px-5 py-2 rounded-lg">Prefill from Salesforce Imports</button>
      </div>
    </div>
  </div>
</div>

<!-- Follow-Up Manager Modal -->
<div id="followUpModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" onclick="if(event.target.id==='followUpModal')closeFollowUpModal()">
  <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full mx-4">
    <div class="flex items-center justify-between px-6 py-4 border-b">
      <div>
        <p class="text-xs uppercase tracking-wide text-gray-500">Follow-Up Queue</p>
        <h3 class="text-xl font-semibold text-gray-900">Manage Tasks</h3>
      </div>
      <button onclick="closeFollowUpModal()" aria-label="Close follow-up modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
    </div>
    <div class="px-6 py-4 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2">Open Follow-Ups</h4>
          <div id="followUpModalList" class="space-y-3 max-h-80 overflow-y-auto border rounded-lg p-3 bg-gray-50">
            <p class="text-sm text-gray-500">No pending follow-ups.</p>
          </div>
        </div>
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2">Add Manual Follow-Up</h4>
          <form id="followUpForm" class="space-y-3">
            <div>
              <label class="text-xs font-semibold text-gray-600 mb-1 block">Customer / Location</label>
              <input id="followUpCustomer" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Houston Bakery" required>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-600 mb-1 block">Next Action</label>
              <textarea id="followUpAction" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="Send revised proposal" required></textarea>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-600 mb-1 block">Due Date</label>
              <input id="followUpDueDate" type="date" class="w-full border rounded-lg px-3 py-2">
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg">Save Follow-Up</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quote Tracker Modal -->
<div id="quoteTrackerModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" onclick="if(event.target.id==='quoteTrackerModal')closeQuoteTrackerModal()">
  <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4">
    <div class="flex items-center justify-between px-6 py-4 border-b">
      <div>
        <p class="text-xs uppercase tracking-wide text-gray-500">Salesforce Quotes</p>
        <h3 class="text-xl font-semibold text-gray-900">Tracker & Actions</h3>
      </div>
      <button onclick="closeQuoteTrackerModal()" aria-label="Close quote tracker modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
    </div>
    <div class="px-6 py-4 space-y-4">
      <div class="overflow-x-auto" id="quoteTrackerModalBody">
        <p class="text-sm text-gray-500">No Salesforce quotes imported yet.</p>
      </div>
      <div class="flex flex-col md:flex-row gap-3 pt-2">
        <button type="button" onclick="openSalesforceImportModal()" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-5 py-2 rounded-lg">Import Salesforce Quote</button>
        <button type="button" onclick="prefillActivityFromQuotes()" class="w-full md:w-auto border border-indigo-200 text-indigo-700 font-semibold px-5 py-2 rounded-lg">Sync Today's Activity</button>
      </div>
    </div>
  </div>
</div>

<script>
  function getActiveDemoUser() {
    try {
      if (window.parent && window.parent.Branch360CurrentUser) {
        return window.parent.Branch360CurrentUser;
      }
      if (window.localStorage) {
        const stored = localStorage.getItem('branch360CurrentUser');
        return stored ? JSON.parse(stored) : null;
      }
    } catch (err) {
      console.warn('Unable to read demo user context', err);
    }
    return null;
  }

  var dashboardData = null;
  var pipelineLeads = [];
  var filteredPipelineLeads = [];
  var leadSearchTerm = '';
  var leadSortMode = 'newest';
  var salesforceQuoteFile = null;
  var currentUserId = '';
  var serviceMonthValues = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  var currentImportedServices = [];
  var currentImportedContactEmail = '';
  var quoteTrackerKey = 'branch360QuoteTracker';
  var quoteTrackerEntries = loadQuoteTrackerEntries();
  var currentQuoteTrackerId = null;
  var Branch360ActiveUser = getActiveDemoUser();
  var Branch360DemoState = window.Branch360DemoState || initializeDemoState(Branch360ActiveUser);
  window.Branch360DemoState = Branch360DemoState;
  const defaultSraHazards = [
    { hazard: 'Access routes / floors: slips, trips, uneven surfaces', control: 'Identify safe routes, remove obstructions, wear slip-resistant footwear', safeToProceed: true },
    { hazard: 'Electrical sources / appliances: exposed wires, sockets', control: 'Inspect equipment, isolate power, avoid contact with exposed cables', safeToProceed: true },
    { hazard: 'Working at height / ladders', control: 'Use ladders safely, avoid work at height when possible', safeToProceed: true },
    { hazard: 'Confined spaces / limited movement', control: 'Keep area clear, use proper PPE, do not enter confined spaces without assessment', safeToProceed: true },
    { hazard: 'Lighting / ventilation issues', control: 'Use portable lighting, ensure adequate ventilation, wear RPE when required', safeToProceed: true },
    { hazard: 'Asbestos / airborne dust', control: 'Do not disturb materials, wear masks/coveralls, carry out assessment if suspected', safeToProceed: true },
    { hazard: 'Extreme temperatures', control: 'Assess suitability, take breaks, rotate team members to reduce exposure', safeToProceed: true }
  ];
  var leadStageFilter = 'all';
  var customFollowUpsKey = 'branch360CustomFollowUps';
  var completedFollowUpsKey = 'branch360CompletedFollowUps';
  var customFollowUps = loadCustomFollowUps();
  var completedFollowUpIds = loadCompletedFollowUps();
  var latestServerFollowUps = [];

  function loadCustomFollowUps() {
    if (!window.localStorage) return [];
    try {
      const stored = JSON.parse(localStorage.getItem(customFollowUpsKey));
      return Array.isArray(stored) ? stored : [];
    } catch (err) {
      console.warn('Failed to load custom follow-ups', err);
      return [];
    }
  }

  function saveCustomFollowUps() {
    if (!window.localStorage) return;
    try {
      localStorage.setItem(customFollowUpsKey, JSON.stringify(customFollowUps));
    } catch (err) {
      console.warn('Failed to persist custom follow-ups', err);
    }
  }

  function loadCompletedFollowUps() {
    if (!window.localStorage) return [];
    try {
      const stored = JSON.parse(localStorage.getItem(completedFollowUpsKey));
      return Array.isArray(stored) ? stored : [];
    } catch (err) {
      console.warn('Failed to load completed follow-ups', err);
      return [];
    }
  }

  function saveCompletedFollowUps() {
    if (!window.localStorage) return;
    try {
      localStorage.setItem(completedFollowUpsKey, JSON.stringify(completedFollowUpIds));
    } catch (err) {
      console.warn('Failed to persist completed follow-ups', err);
    }
  }

  function hasAppsScript() {
    return typeof google !== 'undefined' && google.script && google.script.run;
  }

  function loadDashboard() {
    Branch360ActiveUser = getActiveDemoUser() || Branch360ActiveUser;
    const requestUserID = Branch360ActiveUser && (Branch360ActiveUser.userID || Branch360ActiveUser.UserID || Branch360ActiveUser.id || '');
    if (hasAppsScript() && google.script.run.getAEDashboard) {
      google.script.run
        .withSuccessHandler(function(data) {
          dashboardData = data;
          renderDashboard(data);
        })
        .withFailureHandler(function(error) {
          console.warn('Falling back to demo data. Reason:', error.message);
          dashboardData = getDemoAEDashboard(Branch360ActiveUser);
          renderDashboard(dashboardData);
        })
        .getAEDashboard(requestUserID);
    } else {
      dashboardData = getDemoAEDashboard(Branch360ActiveUser);
      renderDashboard(dashboardData);
    }
    loadMyTimeSavedSummary();
  }
  
  function renderDashboard(data) {
    if (!data || !data.user) return;
    const persona = Branch360ActiveUser || getActiveDemoUser();
    if (persona) {
      data.user = Object.assign({}, data.user, {
        name: persona.name || data.user.name,
        email: persona.email || data.user.email,
        branchID: persona.branchId || data.user.branchID || data.user.BranchID,
        userID: persona.userID || persona.id || data.user.userID
      });
      Branch360DemoState.user = Object.assign({}, Branch360DemoState.user, {
        name: data.user.name,
        email: data.user.email,
        userID: data.user.userID,
        branchID: data.user.branchID || data.user.BranchID
      });
    }
    document.getElementById('userName').textContent = data.user.name || 'AE';
    document.getElementById('userBranch').textContent = 'Branch: ' + (data.user.branchID || data.user.BranchID || 'Houston');
    currentUserId = data.user.userID || data.user.email || '';
    
    const today = mergeDailyMetrics(data.todayMetrics);
    dashboardData.todayMetrics = today;
    applyTodayMetricsToDom(today);
    
    const month = data.monthMetrics || {};
    document.getElementById('monthTAP').textContent = month.totalTAP || 0;
    document.getElementById('monthWinRate').textContent = month.winRate || 0;
    document.getElementById('monthSales').textContent = (month.totalSales || 0).toLocaleString();
    document.getElementById('monthAppointments').textContent = month.totalAppointments || 0;
    
    const pipeline = (data.pipeline && data.pipeline.stages) || { proposal: [], negotiation: [], sold: [] };
    document.getElementById('proposalCount').textContent = pipeline.proposal.length;
    document.getElementById('proposalValue').textContent = calculateStageValue(pipeline.proposal).toLocaleString();
    document.getElementById('negotiationCount').textContent = pipeline.negotiation.length;
    document.getElementById('negotiationValue').textContent = calculateStageValue(pipeline.negotiation).toLocaleString();
    document.getElementById('soldCount').textContent = pipeline.sold.length;
    document.getElementById('soldValue').textContent = calculateStageValue(pipeline.sold).toLocaleString();
    
    renderNewLeads(data.newLeads || []);
    renderTasks(data.upcomingTasks || []);
    renderRecentActivity(data.recentActivity || []);
    loadUnifiedSalesPipeline();
    renderQuoteTracker();
  }

  function openMonthDetailModal() {
    populateMonthDetailModal();
    const modal = document.getElementById('monthDetailModal');
    if (modal) {
      modal.classList.remove('hidden');
      setupModalEscKey(modal, closeMonthDetailModal);
    }
  }

  function closeMonthDetailModal() {
    const modal = document.getElementById('monthDetailModal');
    if (modal) modal.classList.add('hidden');
  }

  function populateMonthDetailModal() {
    const container = document.getElementById('monthDetailMetrics');
    if (!container) return;
    const metrics = (dashboardData && dashboardData.monthMetrics) || {};
    const statRows = [
      { label: 'Total TAP', value: metrics.totalTAP || 0 },
      { label: 'Win Rate', value: (metrics.winRate || 0) + '%' },
      { label: 'Total Sales', value: '$' + (metrics.totalSales || 0).toLocaleString() },
      { label: 'Appointments', value: metrics.totalAppointments || 0 }
    ];
    container.innerHTML = statRows.map(function(stat) {
      return `<div class="border rounded-lg p-4 bg-gray-50">
        <p class="text-xs uppercase text-gray-500">${stat.label}</p>
        <p class="text-2xl font-bold text-gray-800">${stat.value}</p>
      </div>`;
    }).join('');
  }
  
  function calculateStageValue(opportunities) {
    return opportunities.reduce(function(sum, opp) {
      return sum + (opp.value || 0);
    }, 0);
  }
  
  function renderNewLeads(leads) {
    document.getElementById('newLeadsCount').textContent = leads.length;
    const container = document.getElementById('newLeadsList');
    if (leads.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-sm">No new leads</p>';
      return;
    }
    container.innerHTML = leads.slice(0, 3).map(function(lead, index) {
      const isTechLead = lead.source === 'Technician';
      const borderColor = isTechLead ? 'border-purple-500' : 'border-blue-500';
      const bgColor = isTechLead ? 'bg-purple-50' : 'bg-blue-50';
      const hoverColor = isTechLead ? 'hover:bg-purple-100' : 'hover:bg-blue-100';
      
      return `
        <div class="border-l-4 ${borderColor} ${bgColor} p-3 rounded cursor-pointer ${hoverColor} transition-colors" onclick="showLeadDetail(${index})">
          <div class="flex items-start justify-between mb-1">
            <p class="font-semibold text-gray-800">${lead.customer_name}</p>
            ${isTechLead ? '<span class="text-xs bg-purple-600 text-white px-2 py-0.5 rounded">üë∑ Tech</span>' : ''}
          </div>
          <p class="text-sm text-gray-600">${lead.service_address}</p>
          ${isTechLead && lead.special_notes ? `<p class="text-xs text-gray-600 mt-1 italic">"${lead.special_notes.substring(0, 60)}..."</p>` : ''}
          <div class="flex items-center justify-between mt-2">
            <a href="tel:${lead.phone || ''}" class="text-xs text-blue-600 hover:underline" onclick="event.stopPropagation()">${lead.phone || ''}</a>
            <button type="button" onclick="event.stopPropagation(); startPacketFromNewLead('${lead.recordId || ''}')" class="text-xs font-semibold text-blue-600 hover:text-blue-800">
              ${isTechLead ? 'Qualify' : 'Start Packet'}
            </button>
          </div>
        </div>`;
    }).join('');
  }
  
  function showLeadDetail(leadIndex) {
    const leads = (dashboardData && dashboardData.newLeads) || [];
    const lead = leads[leadIndex];
    if (!lead) return;
    
    const isTechLead = lead.source === 'Technician';
    
    const modalHtml = `
      <div id="leadDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="closeLeadDetailModal()">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
          <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
              <h3 class="text-xl font-bold text-gray-800">Lead Details</h3>
              ${isTechLead ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded font-semibold">üë∑ Tech Lead</span>' : '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-semibold">üíº Sales Lead</span>'}
            </div>
            <button type="button" onclick="closeLeadDetailModal()" aria-label="Close lead detail modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
          
          <div class="p-6">
            <div class="space-y-4">
              <div>
                <label class="text-sm font-semibold text-gray-600">Customer Name</label>
                <p class="text-lg font-bold text-gray-800">${lead.customer_name || 'N/A'}</p>
              </div>
              
              ${isTechLead && lead.pocName ? `
              <div>
                <label class="text-sm font-semibold text-gray-600">Point of Contact</label>
                <p class="text-gray-800">${lead.pocName}</p>
              </div>
              ` : ''}
              
              <div>
                <label class="text-sm font-semibold text-gray-600">Service Address</label>
                <p class="text-gray-800">${lead.service_address || 'N/A'}</p>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-semibold text-gray-600">Phone</label>
                  <p class="text-gray-800"><a href="tel:${lead.phone || ''}" class="text-blue-600 hover:underline">${lead.phone || 'N/A'}</a></p>
                </div>
                ${isTechLead && lead.email ? `
                <div>
                  <label class="text-sm font-semibold text-gray-600">Email</label>
                  <p class="text-gray-800"><a href="mailto:${lead.email}" class="text-blue-600 hover:underline">${lead.email}</a></p>
                </div>
                ` : ''}
              </div>
              
              <div>
                <label class="text-sm font-semibold text-gray-600">Service Type Needed</label>
                <p class="text-gray-800">${lead.service_name || 'N/A'}</p>
              </div>
              
              ${!isTechLead && lead.covered_pests ? `
              <div>
                <label class="text-sm font-semibold text-gray-600">Covered Pests</label>
                <p class="text-gray-800">${lead.covered_pests}</p>
              </div>
              ` : ''}
              
              ${!isTechLead && (lead.initial_price || lead.maintenance_price) ? `
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-semibold text-gray-600">Initial Price</label>
                  <p class="text-lg font-bold text-green-600">$${(lead.initial_price || 0).toLocaleString()}</p>
                </div>
                <div>
                  <label class="text-sm font-semibold text-gray-600">Monthly Price</label>
                  <p class="text-lg font-bold text-green-600">$${(lead.maintenance_price || 0).toLocaleString()}</p>
                </div>
              </div>
              ` : ''}
              
              ${lead.special_notes ? `
              <div>
                <label class="text-sm font-semibold text-gray-600">${isTechLead ? 'Customer Issues & Notes' : 'Special Notes'}</label>
                <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mt-1">
                  <p class="text-gray-800">${lead.special_notes}</p>
                </div>
              </div>
              ` : ''}
              
              ${isTechLead && lead.submittedBy ? `
              <div>
                <label class="text-sm font-semibold text-gray-600">Submitted By</label>
                <p class="text-gray-800">${lead.submittedBy} (Technician)</p>
              </div>
              ` : ''}
            </div>
            
            <div class="mt-6 flex gap-3">
              <button type="button" onclick="startPacketFromNewLead('${lead.recordId || ''}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg">
                ${isTechLead ? 'Qualify & Start Packet' : 'Start Packet'}
              </button>
              <button type="button" onclick="closeLeadDetailModal()" class="flex-1 border border-gray-300 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-50">
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    const existingModal = document.getElementById('leadDetailModal');
    if (existingModal) existingModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }
  
  function closeLeadDetailModal() {
    const modal = document.getElementById('leadDetailModal');
    if (modal) modal.remove();
  }
  
  function startPacketFromNewLead(recordId) {
    closeLeadDetailModal();
    if (!recordId) {
      openUnifiedSaleForm();
      return;
    }
    
    const allLeads = (dashboardData && dashboardData.newLeads) || [];
    const lead = allLeads.find(function(l) { return l.recordId === recordId; });
    
    if (!lead) {
      openUnifiedSaleForm();
      return;
    }
    
    const draft = fillDraftDefaults({
      accountName: lead.customer_name || '',
      serviceAddressLine1: lead.service_address || '',
      branchId: (dashboardData && dashboardData.user ? (dashboardData.user.branchID || dashboardData.user.BranchID) : 'HOUSTON'),
      servicesInitialTotal: lead.initial_price || 0,
      servicesMonthlyTotal: lead.maintenance_price || 0,
      combinedInitialTotal: lead.initial_price || 0,
      combinedMonthlyTotal: lead.maintenance_price || 0,
      services: [{
        serviceName: lead.service_name || 'Custom Program',
        category: 'New',
        descriptionText: lead.special_notes || 'New lead from dashboard'
      }]
    });
    
    applyStartPacketDraft(draft);
    openUnifiedSaleForm();
  }
  
  function renderTasks(tasks) {
    latestServerFollowUps = Array.isArray(tasks) ? tasks.slice() : [];
    const container = document.getElementById('tasksList');
    if (!container) return;
    const rows = buildFollowUpRows();
    if (!rows.length) {
      container.innerHTML = '<p class="text-gray-500 text-sm">No pending tasks</p>';
      return;
    }
    container.innerHTML = rows.map(function(row) {
      const badge = buildFollowUpBadge(row);
      const encodedKey = row.source === 'custom' ? row.key : encodeURIComponent(row.key);
      return `
        <div class="flex items-start p-3 bg-yellow-50 rounded">
          <div class="flex-1">
            <p class="font-semibold text-gray-800">${row.customer || 'Account'}</p>
            <p class="text-sm text-gray-600">${row.task || ''}</p>
          </div>
          <div class="flex flex-col items-end gap-1">
            ${badge}
            <button type="button" class="text-xs font-semibold text-blue-600 hover:text-blue-800" onclick="completeFollowUpTask('${row.source}','${encodedKey}')">Complete</button>
          </div>
        </div>`;
    }).join('');
    refreshFollowUpModal();
  }

  function buildFollowUpRows() {
    const rows = [];
    (latestServerFollowUps || []).forEach(function(task, index) {
      const key = buildTaskKey('server', task, index);
      if (completedFollowUpIds.indexOf(key) !== -1) return;
      rows.push({
        source: 'server',
        key: key,
        customer: task.customer,
        task: task.task,
        daysOverdue: typeof task.daysOverdue === 'number' ? task.daysOverdue : null,
        dueDate: null
      });
    });
    (customFollowUps || []).forEach(function(task) {
      if (task.status === 'done') return;
      rows.push({
        source: 'custom',
        key: task.id,
        customer: task.customer,
        task: task.task,
        daysOverdue: computeDaysOverdue(task.dueDate),
        dueDate: task.dueDate
      });
    });
    return rows;
  }

  function buildFollowUpBadge(row) {
    if (typeof row.daysOverdue === 'number') {
      if (row.daysOverdue > 0) {
        return `<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">${row.daysOverdue}d overdue</span>`;
      }
      if (row.daysOverdue === 0) {
        return '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Due today</span>';
      }
      return `<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Due in ${Math.abs(row.daysOverdue)}d</span>`;
    }
    if (row.dueDate) {
      return `<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">Due ${row.dueDate}</span>`;
    }
    return '';
  }

  function computeDaysOverdue(dueDate) {
    if (!dueDate) return null;
    const target = new Date(dueDate);
    if (isNaN(target.getTime())) return null;
    const now = new Date();
    return Math.floor((now - target) / 86400000);
  }

  function buildTaskKey(source, task, index) {
    if (source === 'custom') return task.id || ('custom-' + index);
    return ['server', task.customer || '', task.task || ''].join('|');
  }

  function completeFollowUpTask(source, key) {
    if (source === 'custom') {
      customFollowUps = customFollowUps.filter(function(task) { return task.id !== key; });
      saveCustomFollowUps();
    } else {
      const decoded = decodeURIComponent(key);
      if (completedFollowUpIds.indexOf(decoded) === -1) {
        completedFollowUpIds.push(decoded);
        saveCompletedFollowUps();
      }
    }
    renderTasks(latestServerFollowUps);
  }

  function openFollowUpModal() {
    renderFollowUpModalList();
    const modal = document.getElementById('followUpModal');
    if (modal) {
      modal.classList.remove('hidden');
      setupModalEscKey(modal, closeFollowUpModal);
    }
  }

  function closeFollowUpModal() {
    const modal = document.getElementById('followUpModal');
    if (modal) modal.classList.add('hidden');
  }

  function renderFollowUpModalList() {
    const container = document.getElementById('followUpModalList');
    if (!container) return;
    const rows = buildFollowUpRows();
    if (!rows.length) {
      container.innerHTML = '<p class="text-sm text-gray-500">No pending follow-ups. Add one using the form.</p>';
      return;
    }
    container.innerHTML = rows.map(function(row) {
      const encodedKey = row.source === 'custom' ? row.key : encodeURIComponent(row.key);
      const dueLabel = row.dueDate ? `<p class="text-xs text-gray-400">Due ${new Date(row.dueDate).toLocaleDateString()}</p>` : '';
      return `<div class="bg-white border rounded-lg p-3">
        <div class="flex items-start justify-between gap-2 mb-2">
          <div>
            <p class="font-semibold text-gray-800">${row.customer || 'Account'}</p>
            <p class="text-sm text-gray-600">${row.task || ''}</p>
          </div>
          <button type="button" class="text-xs font-semibold text-blue-600 hover:text-blue-800" onclick="completeFollowUpTask('${row.source}','${encodedKey}')">Complete</button>
        </div>
        ${dueLabel}
      </div>`;
    }).join('');
  }

  function refreshFollowUpModal() {
    const modal = document.getElementById('followUpModal');
    if (modal && !modal.classList.contains('hidden')) {
      renderFollowUpModalList();
    }
  }

  function handleFollowUpFormSubmit(event) {
    event.preventDefault();
    const customer = document.getElementById('followUpCustomer').value.trim();
    const action = document.getElementById('followUpAction').value.trim();
    const dueDate = document.getElementById('followUpDueDate').value;
    if (!customer || !action) return;
    const newTask = {
      id: 'FU-' + Date.now(),
      customer: customer,
      task: action,
      dueDate: dueDate || '',
      createdAt: new Date().toISOString()
    };
    customFollowUps.unshift(newTask);
    saveCustomFollowUps();
    event.target.reset();
    renderTasks(latestServerFollowUps);
    renderFollowUpModalList();
  }
  
  function renderRecentActivity(activities) {
    const container = document.getElementById('recentActivity');
    if (!activities.length) {
      container.innerHTML = '<p class="text-gray-500 text-sm">No recent activity</p>';
      return;
    }
    container.innerHTML = activities.slice(0, 5).map(function(activity) {
      return `
        <div class="text-sm">
          <span class="font-semibold">${activity.customer}</span>
          <span class="text-gray-600"> - ${activity.action}</span>
          <span class="text-xs text-gray-400 block">${formatDate(activity.date)}</span>
        </div>`;
    }).join('');
  }

  function renderQuoteTracker() {
    const table = document.getElementById('quoteTrackerTable');
    const empty = document.getElementById('quoteTrackerEmpty');
    const badge = document.getElementById('quoteTrackerCount');
    if (!table || !empty || !badge) return;
    
    // Filter out sold items - they go to the sold tracker
    const activeEntries = quoteTrackerEntries.filter(function(entry) {
      return entry.status !== 'Sold';
    });
    
    if (!activeEntries.length) {
      table.innerHTML = '';
      empty.classList.remove('hidden');
      badge.textContent = '0 tracked';
      renderQuoteTrackerModal();
      renderSoldQuotes();
      return;
    }
    empty.classList.add('hidden');
    badge.textContent = activeEntries.length + ' tracked';
    const headers = ['Account', 'Status', 'Uploaded', 'Value', 'Actions'];
    const rows = activeEntries.map(function(entry) {
      return `
        <tr class="border-t">
          <td class="px-3 py-2">
            <p class="font-semibold text-gray-800">${entry.accountName}</p>
            <p class="text-xs text-gray-500">${entry.serviceAddress || ''}</p>
          </td>
          <td class="px-3 py-2 text-sm">${humanizeQuoteStatus(entry)}</td>
          <td class="px-3 py-2 text-sm text-gray-500">${formatRelativeTime(entry.uploadedAt)}</td>
          <td class="px-3 py-2 text-sm font-semibold">${formatCurrencyShort(entry.initial || entry.monthly || 0)}</td>
          <td class="px-3 py-2 text-xs text-right space-y-1">
            <button type="button" class="w-full border border-blue-200 text-blue-700 px-2 py-1 rounded" onclick="openQuoteTrackerEntry('${entry.id}')">Open</button>
            <button type="button" class="w-full border border-green-200 text-green-700 px-2 py-1 rounded" onclick="markQuoteTrackerSold('${entry.id}')">Mark Sold</button>
          </td>
        </tr>`;
    }).join('');
    table.innerHTML = `<thead><tr>${headers.map(function(h) {
      return `<th class="text-left text-xs uppercase tracking-wide text-gray-500 px-3 py-2">${h}</th>`;
    }).join('')}</tr></thead><tbody>${rows}</tbody>`;
    renderQuoteTrackerModal();
    renderSoldQuotes();
  }

  function renderSoldQuotes() {
    const table = document.getElementById('soldQuotesTable');
    const empty = document.getElementById('soldQuotesEmpty');
    const badge = document.getElementById('soldQuotesCount');
    if (!table || !empty || !badge) return;
    
    // Filter sold items
    const soldEntries = quoteTrackerEntries.filter(function(entry) {
      return entry.status === 'Sold';
    });
    
    if (!soldEntries.length) {
      table.innerHTML = '';
      empty.classList.remove('hidden');
      badge.textContent = '0 sold';
      return;
    }
    empty.classList.add('hidden');
    badge.textContent = soldEntries.length + ' sold';
    const headers = ['Account', 'Status', 'Sold Date', 'Value'];
    const rows = soldEntries.map(function(entry) {
      return `
        <tr class="border-t">
          <td class="px-3 py-2">
            <p class="font-semibold text-gray-800">${entry.accountName}</p>
            <p class="text-xs text-gray-500">${entry.serviceAddress || ''}</p>
          </td>
          <td class="px-3 py-2 text-sm">${humanizeQuoteStatus(entry)}</td>
          <td class="px-3 py-2 text-sm text-gray-500">${formatRelativeTime(entry.soldAt || entry.uploadedAt)}</td>
          <td class="px-3 py-2 text-sm font-semibold">${formatCurrencyShort(entry.initial || entry.monthly || 0)}</td>
        </tr>`;
    }).join('');
    table.innerHTML = `<thead><tr>${headers.map(function(h) {
      return `<th class="text-left text-xs uppercase tracking-wide text-gray-500 px-3 py-2">${h}</th>`;
    }).join('')}</tr></thead><tbody>${rows}</tbody>`;
  }

  function openQuoteTrackerModal() {
    renderQuoteTrackerModal();
    const modal = document.getElementById('quoteTrackerModal');
    if (modal) {
      modal.classList.remove('hidden');
      setupModalEscKey(modal, closeQuoteTrackerModal);
    }
  }

  function closeQuoteTrackerModal() {
    const modal = document.getElementById('quoteTrackerModal');
    if (modal) modal.classList.add('hidden');
  }

  function renderQuoteTrackerModal() {
    const container = document.getElementById('quoteTrackerModalBody');
    if (!container) return;
    if (!quoteTrackerEntries.length) {
      container.innerHTML = '<p class="text-sm text-gray-500">No Salesforce quotes imported yet. Click ‚ÄúImport Salesforce Quote‚Äù to upload a PDF.</p>';
      return;
    }
    const rows = quoteTrackerEntries.map(function(entry) {
      return `<tr class="border-t">
        <td class="px-3 py-2">
          <p class="font-semibold text-gray-800">${entry.accountName}</p>
          <p class="text-xs text-gray-500">${entry.serviceAddress || ''}</p>
        </td>
        <td class="px-3 py-2 text-sm">${humanizeQuoteStatus(entry)}</td>
        <td class="px-3 py-2 text-sm text-gray-500">${formatRelativeTime(entry.uploadedAt)}</td>
        <td class="px-3 py-2 text-sm font-semibold">${formatCurrencyShort(entry.initial || entry.monthly || 0)}</td>
        <td class="px-3 py-2 text-xs space-y-1">
          <button type="button" class="w-full border border-blue-200 text-blue-700 px-2 py-1 rounded" onclick="openQuoteTrackerEntry('${entry.id}')">Open</button>
          <button type="button" class="w-full border border-green-200 text-green-700 px-2 py-1 rounded" onclick="markQuoteTrackerSold('${entry.id}')">Mark Sold</button>
        </td>
      </tr>`;
    }).join('');
    container.innerHTML = `<table class="min-w-full text-sm">
      <thead>
        <tr>
          <th class="text-left text-xs uppercase tracking-wide text-gray-500 px-3 py-2">Account</th>
          <th class="text-left text-xs uppercase tracking-wide text-gray-500 px-3 py-2">Status</th>
          <th class="text-left text-xs uppercase tracking-wide text-gray-500 px-3 py-2">Uploaded</th>
          <th class="text-left text-xs uppercase tracking-wide text-gray-500 px-3 py-2">Value</th>
          <th class="text-left text-xs uppercase tracking-wide text-gray-500 px-3 py-2">Actions</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
  }

  function openQuoteTrackerEntry(entryId) {
    const entry = quoteTrackerEntries.find(function(item) { return item.id === entryId; });
    if (!entry) return;
    const draft = buildDraftFromQuoteTrackerEntry(entry);
    applyStartPacketDraft(draft);
    closeQuoteTrackerModal();
  }

  function buildDraftFromQuoteTrackerEntry(entry) {
    const initialValue = Number(entry.initial || 0) || 0;
    const monthlyValue = Number(entry.monthly || 0) || 0;
    return fillDraftDefaults({
      accountName: entry.accountName,
      serviceAddressLine1: entry.serviceAddress || '',
      branchId: entry.branchId || (dashboardData && dashboardData.user ? (dashboardData.user.branchID || dashboardData.user.BranchID) : 'HOUSTON'),
      servicesInitialTotal: initialValue,
      servicesMonthlyTotal: monthlyValue,
      combinedInitialTotal: initialValue,
      combinedMonthlyTotal: monthlyValue,
      services: [{
        serviceName: (entry.serviceType || (entry.lobs && entry.lobs[0])) || 'Imported Service',
        category: (entry.lobs && entry.lobs[0]) || 'Proposal',
        descriptionText: 'Scope imported from Salesforce quote tracker.'
      }],
      quoteTrackerId: entry.id
    });
  }

  function getTodayRange() {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const end = new Date(start.getTime() + 86400000);
    return { start: start, end: end };
  }

  function getTodaysQuoteStats() {
    const range = getTodayRange();
    const entries = Array.isArray(quoteTrackerEntries) ? quoteTrackerEntries : [];
    const todays = entries.filter(function(entry) {
      if (!entry.uploadedAt) return false;
      const date = new Date(entry.uploadedAt);
      return date >= range.start && date < range.end;
    });
    const soldToday = entries.filter(function(entry) {
      if (!entry.soldAt) return false;
      const date = new Date(entry.soldAt);
      return date >= range.start && date < range.end;
    });
    const lobsDelivered = collectUniqueLobs(todays);
    const lobsSold = collectUniqueLobs(soldToday);
    const dollarsSold = soldToday.reduce(function(sum, entry) {
      return sum + (Number(entry.initial || 0) + Number(entry.monthly || 0) * 12);
    }, 0);
    const proposalValue = todays.reduce(function(sum, entry) {
      return sum + (Number(entry.initial || 0) + Number(entry.monthly || 0) * 12);
    }, 0);
    const eventsCount = todays.length + soldToday.length;
    let eventsSummary = '';
    if (eventsCount) {
      const pieces = [];
      if (todays.length) pieces.push(todays.length + ' proposals delivered');
      if (soldToday.length) pieces.push(soldToday.length + ' converted/signed');
      eventsSummary = pieces.join(', ') + '.';
    }
    return {
      proposalsDelivered: todays.length,
      lobsOnProposals: lobsDelivered,
      lobsSold: lobsSold,
      dollarsSold: dollarsSold,
      dollarsProposed: proposalValue,
      nextDayConfCount: todays.length,
      eventsCount: eventsCount,
      eventsSummary: eventsSummary
    };
  }

  function collectUniqueLobs(entries) {
    const items = [];
    (entries || []).forEach(function(entry) {
      if (!entry) return;
      const list = Array.isArray(entry.lobs) ? entry.lobs : parseLobCsv(entry.lobs);
      if (list.length) {
        list.forEach(function(label) { items.push(label); });
      } else if (entry.serviceType) {
        items.push(entry.serviceType);
      } else if (entry.accountName) {
        items.push(entry.accountName);
      }
    });
    return uniqueStrings(items);
  }

  function prefillActivityFromQuotes() {
    const stats = getTodaysQuoteStats();
    if (!stats.proposalsDelivered && !stats.dollarsProposed) {
      alert('No Salesforce imports logged today. Import a quote to auto-fill.');
      return;
    }
    document.getElementById('formProposalsDelivered').value = stats.proposalsDelivered || 0;
    document.getElementById('formLobsOnProposals').value = lobListToCsv(stats.lobsOnProposals);
    document.getElementById('formLobsSold').value = lobListToCsv(stats.lobsSold);
    document.getElementById('formDollarsSold').value = (stats.dollarsSold || 0).toFixed(0);
    document.getElementById('formDollarsProposed').value = (stats.dollarsProposed || 0).toFixed(0);
    document.getElementById('formNextDayConf').value = stats.nextDayConfCount || 0;
    document.getElementById('formEventsCount').value = stats.eventsCount || 0;
    document.getElementById('formEvents').value = stats.eventsSummary || 'Auto-filled from Salesforce imports.';
  }

  function loadQuoteTrackerEntries() {
    if (!window.localStorage) return [];
    try {
      const stored = JSON.parse(window.localStorage.getItem(quoteTrackerKey));
      if (!Array.isArray(stored)) return [];
      return stored.map(function(entry) {
        if (!entry) return entry;
        if (!entry.lobs && entry.serviceType) {
          entry.lobs = parseLobCsv(entry.serviceType);
        }
        return entry;
      });
    } catch (err) {
      console.warn('Quote tracker load failed', err);
      return [];
    }
  }

  function saveQuoteTrackerEntries() {
    if (!window.localStorage) return;
    try {
      window.localStorage.setItem(quoteTrackerKey, JSON.stringify(quoteTrackerEntries));
    } catch (err) {
      console.warn('Quote tracker save failed', err);
    }
  }

  function trackSalesforceProposal(draft) {
    if (!draft || !draft.accountName) return null;
    const trackerId = draft.quoteTrackerId || draft.trackerId || 'SF-' + Date.now();
    const address = [draft.serviceAddressLine1 || draft.serviceAddress || '', draft.serviceCity || '', draft.serviceState || '', draft.serviceZip || '']
      .filter(Boolean)
      .join(', ');
    const lobList = deriveLobsFromServices(draft.services || []);
    const entry = {
      id: trackerId,
      accountName: draft.accountName,
      serviceAddress: address,
      uploadedAt: new Date().toISOString(),
      status: 'Proposal',
      initial: draft.combinedInitialTotal || draft.servicesInitialTotal || 0,
      monthly: draft.combinedMonthlyTotal || draft.servicesMonthlyTotal || 0,
      branchId: draft.branchId || 'HOUSTON',
      lobs: lobList
    };
    quoteTrackerEntries = [entry].concat(quoteTrackerEntries.filter(function(item) { return item.id !== trackerId; })).slice(0, 25);
    saveQuoteTrackerEntries();
    renderQuoteTracker();
    refreshTodayMetricsFromQuotes();
    return trackerId;
  }

  function deriveLobsFromServices(services) {
    if (!Array.isArray(services)) return [];
    const matches = [];
    const lobMap = [
      { label: 'Crawling Insect', test: /(general pest|gpc|crawling)/i },
      { label: 'Rodent', test: /rodent/i },
      { label: 'Fly', test: /fly|ilt/i },
      { label: 'Bird', test: /bird/i },
      { label: 'Drain', test: /drain/i },
      { label: 'Mosquito', test: /mosquito/i }
    ];
    services.forEach(function(service) {
      if (!service) return;
      const name = (service.category || service.serviceName || service.programType || '').trim();
      if (name) {
        matches.push(name);
      }
      lobMap.forEach(function(entry) {
        if (entry.test.test(name)) {
          matches.push(entry.label);
        }
      });
    });
    return uniqueStrings(matches);
  }

  function markQuoteTrackerSold(trackerId, saleRecordID) {
    // If no tracker ID is provided, this sale wasn't initiated from quote tracker, so skip
    if (!trackerId && !saleRecordID) return;
    const entry = quoteTrackerEntries.find(function(item) {
      if (trackerId && item.id === trackerId) return true;
      if (saleRecordID && item.saleRecordID === saleRecordID) return true;
      return false;
    });
    // If no entry found, this sale wasn't from quote tracker, so just skip silently
    if (!entry) {
      return;
    }
    if (entry.status === 'Sold') {
      alert('This quote has already been marked as sold.');
      return;
    }
    
    // Build draft from entry and open unified sale form
    const draft = buildDraftFromQuoteTrackerEntry(entry);
    applyStartPacketDraft(draft);
    closeQuoteTrackerModal();
    
    // Show confirmation message
    alert('Quote marked as sold. Please review and submit the start packet form below. Once submitted, the quote will be updated automatically.');
    
    // Update entry status after form submission will be handled by unified form submit
    entry.status = 'Sold';
    entry.saleRecordID = saleRecordID || entry.saleRecordID;
    entry.soldAt = new Date().toISOString();
    saveQuoteTrackerEntries();
    renderQuoteTracker();
    refreshTodayMetricsFromQuotes();
  }

  function humanizeQuoteStatus(entry) {
    if (!entry) return '--';
    if (entry.status === 'Sold') {
      return `<span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-700">Sold</span>`;
    }
    return `<span class="px-2 py-1 rounded-full text-xs bg-amber-100 text-amber-700">Proposal</span>`;
  }

  function formatRelativeTime(value) {
    if (!value) return '--';
    const date = new Date(value);
    if (isNaN(date.getTime())) return '--';
    const diff = Date.now() - date.getTime();
    const minutes = Math.floor(diff / 60000);
    if (minutes < 60) return minutes + 'm ago';
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + 'h ago';
    const days = Math.floor(hours / 24);
    return days + 'd ago';
  }

  function formatCurrencyShort(value) {
    const num = Number(value) || 0;
    if (num >= 1000) {
      return '$' + (num / 1000).toFixed(1) + 'k';
    }
    return '$' + num.toLocaleString(undefined, { maximumFractionDigits: 0 });
  }

  function formatCurrencyFull(value) {
    return '$' + (Number(value) || 0).toLocaleString(undefined, { maximumFractionDigits: 0 });
  }

  function formatCurrencyExact(value) {
    const num = Number(value);
    if (!isFinite(num)) return '$0.00';
    return '$' + num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function normalizeMonthLabel(value) {
    if (!value) return '';
    const lower = value.toString().trim().toLowerCase();
    if (!lower) return '';
    return lower.charAt(0).toUpperCase() + lower.slice(1);
  }

  function buildEquipmentSummary(equipment) {
    if (!equipment) return '';
    if (equipment.summary) {
      return equipment.summary;
    }
    const parts = [];
    if (equipment.multCatchQty) parts.push(formatEquipmentQty(equipment.multCatchQty) + ' MRT');
    if (equipment.rbsQty) parts.push(formatEquipmentQty(equipment.rbsQty) + ' RBS');
    if (equipment.iltQty) parts.push(formatEquipmentQty(equipment.iltQty) + ' ILT');
    (equipment.otherEquipment || []).forEach(function(item) {
      if (!item) return;
      const quantity = item.quantity ? formatEquipmentQty(item.quantity) + ' ' : '';
      parts.push((quantity ? quantity : '') + (item.name || 'Equipment'));
    });
    return parts.join(', ');
  }

  function formatEquipmentQty(value) {
    if (value === null || value === undefined) return '';
    if (Math.abs(value - Math.round(value)) < 0.00001) {
      return String(Math.round(value));
    }
    return String(value);
  }

  function buildServiceDescriptions(services) {
    if (!Array.isArray(services) || !services.length) return '';
    var order = { 'GPC':0,'RBS':1,'MRT':2,'ILT':3 };
    var lines = services.map(function(service) {
      if (!service) return null;
      var code = (service.serviceCode || '').toUpperCase();
      var displayLabel = (function(){
        if (code === 'GPC') return 'General Pest Control';
        if (code === 'RBS') return 'Exterior Monitoring';
        if (code === 'MRT') return 'Interior Monitoring';
        if (code === 'ILT') return 'Insect Light Trap';
        return service.serviceName || service.programType || 'Service';
      })();
      var freq = service.frequencyLabel || null;
      if (!freq && service.servicesPerYear) {
        freq = service.servicesPerYear >= 24 ? 'Semi-Monthly' : service.servicesPerYear >= 12 ? 'Monthly' : (service.servicesPerYear + 'x/Year');
      }
      if (code === 'ILT' && service.servicesPerYear >= 24) freq = 'Semi-Monthly';
      if (!freq) freq = 'Monthly';
      var rightLabel = (function(){
        if (code === 'GPC') return 'GPC';
        if (code === 'RBS') return 'Exterior Monitoring';
        if (code === 'MRT') return 'Interior Monitoring';
        if (code === 'ILT') return 'ILT';
        return service.programType || service.serviceName || displayLabel;
      })();
      return { code: code, text: displayLabel + ' (' + freq + '): ' + rightLabel };
    }).filter(Boolean);

    lines.sort(function(a,b){
      var ao = order.hasOwnProperty(a.code)?order[a.code]:9;
      var bo = order.hasOwnProperty(b.code)?order[b.code]:9;
      if (ao === bo) return a.text.localeCompare(b.text);
      return ao - bo;
    });

    // Deduplicate by code+text to avoid dup rows
    var dedup = [];
    lines.forEach(function(entry){
      if (!dedup.some(function(e){ return e.code === entry.code && e.text === entry.text; })) dedup.push(entry);
    });

    return dedup.map(e => e.text).join('\n');
  }

  function inferServicesPerYear(label) {
    if (!label) return null;
    const lower = label.toLowerCase();
    if (lower.indexOf('weekly') !== -1) return 52;
    if (lower.indexOf('bi-weekly') !== -1) return 26;
    if (lower.indexOf('semi-monthly') !== -1) return 24;
    if (lower.indexOf('monthly') !== -1) return 12;
    if (lower.indexOf('quarter') !== -1) return 4;
    if (lower.indexOf('semi-annual') !== -1) return 2;
    if (lower.indexOf('annual') !== -1 || lower.indexOf('yearly') !== -1) return 1;
    return null;
  }

  function buildDescriptiveServiceName(services, equipment, draft) {
    const hasMRT = equipment && equipment.multCatchQty > 0;
    const hasRBS = equipment && equipment.rbsQty > 0;
    const hasILTEquipment = equipment && equipment.iltQty > 0;

    const flags = {
      hasGpc: false,
      hasInterior: false,
      hasExterior: false,
      hasRodent: false,
      hasIlt: false
    };

    (services || []).forEach(function(service) {
      const source = `${service.serviceName || ''} ${service.programType || ''} ${service.category || ''}`.toLowerCase();
      if (source.includes('general pest') || source.includes('gpc') || source.includes('maintenance')) {
        flags.hasGpc = true;
      }
      if (source.includes('interior rodent') || source.includes('mrt')) {
        flags.hasInterior = true;
        flags.hasRodent = true;
      }
      if (source.includes('exterior rodent') || source.includes('rbs')) {
        flags.hasExterior = true;
        flags.hasRodent = true;
      }
      if (source.includes('rodent')) {
        flags.hasRodent = true;
      }
      if (source.includes('fly') || source.includes('ilt') || source.includes('insect light trap') || source.includes('lumnia')) {
        flags.hasIlt = true;
      }
    });

    if (!services || !services.length) {
      flags.hasGpc = true;
      if (hasMRT || hasRBS) flags.hasRodent = true;
      if (hasMRT) flags.hasInterior = true;
      if (hasRBS) flags.hasExterior = true;
      if (hasILTEquipment) flags.hasIlt = true;
    } else {
      if (hasMRT) flags.hasInterior = true;
      if (hasRBS) flags.hasExterior = true;
      if (hasILTEquipment) flags.hasIlt = true;
    }

    const segments = [];
    if (flags.hasGpc) {
      segments.push('GPC');
    }

    if (flags.hasInterior || flags.hasExterior || flags.hasRodent || hasMRT || hasRBS) {
      if ((flags.hasInterior || hasMRT) && (flags.hasExterior || hasRBS)) {
        segments.push('Interior/Exterior Rodent Monitoring');
      } else if (flags.hasInterior || hasMRT) {
        segments.push('Interior Rodent Monitoring');
      } else if (flags.hasExterior || hasRBS) {
        segments.push('Exterior Rodent Monitoring');
      } else {
        segments.push('Rodent Monitoring');
      }
    }

    if (flags.hasIlt || hasILTEquipment) {
      segments.push('ILT Maintenance');
    }

    if (segments.length) {
      return segments.join(', ');
    }

    if (services && services.length) {
      const fallbackService = services[0];
      return fallbackService.serviceName || fallbackService.programType || 'General Pest Control';
    }

    const fallback = [];
    fallback.push('GPC');
    if (hasMRT || hasRBS) fallback.push('Interior/Exterior Rodent Monitoring');
    if (hasILTEquipment) fallback.push('ILT Maintenance');
    return fallback.join(', ') || 'General Pest Control';
  }

  function applyTodayMetricsToDom(today) {
    if (!today) return;
    document.getElementById('metricProposalsDelivered').textContent = today.proposalsDelivered || 0;
    document.getElementById('metricLobsProposed').textContent = today.lobsOnProposalsText || '--';
    document.getElementById('metricLobsSoldCount').textContent = today.lobsSold ? today.lobsSold.length : 0;
    document.getElementById('metricLobsSold').textContent = today.lobsSoldText || '--';
    document.getElementById('metricDollarsSold').textContent = formatCurrencyFull(today.dollarsSold || 0);
    document.getElementById('metricDollarsProposed').textContent = formatCurrencyFull(today.dollarsProposed || 0);
    document.getElementById('metricNextDayConf').textContent = today.nextDayConfCount || 0;
    document.getElementById('metricEventsCompleted').textContent = today.eventsCount || 0;
    document.getElementById('metricEventsSummary').textContent = today.eventsSummary || 'No events logged yet.';
  }

  function refreshTodayMetricsFromQuotes() {
    if (!dashboardData) return;
    const merged = mergeDailyMetrics(dashboardData.todayMetrics || {});
    dashboardData.todayMetrics = merged;
    applyTodayMetricsToDom(merged);
  }
  
  function parseLobCsv(value) {
    if (!value) return [];
    return value.split(',').map(function(item) { return item.trim(); }).filter(Boolean);
  }

  function normalizeLobList(value) {
    if (Array.isArray(value)) return value.filter(Boolean);
    if (typeof value === 'string') return parseLobCsv(value);
    return [];
  }

  function lobListToCsv(value) {
    const arr = normalizeLobList(value);
    return arr.length ? arr.join(', ') : '';
  }

  function formatLobList(value) {
    const arr = normalizeLobList(value);
    if (!arr.length) return '--';
    return arr.join(', ');
  }

  function uniqueStrings(list) {
    const seen = {};
    return (list || []).filter(function(item) {
      if (!item) return false;
      const key = item.toLowerCase();
      if (seen[key]) return false;
      seen[key] = true;
      return true;
    });
  }

  function setSelectValueByElement(selectEl, value) {
    if (!selectEl) return;
    const formatted = value || '';
    const hasOption = Array.from(selectEl.options).some(function(option) { return option.value === formatted; });
    selectEl.value = hasOption ? formatted : '';
  }

  function setSelectValueById(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    setSelectValueByElement(el, value);
  }

  function populateStandardDropdown(id, values, placeholder) {
    const select = document.getElementById(id);
    if (!select || !Array.isArray(values)) return;
    select.innerHTML = '';
    const baseOption = document.createElement('option');
    baseOption.value = '';
    baseOption.textContent = placeholder || 'Select';
    select.appendChild(baseOption);
    values.forEach(function(value) {
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = value;
      select.appendChild(opt);
    });
  }

  function mergeDailyMetrics(baseMetrics) {
    const computed = getTodaysQuoteStats();
    const merged = Object.assign({}, computed);
    if (baseMetrics && typeof baseMetrics === 'object') {
      Object.keys(baseMetrics).forEach(function(key) {
        if (baseMetrics[key] !== undefined && baseMetrics[key] !== null && baseMetrics[key] !== '') {
          merged[key] = baseMetrics[key];
        }
      });
    }
    merged.lobsOnProposals = normalizeLobList(merged.lobsOnProposals);
    merged.lobsSold = normalizeLobList(merged.lobsSold);
    merged.lobsOnProposalsText = formatLobList(merged.lobsOnProposals);
    merged.lobsSoldText = formatLobList(merged.lobsSold);
    merged.dollarsSold = Number(merged.dollarsSold) || 0;
    merged.dollarsProposed = Number(merged.dollarsProposed) || 0;
    merged.eventsCount = merged.eventsCount || 0;
    merged.eventsSummary = merged.eventsSummary || '';
    return merged;
  }

  function buildDailyActivityPayload(activityData) {
    const payload = Object.assign({}, activityData);
    payload.lobsOnProposals = lobListToCsv(activityData.lobsOnProposals);
    payload.lobsSold = lobListToCsv(activityData.lobsSold);
    payload.tapActual = activityData.proposalsDelivered || 0;
    payload.tapGoal = activityData.nextDayConfCount || payload.tapActual;
    payload.appointmentsSet = activityData.eventsCount || 0;
    payload.appointmentsCompleted = activityData.eventsCount || 0;
    payload.quotesCreated = activityData.proposalsDelivered || 0;
    payload.quotesWon = (activityData.lobsSold || []).length || 0;
    payload.quoteValue = activityData.dollarsProposed || activityData.dollarsSold || 0;
    payload.salesGoal = activityData.dollarsProposed || activityData.dollarsSold || 0;
    payload.salesActual = activityData.dollarsSold || 0;
    return payload;
  }
  
  function formatDate(date) {
    return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }
  
  function openDailyActivityForm() {
    if (dashboardData && dashboardData.todayMetrics) {
      const today = dashboardData.todayMetrics;
      document.getElementById('formProposalsDelivered').value = today.proposalsDelivered || 0;
      document.getElementById('formLobsOnProposals').value = lobListToCsv(today.lobsOnProposals);
      document.getElementById('formLobsSold').value = lobListToCsv(today.lobsSold);
      document.getElementById('formDollarsSold').value = today.dollarsSold || 0;
      document.getElementById('formDollarsProposed').value = today.dollarsProposed || 0;
      document.getElementById('formNextDayConf').value = today.nextDayConfCount || 0;
      document.getElementById('formEventsCount').value = today.eventsCount || 0;
      document.getElementById('formEvents').value = today.eventsSummary || '';
    }
    const modal = document.getElementById('dailyActivityModal');
    modal.classList.remove('hidden');
    setupModalEscKey(modal, closeDailyActivityForm);
  }
  
  function closeDailyActivityForm() {
    document.getElementById('dailyActivityModal').classList.add('hidden');
  }
  
  function setupModalEscKey(modal, closeFn) {
    const escHandler = function(e) {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeFn();
        document.removeEventListener('keydown', escHandler);
      }
    };
    document.addEventListener('keydown', escHandler);
  }
  
  document.getElementById('dailyActivityForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const proposalsDelivered = parseInt(document.getElementById('formProposalsDelivered').value, 10) || 0;
    const lobsOnArray = parseLobCsv(document.getElementById('formLobsOnProposals').value);
    const lobsSoldArray = parseLobCsv(document.getElementById('formLobsSold').value);
    const activityData = {
      proposalsDelivered: proposalsDelivered,
      lobsOnProposals: lobsOnArray,
      lobsSold: lobsSoldArray,
      dollarsSold: parseFloat(document.getElementById('formDollarsSold').value) || 0,
      dollarsProposed: parseFloat(document.getElementById('formDollarsProposed').value) || 0,
      nextDayConfCount: parseInt(document.getElementById('formNextDayConf').value, 10) || 0,
      eventsCount: parseInt(document.getElementById('formEventsCount').value, 10) || 0,
      eventsSummary: document.getElementById('formEvents').value
    };
    const serverPayload = buildDailyActivityPayload(activityData);
    if (hasAppsScript() && google.script.run.saveDailySalesActivity) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            closeDailyActivityForm();
            loadDashboard();
            alert('Activity saved successfully!');
          } else {
            alert('Save failed: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          alert('Save failed: ' + error.message);
        })
        .saveDailySalesActivity(serverPayload);
    } else {
      Branch360DemoState.todayMetrics = Object.assign({}, Branch360DemoState.todayMetrics, activityData);
      closeDailyActivityForm();
      loadDashboard();
      alert('Activity saved locally for demo.');
    }
  });
  
  function viewAllLeads(event) {
    if (event) event.preventDefault();
    // Open pipeline modal with leads filter
    if (typeof openPipelineDetailModal === 'function') {
      openPipelineDetailModal('leads');
    } else {
      // Fallback: find and scroll to pipeline section
      const pipelineSection = document.querySelector('[id*="pipeline"], [id*="Pipeline"], [class*="pipeline"]');
      if (pipelineSection) {
        pipelineSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        alert('Lead pipeline - use the pipeline section to view all leads.');
      }
    }
  }
  
  function viewMetricDetails(metricType) {
    const today = dashboardData && dashboardData.todayMetrics ? dashboardData.todayMetrics : {};
    const month = dashboardData && dashboardData.monthMetrics ? dashboardData.monthMetrics : {};
    let details = 'Sales Metrics - ' + metricType.toUpperCase() + '\n';
    details += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    switch(metricType.toLowerCase()) {
      case 'proposals':
        details += 'Proposals Delivered Today: ' + (today.proposalsDelivered || 0) + '\n';
        details += 'LOBs on Proposals: ' + (Array.isArray(today.lobsOnProposals) ? today.lobsOnProposals.join(', ') : today.lobsOnProposals || 'None') + '\n\n';
        details += 'Month to Date: ' + (month.totalQuotes || 0) + ' quotes\n';
        details += 'Target: ' + (month.quotesTarget || 'N/A') + '\n';
        details += 'Status: ' + ((today.proposalsDelivered || 0) > 0 ? '‚úì Active' : '‚ö† No proposals today');
        break;
      case 'lobs':
        details += 'PRP LOBs Sold Today: ' + (today.lobsSoldCount || 0) + '\n';
        details += 'Lines Sold: ' + (Array.isArray(today.lobsSold) ? today.lobsSold.join(', ') : today.lobsSold || 'None') + '\n\n';
        details += 'Month to Date: ' + (month.totalSales || 0) + ' sales\n';
        details += 'Win Rate: ' + (month.winRate || 0) + '%\n';
        details += 'Status: ' + ((today.lobsSoldCount || 0) > 0 ? '‚úì Sales Today' : '‚ö† No sales today');
        break;
      default:
        details += 'Details for this metric will be available soon.';
    }
    alert(details);
  }

  function viewPipeline(event) {
    if (event) event.preventDefault();
    const leadSection = document.getElementById('leadPipelineTable');
    if (leadSection) {
      leadSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
      alert('Pipeline metrics load below‚Äîscroll down to view details.');
    }
  }

  function handlePipelineStageClick(stageKey) {
    openPipelineDetailModal(stageKey);
  }

  function handlePipelineStageKey(event, stageKey) {
    if (event.key === 'Enter' || event.key === ' ') {
      event.preventDefault();
      handlePipelineStageClick(stageKey);
    }
  }

  function mapSalesStageToLeadFilter(stageKey) {
    switch ((stageKey || '').toLowerCase()) {
      case 'proposal':
        return 'Qualified';
      case 'negotiation':
        return 'Contacted';
      case 'sold':
        return 'Converted';
      case 'leads':
      case 'sales':
      default:
        return 'all';
    }
  }

  function openPipelineDetailModal(stageKey) {
    const mapped = mapSalesStageToLeadFilter(stageKey);
    if (mapped) {
      setLeadStageFilter(mapped);
    }
    renderPipelineDetailModal();
    const modal = document.getElementById('pipelineDetailModal');
    if (modal) {
      modal.classList.remove('hidden');
      setupModalEscKey(modal, closePipelineDetailModal);
    }
  }

  function closePipelineDetailModal() {
    const modal = document.getElementById('pipelineDetailModal');
    if (modal) modal.classList.add('hidden');
  }

  function pipelineDetailModalIsOpen() {
    const modal = document.getElementById('pipelineDetailModal');
    return modal && !modal.classList.contains('hidden');
  }

  function renderPipelineDetailModal() {
    renderPipelineSummaryList();
    renderPipelineStageFilterButtons();
    renderPipelineModalLeads();
  }

  function renderPipelineSummaryList() {
    const container = document.getElementById('pipelineSummaryList');
    if (!container) return;
    const stages = (dashboardData && dashboardData.pipeline && dashboardData.pipeline.stages) || { proposal: [], negotiation: [], sold: [] };
    const summary = [
      { label: 'Proposal', key: 'proposal', count: stages.proposal.length, value: calculateStageValue(stages.proposal), tone: 'text-blue-700', bg: 'bg-blue-50' },
      { label: 'Negotiation', key: 'negotiation', count: stages.negotiation.length, value: calculateStageValue(stages.negotiation), tone: 'text-yellow-700', bg: 'bg-yellow-50' },
      { label: 'Sold (MTD)', key: 'sold', count: stages.sold.length, value: calculateStageValue(stages.sold), tone: 'text-green-700', bg: 'bg-green-50' }
    ];
    container.innerHTML = summary.map(function(entry) {
      return `<div class="p-4 rounded-lg ${entry.bg}">
        <p class="text-xs uppercase text-gray-500">${entry.label}</p>
        <p class="text-2xl font-bold ${entry.tone}">${entry.count} deals</p>
        <p class="text-sm text-gray-600">$${entry.value.toLocaleString()}</p>
      </div>`;
    }).join('');
  }

  function renderPipelineStageFilterButtons() {
    const container = document.getElementById('pipelineStageFilters');
    if (!container) return;
    const stages = ['all', 'New', 'Contacted', 'Qualified', 'Converted', 'Lost'];
    container.innerHTML = stages.map(function(stage) {
      const isActive = normalizeLeadStage(stage) === normalizeLeadStage(leadStageFilter);
      return `<button type="button" class="chip-button ${isActive ? 'active' : ''}" onclick="setLeadStageFilter('${stage}')">${stage === 'all' ? 'All' : stage}</button>`;
    }).join('');
  }

  function renderPipelineModalLeads() {
    const container = document.getElementById('pipelineModalLeads');
    if (!container) return;
    if (!filteredPipelineLeads.length) {
      container.innerHTML = '<p class="text-sm text-gray-500 p-3">No leads match your current filters.</p>';
      return;
    }
    container.innerHTML = filteredPipelineLeads.slice(0, 12).map(function(lead) {
      const submittedDate = lead.date ? new Date(lead.date).toLocaleDateString() : '--';
      return `<div class="p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <p class="font-semibold text-gray-800">${lead.customer_name || 'Unknown'}</p>
          <p class="text-sm text-gray-500">${lead.service_address || ''}</p>
          <p class="text-xs text-gray-400">Submitted ${submittedDate}</p>
        </div>
        <div class="flex items-center gap-3">
          <span class="text-sm font-semibold px-3 py-1 rounded-full bg-gray-100 text-gray-800">${lead.status || 'New'}</span>
          <button type="button" class="text-xs font-semibold text-blue-600 hover:text-blue-800" onclick="startPacketFromPipelineLead('${lead.recordId || ''}')">
            Pre-fill Start Packet
          </button>
        </div>
      </div>`;
    }).join('');
  }

  function startPacketFromPipelineLead(recordId) {
    var lead = null;
    if (recordId) {
      lead = pipelineLeads.find(function(item) {
        return item.recordId === recordId;
      });
    }
    if (!lead) {
      lead = pipelineLeads[0];
    }
    if (!lead) {
      openUnifiedSaleForm();
      return;
    }
    const record = lead.raw || {};
    const initialValue = Number(record.InitialPrice || record.initialPrice || lead.value || 0) || 0;
    const monthlyValue = Number(record.MaintenancePrice || record.maintenancePrice || 0) || 0;
    const draft = fillDraftDefaults({
      accountName: record.AccountName || record.accountName || lead.customer_name,
      contactName: record.POCName || record.pocName || '',
      contactEmail: record.POCEmail || record.pocEmail || '',
      serviceAddressLine1: record.ServiceAddress || record.serviceAddress || lead.service_address || '',
      branchId: record.BranchID || record.branchID || (dashboardData && dashboardData.user ? (dashboardData.user.branchID || dashboardData.user.BranchID) : 'HOUSTON'),
      servicesInitialTotal: initialValue,
      servicesMonthlyTotal: monthlyValue,
      combinedInitialTotal: initialValue,
      combinedMonthlyTotal: monthlyValue,
      services: [{
        serviceName: record.ServiceName || record.serviceName || lead.notes || 'Custom Program',
        category: record.ServiceType || record.serviceType || lead.status || 'New',
        descriptionText: record.SpecialNotes || record.specialNotes || lead.notes || 'Imported from lead pipeline.'
      }],
      quoteTrackerId: record.RecordID || record.recordID || recordId || ('PIPELINE-' + Date.now())
    });
    applyStartPacketDraft(draft);
  }

  function focusLeadPipelineTable() {
    viewPipeline();
    const table = document.getElementById('leadPipelineTable');
    if (table) {
      highlightElement(table);
    }
  }

  function highlightElement(element) {
    if (!element) return;
    element.classList.add('highlight-flash');
    setTimeout(function() {
      element.classList.remove('highlight-flash');
    }, 1500);
  }

  function normalizeLeadStage(stage) {
    if (!stage) return 'all';
    if (stage.toLowerCase() === 'all') return 'all';
    const lower = stage.toLowerCase();
    if (lower === 'new' || lower === 'contacted' || lower === 'qualified' || lower === 'converted' || lower === 'lost') {
      return lower.charAt(0).toUpperCase() + lower.slice(1);
    }
    return 'all';
  }

  function setLeadStageFilter(stage) {
    const normalized = normalizeLeadStage(stage);
    leadStageFilter = normalized === 'all' ? 'all' : normalized;
    renderPipelineStageFilterButtons();
    applyLeadFilters();
  }

  function loadUnifiedSalesPipeline() {
    if (!dashboardData || !dashboardData.user) return;
    const branchId = dashboardData.user.branchID || dashboardData.user.BranchID || 'HOUSTON';
    if (hasAppsScript() && google.script.run.getUnifiedSales) {
      google.script.run
        .withSuccessHandler(function(records) {
          pipelineLeads = transformUnifiedSales(records || [], currentUserId);
          applyLeadFilters();
        })
        .withFailureHandler(function(error) {
          console.warn('Unified sales pipeline failed, using demo data', error.message);
          pipelineLeads = transformUnifiedSales(getDemoUnifiedSales(), currentUserId);
          applyLeadFilters();
        })
        .getUnifiedSales({ branchId: branchId });
    } else {
      pipelineLeads = transformUnifiedSales(getDemoUnifiedSales(), currentUserId);
      applyLeadFilters();
    }
  }

  function transformUnifiedSales(records, userId) {
    return (records || []).filter(function(record) {
      if (!userId) return true;
      const reps = (record.SalesRepIDs || record.salesRepIDs || '').split('|').map(function(rep) { return rep.trim(); });
      return reps.some(function(rep) {
        return rep && userId && rep.toLowerCase() === userId.toLowerCase();
      });
    }).map(function(record) {
      const saleStatus = mapSaleStatus(record.Status || record.status);
      const soldDate = record.SoldDate || record.soldDate || record.CreatedOn || record.CreatedDate || new Date().toISOString();
      return {
        recordId: record.RecordID || record.recordID || record.Id || record.id || '',
        customer_name: record.AccountName || record.accountName || 'Unknown',
        service_address: record.ServiceAddress || record.serviceAddress || '',
        status: saleStatus,
        date: soldDate,
        notes: record.SpecialNotes || record.specialNotes || '',
        value: Number(record.InitialPrice || record.initialPrice || 0) + Number(record.MaintenancePrice || record.maintenancePrice || 0),
        raw: record
      };
    });
  }

  function mapSaleStatus(status) {
    switch ((status || '').toLowerCase()) {
      case 'proposal':
        return 'Qualified';
      case 'negotiation':
      case 'contacted':
        return 'Contacted';
      case 'sold':
      case 'converted':
        return 'Converted';
      case 'lost':
        return 'Lost';
      case 'new sale':
      default:
        return 'New';
    }
  }

  function applyLeadFilters() {
    filteredPipelineLeads = pipelineLeads.filter(function(lead) {
      if (leadStageFilter !== 'all') {
        const status = (lead.status || 'New').toLowerCase();
        if (status !== leadStageFilter.toLowerCase()) {
          return false;
        }
      }
      if (!leadSearchTerm) return true;
      const term = leadSearchTerm.toLowerCase();
      return (
        (lead.customer_name || '').toLowerCase().includes(term) ||
        (lead.service_address || '').toLowerCase().includes(term) ||
        (lead.notes || '').toLowerCase().includes(term)
      );
    });
    sortPipelineLeads();
    renderLeadStatusCards();
    renderPipelineTable();
    if (pipelineDetailModalIsOpen()) {
      renderPipelineModalLeads();
    }
  }

  function sortPipelineLeads() {
    filteredPipelineLeads.sort(function(a, b) {
      const dA = new Date(a.date || 0);
      const dB = new Date(b.date || 0);
      switch (leadSortMode) {
        case 'oldest':
          return dA - dB;
        case 'name':
          return (a.customer_name || '').localeCompare(b.customer_name || '');
        case 'status':
          return (a.status || '').localeCompare(b.status || '');
        case 'newest':
        default:
          return dB - dA;
      }
    });
  }

  function renderLeadStatusCards() {
    const counts = { total: pipelineLeads.length, New: 0, Contacted: 0, Qualified: 0, Converted: 0, Lost: 0 };
    pipelineLeads.forEach(function(lead) {
      const status = lead.status || 'New';
      if (counts[status] !== undefined) counts[status] += 1;
    });
    const cards = [
      { label: 'Total Leads', value: counts.total },
      { label: 'New', value: counts.New },
      { label: 'Contacted', value: counts.Contacted },
      { label: 'Qualified', value: counts.Qualified },
      { label: 'Converted', value: counts.Converted },
      { label: 'Lost', value: counts.Lost }
    ];
    document.getElementById('leadStatusCards').innerHTML = cards.map(function(card) {
      return `<div class="border rounded-lg p-3">
        <p class="text-xs text-gray-500">${card.label}</p>
        <p class="text-xl font-semibold text-gray-800">${card.value}</p>
      </div>`;
    }).join('');
  }

  function renderPipelineTable() {
    const table = document.getElementById('leadPipelineTable');
    const emptyMessage = document.getElementById('leadPipelineEmpty');
    if (!filteredPipelineLeads.length) {
      table.innerHTML = '';
      emptyMessage.classList.remove('hidden');
      return;
    }
    emptyMessage.classList.add('hidden');
    const headers = ['Customer', 'Status', 'Submitted', 'Notes'];
    const rows = filteredPipelineLeads.map(function(lead) {
      const submittedDate = lead.date ? new Date(lead.date) : null;
      const daysOld = submittedDate ? Math.floor((Date.now() - submittedDate.getTime()) / 86400000) : 0;
      let badge = '';
      if (lead.status === 'New' && daysOld >= 14) {
        badge = '<span class="ml-2 text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-700">‚ö† 14+ days</span>';
      } else if (lead.status === 'New' && daysOld >= 7) {
        badge = '<span class="ml-2 text-xs px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700">7+ days</span>';
      }
      return `
        <tr class="border-t">
          <td class="px-3 py-2">
            <p class="font-semibold">${lead.customer_name || 'Unknown'}</p>
            <p class="text-xs text-gray-500">${lead.service_address || ''}</p>
          </td>
          <td class="px-3 py-2"><span class="inline-flex items-center text-sm font-semibold">${lead.status || 'New'}${badge}</span></td>
          <td class="px-3 py-2 text-sm">${submittedDate ? submittedDate.toLocaleDateString() : '--'}</td>
          <td class="px-3 py-2 text-sm text-gray-600">${lead.notes || ''}</td>
        </tr>`;
    }).join('');
    table.innerHTML = `<thead><tr>${headers.map(function(h) {
      return `<th class="text-left text-xs text-gray-500 uppercase tracking-wide px-3 py-2">${h}</th>`;
    }).join('')}</tr></thead><tbody>${rows}</tbody>`;
  }

  function loadMyTimeSavedSummary() {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const payload = { startDate: start.toISOString(), endDate: now.toISOString() };
    if (hasAppsScript() && google.script.run.getMyTimeSavedSummary) {
      google.script.run
        .withSuccessHandler(renderMyTimeSaved)
        .withFailureHandler(function(error) {
          console.warn('Time saved summary failed, using demo data', error.message);
          renderMyTimeSaved(getDemoTimeSavedSummary());
        })
        .getMyTimeSavedSummary(payload);
    } else {
      renderMyTimeSaved(getDemoTimeSavedSummary());
    }
  }

  function renderMyTimeSaved(summary) {
    if (!summary || !summary.user) return;
    const hours = summary.user.hoursSaved || 0;
    const minutes = hours * 60;
    const displayValue = hours >= 1 ? hours.toFixed(1) + ' hours' : Math.round(minutes) + ' minutes';
    document.getElementById('myTimeSavedValue').textContent = displayValue;
    document.getElementById('myTimeSavedDetails').textContent = summary.user.activities > 0 ?
      summary.user.activities + ' workflows logged this period.' :
      'Keep working your leads to see time saved metrics.';
  }

  function buildServiceMonthOptions() {
    const container = document.getElementById('serviceMonthOptions');
    if (!container) return;
    container.innerHTML = serviceMonthValues.map(function(month) {
      return `
        <label class="flex items-center space-x-2 border rounded-lg px-3 py-2 bg-gray-50">
          <input type="checkbox" name="serviceMonthOption" value="${month}" class="text-blue-600 rounded">
          <span class="text-sm font-medium">${month}</span>
        </label>`;
    }).join('');
  }

  function setServiceMonthsSelected(selected) {
    const selectedSet = new Set((selected || []).map(function(item) { return item.toUpperCase(); }));
    document.querySelectorAll('input[name="serviceMonthOption"]').forEach(function(cb) {
      cb.checked = selectedSet.size ? selectedSet.has(cb.value.toUpperCase()) : false;
    });
  }

  function openUnifiedSaleForm() {
    resetUnifiedSaleForm();
    const modal = document.getElementById('unifiedSaleModal');
    modal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
    setupModalEscKey(modal, closeUnifiedSaleForm);
  }

  function closeUnifiedSaleForm() {
    document.getElementById('unifiedSaleModal').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
  }

  function resetUnifiedSaleForm() {
    const form = document.getElementById('unifiedSaleForm');
    if (form) form.reset();
    const now = new Date();
    const soldDateInput = document.getElementById('unifiedSoldDate');
    if (soldDateInput) soldDateInput.value = formatDateForInput(now);
    if (dashboardData && dashboardData.user) {
      const branchSelect = document.getElementById('unifiedBranch');
      if (branchSelect && dashboardData.user.branchID) {
        branchSelect.value = dashboardData.user.branchID;
      }
      const salesRepInput = document.getElementById('unifiedSalesReps');
      if (salesRepInput) {
        salesRepInput.value = dashboardData.user.name || '';
      }
      const sraByInput = document.getElementById('unifiedSRABy');
      if (sraByInput) {
        sraByInput.value = dashboardData.user.name || '';
      }
    }
    const sraDateInput = document.getElementById('unifiedSRADate');
    if (sraDateInput) {
      sraDateInput.value = formatDateForInput(now);
    }
    const sraTimeInput = document.getElementById('unifiedSRATime');
    if (sraTimeInput) {
      sraTimeInput.value = formatTimeForInput(now);
    }
    const pocEmailInput = document.getElementById('unifiedPOCEmail');
    if (pocEmailInput) {
      pocEmailInput.value = '';
    }
    const additionalHazards = document.getElementById('unifiedAdditionalHazards');
    if (additionalHazards) {
      additionalHazards.value = 'None';
    }
    // Reset billing address toggle
    const billingAddressContainer = document.getElementById('billingAddressContainer');
    if (billingAddressContainer) {
      billingAddressContainer.classList.add('hidden');
    }
    const billingAddressDifferent = document.getElementById('unifiedBillingAddressDifferent');
    if (billingAddressDifferent) {
      billingAddressDifferent.checked = false;
    }
    currentImportedContactEmail = '';
    currentQuoteTrackerId = null;
    setServiceMonthsSelected(serviceMonthValues);
    const hazardContainer = document.getElementById('hazardRows');
    if (hazardContainer) {
      setHazardRowsFromArray(defaultSraHazards);
    }
    currentImportedServices = [];
    updateSRAReviewStamp();
  }

  function addHazardRow(prefill) {
    const container = document.getElementById('hazardRows');
    if (!container) return;
    const row = document.createElement('div');
    row.className = 'hazard-row border rounded-lg p-3 bg-gray-50';
    row.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
        <div class="md:col-span-2">
          <label class="text-xs font-semibold text-gray-600">Hazard</label>
          <input type="text" class="hazard-description w-full border rounded px-3 py-2" value="${prefill && prefill.hazard ? prefill.hazard : ''}">
        </div>
        <div class="md:col-span-2">
          <label class="text-xs font-semibold text-gray-600">Control Measure</label>
          <input type="text" class="hazard-control w-full border rounded px-3 py-2" value="${prefill && prefill.control ? prefill.control : ''}">
        </div>
        <div class="md:col-span-1 flex items-center justify-between">
          <label class="flex items-center space-x-2 text-sm text-gray-700">
            <input type="checkbox" class="hazard-safe h-4 w-4 text-blue-600 rounded" ${prefill && prefill.safeToProceed === false ? '' : 'checked'}>
            <span>Safe</span>
          </label>
          <button type="button" class="text-xs text-gray-500 hover:text-red-600" onclick="removeHazardRow(this)">Remove</button>
        </div>
      </div>`;
    container.appendChild(row);
  }

  function removeHazardRow(button) {
    const row = button.closest('.hazard-row');
    if (row) row.remove();
  }

  function setHazardRowsFromArray(hazards) {
    const container = document.getElementById('hazardRows');
    if (!container) return;
    container.innerHTML = '';
    (hazards || defaultSraHazards).forEach(function(hazard) {
      addHazardRow(hazard);
    });
  }

  function collectHazardsFromForm() {
    return Array.from(document.querySelectorAll('.hazard-row')).map(function(row) {
      return {
        hazard: row.querySelector('.hazard-description').value,
        control: row.querySelector('.hazard-control').value,
        safeToProceed: row.querySelector('.hazard-safe').checked
      };
    }).filter(function(hazard) {
      return hazard.hazard || hazard.control;
    });
  }

  function openSalesforceImportModal() {
    const input = document.getElementById('salesforceQuoteFile');
    if (input) {
      input.value = '';
    }
    salesforceQuoteFile = null;
    updateImportStatus('No file selected.');
    const modal = document.getElementById('salesforceImportModal');
    modal.classList.remove('hidden');
    setupModalEscKey(modal, closeSalesforceImportModal);
  }

  function closeSalesforceImportModal() {
    document.getElementById('salesforceImportModal').classList.add('hidden');
  }

  function updateImportStatus(message) {
    const el = document.getElementById('importStatus');
    if (el) el.textContent = message;
  }

  function handleSalesforceQuoteFile(event) {
    salesforceQuoteFile = event.target.files && event.target.files.length ? event.target.files[0] : null;
    if (salesforceQuoteFile) {
      updateImportStatus('Selected: ' + salesforceQuoteFile.name);
    } else {
      updateImportStatus('No file selected.');
    }
  }

  async function processSalesforceQuote() {
    if (!salesforceQuoteFile) {
      alert('Please select a Salesforce quote PDF.');
      return;
    }
    if (!window.pdfjsLib) {
      alert('PDF parser library not available.');
      return;
    }
    try {
      updateImportStatus('Extracting PDF text...');
      const text = await extractTextFromPdfFile(salesforceQuoteFile);
      window.__lastSalesforceQuoteText = text;
      console.log('[SF Parser] Extracted text preview:', (text || '').slice(0, 2000));
      updateImportStatus('Parsing quote details...');
      var activityToken = window.ActivityClient ? ActivityClient.start('AE_IMPORT_SF_QUOTE', salesforceQuoteFile.name, { role: 'AE' }) : null;
      const runner = hasAppsScript() ? google.script.run : null;
      if (runner && runner.parseSalesforceQuoteTextToStartPacketDraft) {
        runner
          .withSuccessHandler(function(draft) {
            if (activityToken && window.ActivityClient) {
              ActivityClient.finish(activityToken, { success: true });
              activityToken = null;
            }
            applyStartPacketDraft(draft);
            closeSalesforceImportModal();
            alert('Salesforce quote imported. Review the start entry and click Mark Sold & Generate Start Packet.');
          })
          .withFailureHandler(function(error) {
            if (activityToken && window.ActivityClient) {
              ActivityClient.finish(activityToken, { success: false, message: error.message });
              activityToken = null;
            }
            updateImportStatus('Failed: ' + error.message);
            alert('Unable to parse quote: ' + error.message);
          })
          .parseSalesforceQuoteTextToStartPacketDraft(text);
      } else {
        const fallbackDraft = fallbackParseSalesforceQuoteText(text);
        console.log('[SF Parser] Fallback draft:', fallbackDraft);
        if (activityToken && window.ActivityClient) {
          ActivityClient.finish(activityToken, { success: true, demo: true });
          activityToken = null;
        }
        applyStartPacketDraft(fallbackDraft);
        closeSalesforceImportModal();
        alert('Salesforce quote imported (demo parser). Review the entry and click Mark Sold & Generate Start Packet.');
      }
    } catch (err) {
      updateImportStatus('Failed: ' + err.message);
      alert('Unable to extract PDF: ' + err.message);
    }
  }

  // ==========================================
  // 1. SMART PDF TEXT EXTRACTOR (Universal Fix for "Blob" Text)
  // ==========================================
  async function extractTextFromPdfFile(file) {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let text = '';

    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      if (content.items.length === 0) continue;

      // Sort by Y (vertical) then X (horizontal) to enforce visual reading order
      // This fixes the issue where columns or headers get merged into body text
      const items = content.items.map(item => ({
        str: item.str,
        x: item.transform[4],
        y: item.transform[5],
        h: item.height || item.transform[3]
      })).sort((a, b) => {
        // If Y difference is > 5, consider it a new line (PDF coordinates start at bottom-left)
        if (Math.abs(a.y - b.y) > 5) return b.y - a.y; 
        return a.x - b.x; 
      });

      let pageText = '';
      let lastY = items[0].y;

      for (let j = 0; j < items.length; j++) {
        const item = items[j];
        // Insert New Line if Y changes significantly
        if (Math.abs(item.y - lastY) > 5) {
          pageText += '\n';
        } else if (j > 0) {
          pageText += ' '; // Add space between words on same line
        }
        pageText += item.str;
        lastY = item.y;
      }
      text += pageText + '\n\n';
    }
    return text;
  }

  function fallbackParseSalesforceQuoteText(text) {
    return clientParseSalesforceQuote(text);
  }

  // ==========================================
  // 2. UNIVERSAL SALESFORCE PARSER (Truth BBQ / Grimaldi / CKS Support)
  // ==========================================
  var StrictSalesforceParser = (function() {
    var HEADER_BLOCK_TERMINATORS = ['prepared by', 'equipment', 'total cost of equipment', 'investment summary', 'covered pests', 'scope of service', 'service specifications', 'table of contents'];
    var ROUTINE_SECTION_TERMINATORS = ['investment summary', 'plan limitations', 'scope of service', 'equipment summary', 'covered pests', 'timeline'];
    var ADDRESS_LINE_REGEX = /^[0-9].*(?:\b(?:st|street|rd|road|dr|drive|ln|lane|blvd|boulevard|ave|avenue|hwy|highway|way|trail|trl|terrace|ter|pkwy|parkway|court|ct|cir|circle|loop|suite|ste|unit)\b)/i;
    var EMAIL_REGEX = /([A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,})/i;
    var MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    // Comprehensive Mapping based on analyzing multiple Start Packets
    const SERVICE_MAP = [
      { key: 'drain fly', label: 'Drain line service' },
      { key: 'small fly', label: 'Small fly service' },
      { key: 'ecocatch', label: 'EcoCatch fly baiting' },
      { key: 'general pest', label: 'GPC' },
      { key: 'insect light', label: 'ILT service' },
      { key: 'interior', label: 'Interior rodent' },
      { key: 'exterior', label: 'Exterior rodent' },
      { key: 'knockdown', label: 'Focal treatment' },
      { key: 'cleanout', label: 'Cleanout' },
      { key: 'bed bug', label: 'Bed Bug service' },
      { key: 'mosquito', label: 'Mosquito service' }
    ];

    // --- DESCRIPTION BUILDERS ---
    function buildInitialDescription(equipment, initialCost, oneTimeServices) {
      var parts = [];
      if (equipment.multCatchQty > 0) parts.push(equipment.multCatchQty + " MRT");
      if (equipment.rbsQty > 0) parts.push(equipment.rbsQty + " RBS");
      if (equipment.iltQty > 0) parts.push(equipment.iltQty + " ILT");

      if (oneTimeServices && oneTimeServices.length > 0) {
          oneTimeServices.forEach(svc => parts.push(svc.name));
      }

      if (!parts.length && initialCost > 0) return "Initial service";
      if (!parts.length) return "Standard Initial Setup";

      var equipmentList = parts.length > 1 ? parts.slice(0,-1).join(", ") + ", & " + parts.slice(-1) : parts[0];
      return "Initial service and install " + equipmentList;
    }

    function buildMaintenanceDescription(services) {
      if (!services || services.length === 0) return "Monthly GPC";

      var hasAfterHours = false;
      var normalized = services.map(function(svc) {
        var rawName = (svc.serviceName || svc.programType || "").toLowerCase();
        if (/after\s+hours.*yes/i.test(rawName) || svc.afterHours) hasAfterHours = true;

        var code = (svc.serviceCode || '').toUpperCase();
        var label = (function(){
          if (code === 'GPC') return 'GPC';
          if (code === 'RBS') return 'Exterior Rodent Monitoring';
          if (code === 'MRT') return 'Interior Rodent Monitoring';
          if (code === 'ILT') return 'ILT Maintenance';
          var mapping = SERVICE_MAP.find(m => rawName.includes(m.key));
          if (mapping) return mapping.label;
          var clean = rawName.replace(/maintenance|service|core services/gi, "").trim();
          return clean || 'Service';
        })();

        // Normalize frequency labels using servicesPerYear where possible
        var freq = svc.frequencyLabel || null;
        if (!freq && svc.servicesPerYear) {
          freq = svc.servicesPerYear >= 24 ? 'Semi-Monthly' : svc.servicesPerYear >= 12 ? 'Monthly' : null;
        }
        if (code === 'ILT' && svc.servicesPerYear >= 24) freq = 'Semi-Monthly';
        if (!freq) freq = 'Monthly';

        return { code: code, freq: freq, label: label, text: `${freq} ${label}` };
      }).filter(function(entry){
        // Only keep the mapped core codes to avoid stray "Semi-Monthly Service" rows
        return ['GPC','RBS','MRT','ILT'].indexOf(entry.code) !== -1;
      });

      // Order explicitly: GPC -> RBS -> MRT -> ILT -> others
      var order = { 'GPC':0,'RBS':1,'MRT':2,'ILT':3 };
      normalized.sort(function(a,b){
        var ao = order.hasOwnProperty(a.code)?order[a.code]:9;
        var bo = order.hasOwnProperty(b.code)?order[b.code]:9;
        if (ao === bo) return a.text.localeCompare(b.text);
        return ao - bo;
      });

      // Deduplicate by code+label so we don't get both monthly and semi-monthly ILT rows
      var deduped = [];
      normalized.forEach(function(entry){
        if (!deduped.some(function(d){ return d.code === entry.code && d.label === entry.label; })) {
          deduped.push(entry);
        }
      });

      var joined = deduped.length > 1 ? deduped.slice(0,-1).map(e=>e.text).join(", ") + " & " + deduped.slice(-1)[0].text : deduped[0].text;
      if (hasAfterHours) joined += " (Includes After Hours Service)";
      return joined;
    }

    // --- MAIN PARSE LOGIC ---
    function parseSalesforceQuoteTextToStartPacketDraft(text) {
      if (!text) throw new Error('No text to parse.');
      
      // Normalize
      var rawLines = text.replace(/\r\n/g, '\n').split('\n').map(l => l.trim()).filter(l => l.length > 0);
      var lines = expandLines(rawLines); 

      var header = extractPreparedForFields(lines);
      var preparedBy = extractPreparedBySection(lines);
      var equipmentInfo = extractEquipmentSection(lines);
      var pricing = extractPricing(lines);
      var schedule = extractRequestedStart(lines);
      
      // Extract both Routine AND Corrective (One-Time) services
      var routine = extractRoutineServices(lines, equipmentInfo.equipment); 
      var corrective = extractCorrectiveServices(lines);

      var derivedPests = deriveCoveredPests(extractCoveredPestsSection(lines), routine.signals, equipmentInfo.equipment);

      // Financials
      var oneTimeCost = pricing.oneTimeCost !== null ? pricing.oneTimeCost : equipmentInfo.totalCost;
      var initialSvcCost = pricing.initialSvcCost;
      var monthlyCost = pricing.avgMonthlyCost;
      var annualCost = monthlyCost !== null ? Math.round(monthlyCost * 12 * 100)/100 : null;
      
      // Combined Initial = Equipment + Initial Service
      var combinedInitial = null;
      if (oneTimeCost !== null || initialSvcCost !== null) {
          combinedInitial = Math.round(((oneTimeCost || 0) + (initialSvcCost || 0)) * 100) / 100;
      }

      var draft = {
        accountName: header.accountName,
        contactName: header.contactName,
        contactEmail: header.contactEmail,
        serviceAddressLine1: header.serviceAddressLine1,
        serviceCity: header.serviceCity,
        serviceState: header.serviceState,
        serviceZip: header.serviceZip,
        aeName: preparedBy.aeName,
        aeEmail: preparedBy.aeEmail,
        branchId: 'BRN-001',
        jobType: (monthlyCost > 0) ? 'Contract' : null,
        services: routine.services,
        equipment: equipmentInfo.equipment,
        equipmentOneTimeTotal: oneTimeCost,
        servicesInitialTotal: initialSvcCost,
        combinedInitialTotal: combinedInitial,
        servicesMonthlyTotal: monthlyCost,
        combinedMonthlyTotal: monthlyCost,
        servicesAnnualTotal: annualCost,
        combinedAnnualTotal: annualCost,
        monthlyCost: monthlyCost,
        annualCost: annualCost,
        requestedStartDate: schedule.requestedStartDate,
        startMonth: schedule.startMonth,
        coveredPests: derivedPests,
        // Use the enhanced builders
        initialServiceDescription: buildInitialDescription(equipmentInfo.equipment, combinedInitial, corrective),
        maintenanceScopeDescription: buildMaintenanceDescription(routine.services),
        leadType: 'Inbound',
        serviceType: null,
        logBookNeeded: true
      };
      return draft;
    }

    // --- EXTRACTORS ---
    
    function extractPricing(lines) {
      // 1. Find Investment Summary
      var startIdx = findFirstIndex(lines, l => /investment\s+summary/i.test(l) && !/^\d+/.test(l));
      
      if (startIdx === -1) {
         startIdx = findFirstIndex(lines, l => /initial\s+investment/i.test(l) || /monthly\s+investment/i.test(l));
         if (startIdx !== -1) startIdx = Math.max(0, startIdx - 5);
      }

      if (startIdx === -1) return { oneTimeCost: null, initialSvcCost: null, avgMonthlyCost: null };

      var endIdx = findFirstIndexFrom(lines, startIdx + 1, l => 
         /^(documentation|additional services|terms|page)/i.test(l)
      );
      if (endIdx === -1) endIdx = Math.min(lines.length, startIdx + 25);
      var block = lines.slice(startIdx, endIdx);

      var oneTime = null, initial = null, monthly = null;

      // 3. Strategy A: Table Row with 3 distinct currency values
      // Expected: One-Time | Initial Svc | Monthly
      for (var i = 0; i < block.length; i++) {
          var line = block[i];
          // Match numbers like 3,455.60 or 3455.60
          var matches = line.match(/(?:\$\s*)?([0-9,]+\.[0-9]{2})/g);
          if (matches && matches.length >= 3) {
             var nums = matches.map(v => parseFloat(v.replace(/[$,\s]/g, '')));
             oneTime = nums[0];
             initial = nums[1];
             monthly = nums[2];
             break; 
          }
      }

      // 4. Fallback Strategy B: Keyword search
      if (oneTime === null) oneTime = findCurrencyInBlock(block, /(?:one[-\s]?time|initial)\s+(?:cost|investment)/i);
      if (initial === null) initial = findCurrencyInBlock(block, /(?:initial\s+(?:svc|service)|start[-\s]?up)\s+(?:cost|investment)/i);
      if (monthly === null) monthly = findCurrencyInBlock(block, /(?:avg|average|monthly)\s+(?:monthly\s+)?(?:cost|investment)/i);

      // 5. Ultimate fallback: scan entire document for a line with 3+ currency values
      if (oneTime === null || initial === null || monthly === null) {
        var currencyRegex = /\$([0-9][0-9,]*(?:\.[0-9]{2})?)/g;
        for (var j = 0; j < lines.length; j++) {
          var vals = [];
          var m;
          while ((m = currencyRegex.exec(lines[j])) !== null) {
            vals.push(parseFloat(m[1].replace(/,/g, '')));
          }
          if (vals.length >= 3) {
            if (oneTime === null) oneTime = vals[0];
            if (initial === null) initial = vals[1];
            if (monthly === null) monthly = vals[2];
            break;
          }
        }
      }

      return { oneTimeCost: oneTime, initialSvcCost: initial, avgMonthlyCost: monthly };
    }
    
    function findCurrencyInBlock(blockLines, regex) {
        for (var i = 0; i < blockLines.length; i++) {
            if (regex.test(blockLines[i])) {
                var textToCheck = blockLines[i] + " " + (blockLines[i+1] || "");
                var match = textToCheck.match(/(?:\$\s*)?([0-9,]+\.[0-9]{2})/);
                if (match) return parseFloat(match[1].replace(/,/g, ''));
            }
        }
        return null;
    }

    function extractRoutineServices(lines, equipment) {
      var idx = findFirstIndex(lines, l => /routine\s+management\s+services/i.test(l));
      if (idx === -1) return { services: [], signals: createServiceSignals() };

      var endIdx = findFirstIndexFrom(lines, idx + 1, l => 
        ROUTINE_SECTION_TERMINATORS.some(t => l.toLowerCase().indexOf(t) === 0)
      );
      if (endIdx === -1) endIdx = lines.length;

      var block = lines.slice(idx + 1, endIdx);
      var services = [];
      var signals = createServiceSignals();

      block.forEach(function(line) {
        if (!line) return;
        
        var parts = [line];
        if (/interior.*monthly.*exterior.*monthly/i.test(line)) {
            var split = line.match(/(.*?monthly)(.*)/i);
            if (split) parts = [split[1], split[2]];
        }
        
        parts.forEach(function(part) {
            var cleanLine = part.replace(/\$[\d,\.]+/g, "").trim(); 
            var freqMatch = cleanLine.match(/(.+?)\s+(?:service|svc)?\s*frequency\s*[-:]*\s*([A-Za-z0-9\-\(\)\s]+)/i);
            
            if (!freqMatch) {
                if (/exterior\s+monitoring/i.test(cleanLine) && /monthly/i.test(cleanLine)) freqMatch = [cleanLine, "Exterior Rodent Monitoring", "Monthly"];
                else if (/interior\s+monitoring/i.test(cleanLine) && /semi/i.test(cleanLine)) freqMatch = [cleanLine, "Interior Rodent Monitoring", "Semi-Monthly"];
                else if (/general\s+pest/i.test(cleanLine) && /monthly/i.test(cleanLine)) freqMatch = [cleanLine, "General Pest Control", "Monthly"];
                else if (/insect\s+light\s+trap\s+maintenance/i.test(cleanLine)) {
                    var iltFreq = /semi/i.test(cleanLine) ? "Semi-Monthly" : "Monthly";
                    freqMatch = ["Insect Light Trap Maintenance", iltFreq];
                }
            }

            if (freqMatch) {
                var label = freqMatch[1] ? freqMatch[1].trim() : freqMatch[0];
                var freqLabel = extractFrequencyLabel(freqMatch[2] || freqMatch[1]); 
                var service = buildServiceFromLabel(label, freqLabel, null, signals);
                
                if (service) {
                    if (/after\s+hours\s+service\??\s*(yes|- yes)/i.test(cleanLine)) service.afterHours = true;
                    upsertService(services, service);
                }
            }
        });
      });
      
      // If the block mentions semi-monthly ILT anywhere, force ILT to semi-monthly/24
      var iltSemi = block.some(function(line){ return /insect\s+light|ilt/i.test(line) && /semi/i.test(line); });
      
      if (!services.some(s => s.serviceCode === 'MRT') && equipment.multCatchQty > 0) 
         upsertService(services, createService('Interior Rodent Monitoring', 'MRT', 'Rodent', 'Interior', 'Semi-Monthly', 24));
      if (!services.some(s => s.serviceCode === 'RBS') && equipment.rbsQty > 0) 
         upsertService(services, createService('Exterior Rodent Monitoring', 'RBS', 'Rodent', 'Exterior', 'Monthly', 12));
      if (!services.some(s => s.serviceCode === 'ILT') && equipment.iltQty > 0) 
         upsertService(services, createService('Insect Light Trap', 'ILT', 'Fly', 'ILT', 'Semi-Monthly', 24));
      if (!services.some(s => s.serviceCode === 'GPC')) 
         upsertService(services, createService('General Pest Control', 'GPC', 'GPC', 'GPC', 'Monthly', 12));

      services.forEach(function(svc){
        if (svc.serviceCode === 'ILT') {
          if (iltSemi || svc.servicesPerYear >= 24 || (svc.frequencyLabel && /semi/i.test(svc.frequencyLabel))) {
            svc.frequencyLabel = 'Semi-Monthly';
            svc.servicesPerYear = 24;
          }
        }
      });

      services.sort((a, b) => serviceOrder(a.serviceCode) - serviceOrder(b.serviceCode));
      return { services: services, signals: signals };
    }

    function extractEquipmentSection(lines) {
      var equipment = { rbsQty: 0, multCatchQty: 0, iltQty: 0, otherEquipment: [], summary: '' };
      // Anchor on the actual equipment table tied to "Total Cost of Equipment"
      var totalIdx = findFirstIndex(lines, l => /^total\s+cost\s+of\s+equipment/i.test(l));
      if (totalIdx === -1) return { equipment: equipment, totalCost: null };

      // Walk backward to find any line that contains "Equipment" but not "Summary"
      var startIdx = -1;
      for (var back = totalIdx - 1; back >= Math.max(0, totalIdx - 30); back--) {
        var line = lines[back] || '';
        if (/equipment\s+summary/i.test(line)) continue;
        if (/^equipment\b/i.test(line) || /equipment\s+quantity/i.test(line) || /\bequipment\b/i.test(line)) {
          startIdx = back;
          break;
        }
      }
      if (startIdx === -1) return { equipment: equipment, totalCost: null };
      var endIdx = totalIdx;

      for (var i = startIdx + 1; i < endIdx; i++) {
        var row = lines[i];
        if (!row || isHeaderBlockStop(row)) continue;
        if (/routine\s+management\s+services/i.test(row)) break;
        if (/service\s+frequency/i.test(row)) continue;
        
        // Fix for orphan quantities (e.g., "22.00" on new line)
        if (/^\s*[0-9]+(\.[0-9]+)?\s*$/.test(row)) {
             var qty = parseFloat(row);
             var prevRow = lines[i-1];
             if (prevRow && !/^\s*[0-9.]+\s*$/.test(prevRow) && !/^equipment/i.test(prevRow)) {
                 categorizeEquipment(equipment, prevRow.trim(), qty);
                 continue; 
             }
        }
        var qtyMatch = row.match(/([0-9]+(?:\.[0-9]+)?)\s*$/);
        if (qtyMatch) {
            var qty = parseFloat(qtyMatch[1]);
            var name = row.slice(0, row.length - qtyMatch[0].length).trim();
            if (name) categorizeEquipment(equipment, name, qty);
        }
      }
      return { equipment: equipment, totalCost: null };
    }

    function extractCorrectiveServices(lines) {
      var start = findFirstIndex(lines, l => /corrective\s+services/i.test(l));
      if (start === -1) return [];
      var end = findFirstIndexFrom(lines, start + 1, l => /total\s+cost/i.test(l));
      if (end === -1) end = Math.min(lines.length, start + 10);
      
      var correctives = [];
      for(var i = start+1; i < end; i++) {
          var line = lines[i];
          if(/knockdown|cleanout|treatment/i.test(line)) {
              // Clean up price
              correctives.push({ name: line.replace(/\$[\d,\.]+/g, "").trim() });
          }
      }
      return correctives;
    }


    // --- UTILS ---
    function expandLines(inputLines) {
      var result = [];
      inputLines.forEach(function(line) {
        if (!line) return;
        var splitPattern = /(PREPARED\s+BY:|TAILORED\s+FOR:)/i;
        if (splitPattern.test(line)) {
          var parts = line.split(splitPattern);
          var current = '';
          for (var i = 0; i < parts.length; i++) {
            if (splitPattern.test(parts[i])) {
              if (current.trim()) {
                result.push(current.trim());
              }
              current = parts[i];
            } else {
              current += parts[i];
            }
          }
          if (current.trim()) {
            result.push(current.trim());
          }
        } else if (line.length > 140 && /\s{2,}/.test(line)) {
          line.split(/\s{2,}/).forEach(function(part) {
            part = part.trim();
            if (part.length) result.push(part);
          });
        } else {
          result.push(line);
        }
      });
      return result;
    }
    function findFirstIndex(l,p){for(var i=0;i<l.length;i++)if(p(l[i]))return i;return -1}
    function findFirstIndexFrom(l,s,p){for(var i=s;i<l.length;i++)if(p(l[i]))return i;return -1}
    function isHeaderBlockStop(l){return HEADER_BLOCK_TERMINATORS.some(t=>l.toLowerCase().indexOf(t)===0)}
    function gatherBlock(l,s,c,m){var b=[];for(var i=s;i<Math.min(l.length,s+m);i++){if(i!==s&&c(l[i]))break;b.push(l[i])}return b}
    function formatQuantity(v){return (Math.abs(v-Math.round(v))<0.001)?String(Math.round(v)):String(v)}
    function roundCurrency(v){return v?Math.round(v*100)/100:null}
    function toTitleCase(v){return v?v.replace(/\b\w/g,l=>l.toUpperCase()):''}
    function createServiceSignals(){return {hasGpc:false,hasRodent:false,hasIlt:false}}
    function serviceOrder(c){return {'GPC':0,'MRT':1,'RBS':2,'ILT':3}[c]||9}
    function categorizeEquipment(e,n,q){
        var l=n.toLowerCase();
        if(/bait|rbs|eradico/.test(l))e.rbsQty+=q;
        else if(/multi|mrt|mouse/.test(l))e.multCatchQty+=q;
        else if(/light|ilt|lumnia/.test(l))e.iltQty+=q;
        else e.otherEquipment.push({name:n,quantity:q});
    }
    function upsertService(l,s){var e=l.find(x=>x.serviceCode===s.serviceCode);if(e)Object.assign(e,s);else l.push(s)}
    function buildServiceFromLabel(l,f,p,s){
        var lo=l.toLowerCase(); var c='MISC';
        if(/insect|light|ilt/.test(lo)){c='ILT';s.hasIlt=true}
        else if(/interior/.test(lo)){c='MRT';s.hasRodent=true}
        else if(/exterior/.test(lo)){c='RBS';s.hasRodent=true}
        else if(/general/.test(lo)){c='GPC';s.hasGpc=true}
        return createService(l,c,c,l,f,p||12);
    }
    function createService(n,c,cat,p,f,y){return {serviceName:n,serviceCode:c,category:cat,programType:p,frequencyLabel:toTitleCase(f),servicesPerYear:y,afterHours:false}}
    
    function extractRequestedStart(l){ 
        var idx=findFirstIndex(l,x=>/requested\s+start/i.test(x)); 
        if(idx!==-1){
            for(var i=idx;i<idx+5;i++){
                var m=l[i]&&l[i].match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
                if(m) {
                    var monthNum = parseInt(m[1]);
                    var monthName = (MONTH_NAMES && MONTH_NAMES[monthNum-1]) ? MONTH_NAMES[monthNum-1] : null;
                    return {
                        requestedStartDate: `${m[3]}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}`, 
                        startMonth: monthName
                    };
                }
            }
        } 
        return {requestedStartDate:null,startMonth:null}; 
    }
    
    function deriveCoveredPests(e,s){ return e.length?e:(s.hasRodent?['Rodents']:[]); }
    
    function extractCoveredPestsSection(lines) {
        var pests = [];
        var joined = lines.join(' ').toLowerCase();
        if (joined.includes('pavement ants')) pests.push('Pavement Ants');
        if (joined.includes('common rodents') || joined.includes('rodents')) pests.push('Rodents'); 
        if (joined.includes('common roaches') || joined.includes('cockroaches')) pests.push('Common Roaches');
        return pests;
    }

    function buildEquipmentSignature(e){ return ""; }
    function extractFrequencyLabel(t) { return t ? t.split('(')[0].trim() : null; }
    function extractServicesPerYear(t, l) { return 12; }

    function extractPreparedForFields(lines) {
      var d={accountName:null,contactName:null,contactEmail:null,serviceAddressLine1:null,serviceCity:null,serviceState:null,serviceZip:null};
      var idx=findFirstIndex(lines,l=>/tailored|prepared|account\s+name/i.test(l));
      if(idx===-1)return d;
      var b=gatherBlock(lines,idx,isHeaderBlockStop,15);
      
      // SPECIFIC LOGIC FOR "TAILORED FOR"
      // 1. TAILORED FOR
      // 2. Account Name
      // 3. POC Name
      // 4. Address Line 1
      // 5. Address Line 2 (City, State, Zip)
      // 6. (Phone usually)
      // 7. Email
      
      var tailoredIdx = b.findIndex(l => /tailored\s+for/i.test(l));
      if (tailoredIdx !== -1) {
          // Offset relative to the block `b`
          var offset = tailoredIdx;
          
          // Line +1: Account Name
          if (b[offset+1]) d.accountName = b[offset+1].trim();
          
          // Line +2: Contact Name
          if (b[offset+2]) d.contactName = b[offset+2].trim();
          
          // Line +3: Address 1
          if (b[offset+3]) d.serviceAddressLine1 = b[offset+3].trim();
          
          // Line +4: Address 2 (City, State, Zip)
          if (b[offset+4]) {
              var addr2 = b[offset+4].trim();
              d.serviceAddressLine1 = (d.serviceAddressLine1 ? d.serviceAddressLine1 + ", " + addr2 : addr2);
              
              // Try parsing city/state/zip
              var parts = addr2.split(',');
              if (parts.length > 0) d.serviceCity = parts[0].trim();
              if (parts.length > 1) {
                  var stateZip = parts[parts.length-1].trim().split(/\s+/);
                  if (stateZip.length >= 2) {
                      d.serviceZip = stateZip.pop();
                      d.serviceState = stateZip.join(' ');
                  }
              }
          }
          
          // Scan ahead for Email (Lines +5, +6, +7...)
          for(var k=offset+5; k<Math.min(offset+10, b.length); k++) {
              if (EMAIL_REGEX.test(b[k])) {
                  d.contactEmail = b[k].match(EMAIL_REGEX)[1];
                  break; 
              }
          }
      } else {
          // Fallback to standard regex search if "TAILORED FOR" not found
          var email=b.find(l=>EMAIL_REGEX.test(l));
          if(email)d.contactEmail=email.match(EMAIL_REGEX)[1];
          
          var addr=b.find(l=>ADDRESS_LINE_REGEX.test(l));
          if(addr)d.serviceAddressLine1=addr;
          
          d.accountName=b.find(l=>l.length<50 && !/[@\d]/.test(l) && !/prepared|tailored/i.test(l));
      }
      
      return d;
    }
    function extractPreparedBySection(lines){
      var result={aeName:null,aeEmail:null};
      var idx=findFirstIndex(lines,l=>/prepared\s+by\b/i.test(l));
      if(idx===-1)return result;
      var block=gatherBlock(lines,idx,isHeaderBlockStop,8);
      block.forEach(function(line){
        if(!line)return;
        var emailMatch=line.match(EMAIL_REGEX);
        if(emailMatch)result.aeEmail=emailMatch[1];
        var cleaned=line.replace(EMAIL_REGEX,'').replace(/prepared\s+by[:\s-]*/i,'').trim();
        if(cleaned && cleaned.indexOf('@')===-1 && !result.aeName && !/prepared\s+for/i.test(cleaned)){
          result.aeName=cleaned;
        }
      });
      return result;
    }

    return parseSalesforceQuoteTextToStartPacketDraft;
  })();

  function clientParseSalesforceQuote(rawText) {
    try {
      var parsed = StrictSalesforceParser(rawText);
      // If core fields are missing, run minimal fallback to avoid empty preview
      if (!parsed || (!parsed.accountName && !parsed.serviceAddressLine1 && (!parsed.services || !parsed.services.length))) {
        console.warn('[SF Parser] Strict parser returned empty, running minimal fallback');
        var minimal = minimalFallbackParse(rawText);
        parsed = Object.assign(parsed || {}, minimal);
      }
      return parsed;
    } catch (parseError) {
      console.error('Strict Salesforce parser failed', parseError);
      return minimalFallbackParse(rawText);
    }
  }

  function minimalFallbackParse(text) {
    if (!text) return buildEmptyDraft();
    var draft = buildEmptyDraft();
    var lines = text.replace(/\r\n/g, '\n').split('\n').map(function(l){return l.trim();}).filter(Boolean);

    function getAfterLabel(label) {
      var idx = lines.findIndex(function(l){ return l.toLowerCase().indexOf(label.toLowerCase()) !== -1; });
      if (idx !== -1) {
        var inline = lines[idx].replace(new RegExp(label, 'i'), '').trim();
        if (inline) return inline;
        if (lines[idx+1]) return lines[idx+1].trim();
      }
      return null;
    }

    draft.accountName = getAfterLabel('Customer Name') || draft.accountName;
    var svcAddr = getAfterLabel('Service Address');
    if (svcAddr) {
      draft.serviceAddressLine1 = svcAddr.replace(/\s+USA$/i,'').trim();
      var partsA = draft.serviceAddressLine1.split(',');
      if (partsA.length >= 3) {
        draft.serviceCity = partsA[1].trim();
        var stateZipA = partsA[2].trim().split(/\s+/);
        draft.serviceState = stateZipA.shift();
        draft.serviceZip = stateZipA.join(' ');
      }
    }
    var pocLine = getAfterLabel('Point of Contact') || getAfterLabel('POC');
    if (pocLine) {
      var emailMatchPoc = pocLine.match(/([A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,})/i);
      if (emailMatchPoc) draft.contactEmail = emailMatchPoc[1];
      var nameOnly = pocLine.replace(/\/.*$/,'').replace(/[,|]/g,'').trim();
      if (nameOnly) draft.contactName = nameOnly;
    }
    var pestsLineIdx = lines.findIndex(function(l){ return /covered\s+pests/i.test(l); });
    if (pestsLineIdx !== -1 && lines[pestsLineIdx+1]) {
      draft.coveredPests = lines[pestsLineIdx+1].split(/[,|]/).map(function(p){return p.trim();}).filter(Boolean);
    }

    // Address and account line: first line with street + city + state + zip
    var addrMatch = text.match(/([0-9][^\n]+?,\s*[A-Za-z\s]+?,\s*[A-Z]{2},?\s*\d{5}(?:-\d{4})?)/);
    if (addrMatch && !draft.serviceAddressLine1) {
      draft.serviceAddressLine1 = addrMatch[1].trim();
      var parts = draft.serviceAddressLine1.split(',');
      if (parts.length >= 3) {
        draft.serviceCity = parts[1].trim();
        var stateZip = parts[2].trim().split(/\s+/);
        draft.serviceState = stateZip.shift();
        draft.serviceZip = stateZip.join(' ');
      }
    }
    // Contact phone: first phone-like pattern in the doc
    var phoneMatch = text.match(/(\+?1[\s\-\.])?\(?\d{3}\)?[\s\-\.]?\d{3}[\s\-\.]?\d{4}/);
    if (phoneMatch && phoneMatch[0]) {
      draft.contactPhone = phoneMatch[0].trim();
    }
    // Contact email
    var email = text.match(/([A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,})/i);
    if (email) draft.contactEmail = email[1];
    // Account/POC: look for TAILORED/PREPARED block
    var headerIdx = lines.findIndex(function(l){return /tailored|prepared\s+for/i.test(l);});
    if (headerIdx !== -1) {
      draft.accountName = lines[headerIdx+1] || draft.accountName;
      draft.contactName = lines[headerIdx+2] || draft.contactName;
    }
    // Pricing: grab first three currency values
    var money = [];
    var moneyRe = /\$[0-9][0-9,]*(?:\.[0-9]{2})?/g;
    var m;
    while ((m = moneyRe.exec(text)) !== null) {
      money.push(parseFloat(m[0].replace(/[$,]/g,'')));
      if (money.length >= 3) break;
    }
    if (money.length >= 3) {
      draft.equipmentOneTimeTotal = money[0];
      draft.servicesInitialTotal = money[1];
      draft.combinedInitialTotal = money[0] + money[1];
      draft.servicesMonthlyTotal = money[2];
      draft.combinedMonthlyTotal = money[2];
    }
    // Equipment counts from plain text lines
    var mrt = text.match(/(Multicatch|Mouse Trap)[^0-9]*([0-9]{1,3}(?:\.[0-9]+)?)/i);
    var rbs = text.match(/(Rodent Bait Station|RBS)[^0-9]*([0-9]{1,3}(?:\.[0-9]+)?)/i);
    var ilt = text.match(/(Insect Light Trap|Lumnia)[^0-9]*([0-9]{1,3}(?:\.[0-9]+)?)/i);
    draft.equipment = draft.equipment || { multCatchQty:0,rbsQty:0,iltQty:0,otherEquipment:[] };
    if (mrt) draft.equipment.multCatchQty = parseFloat(mrt[2]);
    if (rbs) draft.equipment.rbsQty = parseFloat(rbs[2]);
    if (ilt) draft.equipment.iltQty = parseFloat(ilt[2]);
    draft.equipment.summary = buildEquipmentSummary(draft.equipment);
    // Services fallback: at least GPC + rodent + ILT if counts exist
    var makeService = function(name, code, category, programType, freq, perYear) {
      return {
        serviceName: name,
        serviceCode: code,
        category: category,
        programType: programType,
        frequencyLabel: freq,
        servicesPerYear: perYear,
        descriptionText: 'Imported from PDF',
        afterHours: false,
        initialAmount: null,
        pricePerService: null
      };
    };
    var fallbackServices = [];
    if (draft.equipment.multCatchQty || draft.equipment.rbsQty || draft.equipment.iltQty) {
      if (draft.equipment.multCatchQty) fallbackServices.push(makeService('Interior Rodent Monitoring','MRT','Rodent Monitoring','Interior Monitoring','Semi-Monthly',24));
      if (draft.equipment.rbsQty) fallbackServices.push(makeService('Exterior Rodent Monitoring','RBS','Rodent Monitoring','Exterior Monitoring','Monthly',12));
      if (draft.equipment.iltQty) fallbackServices.push(makeService('Insect Light Trap Maintenance','ILT','Fly / ILT','Insect Light Trap Maintenance','Semi-Monthly',24));
    }
    fallbackServices.push(makeService('General Pest Control','GPC','GPC','General Pest Control','Monthly',12));
    draft.services = fallbackServices;
    // Local maintenance description builder (avoid relying on Strict parser helpers)
    draft.maintenanceScopeDescription = fallbackServices.map(function(svc){
      var freq = svc.frequencyLabel || 'Monthly';
      var name = svc.serviceName || 'Service';
      return freq + ' ' + name;
    }).join(', ');
    draft.initialServiceDescription = draft.initialServiceDescription || 'Initial service' + (draft.equipment.summary ? ' and install ' + draft.equipment.summary : '');
    draft.leadType = draft.leadType || 'Inbound';
    draft.logBookNeeded = true;
    return draft;
  }


  function buildEmptyDraft() {
    return fillDraftDefaults({
      accountName: null,
      contactName: null,
      contactTitle: null,
      contactEmail: null,
      serviceAddressLine1: null,
      serviceCity: null,
      serviceState: null,
      serviceZip: null,
      aeName: null,
      aeEmail: null,
      branchId: 'BRN-001',
      services: [],
      equipment: { multCatchQty: 0, rbsQty: 0, iltQty: 0, otherEquipment: [] },
      equipmentOneTimeTotal: null,
      servicesInitialTotal: null,
      servicesMonthlyTotal: null,
      combinedInitialTotal: null,
      combinedMonthlyTotal: null,
      servicesAnnualTotal: null,
      combinedAnnualTotal: null,
      monthlyCost: null,
      annualCost: null,
      requestedStartDate: null,
      startMonth: null,
      coveredPests: [],
      leadType: null,
      jobType: null
    });
  }

  function fillDraftDefaults(draft) {
    const result = Object.assign({}, draft);
    if (!result.services || !result.services.length) {
      result.services = [{
        serviceName: 'General Pest Control',
        programType: 'Maintenance',
        category: 'GPC (Comm)',
        descriptionText: 'Scope imported from Salesforce quote.',
        servicesPerYear: 12,
        frequencyLabel: 'Monthly',
        afterHours: false,
        initialAmount: null,
        pricePerService: null
      }];
    }
    // Calculate combinedInitialTotal if we have the components (don't override if already set)
    if (result.combinedInitialTotal === null || result.combinedInitialTotal === undefined) {
      if (result.equipmentOneTimeTotal !== null && result.servicesInitialTotal !== null) {
        result.combinedInitialTotal = result.equipmentOneTimeTotal + result.servicesInitialTotal;
      } else if (result.servicesInitialTotal !== null) {
        result.combinedInitialTotal = result.servicesInitialTotal + (result.equipmentOneTimeTotal || 0);
      }
    }
    // Use combinedMonthlyTotal if available, otherwise fall back to servicesMonthlyTotal
    if (result.combinedMonthlyTotal === null || result.combinedMonthlyTotal === undefined) {
      if (result.servicesMonthlyTotal !== null) {
        result.combinedMonthlyTotal = result.servicesMonthlyTotal;
      }
    }
    if (result.servicesAnnualTotal === null || result.servicesAnnualTotal === undefined) {
      if (result.servicesMonthlyTotal !== null) {
        result.servicesAnnualTotal = Math.round(result.servicesMonthlyTotal * 12 * 100) / 100;
      }
    }
    if (result.combinedAnnualTotal === null || result.combinedAnnualTotal === undefined) {
      if (result.combinedMonthlyTotal !== null) {
        result.combinedAnnualTotal = Math.round(result.combinedMonthlyTotal * 12 * 100) / 100;
      } else if (result.servicesAnnualTotal !== null) {
        result.combinedAnnualTotal = result.servicesAnnualTotal;
      }
    }
    if (result.monthlyCost === null || result.monthlyCost === undefined) {
      if (result.combinedMonthlyTotal !== null) {
        result.monthlyCost = result.combinedMonthlyTotal;
      } else if (result.servicesMonthlyTotal !== null) {
        result.monthlyCost = result.servicesMonthlyTotal;
      }
    }
    if (result.annualCost === null || result.annualCost === undefined) {
      if (result.combinedAnnualTotal !== null) {
        result.annualCost = result.combinedAnnualTotal;
      } else if (result.servicesAnnualTotal !== null) {
        result.annualCost = result.servicesAnnualTotal;
      }
    }
    result.branchId = result.branchId || 'BRN-001';
    return result;
  }

  function applyStartPacketDraft(draft) {
    if (!draft) return;
    currentQuoteTrackerId = trackSalesforceProposal(draft);
    refreshTodayMetricsFromQuotes();
    openUnifiedSaleForm();
    currentImportedServices = Array.isArray(draft.services) ? draft.services.slice() : [];
    currentImportedContactEmail = draft.contactEmail || '';

    var accountInput = document.getElementById('unifiedAccountName');
    if (accountInput) accountInput.value = draft.accountName || '';
    var pocNameInput = document.getElementById('unifiedPOCName');
    if (pocNameInput) pocNameInput.value = draft.contactName || '';
    var pocEmailInput = document.getElementById('unifiedPOCEmail');
    if (pocEmailInput) pocEmailInput.value = draft.contactEmail || '';
    var pocPhoneInput = document.getElementById('unifiedPOCPhone');
    if (pocPhoneInput) pocPhoneInput.value = draft.contactPhone || '';

    const addressPieces = [draft.serviceAddressLine1, draft.serviceCity, draft.serviceState, draft.serviceZip].filter(Boolean);
    var serviceAddressInput = document.getElementById('unifiedServiceAddress');
    if (serviceAddressInput) {
      var joined = addressPieces.join(', ');
      // If line1 already contains city/state/zip, don't append them again
      if (draft.serviceAddressLine1 && draft.serviceCity && draft.serviceAddressLine1.toLowerCase().includes(draft.serviceCity.toLowerCase())) {
        joined = draft.serviceAddressLine1;
      }
      serviceAddressInput.value = joined;
    }

    if (draft.startMonth) {
      setSelectValueById('unifiedStartMonth', normalizeMonthLabel(draft.startMonth));
    }

    const initInput = document.getElementById('unifiedInitialPrice');
    if (initInput) {
      // Initial price should be the total of services initial + equipment one-time
      const initialTotal = draft.combinedInitialTotal !== null && draft.combinedInitialTotal !== undefined ? draft.combinedInitialTotal : 
        ((draft.servicesInitialTotal !== null && draft.servicesInitialTotal !== undefined ? draft.servicesInitialTotal : 0) + 
         (draft.equipmentOneTimeTotal !== null && draft.equipmentOneTimeTotal !== undefined ? draft.equipmentOneTimeTotal : 0));
      console.log('Setting Initial Price:', {
        combinedInitialTotal: draft.combinedInitialTotal,
        servicesInitialTotal: draft.servicesInitialTotal,
        equipmentOneTimeTotal: draft.equipmentOneTimeTotal,
        calculated: initialTotal
      });
      initInput.value = initialTotal > 0 ? initialTotal : '';
    }
    const maintInput = document.getElementById('unifiedMaintenancePrice');
    if (maintInput) {
      // Avg Monthly Cost is the monthly recurring cost
      // Prefer combinedMonthlyTotal, fall back to servicesMonthlyTotal
      const maintTotal = draft.combinedMonthlyTotal !== null && draft.combinedMonthlyTotal !== undefined ? draft.combinedMonthlyTotal : 
        (draft.servicesMonthlyTotal !== null && draft.servicesMonthlyTotal !== undefined ? draft.servicesMonthlyTotal : null);
      console.log('Setting Avg Monthly Cost:', {
        combinedMonthlyTotal: draft.combinedMonthlyTotal,
        servicesMonthlyTotal: draft.servicesMonthlyTotal,
        calculated: maintTotal
      });
      // Set the value, ensuring it's properly formatted (round to 2 decimal places)
      if (maintTotal !== null && maintTotal !== undefined && maintTotal > 0) {
        maintInput.value = Math.round(maintTotal * 100) / 100; // Round to 2 decimal places
        console.log('Avg Monthly Cost set to:', maintInput.value);
      } else {
        maintInput.value = '';
        console.log('Avg Monthly Cost not set - value is null, undefined, or <= 0');
      }
    }

    if (draft.branchId) {
      const branchSelect = document.getElementById('unifiedBranch');
      if (branchSelect) branchSelect.value = draft.branchId;
    } else if (draft.serviceCity) {
      const branchSelect = document.getElementById('unifiedBranch');
      if (branchSelect) {
        for (let i = 0; i < branchSelect.options.length; i++) {
          const opt = branchSelect.options[i];
          if (opt.text && opt.text.toLowerCase().includes(draft.serviceCity.toLowerCase())) {
            branchSelect.value = opt.value;
            break;
          }
        }
      }
    }

    const primaryService = currentImportedServices.length ? currentImportedServices[0] : null;
    if (primaryService || draft.equipment) {
      const serviceNameInput = document.getElementById('unifiedServiceName');
      if (serviceNameInput) {
        // Build descriptive service name with MRT/RBS/ILT and frequencies
        const descriptiveName = buildDescriptiveServiceName(currentImportedServices, draft.equipment, draft);
        serviceNameInput.value = descriptiveName || (primaryService && primaryService.serviceName) || (primaryService && primaryService.programType) || '';
      }
      const frequencyInput = document.getElementById('unifiedFrequency');
      if (frequencyInput) {
        const visits = (primaryService && primaryService.servicesPerYear) || inferServicesPerYear(primaryService && primaryService.frequencyLabel) || 12;
        frequencyInput.value = visits;
      }
    }
    setServiceMonthsSelected(serviceMonthValues);

    const serviceTypeSelect = document.getElementById('unifiedServiceType');
    if (serviceTypeSelect) {
      const typeCandidate = draft.serviceType || (primaryService ? (primaryService.category || primaryService.serviceName) : '');
      setSelectValueByElement(serviceTypeSelect, typeCandidate);
    }
    setSelectValueById('unifiedLeadType', draft.leadType || (draft.tapLeadFlag ? 'TAP' : 'Inbound'));
    // Set job type to "Contract" if there's a recurring monthly cost
    const hasRecurringCost = (draft.combinedMonthlyTotal || draft.servicesMonthlyTotal || 0) > 0;
    setSelectValueById('unifiedJobType', draft.jobType || (hasRecurringCost ? 'Contract' : ''));

    const coveredInput = document.getElementById('unifiedCoveredPests');
    if (coveredInput) {
      if (Array.isArray(draft.coveredPests) && draft.coveredPests.length) {
        // Filter out any invalid pest entries before joining
        const validPests = draft.coveredPests.filter(function(pest) {
          if (!pest || typeof pest !== 'string') return false;
          const cleaned = pest.trim();
          // Reject if it contains URLs, page numbers, or table of contents text
          if (/https?:\/\//i.test(cleaned)) return false;
          if (/^page\s+\d+/i.test(cleaned)) return false;
          if (/table\s+of\s+contents/i.test(cleaned.toLowerCase())) return false;
          if (/presto-x\s*\|/i.test(cleaned)) return false;
          if (cleaned.length > 150) return false;
          return true;
        });
        if (validPests.length > 0) {
          coveredInput.value = validPests.join(', ');
          console.log('Setting Covered Pests (array):', validPests);
        } else {
          coveredInput.value = '';
          console.log('Covered Pests filtered out - all invalid');
        }
      } else if (typeof draft.coveredPests === 'string' && draft.coveredPests.trim()) {
        const cleaned = draft.coveredPests.trim();
        // Only set if it's a reasonable string (not raw PDF text with URLs, page numbers, etc.)
        if (cleaned.length < 200 && 
            !/https?:\/\//i.test(cleaned) && 
            !/^page\s+\d+/i.test(cleaned) && 
            !/table\s+of\s+contents/i.test(cleaned.toLowerCase()) &&
            !/presto-x\s*\|/i.test(cleaned)) {
          coveredInput.value = cleaned;
          console.log('Setting Covered Pests (string):', cleaned);
        } else {
          coveredInput.value = '';
          console.log('Covered Pests not set - contains invalid content:', cleaned.substring(0, 100));
        }
      } else {
        // Don't set raw PDF text - leave empty if no valid pests found
        coveredInput.value = '';
        console.log('Covered Pests not set - invalid value:', draft.coveredPests);
      }
    }

    // Billing email and address
    const billingEmailInput = document.getElementById('unifiedBillingEmail');
    if (billingEmailInput) billingEmailInput.value = draft.billingEmail || '';
    const billingAddressDifferentCheckbox = document.getElementById('unifiedBillingAddressDifferent');
    const billingAddressContainer = document.getElementById('billingAddressContainer');
    const billingAddressInput = document.getElementById('unifiedBillingAddress');
    if (draft.billingAddress && draft.billingAddress.trim()) {
      if (billingAddressDifferentCheckbox) billingAddressDifferentCheckbox.checked = true;
      if (billingAddressContainer) billingAddressContainer.classList.remove('hidden');
      if (billingAddressInput) billingAddressInput.value = draft.billingAddress;
    }

    // Log book required default from parser
    const logBookCheckbox = document.getElementById('unifiedLogBook');
    if (logBookCheckbox && (draft.logBookNeeded === true || draft.logBookNeeded === 'Yes')) {
      logBookCheckbox.checked = true;
    }
    
    // PNOL Required default from parser
    const pnolCheckbox = document.getElementById('unifiedPNOL');
    if (pnolCheckbox && (draft.pnolRequired === true || draft.pnolRequired === 'Yes')) {
      pnolCheckbox.checked = true;
    }
    
    // Equipment counts
    const mrtCountInput = document.getElementById('unifiedMRTCount');
    if (mrtCountInput) {
      const mrtCount = draft.mrtCount || (draft.equipment && draft.equipment.multCatchQty) || 0;
      mrtCountInput.value = mrtCount;
    }
    const rbsCountInput = document.getElementById('unifiedRBSCount');
    if (rbsCountInput) {
      const rbsCount = draft.rbsCount || (draft.equipment && draft.equipment.rbsQty) || 0;
      rbsCountInput.value = rbsCount;
    }
    const iltCountInput = document.getElementById('unifiedILTCount');
    if (iltCountInput) {
      const iltCount = draft.iltCount || (draft.equipment && draft.equipment.iltQty) || 0;
      iltCountInput.value = iltCount;
    }
    
    // Auto-generate initial service description from equipment counts
    updateInitialServiceDescription();
    
    // If there's a custom initial service description, allow override
    const initialServiceDescInput = document.getElementById('unifiedInitialServiceDescription');
    if (initialServiceDescInput && draft.initialServiceDescription && draft.initialServiceDescription.trim()) {
      // Only override if it's different from auto-generated
      const autoGenerated = initialServiceDescInput.value;
      if (draft.initialServiceDescription !== autoGenerated) {
        initialServiceDescInput.value = draft.initialServiceDescription;
      }
    }
    
    // Maintenance scope description
    const maintenanceScopeDescInput = document.getElementById('unifiedMaintenanceScopeDescription');
    if (maintenanceScopeDescInput) maintenanceScopeDescInput.value = draft.maintenanceScopeDescription || '';
    
    // Service areas
    const serviceAreasInput = document.getElementById('unifiedServiceAreas');
    if (serviceAreasInput) serviceAreasInput.value = draft.serviceAreas || '';

    const notesField = document.getElementById('unifiedNotes');
    if (notesField) {
      const summaryLines = [];
      if (draft.contactEmail) summaryLines.push('POC Email: ' + draft.contactEmail);
      const equipmentSummary = buildEquipmentSummary(draft.equipment);
      if (equipmentSummary) summaryLines.push(equipmentSummary);
      if (draft.monthlyCost || draft.annualCost) {
        const costPieces = [];
        if (draft.monthlyCost) costPieces.push('Monthly ' + formatCurrencyExact(draft.monthlyCost));
        if (draft.annualCost) costPieces.push('Annual ' + formatCurrencyExact(draft.annualCost));
        if (costPieces.length) {
          summaryLines.push('Cost: ' + costPieces.join(' | '));
        }
      }
      const serviceDescriptions = buildServiceDescriptions(currentImportedServices);
      if (serviceDescriptions) summaryLines.push(serviceDescriptions);
      notesField.value = summaryLines.join('\n');
    }

    // Don't populate sold date - this is a proposal, not a sold deal
    const soldInput = document.getElementById('unifiedSoldDate');
    if (soldInput) {
      // Leave sold date empty - this is just a proposal/quote
      soldInput.value = '';
    }
    
    // Extract month from requested start date for start month field
    if (draft.requestedStartDate && !draft.startMonth) {
      try {
        const date = new Date(draft.requestedStartDate);
        if (!isNaN(date.getTime())) {
          const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                             'July', 'August', 'September', 'October', 'November', 'December'];
          const monthName = monthNames[date.getMonth()];
          draft.startMonth = monthName;
          console.log('Extracted start month from requested start date:', draft.requestedStartDate, '->', monthName);
        }
      } catch (e) {
        console.log('Error parsing requested start date:', e);
      }
    }

    const salesRepInput = document.getElementById('unifiedSalesReps');
    if (salesRepInput && draft.aeName) {
      salesRepInput.value = draft.aeName;
    }
    const sraBy = document.getElementById('unifiedSRABy');
    if (sraBy && draft.aeName) {
      sraBy.value = draft.aeName;
    }

    const additionalHazards = document.getElementById('unifiedAdditionalHazards');
    if (additionalHazards) {
      additionalHazards.value = draft.sraAdditionalHazards || 'None';
    }
    if (draft.sraHazards && draft.sraHazards.length) {
      setHazardRowsFromArray(draft.sraHazards);
    } else {
      setHazardRowsFromArray(defaultSraHazards);
    }

    if (draft.sraCompletedAt) {
      const completed = new Date(draft.sraCompletedAt);
      const sraDate = document.getElementById('unifiedSRADate');
      const sraTime = document.getElementById('unifiedSRATime');
      if (sraDate && !isNaN(completed.getTime())) sraDate.value = formatDateForInput(completed);
      if (sraTime && !isNaN(completed.getTime())) sraTime.value = formatTimeForInput(completed);
    }
    updateSRAReviewStamp();
  }

  function updateInitialServiceDescription() {
    const mrtCount = parseInt(document.getElementById('unifiedMRTCount').value, 10) || 0;
    const rbsCount = parseInt(document.getElementById('unifiedRBSCount').value, 10) || 0;
    const iltCount = parseInt(document.getElementById('unifiedILTCount').value, 10) || 0;
    
    const parts = [];
    if (mrtCount > 0) parts.push('Install ' + mrtCount + ' MRT' + (mrtCount !== 1 ? 's' : ''));
    if (rbsCount > 0) parts.push(rbsCount + ' RBS' + (rbsCount !== 1 ? 's' : ''));
    if (iltCount > 0) parts.push('For ILT' + (iltCount !== 1 ? 's' : ''));
    if (parts.length > 0) {
      parts.push('Initial GPC');
    }
    
    const initialDescInput = document.getElementById('unifiedInitialServiceDescription');
    if (initialDescInput) {
      initialDescInput.value = parts.length > 0 ? parts.join(', ') : '';
    }
  }

  function collectUnifiedSalePayload(event) {
    const selectedMonths = Array.from(document.querySelectorAll('input[name="serviceMonthOption"]:checked')).map(function(cb) { return cb.value; });
    const billingAddressDifferent = document.getElementById('unifiedBillingAddressDifferent');
    const billingAddress = billingAddressDifferent && billingAddressDifferent.checked 
      ? document.getElementById('unifiedBillingAddress').value.trim() 
      : '';
    const payload = {
      accountName: document.getElementById('unifiedAccountName').value.trim(),
      serviceAddress: document.getElementById('unifiedServiceAddress').value.trim(),
      soldDate: document.getElementById('unifiedSoldDate').value,
      requestedStartMonth: document.getElementById('unifiedStartMonth').value,
      pocName: document.getElementById('unifiedPOCName').value,
      pocPhone: document.getElementById('unifiedPOCPhone').value,
      pocEmail: document.getElementById('unifiedPOCEmail').value,
      billingEmail: document.getElementById('unifiedBillingEmail').value.trim(),
      billingAddressDifferent: billingAddressDifferent ? billingAddressDifferent.checked : false,
      billingAddress: billingAddress,
      initialPrice: parseFloat(document.getElementById('unifiedInitialPrice').value) || 0,
      maintenancePrice: parseFloat(document.getElementById('unifiedMaintenancePrice').value) || 0,
      serviceName: document.getElementById('unifiedServiceName').value,
      serviceType: document.getElementById('unifiedServiceType').value,
      coveredPests: document.getElementById('unifiedCoveredPests').value,
      leadType: document.getElementById('unifiedLeadType').value,
      jobType: document.getElementById('unifiedJobType').value,
      frequency: parseInt(document.getElementById('unifiedFrequency').value, 10) || 12,
      mrtCount: parseInt(document.getElementById('unifiedMRTCount').value, 10) || 0,
      rbsCount: parseInt(document.getElementById('unifiedRBSCount').value, 10) || 0,
      iltCount: parseInt(document.getElementById('unifiedILTCount').value, 10) || 0,
      initialServiceDescription: document.getElementById('unifiedInitialServiceDescription').value.trim(),
      maintenanceScopeDescription: document.getElementById('unifiedMaintenanceScopeDescription').value.trim(),
      serviceAreas: document.getElementById('unifiedServiceAreas').value.trim(),
      serviceMonths: selectedMonths,
      salesRepIDs: document.getElementById('unifiedSalesReps').value.split(',').map(function(rep) { return rep.trim(); }).filter(Boolean),
      branchID: document.getElementById('unifiedBranch').value,
      pestPacConfirmed: document.getElementById('unifiedPestPac').checked,
      tapLeadFlag: document.getElementById('unifiedTapLead').checked ? 'Yes' : '',
      logBookNeeded: document.getElementById('unifiedLogBook').checked,
      pnolRequired: document.getElementById('unifiedPNOL').checked,
      sraCompletedBy: document.getElementById('unifiedSRABy').value,
      sraDate: document.getElementById('unifiedSRADate').value,
      sraTime: document.getElementById('unifiedSRATime').value,
      sraAdditionalHazards: document.getElementById('unifiedAdditionalHazards').value,
      specialNotes: document.getElementById('unifiedNotes').value,
      sraHazards: collectHazardsFromForm(),
      status: 'New Sale',
      quoteTrackerId: currentQuoteTrackerId
    };
    
    // Check if this is a "Mark Sold" submission
    const submitButton = event && event.submitter;
    if (submitButton && submitButton.textContent && submitButton.textContent.indexOf('Mark Sold') !== -1) {
      payload.status = 'Sold';
      payload.soldDate = payload.soldDate || new Date().toISOString().split('T')[0];
    }
    
    return payload;
  }

  // ==========================================
  // 4. SUBMIT HANDLER
  // ==========================================
  function submitUnifiedSaleForm(event) {
    event.preventDefault();
    const payload = collectUnifiedSalePayload(event);
    if (!payload.accountName || !payload.serviceAddress) {
      alert('Account name and service address are required.');
      return;
    }
    function handleSuccess(result) {
      if (payload.status === 'Sold' || payload.status === 'New Sale') {
         simulateOperationsEmail(payload);
      }
      generateStartPacketAfterSave(result, payload);
      markQuoteTrackerSold(payload.quoteTrackerId || currentQuoteTrackerId, result && result.recordID);
      currentQuoteTrackerId = null;
    }
    if (hasAppsScript() && google.script.run.saveUnifiedSale) {
      google.script.run.withSuccessHandler(handleSuccess).saveUnifiedSale(payload);
    } else {
      const recordID = saveDemoUnifiedSale(payload);
      handleSuccess({ success: true, recordID: recordID });
    }
  }

  // ==========================================
  // 3. EMAIL & PREVIEW (Visuals)
  // ==========================================
  function simulateOperationsEmail(payload) {
      const recipients = "midwestmarketsalesentry@rentokil.com, brad.hudson@prestox.com...";
      const subject = `Re: Onboarding Report - ${payload.accountName} -- ${payload.pocName}`;
      const body = `Team,\n\nPlease find the attached start packet for the location below.\n\n` +
        `Service Details\n` +
        `‚Ä¢ Frequency: ${payload.frequency || '12'}\n` +
        `‚Ä¢ Covered Pests: ${payload.coveredPests || 'N/A'}\n` +
        `‚Ä¢ Scope: ${payload.maintenanceScopeDescription || 'N/A'}\n` +
        `‚Ä¢ Treatment Notes: ${payload.specialNotes || 'N/A'}\n\n` +
        `Commercials\n` +
        `‚Ä¢ Total Initial: $${(parseFloat(payload.initialPrice)||0).toFixed(2)}\n` +
        `‚Ä¢ Monthly: $${(parseFloat(payload.maintenancePrice)||0).toFixed(2)}/month\n\n` +
        `Account Details\n` +
        `‚Ä¢ Customer: ${payload.accountName}\n` +
        `‚Ä¢ Service Address: ${payload.serviceAddress}\n` +
        `‚Ä¢ Billing Email: ${payload.billingEmail || 'N/A'}\n` +
        `‚Ä¢ POC: ${payload.pocName} (${payload.pocPhone})`;
      alert(`üìß [DEMO] Email Sent to Operations!\n\nTo: ${recipients}\nSubject: ${subject}\n\n${body}`);
  }

  function getActiveBrandLogo() {
    const presets = {
      PRESTOX: 'https://ik.imagekit.io/9cyexhymf/Presto-X%20Logo-ARentokilCompany.png?updatedAt=1762540113819',
      BUGOUT: 'https://ik.imagekit.io/9cyexhymf/BugOut%20Logo.png?updatedAt=1762651397528',
      RENTOKIL: 'https://ik.imagekit.io/9cyexhymf/Rentokil%20Logo.png?updatedAt=1762651397519'
    };
    var key = (window.dashboardData && dashboardData.brandKey) || localStorage.getItem('branch360BrandKey') || 'PRESTOX';
    key = (key || '').toUpperCase();
    return presets[key] || presets.PRESTOX;
  }

  function previewStartPacket() {
    const data = collectUnifiedSalePayload();
    const logoUrl = getActiveBrandLogo();
    // Safe guard: derive equipment counts from summary if counts are missing
    const equipmentSummary = buildEquipmentSummary({ multCatchQty: data.mrtCount, rbsQty: data.rbsCount, iltQty: data.iltCount, summary: (data.equipment && data.equipment.summary) || '' });
    if ((!data.mrtCount || !data.rbsCount || !data.iltCount) && equipmentSummary) {
      const mrtMatch = equipmentSummary.match(/(\d+)\s*MRT/i);
      const rbsMatch = equipmentSummary.match(/(\d+)\s*RBS/i);
      const iltMatch = equipmentSummary.match(/(\d+)\s*ILT/i);
      data.mrtCount = data.mrtCount || (mrtMatch ? parseInt(mrtMatch[1], 10) : 0);
      data.rbsCount = data.rbsCount || (rbsMatch ? parseInt(rbsMatch[1], 10) : 0);
      data.iltCount = data.iltCount || (iltMatch ? parseInt(iltMatch[1], 10) : 0);
    }
    const hazardsForPreview = (data.sraHazards && data.sraHazards.length ? data.sraHazards : defaultSraHazards).map(function(h) {
      return {
        hazard: h.hazard || h.description || '',
        control: h.control || h.controlMeasure || '',
        safe: h.safeToProceed === false ? false : true
      };
    }).filter(function(h){ return h.hazard || h.control; });

    const initialFromCounts = (function() {
      const parts = [];
      if (data.mrtCount > 0) parts.push(`${data.mrtCount} MRT${data.mrtCount !== 1 ? 's' : ''}`);
      if (data.rbsCount > 0) parts.push(`${data.rbsCount} RBS${data.rbsCount !== 1 ? 's' : ''}`);
      if (data.iltCount > 0) parts.push(`${data.iltCount} ILT${data.iltCount !== 1 ? 's' : ''}`);
      if (!parts.length) return data.initialServiceDescription || 'Initial service';
      return `Initial service and install ${parts.join(', ')}`;
    })();

    const sraNotes = data.sraAdditionalHazards || 'None';
    const costsBlock = `
      <div class="text-right">
        <div class="mb-1 text-sm text-gray-600">Initial Price</div>
        <div class="text-2xl font-bold text-gray-900">$${(Number(data.initialPrice)||0).toFixed(2)}</div>
        <div class="mt-3 mb-1 text-sm text-gray-600">Avg Monthly</div>
        <div class="text-2xl font-bold text-gray-900">$${(Number(data.maintenancePrice)||0).toFixed(2)}</div>
      </div>`;

    const html = `
      <div class="p-8 bg-white text-gray-800 font-sans max-w-4xl mx-auto border shadow-sm">
        <div class="flex justify-between items-start border-b-2 border-gray-800 pb-4 mb-6">
          <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-1">Start Packet</h1>
            <p class="text-sm text-gray-600">Prepared for ${data.accountName}</p>
          </div>
          <div class="text-right">
            <img src="${logoUrl}" alt="Brand logo" class="h-12 inline-block object-contain bg-white p-1 rounded">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-8 mb-8">
          <div>
            <h3 class="text-xs font-bold uppercase text-gray-500 mb-1">Customer</h3>
            <p class="text-lg font-bold">${data.accountName}</p>
            <p>${data.serviceAddress}</p>
          </div>
          <div class="text-right">
            ${costsBlock}
          </div>
        </div>
        <div class="bg-gray-50 border rounded-lg p-5 mb-8">
          <h2 class="text-lg font-bold text-gray-900 border-b pb-2 mb-4">Scope of Work</h2>
          <div class="mb-4"><p class="text-sm font-bold text-blue-700 uppercase mb-1">Initial</p><p>${initialFromCounts}</p></div>
          <div class="mb-4"><p class="text-sm font-bold text-green-700 uppercase mb-1">Maintenance</p><p>${data.maintenanceScopeDescription || 'Maintenance program'}</p></div>
        </div>
        <div class="grid grid-cols-2 gap-8 mb-8">
           <div>
             <h3 class="font-bold text-gray-900 mb-2">Equipment</h3>
             <ul class="list-disc pl-5 text-sm">
               <li>${data.mrtCount || 0} MRTs</li>
               <li>${data.rbsCount || 0} RBSs</li>
               <li>${data.iltCount || 0} ILTs</li>
             </ul>
           </div>
           <div>
             <h3 class="font-bold text-gray-900 mb-2">Primary Contact</h3>
             <p class="font-semibold">${data.pocName || 'N/A'}</p>
             <p class="text-sm">${data.pocEmail || ''}</p>
             <p class="text-sm">${data.pocPhone || ''}</p>
           </div>
        </div>
        <div class="bg-gray-50 border rounded-lg p-5">
          <h2 class="text-lg font-bold text-gray-900 border-b pb-2 mb-4">Special Notes</h2>
          <pre class="whitespace-pre-wrap text-sm text-gray-800">${(data.specialNotes || '').trim() || 'None'}</pre>
        </div>
        <div class="page-break pt-8 mt-8 border-t border-gray-200" style="page-break-before: always;">
          <h2 class="text-xl font-bold text-gray-900 mb-2">Safety Risk Assessment (SRA)</h2>
          <p class="text-sm text-gray-600 mb-4">Completed as part of the start packet. This page is always the final page.</p>
          <div class="mb-4">
            <h3 class="text-sm font-semibold text-gray-800 mb-1">Additional Hazards</h3>
            <p class="text-sm">${sraNotes}</p>
          </div>
          <div>
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Hazard Controls</h3>
            <div class="border rounded-lg divide-y">
              ${hazardsForPreview.length ? hazardsForPreview.map(function(h) {
                return `<div class="grid grid-cols-12 gap-3 p-3 items-center">
                  <div class="col-span-5">
                    <p class="text-xs font-semibold text-gray-600 uppercase">Hazard</p>
                    <p class="text-sm text-gray-900">${h.hazard}</p>
                  </div>
                  <div class="col-span-5">
                    <p class="text-xs font-semibold text-gray-600 uppercase">Control Measure</p>
                    <p class="text-sm text-gray-900">${h.control}</p>
                  </div>
                  <div class="col-span-2 text-right">
                    <label class="inline-flex items-center space-x-2 text-sm text-gray-800">
                      <input type="checkbox" disabled ${h.safe ? 'checked' : ''} class="h-4 w-4 text-green-600 border-gray-300 rounded">
                      <span>Safe</span>
                    </label>
                  </div>
                </div>`;
              }).join('') : '<div class="p-3 text-sm text-gray-800">Standard controls in place</div>'}
            </div>
          </div>
        </div>
      </div>
    `;
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] p-4 overflow-y-auto';
    modal.innerHTML = `<div class="relative w-full max-w-4xl my-8 rounded-lg bg-white shadow-lg" style="max-height:90vh; overflow-y:auto;">${html}<div class="text-center mt-4"><button onclick="this.closest('.fixed').remove()" class="px-6 py-2 bg-gray-800 text-white rounded-full">Close</button></div></div>`;
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
  }

  function saveDemoUnifiedSale(payload) {
    const recordID = 'SALE-DEMO-' + Date.now();
    Branch360DemoState.unifiedSales.unshift({
      RecordID: recordID,
      BranchID: payload.branchID,
      SoldDate: payload.soldDate || new Date().toISOString(),
      AccountName: payload.accountName,
      ServiceAddress: payload.serviceAddress,
      SalesRepIDs: (payload.salesRepIDs || []).join('|') || currentUserId,
      POCName: payload.pocName,
      POCPhone: payload.pocPhone,
      POCEmail: payload.pocEmail,
      RequestedStartMonth: payload.requestedStartMonth,
      InitialPrice: payload.initialPrice,
      MaintenancePrice: payload.maintenancePrice,
      ServiceName: payload.serviceName,
      ServiceType: payload.serviceType || '',
      CoveredPests: payload.coveredPests,
      LeadType: payload.leadType || '',
      JobType: payload.jobType || 'Contract',
      Frequency: payload.frequency,
      ServiceMonths: payload.serviceMonths.join(','),
      serviceMonths: payload.serviceMonths,
      SpecialNotes: payload.specialNotes,
      SRAHazardRef: '',
      sraAdditionalHazards: payload.sraAdditionalHazards,
      status: payload.status,
      Status: payload.status,
      sraHazards: payload.sraHazards,
      quoteTrackerId: payload.quoteTrackerId,
      UpdatedOn: new Date().toISOString()
    });
    Branch360DemoState.recentActivity.unshift({
      customer: payload.accountName,
      action: 'New start entered',
      date: new Date().toISOString()
    });
    return recordID;
  }

  function generateStartPacketAfterSave(result, payload) {
    // Only generate start packet if status is "Sold"
    if (payload.status !== 'Sold') {
      closeUnifiedSaleForm();
      alert('Unified sale saved as proposal. Click "Mark Sold & Generate Start Packet" when ready.');
      loadDashboard();
      return;
    }

    const draft = buildStartPacketDraftForSubmission(payload);
    draft.saleRecordID = result && result.recordID;
    function onComplete(message) {
      closeUnifiedSaleForm();
      alert(message || 'Unified sale saved and start packet generated.');
      loadDashboard();
    }
    if (hasAppsScript() && google.script.run.generateStartPacketFromUnifiedSale) {
      google.script.run
        .withSuccessHandler(function(res) {
          onComplete('Unified sale saved and start packet #' + (res && res.packetID ? res.packetID : '') + ' generated for Ops. Tracker entry created.');
        })
        .withFailureHandler(function(error) {
          console.error('Start packet generation failed', error);
          onComplete('Sale saved. Start packet generation failed: ' + (error && error.message ? error.message : error));
        })
        .generateStartPacketFromUnifiedSale(draft);
    } else {
      // demo fallback: just log to console
      console.log('Demo start packet created from draft', draft);
      onComplete('Unified sale saved and start packet created (demo). Tracker entry created.');
    }
  }

  function buildStartPacketDraftForSubmission(payload) {
    const draft = Object.assign({}, payload);
    draft.services = currentImportedServices.slice();
    if (draft.services.length === 0) {
      draft.services.push({
        serviceName: payload.serviceName || '',
        category: payload.serviceType || '',
        descriptionText: payload.specialNotes || ''
      });
    } else if (payload.serviceType && !draft.services[0].category) {
      draft.services[0].category = payload.serviceType;
    }
    // Preserve equipment object if it exists, or build it from counts
    if (!draft.equipment && (payload.mrtCount || payload.rbsCount || payload.iltCount)) {
      draft.equipment = {
        multCatchQty: payload.mrtCount || 0,
        rbsQty: payload.rbsCount || 0,
        iltQty: payload.iltCount || 0,
        otherEquipment: []
      };
    } else if (draft.equipment) {
      // Update equipment object with form values if they exist
      if (payload.mrtCount !== undefined) draft.equipment.multCatchQty = payload.mrtCount;
      if (payload.rbsCount !== undefined) draft.equipment.rbsQty = payload.rbsCount;
      if (payload.iltCount !== undefined) draft.equipment.iltQty = payload.iltCount;
    }
    draft.branchId = payload.branchID;
    draft.aeName = dashboardData && dashboardData.user ? dashboardData.user.name : '';
    draft.aeEmail = dashboardData && dashboardData.user ? dashboardData.user.email : '';
    draft.requestedStartDate = payload.soldDate || '';
    draft.serviceAddress = payload.serviceAddress;
    const sraByInput = document.getElementById('unifiedSRABy');
    draft.sraCompletedBy = sraByInput ? (sraByInput.value || draft.aeName) : draft.aeName;
    const sraDateEl = document.getElementById('unifiedSRADate');
    const sraTimeEl = document.getElementById('unifiedSRATime');
    draft.sraCompletedAt = sraDateEl ? (sraDateEl.value + ' ' + (sraTimeEl ? sraTimeEl.value : '')) : '';
    draft.contactEmail = payload.pocEmail || currentImportedContactEmail || '';
    draft.quoteTrackerId = payload.quoteTrackerId || currentQuoteTrackerId;
    draft.serviceType = payload.serviceType || '';
    draft.leadType = payload.leadType || '';
    draft.jobType = payload.jobType || '';
    const initialPriceValue = Number(payload.initialPrice);
    if (isFinite(initialPriceValue) && initialPriceValue >= 0) {
      draft.combinedInitialTotal = initialPriceValue;
    }
    const maintenancePriceValue = Number(payload.maintenancePrice);
    if (isFinite(maintenancePriceValue) && maintenancePriceValue >= 0) {
      draft.servicesMonthlyTotal = maintenancePriceValue;
      draft.combinedMonthlyTotal = maintenancePriceValue;
      draft.monthlyCost = maintenancePriceValue;
      const annual = Math.round(maintenancePriceValue * 12 * 100) / 100;
      draft.servicesAnnualTotal = annual;
      draft.combinedAnnualTotal = annual;
      draft.annualCost = annual;
    }
    // Add new fields
    draft.billingEmail = payload.billingEmail || '';
    draft.billingAddress = payload.billingAddress || '';
    draft.billingAddressDifferent = payload.billingAddressDifferent || false;
    draft.mrtCount = payload.mrtCount || 0;
    draft.rbsCount = payload.rbsCount || 0;
    draft.iltCount = payload.iltCount || 0;
    draft.initialServiceDescription = payload.initialServiceDescription || '';
    draft.maintenanceScopeDescription = payload.maintenanceScopeDescription || '';
    draft.serviceAreas = payload.serviceAreas || '';
    return draft;
  }

  function getDemoUnifiedSales() {
    return Branch360DemoState.unifiedSales;
  }

  function getDemoAEDashboard(context) {
    const state = Branch360DemoState || initializeDemoState(context);
    if (context) {
      state.user = Object.assign({}, state.user, {
        name: context.name || state.user.name,
        email: context.email || state.user.email,
        branchID: context.branchId || state.user.branchID,
        userID: context.userID || context.id || state.user.userID
      });
    }
    const pipeline = buildDemoPipeline(state.unifiedSales);
    const now = new Date();
    
    // Combine sales-based leads and technician-submitted leads
    const salesLeads = state.unifiedSales.filter(function(sale) {
      return (sale.Status || '').toLowerCase() === 'new sale';
    }).slice(0, 5).map(function(sale) {
      return {
        recordId: sale.RecordID,
        customer_name: sale.AccountName,
        service_address: sale.ServiceAddress,
        phone: sale.POCPhone,
        service_name: sale.ServiceName,
        covered_pests: sale.CoveredPests,
        initial_price: sale.InitialPrice,
        maintenance_price: sale.MaintenancePrice,
        special_notes: sale.SpecialNotes,
        source: 'Sales'
      };
    });
    
    // Add technician-submitted leads (no pricing yet)
    const techLeads = [
      {
        recordId: 'LEAD-TECH-001',
        customer_name: 'Bayou Coffee',
        pocName: 'Sarah Johnson',
        phone: '(713) 555-9001',
        email: 'sarah@bayoucoffee.com',
        service_address: '1201 Caroline St, Houston, TX 77002',
        zipCode: '77002',
        service_name: 'GPC Interior/Exterior',
        leadType: 'Commercial',
        special_notes: 'Customer seeing roaches in kitchen area near espresso machine. Also noticed some mice droppings in back storage room. Looking for comprehensive pest control solution.',
        source: 'Technician',
        submittedBy: 'Jordan Ellis'
      },
      {
        recordId: 'LEAD-TECH-003',
        customer_name: 'Downtown Auto Body',
        pocName: 'Carlos Rodriguez',
        phone: '(713) 555-9003',
        email: 'carlos@dtautobody.com',
        service_address: '2100 Milam St, Houston, TX 77002',
        zipCode: '77002',
        service_name: 'Rodent Control',
        leadType: 'Commercial',
        special_notes: 'Shop manager concerned about rats chewing through wiring in customer vehicles. Seeing droppings in garage bay area. Urgent - already had 2 customer complaints.',
        source: 'Technician',
        submittedBy: 'Jordan Ellis'
      }
    ];
    
    const newLeadRows = techLeads.concat(salesLeads);
    
    return {
      user: state.user,
      todayMetrics: state.todayMetrics,
      monthMetrics: state.monthMetrics,
      pipeline: { stages: pipeline },
      newLeads: newLeadRows,
      upcomingTasks: state.upcomingTasks,
      recentActivity: state.recentActivity
    };
  }

  function buildDemoPipeline(records) {
    const stages = { proposal: [], negotiation: [], sold: [] };
    records.forEach(function(record) {
      const value = Number(record.InitialPrice || 0) + Number(record.MaintenancePrice || 0);
      const entry = { name: record.AccountName, value: value };
      switch ((record.Status || '').toLowerCase()) {
        case 'proposal':
          stages.proposal.push(entry);
          break;
        case 'negotiation':
          stages.negotiation.push(entry);
          break;
        case 'sold':
          stages.sold.push(entry);
          break;
        default:
          break;
      }
    });
    return stages;
  }

  function getDemoTimeSavedSummary() {
    return {
      user: {
        hoursSaved: Branch360DemoState.timeSaved.hours,
        activities: Branch360DemoState.timeSaved.events
      }
    };
  }

  function updateSRAReviewStamp() {
    const by = document.getElementById('unifiedSRABy') ? (document.getElementById('unifiedSRABy').value || '--') : '--';
    const date = document.getElementById('unifiedSRADate') ? (document.getElementById('unifiedSRADate').value || '--') : '--';
    const time = document.getElementById('unifiedSRATime') ? (document.getElementById('unifiedSRATime').value || '--') : '--';
    const label = document.getElementById('sraCompletedByLabel');
    const stamp = document.getElementById('sraCompletedAtLabel');
    if (label) label.textContent = by || '--';
    if (stamp) stamp.textContent = date && time ? (date + ' ' + time) : date || '--';
  }

  function initializeDemoState(activeUser) {
    const now = new Date();
    const persona = activeUser || {};
    return {
      user: {
        name: persona.name || 'Alex Taylor',
        email: persona.email || 'alex.taylor@presto-x.com',
        userID: persona.userID || persona.id || 'AE-HTX-001',
        branchID: persona.branchId || persona.branchID || 'HOUSTON'
      },
      todayMetrics: {
        proposalsDelivered: 4,
        lobsOnProposals: ['Crawling Insect', 'Rodent', 'Fly'],
        lobsSold: ['Rodent', 'Fly'],
        dollarsSold: 5800,
        dollarsProposed: 14200,
        nextDayConfCount: 3,
        eventsCount: 5,
        eventsSummary: '3 site assessments, 2 proposal walk-throughs.'
      },
      monthMetrics: {
        totalTAP: 42,
        winRate: 28,
        totalSales: 18250,
        totalAppointments: 31
      },
      upcomingTasks: [
        { customer: 'Texas Thrift - Midtown', task: 'Confirm scope walk', daysOverdue: 1 },
        { customer: 'Heights Food Hall', task: 'Send revised quote', daysOverdue: 2 }
      ],
      recentActivity: [
        { customer: 'Texas Thrift - Midtown', action: 'Converted to start', date: now.toISOString() },
        { customer: 'Montrose Medical', action: 'Quote sent', date: new Date(now - 86400000).toISOString() }
      ],
      unifiedSales: [
        {
          RecordID: 'SALE-1001',
          BranchID: 'HOUSTON',
          SoldDate: new Date(now - 86400000 * 2).toISOString(),
          AccountName: 'Texas Thrift - Midtown',
          ServiceAddress: '1234 Westheimer Rd, Houston, TX',
          ServiceName: 'GPC Interior/Exterior',
          CoveredPests: 'Rodents, Roaches',
          SalesRepIDs: 'AE-HTX-001',
          POCPhone: '(713) 555-0101',
          Status: 'Proposal',
          InitialPrice: 3200,
          MaintenancePrice: 950,
          Frequency: 12,
          ServiceMonths: 'JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC',
          serviceMonths: serviceMonthValues,
          SpecialNotes: 'Needs logbooks + roof void inspection',
          sraHazards: []
        },
        {
          RecordID: 'SALE-1002',
          BranchID: 'HOUSTON',
          SoldDate: new Date(now - 86400000 * 5).toISOString(),
          AccountName: 'Montrose Medical Group',
          ServiceAddress: '450 Westheimer Rd, Houston, TX',
          ServiceName: 'Rodent & Fly Program',
          CoveredPests: 'Rodents, Flies',
          SalesRepIDs: 'AE-HTX-001',
          POCPhone: '(713) 555-0202',
          Status: 'Negotiation',
          InitialPrice: 5800,
          MaintenancePrice: 1200,
          Frequency: 12,
          ServiceMonths: 'JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC',
          serviceMonths: serviceMonthValues,
          SpecialNotes: 'Two rooftop units to be installed',
          sraHazards: []
        },
        {
          RecordID: 'SALE-1003',
          BranchID: 'HOUSTON',
          SoldDate: new Date(now - 86400000 * 10).toISOString(),
          AccountName: 'Bayou Coffee Roasters',
          ServiceAddress: '2121 Main St, Houston, TX',
          ServiceName: 'Mosquito & GPC Combo',
          CoveredPests: 'Mosquito, Roach',
          SalesRepIDs: 'AE-HTX-001',
          POCPhone: '(713) 555-0303',
          Status: 'Sold',
          InitialPrice: 2500,
          MaintenancePrice: 600,
          Frequency: 12,
          ServiceMonths: 'MAR,APR,MAY,JUN,JUL,AUG,SEP',
          serviceMonths: ['MAR','APR','MAY','JUN','JUL','AUG','SEP'],
          SpecialNotes: 'Install ILTs in roasting room',
          sraHazards: []
        },
        {
          RecordID: 'SALE-1004',
          BranchID: 'HOUSTON',
          SoldDate: new Date(now - 86400000 * 1).toISOString(),
          AccountName: 'Galleria Offices',
          ServiceAddress: '5085 Westheimer Rd, Houston, TX',
          ServiceName: 'GPC & Rodent Bundle',
          CoveredPests: 'Rodents, Common Roaches',
          SalesRepIDs: 'AE-HTX-001',
          POCPhone: '(713) 555-0404',
          Status: 'New Sale',
          InitialPrice: 4100,
          MaintenancePrice: 1600,
          Frequency: 12,
          ServiceMonths: 'JAN,MAR,MAY,JUL,SEP,NOV',
          serviceMonths: ['JAN','MAR','MAY','JUL','SEP','NOV'],
          SpecialNotes: 'High security building - badge required',
          sraHazards: []
        },
        {
          RecordID: 'SALE-1005',
          BranchID: 'HOUSTON',
          SoldDate: new Date(now - 86400000 * 0.5).toISOString(),
          AccountName: 'Memorial Park Fitness',
          ServiceAddress: '6100 Memorial Dr, Houston, TX',
          ServiceName: 'Rodent Control & Exclusion',
          CoveredPests: 'Rodents, Mice',
          SalesRepIDs: 'AE-HTX-001',
          POCPhone: '(713) 555-0505',
          Status: 'New Sale',
          InitialPrice: 3800,
          MaintenancePrice: 1100,
          Frequency: 12,
          ServiceMonths: 'JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC',
          serviceMonths: serviceMonthValues,
          SpecialNotes: 'Multiple entry points - full exclusion needed',
          sraHazards: []
        },
        {
          RecordID: 'SALE-1006',
          BranchID: 'HOUSTON',
          SoldDate: new Date(now - 86400000 * 3).toISOString(),
          AccountName: 'Heights Food Hall',
          ServiceAddress: '123 Heights Blvd, Houston, TX',
          ServiceName: 'Fly & Rodent Control',
          CoveredPests: 'Flies, Rodents',
          SalesRepIDs: 'AE-HTX-001',
          POCPhone: '(713) 555-0606',
          Status: 'Proposal',
          InitialPrice: 2800,
          MaintenancePrice: 850,
          Frequency: 12,
          ServiceMonths: 'JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC',
          serviceMonths: serviceMonthValues,
          SpecialNotes: 'Multiple food vendors - need comprehensive coverage',
          sraHazards: []
        },
        {
          RecordID: 'SALE-1007',
          BranchID: 'HOUSTON',
          SoldDate: new Date(now - 86400000 * 4).toISOString(),
          AccountName: 'River Oaks Apartments',
          ServiceAddress: '2200 Westheimer Rd, Houston, TX',
          ServiceName: 'Rodent Exclusion',
          CoveredPests: 'Rodents',
          SalesRepIDs: 'AE-HTX-001',
          POCPhone: '(713) 555-0707',
          Status: 'Negotiation',
          InitialPrice: 4500,
          MaintenancePrice: 1300,
          Frequency: 12,
          ServiceMonths: 'JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC',
          serviceMonths: serviceMonthValues,
          SpecialNotes: '200-unit complex - ongoing maintenance needed',
          sraHazards: []
        },
        {
          RecordID: 'SALE-1008',
          BranchID: 'HOUSTON',
          SoldDate: new Date(now - 86400000 * 6).toISOString(),
          AccountName: 'Downtown Restaurant Supply',
          ServiceAddress: '500 Travis St, Houston, TX',
          ServiceName: 'Full GPC Program',
          CoveredPests: 'Roaches, Rodents, Flies',
          SalesRepIDs: 'AE-HTX-001',
          POCPhone: '(713) 555-0808',
          Status: 'Sold',
          InitialPrice: 3300,
          MaintenancePrice: 900,
          Frequency: 12,
          ServiceMonths: 'JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC',
          serviceMonths: serviceMonthValues,
          SpecialNotes: 'Warehouse + office space coverage',
          sraHazards: []
        },
        {
          RecordID: 'SALE-1009',
          BranchID: 'HOUSTON',
          SoldDate: new Date(now - 86400000 * 0.3).toISOString(),
          AccountName: 'Rice Village Shopping Center',
          ServiceAddress: '2519 University Blvd, Houston, TX',
          ServiceName: 'Commercial GPC Program',
          CoveredPests: 'Roaches, Ants, Spiders',
          SalesRepIDs: 'AE-HTX-001',
          POCPhone: '(713) 555-0606',
          Status: 'New Sale',
          InitialPrice: 5200,
          MaintenancePrice: 1500,
          Frequency: 12,
          ServiceMonths: 'JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC',
          serviceMonths: serviceMonthValues,
          SpecialNotes: 'Multi-tenant location - coordinate with property manager',
          sraHazards: []
        },
        {
          RecordID: 'SALE-1007',
          BranchID: 'HOUSTON',
          SoldDate: new Date(now - 86400000 * 0.2).toISOString(),
          AccountName: 'Houston Food Bank',
          ServiceAddress: '535 Portwall St, Houston, TX',
          ServiceName: 'Food Safety Pest Control',
          CoveredPests: 'Rodents, Roaches, Stored Product Pests',
          SalesRepIDs: 'AE-HTX-001',
          POCPhone: '(713) 555-0707',
          Status: 'New Sale',
          InitialPrice: 6500,
          MaintenancePrice: 1800,
          Frequency: 12,
          ServiceMonths: 'JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC',
          serviceMonths: serviceMonthValues,
          SpecialNotes: 'HACCP compliance required - detailed documentation',
          sraHazards: []
        },
        {
          RecordID: 'SALE-1008',
          BranchID: 'HOUSTON',
          SoldDate: new Date(now - 86400000 * 0.1).toISOString(),
          AccountName: 'Downtown Corporate Plaza',
          ServiceAddress: '1200 Smith St, Houston, TX',
          ServiceName: 'Executive Office Pest Control',
          CoveredPests: 'Ants, Spiders, Occasional Invaders',
          SalesRepIDs: 'AE-HTX-001',
          POCPhone: '(713) 555-0808',
          Status: 'New Sale',
          InitialPrice: 2800,
          MaintenancePrice: 850,
          Frequency: 12,
          ServiceMonths: 'FEB,APR,JUN,AUG,OCT,DEC',
          serviceMonths: ['FEB','APR','JUN','AUG','OCT','DEC'],
          SpecialNotes: 'After-hours service preferred - minimal disruption',
          sraHazards: []
        },
        {
          RecordID: 'SALE-1009',
          BranchID: 'HOUSTON',
          SoldDate: new Date(now - 86400000 * 0.05).toISOString(),
          AccountName: 'Heights Brewery & Taproom',
          ServiceAddress: '1617 W 18th St, Houston, TX',
          ServiceName: 'Bar & Restaurant Pest Program',
          CoveredPests: 'Fruit Flies, Roaches, Rodents',
          SalesRepIDs: 'AE-HTX-001',
          POCPhone: '(713) 555-0909',
          Status: 'New Sale',
          InitialPrice: 3400,
          MaintenancePrice: 1050,
          Frequency: 12,
          ServiceMonths: 'JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC',
          serviceMonths: serviceMonthValues,
          SpecialNotes: 'Drain fly treatment and bar area focus',
          sraHazards: []
        }
      ],
      timeSaved: {
        hours: 14.5,
        events: 11
      }
    };
  }

  function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function formatTimeForInput(date) {
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
  }
  function initAeDashboardPage() {
    buildServiceMonthOptions();
    setServiceMonthsSelected(serviceMonthValues);
    renderQuoteTracker();
    updateSRAReviewStamp();

    var salesforceFileInput = document.getElementById('salesforceQuoteFile');
    if (salesforceFileInput) {
      salesforceFileInput.addEventListener('change', handleSalesforceQuoteFile);
    }

    if (window.Branch360Options) {
      populateStandardDropdown('unifiedServiceType', Branch360Options.serviceTypes, 'Select Service Type');
      populateStandardDropdown('unifiedLeadType', Branch360Options.leadTypes, 'Select Lead Type');
      populateStandardDropdown('unifiedJobType', Branch360Options.jobTypes, 'Select Job Type');
    }

    ['unifiedSRABy','unifiedSRADate','unifiedSRATime'].forEach(function(id) {
      var el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', updateSRAReviewStamp);
      }
    });

    var leadSearchEl = document.getElementById('leadSearch');
    if (leadSearchEl) {
      leadSearchEl.addEventListener('input', function(e) {
        leadSearchTerm = e.target.value.trim();
        applyLeadFilters();
      });
    }
    var leadSortEl = document.getElementById('leadSort');
    if (leadSortEl) {
      leadSortEl.addEventListener('change', function(e) {
        leadSortMode = e.target.value;
        applyLeadFilters();
      });
    }

    var unifiedSaleForm = document.getElementById('unifiedSaleForm');
    if (unifiedSaleForm) {
      unifiedSaleForm.addEventListener('submit', submitUnifiedSaleForm);
    }
    
    // Billing address toggle
    var billingAddressDifferent = document.getElementById('unifiedBillingAddressDifferent');
    var billingAddressContainer = document.getElementById('billingAddressContainer');
    if (billingAddressDifferent && billingAddressContainer) {
      billingAddressDifferent.addEventListener('change', function() {
        if (this.checked) {
          billingAddressContainer.classList.remove('hidden');
        } else {
          billingAddressContainer.classList.add('hidden');
          var billingAddressInput = document.getElementById('unifiedBillingAddress');
          if (billingAddressInput) billingAddressInput.value = '';
        }
      });
    }

    var followUpForm = document.getElementById('followUpForm');
    if (followUpForm) {
      followUpForm.addEventListener('submit', handleFollowUpFormSubmit);
    }

    loadDashboard();
    setInterval(loadDashboard, 120000);
  }

  document.addEventListener('DOMContentLoaded', initAeDashboardPage);
  
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('service-worker.js')
        .then(function() { console.log('ServiceWorker registration successful'); })
        .catch(function(error) { console.log('ServiceWorker registration failed:', error); });
    });
  }

  window.addEventListener('message', function(event) {
    if (event && event.data && event.data.type === 'OPEN_START_PACKET') {
      openUnifiedSaleForm();
    }
    if (event && event.data && event.data.type === 'OPEN_SALESFORCE_IMPORT') {
      openSalesforceImportModal();
    }
    if (event && event.data && event.data.type === 'CREATE_START_PACKET_FROM_HANDOFF') {
      const handoffData = event.data.data || {};
      const draft = fillDraftDefaults({
        accountName: handoffData.accountName || '',
        serviceAddressLine1: handoffData.serviceAddress || '',
        branchId: (dashboardData && dashboardData.user ? (dashboardData.user.branchID || dashboardData.user.BranchID) : 'HOUSTON'),
        quoteTrackerId: 'HANDOFF-' + (handoffData.recordID || ''),
        saleDate: new Date().toISOString().split('T')[0]
      });
      applyStartPacketDraft(draft);
      openUnifiedSaleForm();
    }
  });

  // ===== TERRITORY MAP & LIST VIEW =====
  
  let map = null;
  let mapboxToken = null;
  let currentView = 'list';
  let allProspects = [];
  let filteredProspects = [];
  let calendarEvents = [];
  
  // Initialize map/list view
  function initTerritoryView() {
    loadAEsForFilter();
    loadProspects();
    setupFilters();
    switchView('list'); // Start with list view
  }
  
  // Switch between map and list view
  function switchView(view) {
    currentView = view;
    const mapView = document.getElementById('mapView');
    const listView = document.getElementById('listView');
    const mapBtn = document.getElementById('viewMapBtn');
    const listBtn = document.getElementById('viewListBtn');
    
    if (view === 'map') {
      mapView.classList.remove('hidden');
      listView.classList.add('hidden');
      mapBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700';
      listBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300';
      if (!map) {
        initMap();
      }
      updateMap();
    } else {
      mapView.classList.add('hidden');
      listView.classList.remove('hidden');
      mapBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300';
      listBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700';
      updateListView();
    }
  }
  
  // Load AEs for filter dropdown
  function loadAEsForFilter() {
    const aeFilter = document.getElementById('aeFilter');
    const runner = hasAppsScript() ? google.script.run : null;
    
    if (runner && runner.getSalesTeamPerformance) {
      runner
        .withSuccessHandler(function(aes) {
          if (!aes || !Array.isArray(aes)) return;
          aes.forEach(function(ae) {
            const option = document.createElement('option');
            option.value = ae.userID || ae.email;
            option.textContent = ae.name || ae.email;
            aeFilter.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load AEs:', error);
        })
        .getSalesTeamPerformance(getCurrentUserBranchID());
    } else {
      // Demo data
      const demoAEs = [
        { userID: 'AE-001', name: 'John Doe', email: 'john@company.com' },
        { userID: 'AE-002', name: 'Jane Smith', email: 'jane@company.com' }
      ];
      demoAEs.forEach(function(ae) {
        const option = document.createElement('option');
        option.value = ae.userID;
        option.textContent = ae.name;
        aeFilter.appendChild(option);
      });
    }
  }
  
  // Load prospects from database
  function loadProspects() {
    const runner = hasAppsScript() ? google.script.run : null;
    
    if (runner && runner.getAEDashboard) {
      const currentUser = getActiveDemoUser();
      const userID = currentUser ? currentUser.userID : null;
      
      runner
        .withSuccessHandler(function(data) {
          allProspects = (data.newLeads || []).concat(data.pipeline?.proposal || []).concat(data.pipeline?.negotiation || []);
          applyFilters();
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load prospects:', error);
          // Use demo data
          loadDemoProspects();
        })
        .getAEDashboard(userID);
    } else {
      loadDemoProspects();
    }
  }
  
  // Load demo prospects
  function loadDemoProspects() {
    allProspects = [
      {
        id: 'LEAD-001',
        customer: 'Downtown Restaurant',
        address: '123 Main St, Houston, TX 77002',
        zip: '77002',
        vertical: 'restaurant',
        status: 'New',
        lat: 29.7604,
        lng: -95.3698
      },
      {
        id: 'LEAD-002',
        customer: 'Property Management Co',
        address: '456 Oak Ave, Houston, TX 77005',
        zip: '77005',
        vertical: 'property_management',
        status: 'Contacted',
        lat: 29.7500,
        lng: -95.3600
      },
      {
        id: 'LEAD-003',
        customer: 'Retail Store',
        address: '789 Commerce Blvd, Houston, TX 77010',
        zip: '77010',
        vertical: 'retail',
        status: 'New',
        lat: 29.7400,
        lng: -95.3500
      }
    ];
    applyFilters();
  }
  
  // Setup filter event listeners
  function setupFilters() {
    document.getElementById('aeFilter').addEventListener('change', applyFilters);
    document.getElementById('verticalFilter').addEventListener('change', applyFilters);
    document.getElementById('zipFilter').addEventListener('input', function() {
      const zip = this.value.trim();
      if (zip.length === 5) {
        applyFilters();
      }
    });
  }
  
  // Apply filters to prospects
  function applyFilters() {
    const aeFilter = document.getElementById('aeFilter').value;
    const verticalFilter = document.getElementById('verticalFilter').value;
    const zipFilter = document.getElementById('zipFilter').value.trim();
    
    filteredProspects = allProspects.filter(function(prospect) {
      if (aeFilter && prospect.assignedAE !== aeFilter) return false;
      if (verticalFilter && prospect.vertical !== verticalFilter) return false;
      if (zipFilter && prospect.zip !== zipFilter) return false;
      return true;
    });
    
    if (currentView === 'map') {
      updateMap();
    } else {
      updateListView();
    }
  }
  
  // Initialize Mapbox map
  function initMap() {
    const mapContainer = document.getElementById('prospectMap');
    if (!mapContainer) return;
    
    // Try to get token from localStorage first (for demo/fallback)
    let tokenToUse = null;
    try {
      if (window.localStorage) {
        tokenToUse = localStorage.getItem('MAPBOX_TOKEN');
      }
    } catch (e) {
      console.warn('Cannot access localStorage:', e);
    }
    
    const runner = hasAppsScript() ? google.script.run : null;
    
    if (runner && runner.getMapboxToken) {
      runner
        .withSuccessHandler(function(token) {
          if (token && token.trim().length > 0) {
            tokenToUse = token;
            // Store in localStorage for future use
            try {
              if (window.localStorage) {
                localStorage.setItem('MAPBOX_TOKEN', token);
              }
            } catch (e) {}
            initializeMapWithToken(token);
          } else if (tokenToUse) {
            // Fallback to stored token
            console.log('Server returned empty token, using fallback');
            initializeMapWithToken(tokenToUse);
          } else {
            showMapPlaceholder('Mapbox token is not configured. Please configure your Mapbox token in settings to view the map.');
          }
        })
        .withFailureHandler(function(error) {
          console.warn('Failed to get Mapbox token from server:', error);
          // Try fallback token if available
          if (tokenToUse) {
            console.log('Using fallback token from localStorage');
            initializeMapWithToken(tokenToUse);
          } else {
            showMapPlaceholder('Mapbox token configuration is required. Please configure your Mapbox token in settings to view the map.');
          }
        })
        .getMapboxToken();
    } else {
      // No Apps Script available - try stored token or fallback
      if (tokenToUse) {
        console.log('Using stored token (no Apps Script available)');
        initializeMapWithToken(tokenToUse);
      } else {
        // Last resort: try default token from config (if embedded in page)
        const defaultToken = 'pk.eyJ1IjoiY2xhc2FrIiwiYSI6ImNtaHduMzF4bTAxZjgya3BxMjMzYXNzM2kifQ.Ervu02B9hyFoRYmuQgodIA';
        if (defaultToken && defaultToken.startsWith('pk.')) {
          console.log('Using default Mapbox token');
          initializeMapWithToken(defaultToken);
        } else {
          showMapPlaceholder('Mapbox token configuration required. Configure your Mapbox token in settings to view prospects on the map.');
        }
      }
    }
  }
  
  function initializeMapWithToken(token) {
    if (!token || token.trim().length === 0) {
      showMapPlaceholder('Invalid Mapbox token provided.');
      return;
    }
    
    const mapContainer = document.getElementById('prospectMap');
    if (!mapContainer) return;
    
    try {
      mapboxToken = token;
      mapboxgl.accessToken = token;
      map = new mapboxgl.Map({
        container: 'prospectMap',
        style: 'mapbox://styles/mapbox/dark-v11',
        center: [-95.3698, 29.7604], // Houston default
        zoom: 11
      });
      
      map.on('load', function() {
        updateMap();
      });
      
      map.on('error', function(e) {
        console.error('Mapbox error:', e);
        showMapPlaceholder('Map failed to load. The token may be invalid or expired. Error: ' + (e.error ? e.error.message : 'Unknown error'));
      });
    } catch (error) {
      console.error('Map initialization error:', error);
      showMapPlaceholder('Map initialization failed: ' + error.message);
    }
  }
  
  function showMapPlaceholder(message) {
    const mapContainer = document.getElementById('prospectMap');
    if (!mapContainer) return;
    
    mapContainer.innerHTML = `
      <div class="flex flex-col items-center justify-center h-full bg-gray-800 text-gray-300 p-8">
        <div class="text-4xl mb-4">üó∫Ô∏è</div>
        <p class="text-center font-semibold mb-2">Map View Unavailable</p>
        <p class="text-center text-sm mb-4">${message || 'Mapbox token configuration required.'}</p>
        <button onclick="switchView('list')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold">
          Switch to List View
        </button>
      </div>
    `;
  }
  
  // Update map with filtered prospects
  function updateMap() {
    if (!map) return;
    
    // Remove existing markers
    const markers = document.querySelectorAll('.mapbox-marker');
    markers.forEach(function(marker) {
      marker.remove();
    });
    
    // Add markers for each prospect
    filteredProspects.forEach(function(prospect) {
      if (prospect.lat && prospect.lng) {
        const el = document.createElement('div');
        el.className = 'mapbox-marker';
        el.style.width = '20px';
        el.style.height = '20px';
        el.style.borderRadius = '50%';
        el.style.backgroundColor = getStatusColor(prospect.status);
        el.style.border = '2px solid white';
        el.style.cursor = 'pointer';
        el.title = prospect.customer;
        
        new mapboxgl.Marker(el)
          .setLngLat([prospect.lng, prospect.lat])
          .setPopup(new mapboxgl.Popup().setHTML(
            '<div class="p-2"><strong>' + prospect.customer + '</strong><br>' +
            prospect.address + '<br>' +
            '<span class="text-sm text-gray-600">' + prospect.vertical + '</span></div>'
          ))
          .addTo(map);
      }
    });
    
    // Update count
    document.getElementById('mapProspectCount').textContent = filteredProspects.length;
    
    // Fit map to bounds if we have prospects
    if (filteredProspects.length > 0) {
      const bounds = new mapboxgl.LngLatBounds();
      filteredProspects.forEach(function(prospect) {
        if (prospect.lat && prospect.lng) {
          bounds.extend([prospect.lng, prospect.lat]);
        }
      });
      if (!bounds.isEmpty()) {
        map.fitBounds(bounds, { padding: 50 });
      }
    }
  }
  
  // Update list view
  function updateListView() {
    const tbody = document.getElementById('prospectListBody');
    
    if (filteredProspects.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No prospects match your filters.</td></tr>';
      return;
    }
    
    tbody.innerHTML = filteredProspects.map(function(prospect) {
      return '<tr class="hover:bg-gray-50">' +
        '<td class="px-4 py-3 text-sm font-medium text-gray-900">' + (prospect.customer || 'N/A') + '</td>' +
        '<td class="px-4 py-3 text-sm text-gray-600">' + (prospect.address || 'N/A') + '</td>' +
        '<td class="px-4 py-3 text-sm text-gray-600">' + (prospect.zip || 'N/A') + '</td>' +
        '<td class="px-4 py-3 text-sm text-gray-600">' + formatVertical(prospect.vertical) + '</td>' +
        '<td class="px-4 py-3 text-sm"><span class="px-2 py-1 rounded-full text-xs ' + getStatusClass(prospect.status) + '">' + (prospect.status || 'New') + '</span></td>' +
        '<td class="px-4 py-3 text-sm"><button onclick="viewProspect(\'' + prospect.id + '\')" class="text-blue-600 hover:text-blue-800 font-semibold">View</button></td>' +
        '</tr>';
    }).join('');
  }
  
  // Load prospects from calendar (site assessments)
  function loadProspectsFromCalendar() {
    const runner = hasAppsScript() ? google.script.run : null;
    
    if (runner && runner.getCalendarEvents) {
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      runner
        .withSuccessHandler(function(events) {
          if (!events || events.length === 0) {
            alert('No calendar events found for today or tomorrow. Calendar integration will load prospects near your scheduled site assessments.');
            return;
          }
          
          // Find events with locations
          const eventsWithLocations = events.filter(function(event) {
            return event.location && event.location.trim().length > 0;
          });
          
          if (eventsWithLocations.length === 0) {
            alert('Found calendar events but none have location information. Please add locations to your calendar events to use this feature.');
            return;
          }
          
          // Extract zip codes from event locations and filter prospects
          const zipCodes = [];
          eventsWithLocations.forEach(function(event) {
            const zipMatch = event.location.match(/\b(\d{5})\b/);
            if (zipMatch) {
              zipCodes.push(zipMatch[1]);
            }
          });
          
          if (zipCodes.length > 0) {
            // Filter by first zip code found
            const firstZip = zipCodes[0];
            document.getElementById('zipFilter').value = firstZip;
            applyFilters();
            
            alert('Loaded prospects near your calendar events!\n\n' +
                  'Found ' + eventsWithLocations.length + ' event(s) with locations.\n' +
                  'Filtering by zip code: ' + firstZip + '\n\n' +
                  'Prospects matching your calendar events are now shown in the list.');
          } else {
            alert('Could not extract zip codes from calendar event locations. Please ensure your calendar events include full addresses with zip codes.');
          }
        })
        .withFailureHandler(function(error) {
          console.warn('Calendar integration failed:', error);
          // Demo: Simulate loading prospects near a calendar event
          const demoCalendarEvent = {
            location: '123 Main St, Houston, TX 77002',
            date: new Date(),
            type: 'Site Assessment'
          };
          
          // Filter prospects by zip code of calendar event location
          const eventZip = '77002';
          document.getElementById('zipFilter').value = eventZip;
          applyFilters();
          
          alert('Calendar integration (demo mode): Loading prospects near your scheduled site assessments.\n\n' +
                'Using demo location: ' + demoCalendarEvent.location + '\n' +
                'Filtering by zip code: ' + eventZip);
        })
        .getCalendarEvents({ 
          startDate: today.toISOString(), 
          endDate: tomorrow.toISOString() 
        });
    } else {
      // Demo: Simulate loading prospects near a calendar event
      const demoCalendarEvent = {
        location: '123 Main St, Houston, TX 77002',
        date: new Date(),
        type: 'Site Assessment'
      };
      
      // Filter prospects by zip code of calendar event location
      const eventZip = '77002';
      document.getElementById('zipFilter').value = eventZip;
      applyFilters();
      
      alert('Calendar integration (demo mode): Loading prospects near your scheduled site assessments.\n\n' +
            'Using demo location: ' + demoCalendarEvent.location + '\n' +
            'Filtering by zip code: ' + eventZip + '\n\n' +
            'When Google Calendar API is configured, this will automatically:\n' +
            '1. Get locations from your calendar events\n' +
            '2. Find all prospects within the selected radius\n' +
            '3. Filter by your selected verticals\n' +
            '4. Show them on the map/list for easy prospecting');
    }
  }
  
  // Map zoom functions
  function zoomMapIn() {
    if (map) {
      map.zoomIn();
    }
  }
  
  function zoomMapOut() {
    if (map) {
      map.zoomOut();
    }
  }
  
  function resetMapView() {
    if (map) {
      map.setCenter([-95.3698, 29.7604]);
      map.setZoom(11);
    }
  }
  
  // Helper functions
  function getStatusColor(status) {
    const colors = {
      'New': '#ef4444',
      'Contacted': '#f59e0b',
      'Proposal': '#3b82f6',
      'Negotiation': '#8b5cf6',
      'Sold': '#10b981'
    };
    return colors[status] || '#6b7280';
  }
  
  function getStatusClass(status) {
    const classes = {
      'New': 'bg-red-100 text-red-800',
      'Contacted': 'bg-yellow-100 text-yellow-800',
      'Proposal': 'bg-blue-100 text-blue-800',
      'Negotiation': 'bg-purple-100 text-purple-800',
      'Sold': 'bg-green-100 text-green-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
  }
  
  function formatVertical(vertical) {
    if (!vertical) return 'N/A';
    return vertical.split('_').map(function(word) {
      return word.charAt(0).toUpperCase() + word.slice(1);
    }).join(' ');
  }
  
  function viewProspect(id) {
    const prospect = filteredProspects.find(function(p) { return p.id === id; }) || 
                     allProspects.find(function(p) { return p.id === id; });
    if (!prospect) {
      alert('Prospect not found: ' + id);
      return;
    }
    
    // Create and show prospect details modal
    const modalHtml = `
      <div id="prospectDetailModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" onclick="if(event.target.id==='prospectDetailModal')closeProspectDetailModal()">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="flex items-center justify-between px-6 py-4 border-b">
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-500">Prospect Details</p>
              <h3 class="text-xl font-semibold text-gray-900">${prospect.customer || 'Unknown'}</h3>
            </div>
            <button onclick="closeProspectDetailModal()" aria-label="Close prospect detail modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
          </div>
          <div class="px-6 py-4 space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Customer Name</label>
              <p class="text-gray-900">${prospect.customer || 'N/A'}</p>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Address</label>
              <p class="text-gray-900">${prospect.address || 'N/A'}</p>
              <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(prospect.address || '')}" 
                 target="_blank" class="text-blue-600 hover:underline text-sm mt-1">View on Maps</a>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Zip Code</label>
                <p class="text-gray-900">${prospect.zip || 'N/A'}</p>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Vertical</label>
                <p class="text-gray-900">${formatVertical(prospect.vertical) || 'N/A'}</p>
              </div>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">Status</label>
              <span class="inline-block px-3 py-1 rounded-full text-xs ${getStatusClass(prospect.status)}">${prospect.status || 'New'}</span>
            </div>
            <div class="pt-4 border-t flex gap-3">
              <button onclick="startPacketFromProspect('${prospect.id}'); closeProspectDetailModal();" 
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">
                Create Start Packet
              </button>
              <button onclick="closeProspectDetailModal()" 
                class="px-6 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded-lg">
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('prospectDetailModal');
    if (existingModal) existingModal.remove();
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Add ESC key handler
    const escHandler = function(e) {
      if (e.key === 'Escape') {
        closeProspectDetailModal();
        document.removeEventListener('keydown', escHandler);
      }
    };
    document.addEventListener('keydown', escHandler);
  }
  
  function closeProspectDetailModal() {
    const modal = document.getElementById('prospectDetailModal');
    if (modal) modal.remove();
  }
  
  function startPacketFromProspect(prospectId) {
    const prospect = filteredProspects.find(function(p) { return p.id === prospectId; }) || 
                     allProspects.find(function(p) { return p.id === prospectId; });
    if (!prospect) return;
    
    const draft = fillDraftDefaults({
      accountName: prospect.customer,
      serviceAddressLine1: prospect.address || '',
      branchId: (dashboardData && dashboardData.user ? (dashboardData.user.branchID || dashboardData.user.BranchID) : 'HOUSTON'),
      services: [{
        serviceName: 'Prospect Import',
        category: prospect.vertical || 'General',
        descriptionText: 'Imported from prospect list.'
      }],
      quoteTrackerId: 'PROSPECT-' + prospectId
    });
    applyStartPacketDraft(draft);
  }
  
  function getCurrentUserBranchID() {
    const user = getActiveDemoUser();
    return user ? (user.branchID || 'BRN-001') : 'BRN-001';
  }
  
  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTerritoryView);
  } else {
    initTerritoryView();
  }
</script>

</div>
<!-- End main-with-sidebar -->

</body>
</html>
